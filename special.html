<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Author 1">
<meta name="author" content="Author 2">
<title>Flexible and Robust Machine Learning Using mlr3 in R - 8&nbsp; Special Tasks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./technical.html" rel="next">
<link href="./preprocessing.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script async="" src="https://hypothes.is/embed.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Special Tasks</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Flexible and Robust Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="./Flexible-and-Robust-Machine-Learning-Using-mlr3-in-R.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Resampling and Benchmarking</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Feature Selection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pipelines.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pipelines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preprocessing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Preprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./special.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Special Tasks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./technical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Technical</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpretation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Interpretation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extending.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Extending</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Appendices</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Glossary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tasks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview-tables.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Overview Tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Session Info</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#survival" id="toc-survival" class="nav-link active" data-scroll-target="#survival"><span class="toc-section-number">8.1</span>  Survival Analysis</a>
  <ul class="collapse">
<li><a href="#tasksurv" id="toc-tasksurv" class="nav-link" data-scroll-target="#tasksurv"><span class="toc-section-number">8.1.1</span>  TaskSurv</a></li>
  <li><a href="#predict-types---crank-lp-and-distr" id="toc-predict-types---crank-lp-and-distr" class="nav-link" data-scroll-target="#predict-types---crank-lp-and-distr"><span class="toc-section-number">8.1.2</span>  Predict Types - crank, lp, and distr</a></li>
  <li><a href="#composition" id="toc-composition" class="nav-link" data-scroll-target="#composition"><span class="toc-section-number">8.1.3</span>  Composition</a></li>
  <li><a href="#benchmark-experiment" id="toc-benchmark-experiment" class="nav-link" data-scroll-target="#benchmark-experiment"><span class="toc-section-number">8.1.4</span>  Benchmark Experiment</a></li>
  </ul>
</li>
  <li>
<a href="#density" id="toc-density" class="nav-link" data-scroll-target="#density"><span class="toc-section-number">8.2</span>  Density Estimation</a>
  <ul class="collapse">
<li><a href="#train-and-predict" id="toc-train-and-predict" class="nav-link" data-scroll-target="#train-and-predict"><span class="toc-section-number">8.2.1</span>  Train and Predict</a></li>
  <li><a href="#benchmark-experiment-1" id="toc-benchmark-experiment-1" class="nav-link" data-scroll-target="#benchmark-experiment-1"><span class="toc-section-number">8.2.2</span>  Benchmark Experiment</a></li>
  </ul>
</li>
  <li>
<a href="#spatiotemporal" id="toc-spatiotemporal" class="nav-link" data-scroll-target="#spatiotemporal"><span class="toc-section-number">8.3</span>  Spatiotemporal Analysis</a>
  <ul class="collapse">
<li><a href="#spatial-task" id="toc-spatial-task" class="nav-link" data-scroll-target="#spatial-task"><span class="toc-section-number">8.3.1</span>  Creating a spatial Task</a></li>
  <li><a href="#autocorrelation" id="toc-autocorrelation" class="nav-link" data-scroll-target="#autocorrelation"><span class="toc-section-number">8.3.2</span>  Autocorrelation</a></li>
  <li><a href="#spatiotemp-cv" id="toc-spatiotemp-cv" class="nav-link" data-scroll-target="#spatiotemp-cv"><span class="toc-section-number">8.3.3</span>  Spatiotemporal Cross-Validation and Partitioning</a></li>
  <li><a href="#vis-spt-partitions" id="toc-vis-spt-partitions" class="nav-link" data-scroll-target="#vis-spt-partitions"><span class="toc-section-number">8.3.4</span>  Visualization of Spatiotemporal Partitions</a></li>
  <li><a href="#choose-spt-rsmp" id="toc-choose-spt-rsmp" class="nav-link" data-scroll-target="#choose-spt-rsmp"><span class="toc-section-number">8.3.5</span>  Choosing a Resampling Method</a></li>
  <li><a href="#sec-spatial-prediction" id="toc-sec-spatial-prediction" class="nav-link" data-scroll-target="#sec-spatial-prediction"><span class="toc-section-number">8.3.6</span>  Spatial Prediction</a></li>
  </ul>
</li>
  <li>
<a href="#cost-sens" id="toc-cost-sens" class="nav-link" data-scroll-target="#cost-sens"><span class="toc-section-number">8.4</span>  Cost-Sensitive Classification</a>
  <ul class="collapse">
<li><a href="#a-first-model" id="toc-a-first-model" class="nav-link" data-scroll-target="#a-first-model"><span class="toc-section-number">8.4.1</span>  A First Model</a></li>
  <li><a href="#cost-sensitive-measure" id="toc-cost-sensitive-measure" class="nav-link" data-scroll-target="#cost-sensitive-measure"><span class="toc-section-number">8.4.2</span>  Cost-sensitive Measure</a></li>
  <li><a href="#thresholding" id="toc-thresholding" class="nav-link" data-scroll-target="#thresholding"><span class="toc-section-number">8.4.3</span>  Thresholding</a></li>
  <li><a href="#threshold-tuning" id="toc-threshold-tuning" class="nav-link" data-scroll-target="#threshold-tuning"><span class="toc-section-number">8.4.4</span>  Threshold Tuning</a></li>
  <li><a href="#pipeopthreshold" id="toc-pipeopthreshold" class="nav-link" data-scroll-target="#pipeopthreshold"><span class="toc-section-number">8.4.5</span>  PipeOpThreshold</a></li>
  <li><a href="#pipeoptunethreshold" id="toc-pipeoptunethreshold" class="nav-link" data-scroll-target="#pipeoptunethreshold"><span class="toc-section-number">8.4.6</span>  PipeOpTunethreshold</a></li>
  </ul>
</li>
  <li>
<a href="#cluster" id="toc-cluster" class="nav-link" data-scroll-target="#cluster"><span class="toc-section-number">8.5</span>  Cluster Analysis</a>
  <ul class="collapse">
<li><a href="#train-and-predict-1" id="toc-train-and-predict-1" class="nav-link" data-scroll-target="#train-and-predict-1"><span class="toc-section-number">8.5.1</span>  Train and Predict</a></li>
  <li><a href="#measures" id="toc-measures" class="nav-link" data-scroll-target="#measures"><span class="toc-section-number">8.5.2</span>  Measures</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="toc-section-number">8.5.3</span>  Visualization</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mlr-org/mlr3book/edit/main/book/special.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/mlr-org/mlr3book/blob/main/book/special.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-special" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Special Tasks</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    Author 1 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 1
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    Author 2 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 2
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    TODO (150-200 WORDS)
  </div>
</div>

</header><p>This chapter explores the different functions of <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> when dealing with specific data sets that require further statistical modification to undertake sensible analysis. Following topics are discussed:</p>
<p><strong>Survival Analysis</strong></p>
<p>This sub-chapter explains how to conduct sound <a href="#survival">survival analysis</a> in mlr3. <a href="#survival">Survival analysis</a> is used to monitor the period of time until a specific event takes places. This specific event could be, e.g., death, the transmission of a disease, marriage, or divorce. Two considerations are important when conducting <a href="#survival">survival analysis</a>:</p>
<ul>
<li>Whether the event occurred within the frame of the given data</li>
<li>How much time it took until the event occurred</li>
</ul>
<p>In summary, this sub-chapter explains how to account for these considerations and conduct survival analysis using the <code>mlr3proba</code> extension package.</p>
<p><strong>Density Estimation</strong></p>
<p>This sub-chapter explains how to conduct (unconditional) <a href="#density">density estimation</a> in mlr3. <a href="#density">Density estimation</a> is used to estimate the probability density function of a continuous variable. Unconditional density estimation is an unsupervised task, so there is no ‘value’ to predict. Instead, densities are <em>estimated</em>.</p>
<p>This sub-chapter explains how to estimate probability distributions for continuous variables using the <code>mlr3proba</code> extension package.</p>
<p><strong>Spatiotemporal Analysis</strong></p>
<p><a href="#spatiotemporal">Spatiotemporal analysis</a> data observations entail reference information about spatial and temporal characteristics. One of the largest issues of <a href="#spatiotemporal">spatiotemporal data analysis</a> is the inevitable presence of auto-correlation in the data. Auto-correlation is especially severe in data with a marginal spatiotemporal variation. The sub-chapter on <a href="#spatiotemporal">Spatiotemporal analysis</a> provides instructions on how to account for spatiotemporal data.</p>
<p><strong>Multilabel Classification</strong></p>
<p><a href="#multilabel">Multilabel classification</a> deals with objects that can belong to more than one category at the same time. Numerous target labels are attributed to a single observation. Working with multilabel data requires one to use modified algorithms, to accommodate data specific characteristics. Two approaches to <a href="#multilabel">multilabel classification</a> are prominently used:</p>
<ul>
<li>The problem transformation method</li>
<li>The algorithm adaption method</li>
</ul>
<p>Instructions on how to deal with <a href="#multilabel">multilabel classification</a> in<a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>can be found in this sub-chapter.</p>
<p><strong>Cost Sensitive Classification</strong></p>
<p>This sub-chapter deals with the implementation of <a href="#cost-sens">cost-sensitive classification</a>. Regular classification aims to minimize the misclassification rate and thus all types of misclassification errors are deemed equally severe. <a href="#cost-sens">Cost-sensitive classification</a> is a setting where the costs caused by different kinds of errors are not assumed to be equal. The objective is to minimize the expected costs.</p>
<p>Analytical data for a big credit institution is used as a use case to illustrate the different features. Firstly, the sub-chapter provides guidance on how to implement a first model. Subsequently, the sub-chapter contains instructions on how to modify cost sensitivity measures, thresholding and threshold tuning.</p>
<p><strong>Cluster Analysis</strong></p>
<p><a href="#cluster">Cluster analysis</a> aims to group data into clusters such that objects that are similar end up in the same cluster. Fundamentally, clustering and classification are similar. However, clustering is an unsupervised task because observations do not contain true labels while in classification, labels are needed in order to train a model.</p>
<p>This sub-chapter explains how to perform <a href="#cluster">cluster analysis</a> in<a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>with the help of <code>mlr3cluster</code> extension package.</p>
<p><strong>Coming soon</strong></p>
<p>In development we are also working on</p>
<ul>
<li>Multilabel classification - <a href="https://github.com/mlr-org/mlr3multioutput"><code>mlr3multioutput</code></a>
</li>
<li>Functional data analysis - <a href="https://github.com/mlr-org/mlr3fda"><code>mlr3fda</code></a>
</li>
<li>Ordinal analysis - <a href="https://cran.r-project.org/package=mlr3ordinal"><code>mlr3ordinal</code></a>
</li>
<li>Time-series analysis / forecasting - <a href="https://cran.r-project.org/package=mlr3temporal"><code>mlr3temporal</code></a>
</li>
</ul>
<p>Send us a message if you want to help out on any of these!</p>
<section id="survival" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="survival">
<span class="header-section-number">8.1</span> Survival Analysis</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Survival analysis with {mlr3proba} is currently in a fragile state after its removal from CRAN. Hence most code examples listed in this page will not work for the time being. We are actively working on a solution!</p>
</div>
</div>
<p>Survival analysis is a sub-field of supervised machine learning in which the aim is to predict the survival distribution of a given individual. Arguably the main feature of survival analysis is that, unlike classification and regression, learners are trained on two features:</p>
<ol type="1">
<li>the time until the event takes place</li>
<li>the event type: either censoring or death.</li>
</ol>
<p>At a particular time-point, an individual is either: alive, dead, or censored. Censoring occurs if it is unknown if an individual is alive or dead. For example, say we are interested in patients in hospital and every day it is recorded if they are alive or dead, then after a patient leaves, it is unknown if they are alive or dead. Hence they are censored. If there was no censoring, then ordinary regression analysis could be used instead. Furthermore, survival data contains solely positive values and therefore needs to be transformed to avoid biases.</p>
<p>Note that survival analysis accounts for both censored and uncensored observations while adjusting respective model parameters.</p>
<p>The package <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a> <span class="citation" data-cites="mlr3proba">(<a href="references.html#ref-mlr3proba" role="doc-biblioref">Sonabend et al. 2021</a>)</span> extends <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> with the following objects for survival analysis:</p>
<ul>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/TaskSurv.html"><code>TaskSurv</code></a> to define (censored) survival tasks</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerSurv.html"><code>LearnerSurv</code></a> as base class for survival learners</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/PredictionSurv.html"><code>PredictionSurv</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/MeasureSurv.html"><code>MeasureSurv</code></a> as specialized class for performance measures</li>
</ul>
<p>For a good introduction to survival analysis see <em>Modelling Survival Data in Medical Research</em> <span class="citation" data-cites="Collett2014">(<a href="references.html#ref-Collett2014" role="doc-biblioref">Collett 2014</a>)</span>.</p>
<section id="tasksurv" class="level3" data-number="8.1.1"><h3 data-number="8.1.1" class="anchored" data-anchor-id="tasksurv">
<span class="header-section-number">8.1.1</span> TaskSurv</h3>
<p>Unlike <a href="https://mlr3.mlr-org.com/reference/TaskClassif.html"><code>TaskClassif</code></a> and <a href="https://mlr3.mlr-org.com/reference/TaskRegr.html"><code>TaskRegr</code></a> which have a single ‘target’ argument, <a href="https://mlr3proba.mlr-org.com/reference/TaskSurv.html"><code>TaskSurv</code></a> mimics the <a href="https://www.rdocumentation.org/packages/survival/topics/Surv"><code>survival::Surv</code></a> object and has three to four target arguments (dependent on censoring type). A <a href="https://mlr3proba.mlr-org.com/reference/TaskSurv.html"><code>TaskSurv</code></a> can be constructed with the function <a href="https://mlr3proba.mlr-org.com/reference/as_task_surv.html"><code>as_task_surv()</code></a>:</p>
<div class="cell" data-hash="special_cache/html/special-002_73e844e2d6c77316cd1151e1bc80a409">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(<span class="st">"mlr3proba"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(<span class="st">"survival"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">as_task_surv</span>(survival<span class="sc">::</span>bladder2[, <span class="sc">-</span>1L], <span class="at">id =</span> <span class="st">"interval_censored"</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="at">time =</span> <span class="st">"start"</span>, <span class="at">event =</span> <span class="st">"event"</span>, <span class="at">time2 =</span> <span class="st">"stop"</span>, <span class="at">type =</span> <span class="st">"interval"</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># type = "right" is default</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>task <span class="ot">=</span> <span class="fu">as_task_surv</span>(survival<span class="sc">::</span>rats, <span class="at">id =</span> <span class="st">"right_censored"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="at">time =</span> <span class="st">"time"</span>, <span class="at">event =</span> <span class="st">"status"</span>, <span class="at">type =</span> <span class="st">"right"</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="fu">print</span>(task)</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># the target column is a survival object:</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="fu">head</span>(task<span class="sc">$</span><span class="fu">truth</span>())</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># kaplan-meier plot</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co"># library("mlr3viz")</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">autoplot</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="predict-types---crank-lp-and-distr" class="level3" data-number="8.1.2"><h3 data-number="8.1.2" class="anchored" data-anchor-id="predict-types---crank-lp-and-distr">
<span class="header-section-number">8.1.2</span> Predict Types - crank, lp, and distr</h3>
<p>Every <a href="https://mlr3proba.mlr-org.com/reference/PredictionSurv.html"><code>PredictionSurv</code></a> object can predict one or more of:</p>
<ul>
<li>
<code>lp</code> - Linear predictor calculated as the fitted coefficients multiplied by the test data.</li>
<li>
<code>distr</code> - Predicted survival distribution, either discrete or continuous. Implemented in <a href="https://cran.r-project.org/package=distr6"><code>distr6</code></a>.</li>
<li>
<code>crank</code> - Continuous risk ranking.</li>
<li>
<code>response</code> - Predicted survival time.</li>
</ul>
<p><code>lp</code> and <code>crank</code> can be used with measures of discrimination such as the concordance index. Whilst <code>lp</code> is a specific mathematical prediction, <code>crank</code> is any continuous ranking that identifies who is more or less likely to experience the event. So far the only implemented learner that only returns a continuous ranking is <code>surv.svm</code>. If a <a href="https://mlr3proba.mlr-org.com/reference/PredictionSurv.html"><code>PredictionSurv</code></a> returns an <code>lp</code> then the <code>crank</code> is identical to this. Otherwise <code>crank</code> is calculated as the expectation of the predicted survival distribution. Note that for linear proportional hazards models, the ranking (but not necessarily the <code>crank</code> score itself) given by <code>lp</code> and the expectation of <code>distr</code>, is identical.</p>
<p>The example below uses the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_rats.html"><code>rats</code></a> task shipped with <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a>.</p>
<div class="cell" data-hash="special_cache/html/special-003_6950b401e3e3f13a9a4b7788f5f59329">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>learn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.coxph"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>train_set <span class="ot">=</span> <span class="fu">sample</span>(task<span class="sc">$</span>nrow, <span class="fl">0.8</span> <span class="sc">*</span> task<span class="sc">$</span>nrow)</span>
<span id="cb2-5"><a href="#cb2-5"></a>test_set <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train_set)</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>learn<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> train_set)</span>
<span id="cb2-8"><a href="#cb2-8"></a>prediction <span class="ot">=</span> learn<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> test_set)</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="fu">print</span>(prediction)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionSurv&gt; for 60 observations:
    row_ids time status      crank         lp     distr
          2   49   TRUE -0.5038971 -0.5038971 &lt;list[1]&gt;
          3  104  FALSE -0.5038971 -0.5038971 &lt;list[1]&gt;
         12  102  FALSE -3.4446695 -3.4446695 &lt;list[1]&gt;
---                                                    
        281   89  FALSE -2.5217340 -2.5217340 &lt;list[1]&gt;
        295  104  FALSE  1.3955682  1.3955682 &lt;list[1]&gt;
        300  102  FALSE -2.4602050 -2.4602050 &lt;list[1]&gt;</code></pre>
</div>
</div>
</section><section id="composition" class="level3" data-number="8.1.3"><h3 data-number="8.1.3" class="anchored" data-anchor-id="composition">
<span class="header-section-number">8.1.3</span> Composition</h3>
<p>Finally we take a look at the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s implemented in <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a>, which are used for composition of predict types. For example, a predict linear predictor does not have a lot of meaning by itself, but it can be composed into a survival distribution. See <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> for full tutorials and details on <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s.</p>
<div class="cell" data-hash="special_cache/html/special-004_91227814f7cc6ee1a2bdb952a2acbb18">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># PipeOpDistrCompositor - Train one model with a baseline distribution,</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># (Kaplan-Meier or Nelson-Aalen), and another with a predicted linear predictor.</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># remove the factor column for support with glmnet</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"litter"</span>, <span class="st">"rx"</span>))</span>
<span id="cb4-8"><a href="#cb4-8"></a>learner_lp <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.glmnet"</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a>learner_distr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.kaplan"</span>)</span>
<span id="cb4-10"><a href="#cb4-10"></a>prediction_lp <span class="ot">=</span> learner_lp<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb4-11"><a href="#cb4-11"></a>prediction_distr <span class="ot">=</span> learner_distr<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb4-12"><a href="#cb4-12"></a>prediction_lp<span class="sc">$</span>distr</span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co"># Doesn't need training. Base = baseline distribution. ph = Proportional hazards.</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a>pod <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"compose_distr"</span>, <span class="at">form =</span> <span class="st">"ph"</span>, <span class="at">overwrite =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-17"><a href="#cb4-17"></a>prediction <span class="ot">=</span> pod<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(<span class="at">base =</span> prediction_distr, <span class="at">pred =</span> prediction_lp))<span class="sc">$</span>output</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># Now we have a predicted distr!</span></span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>prediction<span class="sc">$</span>distr</span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co"># This can all be simplified by using the distrcompose pipeline</span></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a>glm.distr <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"distrcompositor"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"surv.glmnet"</span>),</span>
<span id="cb4-26"><a href="#cb4-26"></a>  <span class="at">estimator =</span> <span class="st">"kaplan"</span>, <span class="at">form =</span> <span class="st">"ph"</span>, <span class="at">overwrite =</span> <span class="cn">FALSE</span>, <span class="at">graph_learner =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-27"><a href="#cb4-27"></a>glm.distr<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="benchmark-experiment" class="level3" data-number="8.1.4"><h3 data-number="8.1.4" class="anchored" data-anchor-id="benchmark-experiment">
<span class="header-section-number">8.1.4</span> Benchmark Experiment</h3>
<p>Finally, we conduct a small benchmark study on the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_rats.html"><code>rats</code></a> task using some of the integrated survival learners:</p>
<div class="cell" data-hash="special_cache/html/special-005_85f95249395451040e3dfa10e3cff882">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co"># some integrated learners</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"surv.coxph"</span>, <span class="st">"surv.kaplan"</span>, <span class="st">"surv.ranger"</span>))</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="fu">print</span>(learners)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$surv.coxph
&lt;LearnerSurvCoxPH:surv.coxph&gt;: Cox Proportional Hazards
* Model: -
* Parameters: list()
* Packages: mlr3, mlr3proba, survival, distr6
* Predict Types:  crank, [distr], lp
* Feature Types: logical, integer, numeric, factor
* Properties: weights

$surv.kaplan
&lt;LearnerSurvKaplan:surv.kaplan&gt;: Kaplan-Meier Estimator
* Model: -
* Parameters: list()
* Packages: mlr3, mlr3proba, survival, distr6
* Predict Types:  [crank], distr
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: missings

$surv.ranger
&lt;LearnerSurvRanger:surv.ranger&gt;: Random Forest
* Model: -
* Parameters: num.threads=1
* Packages: mlr3, mlr3proba, mlr3extralearners, ranger
* Predict Types:  crank, [distr]
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: importance, oob_error, weights</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Harrell's C-Index for survival</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"surv.cindex"</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">print</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureSurvCindex:surv.cindex&gt;
* Packages: mlr3, mlr3proba
* Range: [0, 1]
* Minimize: FALSE
* Average: macro
* Parameters: weight_meth=I, tiex=0.5, eps=0.001
* Properties: -
* Predict type: crank
* Return type: Score</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)))</span>
<span id="cb9-3"><a href="#cb9-3"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr      resample_result task_id  learner_id resampling_id iters surv.cindex
1:  1 &lt;ResampleResult[21]&gt;    rats  surv.coxph            cv     3   0.7671307
2:  2 &lt;ResampleResult[21]&gt;    rats surv.kaplan            cv     3   0.5000000
3:  3 &lt;ResampleResult[21]&gt;    rats surv.ranger            cv     3   0.7799153</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-005-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The experiment indicates that both the Cox PH and the random forest have better discrimination than the Kaplan-Meier baseline estimator, but that the machine learning random forest is not consistently better than the interpretable Cox PH.</p>
</section></section><section id="density" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="density">
<span class="header-section-number">8.2</span> Density Estimation</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Survival analysis with {mlr3proba} is currently in a fragile state after its removal from CRAN. Hence most code examples listed in this page will not work for the time being. We are actively working on a solution!</p>
</div>
</div>
<p>Density estimation is the learning task to find the unknown distribution from which an i.i.d. data set is generated. We interpret this broadly, with this distribution not necessarily being continuous (so may possess a mass not density). The conditional case, where a distribution is predicted conditional on covariates, is known as ‘probabilistic supervised regression’, and will be implemented in <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a> in the near-future. Unconditional density estimation is viewed as an unsupervised task. For a good overview to density estimation see <em>Density estimation for statistics and data analysis</em> <span class="citation" data-cites="Silverman1986">(<a href="references.html#ref-Silverman1986" role="doc-biblioref">Silverman 1986</a>)</span>.</p>
<p>The package <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a> extends <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> with the following objects for density estimation:</p>
<ul>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> to define density tasks</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerDens.html"><code>LearnerDens</code></a> as base class for density estimators</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/PredictionDens.html"><code>PredictionDens</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/MeasureDens.html"><code>MeasureDens</code></a> as specialized class for performance measures</li>
</ul>
<p>In this example we demonstrate the basic functionality of the package on the <a href="https://www.rdocumentation.org/packages/datasets/topics/faithful"><code>faithful</code></a> data from the datasets package. This task ships as pre-defined <a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> with <a href="https://mlr3proba.mlr-org.com"><code>mlr3proba</code></a>.</p>
<div class="cell" data-hash="special_cache/html/special-007_3dc28e937fa588310e43e059cab4ddb3">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">library</span>(<span class="st">"mlr3proba"</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"precip"</span>)</span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="fu">print</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskDens:precip&gt; (70 x 1): Annual Precipitation
* Target: -
* Properties: -
* Features (1):
  - dbl (1): precip</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># histogram and density plot</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">library</span>(<span class="st">"mlr3viz"</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co"># </span><span class="al">FIXME</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co"># autoplot(task, type = "overlay")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unconditional density estimation is an unsupervised method. Hence, <a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> is an unsupervised task which inherits directly from <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> unlike <a href="https://mlr3.mlr-org.com/reference/TaskClassif.html"><code>TaskClassif</code></a> and <a href="https://mlr3.mlr-org.com/reference/TaskRegr.html"><code>TaskRegr</code></a>. However, <a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> still has a <code>target</code> argument and a <code>$truth</code> field defined by:</p>
<ul>
<li>
<code>target</code> - the name of the variable in the data for which to estimate density</li>
<li>
<code>$truth</code> - the values of the <code>target</code> column (which is <em>not</em> the true density, which is always unknown)</li>
</ul>
<section id="train-and-predict" class="level3" data-number="8.2.1"><h3 data-number="8.2.1" class="anchored" data-anchor-id="train-and-predict">
<span class="header-section-number">8.2.1</span> Train and Predict</h3>
<p>Density learners have <code>train</code> and <code>predict</code> methods, though being unsupervised, ‘prediction’ is actually ‘estimation’. In training, a <a href="https://cran.r-project.org/package=distr6"><code>distr6</code></a> object is created, <a href="https://alan-turing-institute.github.io/distr6/">see here</a> for full tutorials on how to access the probability density function, <code>pdf</code>, cumulative distribution function, <code>cdf</code>, and other important fields and methods. The predict method is simply a wrapper around <code>self$model$pdf</code> and if available <code>self$model$cdf</code>, i.e.&nbsp;evaluates the pdf/cdf at given points. Note that in prediction the points to evaluate the pdf and cdf are determined by the <code>target</code> column in the <a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> object used for testing.</p>
<div class="cell" data-hash="special_cache/html/special-008_8e2761037173f33c98dad2f4b3c1766a">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># create task and learner</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>task_faithful <span class="ot">=</span> TaskDens<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"eruptions"</span>, <span class="at">backend =</span> datasets<span class="sc">::</span>faithful<span class="sc">$</span>eruptions)</span>
<span id="cb15-4"><a href="#cb15-4"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"dens.hist"</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co"># train/test split</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>train_set <span class="ot">=</span> <span class="fu">sample</span>(task_faithful<span class="sc">$</span>nrow, <span class="fl">0.8</span> <span class="sc">*</span> task_faithful<span class="sc">$</span>nrow)</span>
<span id="cb15-8"><a href="#cb15-8"></a>test_set <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task_faithful<span class="sc">$</span>nrow), train_set)</span>
<span id="cb15-9"><a href="#cb15-9"></a></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co"># fitting KDE and model inspection</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>learner<span class="sc">$</span><span class="fu">train</span>(task_faithful, <span class="at">row_ids =</span> train_set)</span>
<span id="cb15-12"><a href="#cb15-12"></a>learner<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$distr
Histogram() 

$hist
$breaks
[1] 1.5 2.0 2.5 3.0 3.5 4.0 4.5 5.0 5.5

$counts
[1] 39 30  5  4 25 62 49  3

$density
[1] 0.35944700 0.27649770 0.04608295 0.03686636 0.23041475 0.57142857 0.45161290
[8] 0.02764977

$mids
[1] 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25

$xname
[1] "dat"

$equidist
[1] TRUE

attr(,"class")
[1] "histogram"

attr(,"class")
[1] "dens.hist"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">class</span>(learner<span class="sc">$</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "dens.hist"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># make predictions for new data</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task_faithful, <span class="at">row_ids =</span> test_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Every <a href="https://mlr3proba.mlr-org.com/reference/PredictionDens.html"><code>PredictionDens</code></a> object can estimate:</p>
<ul>
<li>
<code>pdf</code> - probability density function</li>
</ul>
<p>Some learners can estimate:</p>
<ul>
<li>
<code>cdf</code> - cumulative distribution function</li>
</ul></section><section id="benchmark-experiment-1" class="level3" data-number="8.2.2"><h3 data-number="8.2.2" class="anchored" data-anchor-id="benchmark-experiment-1">
<span class="header-section-number">8.2.2</span> Benchmark Experiment</h3>
<p>Finally, we conduct a small benchmark study on the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_precip.html"><code>precip</code></a> task using some of the integrated survival learners:</p>
<div class="cell" data-hash="special_cache/html/special-009_2982ee09244b7618c34ee624077a5671">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># some integrated learners</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"dens.hist"</span>, <span class="st">"dens.kde"</span>))</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="fu">print</span>(learners)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dens.hist
&lt;LearnerDensHistogram:dens.hist&gt;: Histogram Density Estimator
* Model: -
* Parameters: list()
* Packages: mlr3, mlr3proba, distr6
* Predict Types:  [pdf], cdf, distr
* Feature Types: integer, numeric
* Properties: -

$dens.kde
&lt;LearnerDensKDE:dens.kde&gt;: Kernel Density Estimator
* Model: -
* Parameters: kernel=Epan, bandwidth=silver
* Packages: mlr3, mlr3proba, distr6
* Predict Types:  [pdf], distr
* Feature Types: integer, numeric
* Properties: missings</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Logloss for probabilistic predictions</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"dens.logloss"</span>)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">print</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureDensLogloss:dens.logloss&gt;: Log Loss
* Packages: mlr3, mlr3proba
* Range: [0, Inf]
* Minimize: TRUE
* Average: macro
* Parameters: eps=1e-15
* Properties: -
* Predict type: pdf</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)))</span>
<span id="cb24-3"><a href="#cb24-3"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr      resample_result task_id learner_id resampling_id iters dens.logloss
1:  1 &lt;ResampleResult[21]&gt;  precip  dens.hist            cv     3     4.396138
2:  2 &lt;ResampleResult[21]&gt;  precip   dens.kde            cv     3     4.817715</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-009-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The results of this experiment show that the sophisticated Penalized Density Estimator does not outperform the baseline histogram, but that the Kernel Density Estimator has at least consistently better (i.e.&nbsp;lower logloss) results.</p>
</section></section><section id="spatiotemporal" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="spatiotemporal">
<span class="header-section-number">8.3</span> Spatiotemporal Analysis</h2>
<p>Data observations may entail reference information about spatial or temporal characteristics. Spatial information is stored as coordinates, usually named “x” and “y” or “lat”/“lon”. Treating spatiotemporal data using non-spatial data methods can lead to over-optimistic performance estimates. Hence, methods specifically designed to account for the special nature of spatiotemporal data are needed.</p>
<p>In the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> framework, the following packages relate to this field:</p>
<ul>
<li>
<a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> (biased-reduced performance estimation)</li>
<li>
<a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a> (spatial prediction support)</li>
</ul>
<p>The following (sub-)sections introduce the potential pitfalls of spatiotemporal data in machine learning and how to account for it. Note that not all functionality will be covered, and that some of the used packages are still in early lifecycles. If you want to contribute to one of the packages mentioned above, please contact <a href="https://github.com/pat-s">Patrick Schratz</a>.</p>
<section id="spatial-task" class="level3" data-number="8.3.1"><h3 data-number="8.3.1" class="anchored" data-anchor-id="spatial-task">
<span class="header-section-number">8.3.1</span> Creating a spatial Task</h3>
<p>To make use of spatial resampling methods, a {mlr3} task that is aware of its spatial characteristic needs to be created. Two <code>Task</code> child classes exist in {mlr3spatiotempcv} for this purpose:</p>
<ul>
<li><code>TaskClassifST</code></li>
<li><code>TaskRegrST</code></li>
</ul>
<p>To create one of these, you have multiple options:</p>
<ol type="1">
<li>Use the constructor of the <code>Task</code> directly via <code>$new()</code> - this only works for data.table backends (!)</li>
<li>Use the <code>as_task_*</code> converters (e.g.&nbsp;if your data is stored in an <code>sf</code> object)</li>
</ol>
<p>We recommend the latter, as the <code>as_task_*</code> converters aim to make task construction easier, e.g., by creating the <code>DataBackend</code> (which is required to create a Task in {mlr3}) automatically and setting the <code>crs</code> and <code>coordinate_names</code> fields. Let’s assume your (point) data is stored in with an <code>sf</code> object, which is a common scenario for spatial analysis in R.</p>
<div class="cell" data-hash="special_cache/html/special-011_cc7313057c9f24d7b8b17d47ccf6ed31">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># create 'sf' object</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>data_sf <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(ecuador, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="dv">32717</span>)</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co"># create `TaskClassifST` from `sf` object</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>task <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(data_sf, <span class="at">id =</span> <span class="st">"ecuador_task"</span>, <span class="at">target =</span> <span class="st">"slides"</span>, <span class="at">positive =</span> <span class="st">"TRUE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also use a plain <code>data.frame</code>. In this case, <code>crs</code> and <code>coordinate_names</code> need to be passed along explicitly as they cannot be inferred directly from the <code>sf</code> object:</p>
<div class="cell" data-hash="special_cache/html/special-012_1c95d9b7ae37944ec7eb6cd581ee0158">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(ecuador, <span class="at">id =</span> <span class="st">"ecuador_task"</span>, <span class="at">target =</span> <span class="st">"slides"</span>,</span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="at">positive =</span> <span class="st">"TRUE"</span>, <span class="at">coordinate_names =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="dv">32717</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>*ST</code> task family prints a subset of the coordinates by default:</p>
<div class="cell" data-hash="special_cache/html/special-013_34c5b0842e7ba9c84cfcfff1aaf181db">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">print</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassifST:ecuador_task&gt; (751 x 11)
* Target: slides
* Properties: twoclass
* Features (10):
  - dbl (10): carea, cslope, dem, distdeforest, distroad,
    distslidespast, hcurv, log.carea, slope, vcurv
* Coordinates:
            x       y
  1: 712882.5 9560002
  2: 715232.5 9559582
  3: 715392.5 9560172
  4: 715042.5 9559312
  5: 715382.5 9560142
 ---                 
747: 714472.5 9558482
748: 713142.5 9560992
749: 713322.5 9560562
750: 715392.5 9557932
751: 713802.5 9560862</code></pre>
</div>
</div>
<p>All <code>*ST</code> tasks can be treated as their super class equivalents <code>TaskClassif</code> or <code>TaskRegr</code> in subsequent {mlr3} modeling steps.</p>
</section><section id="autocorrelation" class="level3" data-number="8.3.2"><h3 data-number="8.3.2" class="anchored" data-anchor-id="autocorrelation">
<span class="header-section-number">8.3.2</span> Autocorrelation</h3>
<p>Data which includes spatial or temporal information requires special treatment in machine learning (similar to <a href="#survival">survival</a>, <a href="#ordinal">ordinal</a> and other task types listed in the <a href="#special-tasks">special tasks</a> chapter). In contrast to non-spatial/non-temporal data, observations inherit a natural grouping, either in space or time or in both space and time <span class="citation" data-cites="legendre1993">(<a href="references.html#ref-legendre1993" role="doc-biblioref">Legendre 1993</a>)</span>. This grouping causes observations to be autocorrelated, either in space (spatial autocorrelation (SAC)), time (temporal autocorrelation (TAC)) or both space and time (spatiotemporal autocorrelation (STAC)). For simplicity, the acronym STAC is used as a generic term in the following chapter for all the different characteristics introduced above.</p>
<p><em>What effects does STAC have in statistical/machine learning?</em></p>
<p>The overarching problem is that STAC violates the assumption that the observations in the train and test datasets are independent <span class="citation" data-cites="hastie2001">(<a href="references.html#ref-hastie2001" role="doc-biblioref">Hastie, Friedman, and Tibshirani 2001</a>)</span>. If this assumption is violated, the reliability of the resulting performance estimates, for example retrieved via cross-validation, is decreased. The magnitude of this decrease is linked to the magnitude of STAC in the dataset, which cannot be determined easily.</p>
<p>One approach to account for the existence of STAC is to use dedicated resampling methods. <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> provides access to the most frequently used spatiotemporal resampling methods. The following example showcases how a spatial dataset can be used to retrieve a bias-reduced performance estimate of a learner.</p>
<p>The following examples use the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_tasks_ecuador.html"><code>ecuador</code></a> dataset created by <a href="https://scholar.google.com/citations?user=Slq94Y4AAAAJ&amp;hl=de&amp;authuser=1&amp;oi=ao">Jannes Muenchow</a>. It contains information on the occurrence of landslides (binary) in the Andes of Southern Ecuador. The landslides were mapped from aerial photos taken in 2000. The dataset is well suited to serve as an example because it it relatively small and of course due to the spatial nature of the observations. Please refer to <span class="citation" data-cites="muenchow2012">Muenchow, Brenning, and Richter (<a href="references.html#ref-muenchow2012" role="doc-biblioref">2012</a>)</span> for a detailed description of the dataset.</p>
<p>To account for the spatial autocorrelation probably present in the landslide data, we will make use one of the most used spatial partitioning methods, a cluster-based k-means grouping <span class="citation" data-cites="brenning2012">(<a href="references.html#ref-brenning2012" role="doc-biblioref">Brenning 2012</a>)</span>, (<a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_spcv_coords.html"><code>spcv_coords</code></a> in <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a>). This method performs a clustering in 2D space which contrasts with the commonly used random partitioning for non-spatial data. The grouping has the effect that train and test data are more separated in space as they would be by conducting a random partitioning, thereby reducing the effect of STAC.</p>
<p>By contrast, when using the classical random partitioning approach with spatial data, train and test observations would be located side-by-side across the full study area (a visual example is provided further below). This leads to a high similarity between train and test sets, resulting in “better” but biased performance estimates in every fold of a CV compared to the spatial CV approach. However, these low error rates are mainly caused due to the STAC in the observations and the lack of appropriate partitioning methods and not by the power of the fitted model.</p>
</section><section id="spatiotemp-cv" class="level3" data-number="8.3.3"><h3 data-number="8.3.3" class="anchored" data-anchor-id="spatiotemp-cv">
<span class="header-section-number">8.3.3</span> Spatiotemporal Cross-Validation and Partitioning</h3>
<p>One part of spatiotemporal machine learning is dealing with the spatiotemporal components of the data during performance estimation. Performance is commonly estimated via cross-validation and <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> provides specialized resamplings methods for spatiotemporal data. The following chapters showcases how these methods can be applied and how they differ compared to non-spatial resampling methods, e.g.&nbsp;random partitioning. In addition, examples which show how resamplings with spatial information can be visualized using <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a>.</p>
<p>Besides performance estimation, prediction on spatiotemporal data is another challenging task. See <a href="#sec-spatial-prediction"><span>Section&nbsp;8.3.6</span></a> for more information about how this topic is handled within the mlr3 framework.</p>
<section id="sp-vs-nsp-cv" class="level4" data-number="8.3.3.1"><h4 data-number="8.3.3.1" class="anchored" data-anchor-id="sp-vs-nsp-cv">
<span class="header-section-number">8.3.3.1</span> Spatial CV vs.&nbsp;Non-Spatial CV</h4>
<p>In the following a spatial and non-spatial CV will be applied to showcase the mentioned performance differences.</p>
<p>The performance of a simple classification tree (<code>"classif.rpart"</code>) is evaluated on a random partitioning (<a href="https://mlr3.mlr-org.com/reference/mlr_resamplings_repeated_cv.html"><code>repeated_cv</code></a>) with four folds and two repetitions. The chosen evaluation measure is “classification error” (<code>"classif.ce"</code>).</p>
<p>For the spatial example, <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_repeated_spcv_coords.html"><code>repeated_spcv_coords</code></a> is chosen whereas <a href="https://mlr3.mlr-org.com/reference/mlr_resamplings_repeated_cv.html"><code>repeated_cv</code></a> represents the non-spatial example.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The selection of <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_repeated_spcv_coords.html"><code>repeated_spcv_coords</code></a> in this example is arbitrary. For your use case, you might want to use a different spatial partitioning method (but not necessarily!). Have a look at the <a href="https://mlr3spatiotempcv.mlr-org.com/dev/articles/mlr3spatiotempcv.html#resampling-methods">“Getting Started”</a> vignette of <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> to see all available methods and choose one which <strong>fits your data and its prediction purpose</strong>.</p>
</div>
</div>
<section id="nsp-cv" class="level5" data-number="8.3.3.1.1"><h5 data-number="8.3.3.1.1" class="anchored" data-anchor-id="nsp-cv">
<span class="header-section-number">8.3.3.1.1</span> Non-Spatial CV</h5>
<p>In this example the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_tasks_ecuador.html"><code>ecuador</code></a> example task is taken to estimate the performance of an <code>rpart</code> learner with fixed parameters on it.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>In practice you usually might want to tune the hyperparameters of the learner in this case and apply a nested CV in which the inner loop is used for hyperparameter tuning.</p>
</div>
</div>
<div class="cell" data-hash="special_cache/html/special-014_31a18281c703b63e837baf7286a0181a">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="fu">library</span>(<span class="st">"mlr3spatiotempcv"</span>)</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb31-4"><a href="#cb31-4"></a></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="co"># be less verbose</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb31-7"><a href="#cb31-7"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">maxdepth =</span> <span class="dv">3</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb31-12"><a href="#cb31-12"></a>resampling_nsp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>, <span class="at">repeats =</span> <span class="dv">2</span>)</span>
<span id="cb31-13"><a href="#cb31-13"></a>rr_nsp <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb31-14"><a href="#cb31-14"></a>  <span class="at">task =</span> task, <span class="at">learner =</span> learner,</span>
<span id="cb31-15"><a href="#cb31-15"></a>  <span class="at">resampling =</span> resampling_nsp)</span>
<span id="cb31-16"><a href="#cb31-16"></a></span>
<span id="cb31-17"><a href="#cb31-17"></a>rr_nsp<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
 0.3388575 </code></pre>
</div>
</div>
</section><section id="sp-cv" class="level5" data-number="8.3.3.1.2"><h5 data-number="8.3.3.1.2" class="anchored" data-anchor-id="sp-cv">
<span class="header-section-number">8.3.3.1.2</span> Spatial CV</h5>
<div class="cell" data-hash="special_cache/html/special-015_e639dabb808f30730445ed8e3584ef54">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">maxdepth =</span> <span class="dv">3</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb33-4"><a href="#cb33-4"></a>resampling_sp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_spcv_coords"</span>, <span class="at">folds =</span> <span class="dv">4</span>, <span class="at">repeats =</span> <span class="dv">2</span>)</span>
<span id="cb33-5"><a href="#cb33-5"></a>rr_sp <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="at">task =</span> task, <span class="at">learner =</span> learner,</span>
<span id="cb33-7"><a href="#cb33-7"></a>  <span class="at">resampling =</span> resampling_sp)</span>
<span id="cb33-8"><a href="#cb33-8"></a></span>
<span id="cb33-9"><a href="#cb33-9"></a>rr_sp<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
  0.412529 </code></pre>
</div>
</div>
<p>Here, the performance of the classification tree learner is around 7 percentage points worse when using Spatial Cross-Validation (SpCV) compared to Non-Spatial Cross-Validation (NSpCV). The resulting difference in performance is variable as it depends on the dataset, the magnitude of STAC and the learner itself. For algorithms with a higher tendency of overfitting to the training set, the difference between the two methods will be larger.</p>
<p>Now, what does it mean that the performance in the spatial case is worse? Should you ditch SpCV and keep using non-spatial partitioning? The answer is <strong>NO</strong>. The reason why the spatial partitioning scenario results in a lower predictive performance is because throughout the CV the model has been trained on data that is less similar than the test data compared against the non-spatial scenario. Or in other words: in the non-spatial scenario, train and test data are almost identical (due to spatial autocorrelation).</p>
<p>This means that the result from the SpCV setting is more close to the true predictive power of the model - whereas the result from non-spatial CV is overoptimistic and biased.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The result of the SpCV setting is by no means the absolute truth - it is also biased, but (most often) less compared to the non-spatial setting.</p>
</div>
</div>
</section></section></section><section id="vis-spt-partitions" class="level3" data-number="8.3.4"><h3 data-number="8.3.4" class="anchored" data-anchor-id="vis-spt-partitions">
<span class="header-section-number">8.3.4</span> Visualization of Spatiotemporal Partitions</h3>
<p>Every partitioning method in <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> comes with S3 methods for <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> and <code>autoplot()</code> to visualize the created groups. In a 2D space <a href="https://cran.r-project.org/package=ggplot2"><code>ggplot2</code></a> is used in the backgroudn while for spatiotemporal methods 3D visualizations via <a href="https://cran.r-project.org/package=plotly"><code>plotly</code></a> are created.</p>
<p>The following examples shows how the <code>resampling_sp</code> object from the previous example can be visualized. In this case I want to look at the first four partitions of the first repetition. The point size is adjusted via argument <code>size</code>. After the plot creation, additional <code>scale_*</code> calls are used to adjust the coordinate labels on the x and y axes, respectively.</p>
<div class="cell" data-fig.asp="0.8" data-hash="special_cache/html/special-016_bc8d1953c20927759a282e79bcc2f458">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">autoplot</span>(resampling_sp, task, <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">*</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">3.97</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">0.01</span>)) <span class="sc">*</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.06</span>, <span class="sc">-</span><span class="fl">79.08</span>, <span class="sc">-</span><span class="fl">0.02</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-016-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that setting the correct CRS for the given data is important which is done <strong>during task creation</strong>. Spatial offsets of up to multiple meters may occur if the wrong CRS is supplied initially.</p>
</div>
</div>
<p>This example used a built-in mlr3 task via <a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html"><code>tsk()</code></a>. In practice however, one needs to create a spatiotemporal task via <a href="https://mlr3spatiotempcv.mlr-org.com/reference/TaskClassifST.html"><code>TaskClassifST</code></a>/<a href="https://mlr3spatiotempcv.mlr-org.com/reference/TaskRegrST.html"><code>TaskRegrST</code></a> and set the <code>crs</code> argument (unless a <code>sf</code> object is handed over).</p>
<p><a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> can also visualize non-spatial partitonings. This helps to visually compare differences. Let’s use the objects from the previous example again, this time <code>resampling_nsp</code>.</p>
<div class="cell" data-fig.asp="0.8" data-hash="special_cache/html/special-017_ba6e48c62a46d1b6016543a3cf642029">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">autoplot</span>(resampling_nsp, task, <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">*</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">3.97</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">0.01</span>)) <span class="sc">*</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.06</span>, <span class="sc">-</span><span class="fl">79.08</span>, <span class="sc">-</span><span class="fl">0.02</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-017-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The visualization show very well how close train and test observations are located next to each other.</p>
<section id="vis-spatial-block" class="level4" data-number="8.3.4.1"><h4 data-number="8.3.4.1" class="anchored" data-anchor-id="vis-spatial-block">
<span class="header-section-number">8.3.4.1</span> Spatial Block Visualization</h4>
<p>This examples showcases another SpCV method: <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_spcv_block.html"><code>spcv_block</code></a>. This method makes use of rectangular blocks to divide the study area into equally-sized parts. {mlr3spatiotempcv} has support for visualizing the created blocks and displaying their respective fold ID to get a better understanding how the final folds were composed out of the partitions. E.g. the “Fold 1 Repetition 1” plot shows that the test set is composed out of two “blocks” with the ID “1” in this case.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The use of <code>range = 1000L</code> is arbitrary here and should not be copy-pasted into a real application.</p>
</div>
</div>
<div class="cell" data-hash="special_cache/html/special-018_60922eec0e5057466248b88fec6bb8aa">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"spcv_block"</span>, <span class="at">range =</span> 1000L)</span>
<span id="cb37-3"><a href="#cb37-3"></a></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="co"># Visualize train/test splits of multiple folds</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="fu">autoplot</span>(resampling, task, <span class="at">size =</span> <span class="fl">0.7</span>,</span>
<span id="cb37-6"><a href="#cb37-6"></a>  <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">show_blocks =</span> <span class="cn">TRUE</span>, <span class="at">show_labels =</span> <span class="cn">TRUE</span>) <span class="sc">*</span></span>
<span id="cb37-7"><a href="#cb37-7"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.085</span>, <span class="sc">-</span><span class="fl">79.055</span>, <span class="fl">0.02</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-018-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="vis-spatiotemp" class="level4" data-number="8.3.4.2"><h4 data-number="8.3.4.2" class="anchored" data-anchor-id="vis-spatiotemp">
<span class="header-section-number">8.3.4.2</span> Spatiotemporal Visualization</h4>
<p>When going spatiotemporal, two dimensions are not enough anymore. To visualize space and time together, a 3D solution is needed. {mlr3spatiotempcv} makes use of <a href="https://cran.r-project.org/package=plotly"><code>plotly</code></a> for this purpose.</p>
<p>The following examples uses a modified version of the <code>cookfarm_mlr3</code> task for showcasing reasons. By adjusting some levels, the individual partitions can be recognized very well.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>In practice, you should not modify your data to achieve “good looking” visualizations as done in this example. This is only done for (visual) demonstration purposes.</p>
</div>
</div>
<p>In the following we use the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_sptcv_cstf.html"><code>sptcv_cstf</code></a> method after <span class="citation" data-cites="meyer2018">Meyer et al. (<a href="references.html#ref-meyer2018" role="doc-biblioref">2018</a>)</span>. Only the temporal variable is used in this first example, denoted by setting the column role “time” to variable “Date”. This column role is then picked up by the resampling method. Last, <code>autoplot()</code> is called with an explicit definition of <code>plot3D = TRUE</code>. This is because <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_sptcv_cstf.html"><code>sptcv_cstf</code></a> can also be visualized in 2D (which only makes sense if the “space” column role is used for partitioning).</p>
<p>Last, <code>sample_fold_n</code> is used to take a stratified random sample from all partitions. The call to <a href="https://www.rdocumentation.org/packages/plotly/topics/layout"><code>plotly::layout()</code></a> only adjusts the default viewing angle of the plot - in interactive visualizations, this is not needed and the viewing angle can be adjusted with the mouse.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is done to reduce the final plot size and keep things small for demos like this one. We don’t recommend doing this in actual studies - unless you prominently communicate this alongside the resulting plot.</p>
</div>
</div>
<div class="cell" data-hash="special_cache/html/special-019_e021d8cd96cf09886270a1bdeee9c4bf">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>data <span class="ot">=</span> cookfarm_mlr3</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb38-3"><a href="#cb38-3"></a>data<span class="sc">$</span>Date <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="fu">c</span>(</span>
<span id="cb38-4"><a href="#cb38-4"></a>  <span class="st">"2020-01-01"</span>, <span class="st">"2020-02-01"</span>, <span class="st">"2020-03-01"</span>, <span class="st">"2020-04-01"</span>,</span>
<span id="cb38-5"><a href="#cb38-5"></a>  <span class="st">"2020-05-01"</span>), <span class="at">times =</span> <span class="dv">1</span>, <span class="at">each =</span> <span class="dv">35768</span>))</span>
<span id="cb38-6"><a href="#cb38-6"></a>task_spt <span class="ot">=</span> <span class="fu">as_task_regr_st</span>(data,</span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="at">id =</span> <span class="st">"cookfarm"</span>, <span class="at">target =</span> <span class="st">"PHIHOX"</span>,</span>
<span id="cb38-8"><a href="#cb38-8"></a>  <span class="at">coordinate_names =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">coords_as_features =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-9"><a href="#cb38-9"></a>  <span class="at">crs =</span> <span class="dv">26911</span>)</span>
<span id="cb38-10"><a href="#cb38-10"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"Date"</span>, <span class="at">roles =</span> <span class="st">"time"</span>)</span>
<span id="cb38-11"><a href="#cb38-11"></a></span>
<span id="cb38-12"><a href="#cb38-12"></a>rsmp_cstf_time <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"sptcv_cstf"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb38-13"><a href="#cb38-13"></a></span>
<span id="cb38-14"><a href="#cb38-14"></a>plot <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_time,</span>
<span id="cb38-15"><a href="#cb38-15"></a>  <span class="at">fold_id =</span> <span class="dv">5</span>, <span class="at">task =</span> task_spt, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-16"><a href="#cb38-16"></a>  <span class="at">sample_fold_n =</span> 3000L</span>
<span id="cb38-17"><a href="#cb38-17"></a>)</span>
<span id="cb38-18"><a href="#cb38-18"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(plot, <span class="at">scene =</span> <span class="fu">list</span>(<span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If both space and time are used for partitioning in <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_sptcv_cstf.html"><code>sptcv_cstf</code></a>, the visualization becomes even more powerful as it allows to also show the observations which are omitted, i.e., not being used in either train and test sets for a specific fold.</p>
<div class="cell" data-hash="special_cache/html/special-020_c05b4b647be4a7994dbfd591b30523f2">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"SOURCEID"</span>, <span class="at">roles =</span> <span class="st">"space"</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"Date"</span>, <span class="at">roles =</span> <span class="st">"time"</span>)</span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a>rsmp_cstf_space_time <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"sptcv_cstf"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb39-5"><a href="#cb39-5"></a></span>
<span id="cb39-6"><a href="#cb39-6"></a>plot <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_space_time,</span>
<span id="cb39-7"><a href="#cb39-7"></a>  <span class="at">fold_id =</span> <span class="dv">4</span>, <span class="at">task =</span> task_spt, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb39-8"><a href="#cb39-8"></a>  <span class="at">show_omitted =</span> <span class="cn">TRUE</span>, <span class="at">sample_fold_n =</span> 3000L)</span>
<span id="cb39-9"><a href="#cb39-9"></a></span>
<span id="cb39-10"><a href="#cb39-10"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(plot, <span class="at">scene =</span> <span class="fu">list</span>(<span class="at">camera =</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Combining multiple spatiotemporal plots with <a href="https://www.rdocumentation.org/packages/plotly/topics/layout"><code>plotly::layout()</code></a> is possible but somewhat cumbersome. First, a list of plots containing the individuals plots must be created. These plots can then be passed to <a href="https://www.rdocumentation.org/packages/plotly/topics/subplot"><code>plotly::subplot()</code></a>. This return is then passed to <a href="https://www.rdocumentation.org/packages/plotly/topics/layout"><code>plotly::layout()</code></a>.</p>
<div class="cell" data-hash="special_cache/html/special-021_a88d778eddbf92b95a61368a260c25fb">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>pl <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_space_time, <span class="at">task =</span> task_spt,</span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), <span class="at">point_size =</span> <span class="dv">3</span>,</span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="at">axis_label_fontsize =</span> <span class="dv">10</span>, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="at">sample_fold_n =</span> 3000L, <span class="at">show_omitted =</span> <span class="cn">TRUE</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>)</span>
<span id="cb40-6"><a href="#cb40-6"></a></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="co"># Warnings can be ignored</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>pl_subplot <span class="ot">=</span> plotly<span class="sc">::</span><span class="fu">subplot</span>(pl)</span>
<span id="cb40-9"><a href="#cb40-9"></a></span>
<span id="cb40-10"><a href="#cb40-10"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(pl_subplot,</span>
<span id="cb40-11"><a href="#cb40-11"></a>  <span class="at">title =</span> <span class="st">"Individual Folds"</span>,</span>
<span id="cb40-12"><a href="#cb40-12"></a>  <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb40-13"><a href="#cb40-13"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)),</span>
<span id="cb40-14"><a href="#cb40-14"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb40-15"><a href="#cb40-15"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.20</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb40-16"><a href="#cb40-16"></a>  ),</span>
<span id="cb40-17"><a href="#cb40-17"></a>  <span class="at">scene2 =</span> <span class="fu">list</span>(</span>
<span id="cb40-18"><a href="#cb40-18"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)),</span>
<span id="cb40-19"><a href="#cb40-19"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb40-20"><a href="#cb40-20"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.1</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb40-21"><a href="#cb40-21"></a>  ),</span>
<span id="cb40-22"><a href="#cb40-22"></a>  <span class="at">scene3 =</span> <span class="fu">list</span>(</span>
<span id="cb40-23"><a href="#cb40-23"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb40-24"><a href="#cb40-24"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb40-25"><a href="#cb40-25"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.1</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb40-26"><a href="#cb40-26"></a>  ),</span>
<span id="cb40-27"><a href="#cb40-27"></a>  <span class="at">scene4 =</span> <span class="fu">list</span>(</span>
<span id="cb40-28"><a href="#cb40-28"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb40-29"><a href="#cb40-29"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb40-30"><a href="#cb40-30"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb40-31"><a href="#cb40-31"></a>  )</span>
<span id="cb40-32"><a href="#cb40-32"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately, titles in subplots cannot be created dynamically. However, there is a manual workaround via annotations show in <a href="https://rpubs.com/bcd/subplot-titles">this RPubs post</a>.</p>
</section></section><section id="choose-spt-rsmp" class="level3" data-number="8.3.5"><h3 data-number="8.3.5" class="anchored" data-anchor-id="choose-spt-rsmp">
<span class="header-section-number">8.3.5</span> Choosing a Resampling Method</h3>
<p>While the example in this section made use of the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_resamplings_spcv_coords.html"><code>spcv_coords</code></a> method, this should by no means infer that this method is the best or only method suitable for this task. Even though this method is quite popular, it was mainly chosen because of the clear visual grouping differences when being applied on the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_tasks_ecuador.html"><code>ecuador</code></a> task when compared to random partitioning.</p>
<p>In fact, most often multiple spatial partitioning methods can be used for a dataset. It is recommended (required) that users familiarize themselves with each implemented method and decide which method to choose based on the specific characteristics of the dataset. For almost all methods implemented in <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a>, there is a scientific publication describing the strengths and weaknesses of the respective approach (either linked in the help file of <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> or its respective dependency packages).</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the example above, a cross-validation without hyperparameter tuning was shown. If a nested CV is desired, it is recommended to use the same spatial partitioning method for the inner loop (= tuning level). See <span class="citation" data-cites="schratz2019">Schratz et al. (<a href="references.html#ref-schratz2019" role="doc-biblioref">2019</a>)</span> for more details and chapter 11 of <a href="https://geocompr.robinlovelace.net/spatial-cv.html">Geocomputation with R</a> <span class="citation" data-cites="lovelace2019">(<a href="references.html#ref-lovelace2019" role="doc-biblioref">Lovelace, Nowosad, and Muenchow 2019</a>)</span>.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A list of all implemented methods in <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a> can be found in the <a href="https://mlr3spatiotempcv.mlr-org.com/articles/mlr3spatiotempcv.html#resampling-methods">Getting Started</a> vignette of the package.</p>
</div>
</div>
<p>If you want to learn even more about the field of spatial partitioning, STAC and the problems associated with it, the works of <a href="https://scholar.google.com/citations?user=9YibxW0AAAAJ&amp;hl=en">Prof.&nbsp;Hanna Meyer</a> and <a href="https://scholar.google.com/citations?hl=en&amp;user=GD5bzTgAAAAJ">Prof.&nbsp;Alexander Brenning</a> are very much recommended for further reference.</p>
</section><section id="sec-spatial-prediction" class="level3" data-number="8.3.6"><h3 data-number="8.3.6" class="anchored" data-anchor-id="sec-spatial-prediction">
<span class="header-section-number">8.3.6</span> Spatial Prediction</h3>
<p>Support for (parallel) spatial prediction with <a href="https://cran.r-project.org/package=terra"><code>terra</code></a>, <a href="https://cran.r-project.org/package=raster"><code>raster</code></a>, <a href="https://cran.r-project.org/package=stars"><code>stars</code></a> and <a href="https://cran.r-project.org/package=sf"><code>sf</code></a> objects is available via <a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a>.</p>
<p><a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a> has two main scopes:</p>
<ul>
<li>Provide DataBackends for spatial objects (vector and raster data)</li>
<li>Simplify spatial prediction tasks</li>
</ul>
<p>Overall it aims to reduce the roundtripping between spatial objects -&gt; data.frame / data.table -&gt; spatial object during modeling.</p>
<section id="spatial-data-backends" class="level4" data-number="8.3.6.1"><h4 data-number="8.3.6.1" class="anchored" data-anchor-id="spatial-data-backends">
<span class="header-section-number">8.3.6.1</span> Spatial Data Backends</h4>
<p>A common scenario is the existence of spatial information in (point) vector data. <a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a> provides <code>as_task_*</code> helpers to directly convert these into a spatiotemporal (ST) task:</p>
<div class="cell" data-hash="special_cache/html/unnamed-chunk-2_12e417f3fdf6aa120310dbe89b71edbb">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="fu">library</span>(mlr3spatial)</span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="fu">library</span>(sf)</span>
<span id="cb41-4"><a href="#cb41-4"></a></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="co"># load sample points</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>leipzig_vector <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>,</span>
<span id="cb41-7"><a href="#cb41-7"></a>  <span class="st">"leipzig_points.gpkg"</span>, <span class="at">package =</span> <span class="st">"mlr3spatial"</span>),</span>
<span id="cb41-8"><a href="#cb41-8"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-9"><a href="#cb41-9"></a></span>
<span id="cb41-10"><a href="#cb41-10"></a><span class="co"># create land cover task</span></span>
<span id="cb41-11"><a href="#cb41-11"></a>tsk_leipzig <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(leipzig_vector, <span class="at">target =</span> <span class="st">"land_cover"</span>)</span>
<span id="cb41-12"><a href="#cb41-12"></a>tsk_leipzig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassifST:leipzig_vector&gt; (97 x 9)
* Target: land_cover
* Properties: multiclass
* Features (8):
  - dbl (8): b02, b03, b04, b06, b07, b08, b11, ndvi
* Coordinates:
           X       Y
 1: 732480.1 5693957
 2: 732217.4 5692769
 3: 732737.2 5692469
 4: 733169.3 5692777
 5: 732202.2 5692644
---                 
93: 733018.7 5692342
94: 732551.4 5692887
95: 732520.4 5692589
96: 732542.2 5692204
97: 732437.8 5692300</code></pre>
</div>
</div>
<p>This saves users from stripping the coordinates from the vector data or transforming the <code>sf</code> object to a <code>data.frame</code> or <code>data.table</code> in the first place.</p>
<p><a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a> adds support for the following spatial data classes:</p>
<ul>
<li>
<code>stars</code> (from package <a href="https://cran.r-project.org/package=stars"><code>stars</code></a>)</li>
<li>
<code>SpatRaster</code> (from package <a href="https://cran.r-project.org/package=terra"><code>terra</code></a>)</li>
<li>
<code>RasterLayer</code> (from package <a href="https://cran.r-project.org/package=raster"><code>raster</code></a>)</li>
<li>
<code>RasterStack</code> (from package <a href="https://cran.r-project.org/package=raster"><code>raster</code></a>)</li>
</ul></section><section id="spatial-prediction" class="level4" data-number="8.3.6.2"><h4 data-number="8.3.6.2" class="anchored" data-anchor-id="spatial-prediction">
<span class="header-section-number">8.3.6.2</span> Spatial prediction</h4>
<p>The goal of spatial prediction is usually a raster image that covers a specific area. Most often this area is quite large and contains millions of pixels. The goal is to predict on each pixel and return a raster image containing these predictions.</p>
<p>To save users from having to go the extra mile of extracting the final model and using it with the respective <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function of the spatial R package of their desired outcome class, <a href="https://mlr3spatial.mlr-org.com"><code>mlr3spatial</code></a> provides <a href="https://mlr3spatial.mlr-org.com/reference/predict_spatial.html"><code>predict_spatial()</code></a>. <a href="https://mlr3spatial.mlr-org.com/reference/predict_spatial.html"><code>predict_spatial()</code></a> let’s users</p>
<ul>
<li>choose the output class of the resulting raster image</li>
<li>optionally predict in parallel via the <a href="https://cran.r-project.org/package=future"><code>future</code></a> package, using a parallel backend of their choice</li>
</ul>
<p>To use a raster image for prediction, it must be wrapped into a <a href="https://mlr3.mlr-org.com/reference/TaskUnsupervised.html"><code>TaskUnsupervised</code></a> for internal <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> reasons. Next, the learner can be used to predict on the task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>leipzig_raster <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"leipzig_raster.tif"</span>,</span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="at">package =</span> <span class="st">"mlr3spatial"</span>))</span>
<span id="cb43-3"><a href="#cb43-3"></a>tsk_predict <span class="ot">=</span> <span class="fu">as_task_unsupervised</span>(leipzig_raster)</span>
<span id="cb43-4"><a href="#cb43-4"></a></span>
<span id="cb43-5"><a href="#cb43-5"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb43-6"><a href="#cb43-6"></a>lrn<span class="sc">$</span><span class="fu">train</span>(tsk_leipzig)</span>
<span id="cb43-7"><a href="#cb43-7"></a></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="co"># plan("multisession") # optional parallelization</span></span>
<span id="cb43-9"><a href="#cb43-9"></a>pred <span class="ot">=</span> <span class="fu">predict_spatial</span>(tsk_predict, lrn, <span class="at">format =</span> <span class="st">"terra"</span>)</span>
<span id="cb43-10"><a href="#cb43-10"></a><span class="fu">class</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SpatRaster"
attr(,"package")
[1] "terra"</code></pre>
</div>
</div>
<p>The resulting object can be visualized and treated as any other <code>terra</code> object. Thanks to the improved handling of factor variables in <a href="https://cran.r-project.org/package=terra"><code>terra</code></a>, the raster image contains the correct labeled classes from the prediction right away.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">library</span>(terra, <span class="at">exclude =</span> <span class="st">"resample"</span>)</span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="fu">plot</span>(pred, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#440154FF"</span>, <span class="st">"#443A83FF"</span>, <span class="st">"#31688EFF"</span>,</span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="st">"#21908CFF"</span>, <span class="st">"#35B779FF"</span>, <span class="st">"#8FD744FF"</span>, <span class="st">"#FDE725FF"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you are interested in the performance of parallel spatial prediction, have a look at the <a href="https://mlr3spatial.mlr-org.com/articles/benchmark.html">Spatial Prediction Benchmark</a> vignette - the resulting plot is shown below.</p>
<div class="callout-warning callout callout-style-simple">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The results of the shown benchmark results should be taken with care as something seems to go wrong when using all-core parallelization with <code><a href="https://rdrr.io/pkg/terra/man/predict.html">terra::predict()</a></code>. Also both relative and absolute numbers will vary on your local machine and results might change depending on eventual package updates in the future.</p>
</div>
</div>
</div>
</section></section></section><section id="cost-sens" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="cost-sens">
<span class="header-section-number">8.4</span> Cost-Sensitive Classification</h2>
<p>In regular classification, the aim is to minimize the misclassification rate, and thus all types of misclassification errors are deemed equally severe. A more general setting is cost-sensitive classification. Cost-sensitive classification does not assume that the costs caused by different kinds of errors are equal. The objective of cost-sensitive classification is to minimize the expected costs.</p>
<p>Imagine you are an analyst for a big credit institution. Let’s also assume that a correct bank decision would result in 35% of the profit at the end of a specific period. A correct decision means that the bank predicts that a customer will pay their bills (hence would obtain a loan), and the customer indeed has good credit. On the other hand, a wrong decision means that the bank predicts that the customer’s credit is in good standing, but the opposite is true. This would result in a loss of 100% of the given loan.</p>
<table class="table">
<colgroup>
<col style="width: 32%">
<col style="width: 34%">
<col style="width: 33%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">Good Customer (truth)</th>
<th style="text-align: center;">Bad Customer (truth)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Good Customer (predicted)</td>
<td style="text-align: center;">+ 0.35</td>
<td style="text-align: center;">- 1.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">Bad Customer (predicted)</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
<p>Expressed as costs (instead of profit), we can write down the cost-matrix as follows:</p>
<div class="cell" data-hash="special_cache/html/special-022_5a7396b29581a6815895690d5b70a8c2">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>costs <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.35</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="fu">dimnames</span>(costs) <span class="ot">=</span> <span class="fu">list</span>(<span class="at">response =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>), <span class="at">truth =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>))</span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="fu">print</span>(costs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response  good bad
    good -0.35   1
    bad   0.00   0</code></pre>
</div>
</div>
<p>An exemplary data set for such a problem is the <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_german_credit.html"><code>German Credit</code></a> task:</p>
<div class="cell" data-hash="special_cache/html/special-023_d234dd88c2a7c44e7964a7f7868d15f4">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">library</span>(<span class="st">"mlr3verse"</span>)</span>
<span id="cb48-2"><a href="#cb48-2"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="fu">table</span>(task<span class="sc">$</span><span class="fu">truth</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
good  bad 
 700  300 </code></pre>
</div>
</div>
<p>The data has 70% of customers who can pay back their credit and 30% of bad customers who default on their debt. A manager, who doesn’t have any model, could decide to give either everybody credit or to give nobody credit. The resulting costs for the German credit data are:</p>
<div class="cell" data-hash="special_cache/html/special-024_07bd03f78102b357953f45f5d8d90d27">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># nobody:</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>(<span class="dv">700</span> <span class="sc">*</span> costs[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">300</span> <span class="sc">*</span> costs[<span class="dv">2</span>, <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># everybody</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>(<span class="dv">700</span> <span class="sc">*</span> costs[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">300</span> <span class="sc">*</span> costs[<span class="dv">1</span>, <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.055</code></pre>
</div>
</div>
<p>If the average loan is $20,000, the credit institute will lose more than one million dollars if it would grant everybody a credit:</p>
<div class="cell" data-hash="special_cache/html/special-025_eda217879bf5988a236f8d9d76d862d3">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># average profit * average loan * number of customers</span></span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="fl">0.055</span> <span class="sc">*</span> <span class="dv">20000</span> <span class="sc">*</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1100000</code></pre>
</div>
</div>
<p>Our goal is to find a model that minimizes the costs (and maximizes the expected profit).</p>
<section id="a-first-model" class="level3" data-number="8.4.1"><h3 data-number="8.4.1" class="anchored" data-anchor-id="a-first-model">
<span class="header-section-number">8.4.1</span> A First Model</h3>
<p>For our first model, we choose an ordinary logistic regression (implemented in add-on package <a href="https://mlr3learners.mlr-org.com"><code>mlr3learners</code></a>). We first create a classification task, then resample the model using 10-fold cross-validation and extract the resulting confusion matrix:</p>
<div class="cell" data-hash="special_cache/html/special-026_ddf944469fcfef8961b743f455493719">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>)</span>
<span id="cb56-2"><a href="#cb56-2"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>))</span>
<span id="cb56-3"><a href="#cb56-3"></a></span>
<span id="cb56-4"><a href="#cb56-4"></a>confusion <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">prediction</span>()<span class="sc">$</span>confusion</span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="fu">print</span>(confusion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response good bad
    good  606 154
    bad    94 146</code></pre>
</div>
</div>
<p>To calculate the average costs like above, we can simply multiply the elements of the confusion matrix with the elements of the previously introduced cost matrix and sum the values of the resulting matrix:</p>
<div class="cell" data-hash="special_cache/html/special-027_4ee1ec8776b6a3bf2c76625b56ae88f7">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>avg_costs <span class="ot">=</span> <span class="fu">sum</span>(confusion <span class="sc">*</span> costs) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="fu">print</span>(avg_costs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.0581</code></pre>
</div>
</div>
<p>With an average loan of $20,000, the logistic regression yields the following costs:</p>
<div class="cell" data-hash="special_cache/html/special-028_71cfffb81937f410d2f4ab62ab550fa7">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>avg_costs <span class="sc">*</span> <span class="dv">20000</span> <span class="sc">*</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1162000</code></pre>
</div>
</div>
<p>Instead of losing over $1,000,000, the credit institute now can expect a profit of more than $1,000,000.</p>
</section><section id="cost-sensitive-measure" class="level3" data-number="8.4.2"><h3 data-number="8.4.2" class="anchored" data-anchor-id="cost-sensitive-measure">
<span class="header-section-number">8.4.2</span> Cost-sensitive Measure</h3>
<p>Our natural next step would be to further improve the modeling step in order to maximize the profit. For this purpose, we first create a cost-sensitive classification measure that calculates the costs based on our cost matrix. This allows us to conveniently quantify and compare modeling decisions. Fortunately, there already is a predefined measure <a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a> for this purpose: <a href="https://mlr3.mlr-org.com/reference/mlr_measures_classif.costs.html"><code>MeasureClassifCosts</code></a>. The costs have to be provided as a numeric matrix whose columns and rows are named with class labels (just like the previously constructed <code>costs</code> matrix):</p>
<div class="cell" data-hash="special_cache/html/special-029_99ae46469952f683e689340296183c24">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>cost_measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.costs"</span>, <span class="at">costs =</span> costs)</span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="fu">print</span>(cost_measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureClassifCosts:classif.costs&gt;: Cost-sensitive Classification
* Packages: mlr3
* Range: [-Inf, Inf]
* Minimize: TRUE
* Average: macro
* Parameters: normalize=TRUE
* Properties: -
* Predict type: response</code></pre>
</div>
</div>
<p>If we now call <a href="https://mlr3.mlr-org.com/reference/resample.html"><code>resample()</code></a> or <a href="https://mlr3.mlr-org.com/reference/benchmark.html"><code>benchmark()</code></a>, the cost-sensitive measures will be evaluated. We compare the logistic regression to a simple featureless learner and to a random forest from package <a href="https://cran.r-project.org/package=ranger"><code>ranger</code></a> :</p>
<div class="cell" data-hash="special_cache/html/special-030_b4a995405b77f5f13035341ecc4b6517">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>),</span>
<span id="cb64-3"><a href="#cb64-3"></a>  <span class="fu">lrn</span>(<span class="st">"classif.featureless"</span>),</span>
<span id="cb64-4"><a href="#cb64-4"></a>  <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb64-5"><a href="#cb64-5"></a>)</span>
<span id="cb64-6"><a href="#cb64-6"></a>cv10 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">10</span>)</span>
<span id="cb64-7"><a href="#cb64-7"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, cv10))</span>
<span id="cb64-8"><a href="#cb64-8"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> cost_measure) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-030-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As expected, the featureless learner is performing comparably badly. The logistic regression and the random forest both yield a profit on average.</p>
</section><section id="thresholding" class="level3" data-number="8.4.3"><h3 data-number="8.4.3" class="anchored" data-anchor-id="thresholding">
<span class="header-section-number">8.4.3</span> Thresholding</h3>
<p>Although we now correctly evaluate the models in a cost-sensitive fashion, the models themselves are unaware of the classification costs. They assume the same costs for both wrong classification decisions (false positives and false negatives). Some learners natively support cost-sensitive classification (e.g., XXX). However, we will concentrate on a more generic approach that works for all models which can predict probabilities for class labels: thresholding.</p>
<p>Most learners can calculate the probability <span class="math inline">\(p\)</span> for the positive class. If <span class="math inline">\(p\)</span> exceeds the threshold <span class="math inline">\(0.5\)</span>, they predict the positive class and the negative class otherwise.</p>
<p>For our binary classification case of the credit data, we primarily want to minimize the errors where the model predicts “good”, but truth is “bad” (i.e., the number of false positives) as this is the more expensive error. If we now increase the threshold to values <span class="math inline">\(&gt; 0.5\)</span>, we reduce the number of false negatives. Note that we increase the number of false positives simultaneously, or, in other words, we are trading false positives for false negatives.</p>
<div class="cell" data-hash="special_cache/html/special-031_3ed39887ac586ca4b44b0dd08ec8e759">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="co"># fit models with probability prediction</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb65-3"><a href="#cb65-3"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>))</span>
<span id="cb65-4"><a href="#cb65-4"></a>p <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">prediction</span>()</span>
<span id="cb65-5"><a href="#cb65-5"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionClassif&gt; for 1000 observations:
    row_ids truth response  prob.good  prob.bad
          2   bad      bad 0.40126720 0.5987328
         17  good     good 0.97406360 0.0259364
         46  good     good 0.74870171 0.2512983
---                                            
        973   bad      bad 0.09917846 0.9008215
        976  good     good 0.78358973 0.2164103
        997  good     good 0.51492948 0.4850705</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># helper function to try different threshold values interactively</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>with_threshold <span class="ot">=</span> <span class="cf">function</span>(p, th) {</span>
<span id="cb67-3"><a href="#cb67-3"></a>  p<span class="sc">$</span><span class="fu">set_threshold</span>(th)</span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="fu">list</span>(<span class="at">confusion =</span> p<span class="sc">$</span>confusion, <span class="at">costs =</span> p<span class="sc">$</span><span class="fu">score</span>(<span class="at">measures =</span> cost_measure))</span>
<span id="cb67-5"><a href="#cb67-5"></a>}</span>
<span id="cb67-6"><a href="#cb67-6"></a></span>
<span id="cb67-7"><a href="#cb67-7"></a><span class="fu">with_threshold</span>(p, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$confusion
        truth
response good bad
    good  598 152
    bad   102 148

$costs
classif.costs 
      -0.0573 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="fu">with_threshold</span>(p, <span class="fl">0.75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$confusion
        truth
response good bad
    good  462  75
    bad   238 225

$costs
classif.costs 
      -0.0867 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="fu">with_threshold</span>(p, <span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$confusion
        truth
response good bad
    good    0   0
    bad   700 300

$costs
classif.costs 
            0 </code></pre>
</div>
</div>
<p>There is also an <code>autoplot()</code> method which systematically varies the threshold between 0 and 1 and calculates the corresponding scores:</p>
<div class="cell" data-hash="special_cache/html/unnamed-chunk-7_bb7193421d81b83c44824e7b8592089b">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="fu">autoplot</span>(p, <span class="at">type =</span> <span class="st">"threshold"</span>, <span class="at">measure =</span> cost_measure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Instead of manually or visually searching for good values, the base R function <a href="https://www.rdocumentation.org/packages/stats/topics/optimize"><code>optimize()</code></a> can do the job for us:</p>
<div class="cell" data-hash="special_cache/html/special-032_51189bd2a397059c0a23bfa28dc835c9">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># simple wrapper function that takes a threshold and returns the resulting model performance</span></span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="co"># this wrapper is passed to optimize() to find its minimum for thresholds in [0.5, 1]</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>f <span class="ot">=</span> <span class="cf">function</span>(th) {</span>
<span id="cb74-4"><a href="#cb74-4"></a>  <span class="fu">with_threshold</span>(p, th)<span class="sc">$</span>costs</span>
<span id="cb74-5"><a href="#cb74-5"></a>}</span>
<span id="cb74-6"><a href="#cb74-6"></a>best <span class="ot">=</span> <span class="fu">optimize</span>(f, <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb74-7"><a href="#cb74-7"></a><span class="fu">print</span>(best)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minimum
[1] 0.6905289

$objective
classif.costs 
     -0.08925 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="co"># optimized confusion matrix:</span></span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="fu">with_threshold</span>(p, best<span class="sc">$</span>minimum)<span class="sc">$</span>confusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response good bad
    good  515  91
    bad   185 209</code></pre>
</div>
</div>
<p>Note that the function <code>"optimize()"</code> is intended for unimodal functions and, therefore, may converge to a local optimum here. See the next section for better alternatives to tune the threshold.</p>
</section><section id="threshold-tuning" class="level3" data-number="8.4.4"><h3 data-number="8.4.4" class="anchored" data-anchor-id="threshold-tuning">
<span class="header-section-number">8.4.4</span> Threshold Tuning</h3>
<p>Currently <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> offers two main strategies towards adjusting <code>classification thresholds</code>. We can either expose the thresholds as a <code>hyperparameter</code> of the Learner by using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_threshold.html"><code>PipeOpThreshold</code></a>. This allows us to tune the <code>thresholds</code> via an outside optimizer from <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>. Alternatively, we can also use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_tunethreshold.html"><code>PipeOpTuneThreshold</code></a> which automatically tunes the threshold after each learner is fit. Both methods are described in the following subsections.</p>
</section><section id="pipeopthreshold" class="level3" data-number="8.4.5"><h3 data-number="8.4.5" class="anchored" data-anchor-id="pipeopthreshold">
<span class="header-section-number">8.4.5</span> PipeOpThreshold</h3>
<p><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_threshold.html"><code>PipeOpThreshold</code></a> can be put directly after a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>.</p>
<p>A simple example would be:</p>
<div class="cell" data-hash="special_cache/html/special-034_3ac98a46017951187d6b57b09b258d89">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a>gr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"threshold"</span>)</span>
<span id="cb78-2"><a href="#cb78-2"></a>l <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, that <code>predict_type = "prob"</code> is required for <code>po("threshold")</code> to have any effect.</p>
<p>The <code>thresholds</code> are now exposed as a <code>hyperparameter</code> of the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> we created:</p>
<div class="cell" data-hash="special_cache/html/special-035_9550c3f10c152bc19b3aa892fbf1c6de">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>l<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                              id    class lower upper nlevels        default
 1:             classif.rpart.cp ParamDbl     0     1     Inf           0.01
 2:     classif.rpart.keep_model ParamLgl    NA    NA       2          FALSE
 3:     classif.rpart.maxcompete ParamInt     0   Inf     Inf              4
 4:       classif.rpart.maxdepth ParamInt     1    30      30             30
 5:   classif.rpart.maxsurrogate ParamInt     0   Inf     Inf              5
 6:      classif.rpart.minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
 7:       classif.rpart.minsplit ParamInt     1   Inf     Inf             20
 8: classif.rpart.surrogatestyle ParamInt     0     1       2              0
 9:   classif.rpart.usesurrogate ParamInt     0     2       3              2
10:           classif.rpart.xval ParamInt     0   Inf     Inf             10
11:         threshold.thresholds ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
1 variable not shown: [value]</code></pre>
</div>
</div>
<p>We can now tune those thresholds from the outside as follows:</p>
<p>Before tuning, we have to define which hyperparameters we want to tune over. In this example, we only tune over the <code>thresholds</code> parameter of the <code>threshold</code> pipe operator. You can easily imagine that we can also jointly tune over additional hyperparameters, i.e., rpart’s <code>cp</code> parameter.</p>
<p>As the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> we aim to optimize for is a binary task, we can simply specify the threshold param:</p>
<div class="cell" data-hash="special_cache/html/special-036_4694917a0f46a9b52022fd20a458dade">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb81-2"><a href="#cb81-2"></a>ps <span class="ot">=</span> <span class="fu">ps</span>(<span class="at">threshold.thresholds =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now create a <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a> which automatically tunes the supplied learner over the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> we supplied above.</p>
<div class="cell" data-hash="special_cache/html/special-037_11f2e9eb6f454e27dc6e5d0420313719">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>at <span class="ot">=</span> AutoTuner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb82-2"><a href="#cb82-2"></a>  <span class="at">learner =</span> l,</span>
<span id="cb82-3"><a href="#cb82-3"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> 3L),</span>
<span id="cb82-4"><a href="#cb82-4"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb82-5"><a href="#cb82-5"></a>  <span class="at">search_space =</span> ps,</span>
<span id="cb82-6"><a href="#cb82-6"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> 5L),</span>
<span id="cb82-7"><a href="#cb82-7"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb82-8"><a href="#cb82-8"></a>)</span>
<span id="cb82-9"><a href="#cb82-9"></a></span>
<span id="cb82-10"><a href="#cb82-10"></a>at<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"german_credit"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inside the <code>trafo</code>, we simply collect all set params into a named vector via <code>map_dbl</code> and store it in the <code>threshold.thresholds</code> slot expected by the learner.</p>
<p>Again, we create a <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a>, which automatically tunes the supplied learner over the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> we supplied above.</p>
<p>One drawback of this strategy is that this requires us to fit a new model for each new threshold setting. While setting a threshold and computing performance is relatively cheap, fitting the learner is often more computationally demanding. An often better strategy is, therefore, to optimize the thresholds separately after each model fit.</p>
</section><section id="pipeoptunethreshold" class="level3" data-number="8.4.6"><h3 data-number="8.4.6" class="anchored" data-anchor-id="pipeoptunethreshold">
<span class="header-section-number">8.4.6</span> PipeOpTunethreshold</h3>
<p><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_tunethreshold.html"><code>PipeOpTuneThreshold</code></a> on the other hand works together with <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner_cv.html"><code>PipeOpLearnerCV</code></a>. It directly optimizes the <code>cross-validated</code> predictions made by this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. This is necessary to avoid over-fitting the threshold tuning.</p>
<p>A simple example would be:</p>
<div class="cell" data-hash="special_cache/html/special-038_e8a4a520d778720418608cc97907bdf0">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"tunethreshold"</span>)</span>
<span id="cb83-2"><a href="#cb83-2"></a>l2 <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, that <code>predict_type</code> = “prob” is required for <code>po("tunethreshold")</code> to work. Additionally, note that this time no <code>threshold</code> parameter is exposed, and it is automatically tuned internally.</p>
<div class="cell" data-hash="special_cache/html/special-039_eb5ab91a4edf5f86a916acf85892a70e">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>l2<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                                        id    class lower upper nlevels
 1:        classif.rpart.resampling.method ParamFct    NA    NA       2
 2:         classif.rpart.resampling.folds ParamInt     2   Inf     Inf
 3: classif.rpart.resampling.keep_response ParamLgl    NA    NA       2
 4:                       classif.rpart.cp ParamDbl     0     1     Inf
 5:               classif.rpart.keep_model ParamLgl    NA    NA       2
 6:               classif.rpart.maxcompete ParamInt     0   Inf     Inf
 7:                 classif.rpart.maxdepth ParamInt     1    30      30
 8:             classif.rpart.maxsurrogate ParamInt     0   Inf     Inf
 9:                classif.rpart.minbucket ParamInt     1   Inf     Inf
10:                 classif.rpart.minsplit ParamInt     1   Inf     Inf
11:           classif.rpart.surrogatestyle ParamInt     0     1       2
12:             classif.rpart.usesurrogate ParamInt     0     2       3
13:                     classif.rpart.xval ParamInt     0   Inf     Inf
14:           classif.rpart.affect_columns ParamUty    NA    NA     Inf
15:                  tunethreshold.measure ParamUty    NA    NA     Inf
16:                tunethreshold.optimizer ParamUty    NA    NA     Inf
17:                tunethreshold.log_level ParamUty    NA    NA     Inf
2 variables not shown: [default, value]</code></pre>
</div>
</div>
<p>Note that we can set <code>rsmp("intask")</code> as a resampling strategy for “learner_cv” in order to evaluate predictions on the “training” data. This is generally not advised, as it might lead to over-fitting on the thresholds but can significantly reduce runtime.</p>
<p>For more information, see the post on Threshold Tuning on the <a href="https://mlr3gallery.mlr-org.com/">mlr3 gallery</a>.</p>
</section></section><section id="cluster" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="cluster">
<span class="header-section-number">8.5</span> Cluster Analysis</h2>
<p>Cluster analysis is a type of unsupervised machine learning where the goal is to group data into clusters, where each cluster contains similar observations. The similarity is based on specified metrics that are task and application-dependent. Cluster analysis is closely related to classification in the sense that each observation needs to be assigned to a cluster or a class. However, unlike classification problems where each observation is labeled, clustering works on data sets without true labels or class assignments.</p>
<p>The package <a href="https://mlr3cluster.mlr-org.com"><code>mlr3cluster</code></a> extends <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> with the following objects for cluster analysis:</p>
<ul>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/TaskClust.html"><code>TaskClust</code></a> to define clustering tasks</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/LearnerClust.html"><code>LearnerClust</code></a> as base class for clustering learners</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/PredictionClust.html"><code>PredictionClust</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/MeasureClust.html"><code>MeasureClust</code></a> as specialized class for performance measures</li>
</ul>
<p>Since clustering is a type of unsupervised learning, <code>TaskClust</code> is slightly different from <a href="https://mlr3.mlr-org.com/reference/TaskRegr.html"><code>TaskRegr</code></a> and <a href="https://mlr3.mlr-org.com/reference/TaskClassif.html"><code>TaskClassif</code></a> objects. More specifically:</p>
<ul>
<li>
<code>truth()</code> function is missing because observations are not labeled.</li>
<li>
<code>target</code> field is empty and will return <code>character(0)</code> if accessed anyway.</li>
</ul>
<p>Additionally, <code>LearnerClust</code> provides two extra fields that are absent from supervised learners:</p>
<ul>
<li>
<code>assignments</code> returns cluster assignments for training data. It returns <code>NULL</code> if accessed before training.</li>
<li>
<code>save_assignments</code> is a boolean field that controls whether or not to store training set assignments in a learner.</li>
</ul>
<p>Finally, <code>PredictionClust</code> contains two additional fields:</p>
<ul>
<li>
<code>partition</code> stores cluster partitions.</li>
<li>
<code>prob</code> stores cluster probabilities for each observation.</li>
</ul>
<section id="train-and-predict-1" class="level3" data-number="8.5.1"><h3 data-number="8.5.1" class="anchored" data-anchor-id="train-and-predict-1">
<span class="header-section-number">8.5.1</span> Train and Predict</h3>
<p>Clustering learners provide both <code>train</code> and <code>predict</code> methods. The analysis typically consists of building clusters using all available data. To be consistent with the rest of the library, we refer to this process as training.</p>
<p>Some learners can assign new observations to existing groups with <code>predict</code>. However, prediction does not always make sense, as is the case for hierarchical clustering. In hierarchical clustering, the goal is to build a hierarchy of nested clusters by either splitting large clusters into smaller ones or merging smaller clusters into bigger ones. The final result is a tree or dendrogram which can change if a new data point is added. For consistency with the rest of the ecosystem, <a href="https://mlr3cluster.mlr-org.com"><code>mlr3cluster</code></a> offers <code>predict</code> method for hierarchical clusterers but it simply assigns all points to a specified number of clusters by cutting the resulting tree at a corresponding level. Moreover, some learners estimate the probability of each observation belonging to a given cluster. <code>predict_types</code> field gives a list of prediction types for each learner.</p>
<p>After training, the <code>model</code> field stores a learner’s model that looks different for each learner depending on the underlying library. <code>predict</code> returns a <code>PredictionClust</code> object that gives a simplified view of the learned model. If the data given to the <code>predict</code> method is the same as the one on which the learner was trained, <code>predict</code> simply returns cluster assignments for the “training” observations. On the other hand, if the test set contains new data, <code>predict</code> will estimate cluster assignments for that data set. Some learners do not support estimating cluster partitions on new data and will instead return assignments for training data and print a warning message.</p>
<p>In the following example, a <a href="https://mlr3cluster.mlr-org.com/reference/mlr_learners_clust.kmeans.html"><code>$k$-means learner</code></a> is applied on the <a href="https://mlr3cluster.mlr-org.com/reference/mlr_tasks_usarrests.html"><code>US arrest data set</code></a>. The class labels are predicted and the contribution of the task features to assignment of the respective class are visualized.</p>
<div class="cell" data-hash="special_cache/html/special-040_05a7a0f50a17b9e39041ba4341e6c254">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb86-2"><a href="#cb86-2"></a><span class="fu">library</span>(<span class="st">"mlr3cluster"</span>)</span>
<span id="cb86-3"><a href="#cb86-3"></a><span class="fu">library</span>(<span class="st">"mlr3viz"</span>)</span>
<span id="cb86-4"><a href="#cb86-4"></a><span class="fu">set.seed</span>(1L)</span>
<span id="cb86-5"><a href="#cb86-5"></a></span>
<span id="cb86-6"><a href="#cb86-6"></a><span class="co"># create an example task</span></span>
<span id="cb86-7"><a href="#cb86-7"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"usarrests"</span>)</span>
<span id="cb86-8"><a href="#cb86-8"></a><span class="fu">print</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClust:usarrests&gt; (50 x 4): US Arrests
* Target: -
* Properties: -
* Features (4):
  - int (2): Assault, UrbanPop
  - dbl (2): Murder, Rape</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a><span class="fu">autoplot</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-040-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="co"># create a k-means learner</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb89-3"><a href="#cb89-3"></a></span>
<span id="cb89-4"><a href="#cb89-4"></a><span class="co"># assigning each observation to one of the two clusters (default in clust.kmeans)</span></span>
<span id="cb89-5"><a href="#cb89-5"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb89-6"><a href="#cb89-6"></a>learner<span class="sc">$</span>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>K-means clustering with 2 clusters of sizes 21, 29

Cluster means:
   Assault    Murder     Rape UrbanPop
1 255.0000 11.857143 28.11429 67.61905
2 109.7586  4.841379 16.24828 64.03448

Clustering vector:
 [1] 1 1 1 1 1 1 2 1 1 1 2 2 1 2 2 2 2 1 2 1 2 1 2 1 2 2 2 1 2 2 1 1 1 2 2 2 2 2
[39] 2 1 2 1 1 2 2 2 2 2 2 2

Within cluster sum of squares by cluster:
[1] 41636.73 54762.30
 (between_SS / total_SS =  72.9 %)

Available components:

[1] "cluster"      "centers"      "totss"        "withinss"     "tot.withinss"
[6] "betweenss"    "size"         "iter"         "ifault"      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># make "predictions" for the same data</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb91-3"><a href="#cb91-3"></a><span class="fu">autoplot</span>(prediction, task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-040-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="measures" class="level3" data-number="8.5.2"><h3 data-number="8.5.2" class="anchored" data-anchor-id="measures">
<span class="header-section-number">8.5.2</span> Measures</h3>
<p>The difference between supervised and unsupervised learning is that there is no ground truth data in unsupervised learning. In a supervised setting, such as classification, we would need to compare our predictions to true labels. Since clustering is an example of unsupervised learning, there are no true labels to which we can compare. However, we can still measure the quality of cluster assignments by quantifying how closely objects within the same cluster are related (cluster cohesion) as well as how distinct different clusters are from each other (cluster separation).</p>
<p>There are a few built-in evaluation metrics available to assess the quality of clustering. One of them is <a href="https://mlr3cluster.mlr-org.com/reference/mlr_measures_clust.wss.html"><code>within sum of squares (WSS)</code></a> which calculates the sum of squared differences between observations and centroids. WSS is useful because it quantifies cluster cohesion. The range of this measure is <span class="math inline">\([0, \infty)\)</span> where a smaller value means that clusters are more compact.</p>
<p>Another measure is <a href="https://mlr3cluster.mlr-org.com/reference/mlr_measures_clust.silhouette.html"><code>silhouette quality index</code></a> that quantifies how well each point belongs to its assigned cluster versus neighboring cluster. Silhouette values are in <span class="math inline">\([-1, 1]\)</span> range.</p>
<p>Points with silhouette closer to:</p>
<ul>
<li>1 are well clustered</li>
<li>0 lie between two clusters</li>
<li>-1 likely placed in the wrong cluster</li>
</ul>
<p>The following is an example of conducting a benchmark experiment with various learners on <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_iris.html"><code>iris data set</code></a> without target variable and assessing the quality of each learner with both within sum of squares and silhouette measures.</p>
<div class="cell" data-hash="special_cache/html/special-041_cc297f0cce1e55a06ac00b4e97a4df0d">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb92-2"><a href="#cb92-2"></a>  <span class="at">tasks =</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>]),</span>
<span id="cb92-3"><a href="#cb92-3"></a>  <span class="at">learners =</span> <span class="fu">list</span>(</span>
<span id="cb92-4"><a href="#cb92-4"></a>    <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> 3L),</span>
<span id="cb92-5"><a href="#cb92-5"></a>    <span class="fu">lrn</span>(<span class="st">"clust.pam"</span>, <span class="at">k =</span> 2L),</span>
<span id="cb92-6"><a href="#cb92-6"></a>    <span class="fu">lrn</span>(<span class="st">"clust.cmeans"</span>, <span class="at">centers =</span> 3L)),</span>
<span id="cb92-7"><a href="#cb92-7"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"insample"</span>))</span>
<span id="cb92-8"><a href="#cb92-8"></a><span class="fu">print</span>(design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              task                  learner               resampling
1: &lt;TaskClust[46]&gt; &lt;LearnerClustKMeans[38]&gt; &lt;ResamplingInsample[20]&gt;
2: &lt;TaskClust[46]&gt;    &lt;LearnerClustPAM[38]&gt; &lt;ResamplingInsample[20]&gt;
3: &lt;TaskClust[46]&gt; &lt;LearnerClustCMeans[38]&gt; &lt;ResamplingInsample[20]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># execute benchmark</span></span>
<span id="cb94-2"><a href="#cb94-2"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb94-3"><a href="#cb94-3"></a></span>
<span id="cb94-4"><a href="#cb94-4"></a><span class="co"># define measure</span></span>
<span id="cb94-5"><a href="#cb94-5"></a>measures <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">msr</span>(<span class="st">"clust.wss"</span>), <span class="fu">msr</span>(<span class="st">"clust.silhouette"</span>))</span>
<span id="cb94-6"><a href="#cb94-6"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measures)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr      resample_result task_id   learner_id resampling_id iters clust.wss
1:  1 &lt;ResampleResult[21]&gt;    iris clust.kmeans      insample     1  78.85144
2:  2 &lt;ResampleResult[21]&gt;    iris    clust.pam      insample     1 153.32572
3:  3 &lt;ResampleResult[21]&gt;    iris clust.cmeans      insample     1  79.02617
1 variable not shown: [clust.silhouette]</code></pre>
</div>
</div>
<p>The experiment shows that using k-means algorithm with three centers produces a better within sum of squares score than any other learner considered. However, pam (partitioning around medoids) learner with two clusters performs the best when considering silhouette measure which takes into the account both cluster cohesion and separation.</p>
</section><section id="visualization" class="level3" data-number="8.5.3"><h3 data-number="8.5.3" class="anchored" data-anchor-id="visualization">
<span class="header-section-number">8.5.3</span> Visualization</h3>
<p>Cluster analysis in <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> is integrated with <a href="https://mlr3viz.mlr-org.com"><code>mlr3viz</code></a> which provides a number of useful plots. Some of those plots are shown below.</p>
<div class="cell" data-hash="special_cache/html/special-042_c2e920f6cc37c63e06d078becd91f306">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>task <span class="ot">=</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>])</span>
<span id="cb96-2"><a href="#cb96-2"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb96-3"><a href="#cb96-3"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb96-4"><a href="#cb96-4"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb96-5"><a href="#cb96-5"></a></span>
<span id="cb96-6"><a href="#cb96-6"></a><span class="co"># performing PCA on task and showing assignments</span></span>
<span id="cb96-7"><a href="#cb96-7"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"pca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-042-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co"># same as above but with probability ellipse that assumes normal distribution</span></span>
<span id="cb97-2"><a href="#cb97-2"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"pca"</span>, <span class="at">frame =</span> <span class="cn">TRUE</span>, <span class="at">frame.type =</span> <span class="st">"norm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-042-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"usarrests"</span>)</span>
<span id="cb98-2"><a href="#cb98-2"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.hclust"</span>)</span>
<span id="cb98-3"><a href="#cb98-3"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb98-4"><a href="#cb98-4"></a></span>
<span id="cb98-5"><a href="#cb98-5"></a><span class="co"># dendrogram for hierarchical clustering</span></span>
<span id="cb98-6"><a href="#cb98-6"></a><span class="fu">autoplot</span>(learner, <span class="at">task =</span> task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-042-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Silhouette plots can help to visually assess the quality of the analysis and help choose a number of clusters for a given data set. The red dotted line shows the mean silhouette value and each bar represents a data point. If most points in each cluster have an index around or higher than mean silhouette, the number of clusters is chosen well.</p>
<div class="cell" data-hash="special_cache/html/special-043_1ba1073bbf5b36081de61968bdb92fc9">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a><span class="co"># silhouette plot allows to visually inspect the quality of clustering</span></span>
<span id="cb99-2"><a href="#cb99-2"></a>task <span class="ot">=</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>])</span>
<span id="cb99-3"><a href="#cb99-3"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb99-4"><a href="#cb99-4"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">centers =</span> 5L)</span>
<span id="cb99-5"><a href="#cb99-5"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb99-6"><a href="#cb99-6"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb99-7"><a href="#cb99-7"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"sil"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-043-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plot shows that all points in cluster 5 and almost all points in clusters 4, 2 and 1 are below average silhouette index. This means that a lot of observations lie either on the border of clusters or are likely assigned to the wrong cluster.</p>
<div class="cell" data-hash="special_cache/html/special-044_92c4962e30a181a74d6207c8a478b8f0">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb100-2"><a href="#cb100-2"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">centers =</span> 2L)</span>
<span id="cb100-3"><a href="#cb100-3"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb100-4"><a href="#cb100-4"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb100-5"><a href="#cb100-5"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"sil"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="special_files/figure-html/special-044-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Setting the number of centers to two improves both the average silhouette score as well as the overall quality of clustering because almost all points in cluster 1 are higher than, and a lot of points in cluster 2 are close to the mean silhouette. Hence, having two centers might be a better choice for the number of clusters.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-brenning2012" class="csl-entry" role="doc-biblioentry">
Brenning, Alexander. 2012. <span>“Spatial Cross-Validation and Bootstrap for the Assessment of Prediction Rules in Remote Sensing: The <span>R</span> Package Sperrorest.”</span> In <em>2012 <span>IEEE</span> International Geoscience and Remote Sensing Symposium</em>. <span>IEEE</span>. <a href="https://doi.org/10.1109/igarss.2012.6352393">https://doi.org/10.1109/igarss.2012.6352393</a>.
</div>
<div id="ref-Collett2014" class="csl-entry" role="doc-biblioentry">
Collett, David. 2014. <em><span class="nocase">Modelling Survival Data in Medical Research</span></em>. 3rd ed. CRC.
</div>
<div id="ref-hastie2001" class="csl-entry" role="doc-biblioentry">
Hastie, Trevor, Jerome Friedman, and Robert Tibshirani. 2001. <em>The Elements of Statistical Learning</em>. Springer New York. <a href="https://doi.org/10.1007/978-0-387-21606-5">https://doi.org/10.1007/978-0-387-21606-5</a>.
</div>
<div id="ref-legendre1993" class="csl-entry" role="doc-biblioentry">
Legendre, Pierre. 1993. <span>“Spatial Autocorrelation: Trouble or New Paradigm?”</span> <em>Ecology</em> 74 (6): 1659–73. <a href="https://doi.org/10.2307/1939924">https://doi.org/10.2307/1939924</a>.
</div>
<div id="ref-lovelace2019" class="csl-entry" role="doc-biblioentry">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with <span>R</span></em>. CRC Press.
</div>
<div id="ref-meyer2018" class="csl-entry" role="doc-biblioentry">
Meyer, Hanna, Christoph Reudenbach, Tomislav Hengl, Marwan Katurji, and Thomas Nauss. 2018. <span>“Improving Performance of Spatio-Temporal Machine Learning Models Using Forward Feature Selection and Target-Oriented Validation.”</span> <em>Environmental Modelling &amp; Software</em> 101 (March): 1–9. <a href="https://doi.org/10.1016/j.envsoft.2017.12.001">https://doi.org/10.1016/j.envsoft.2017.12.001</a>.
</div>
<div id="ref-muenchow2012" class="csl-entry" role="doc-biblioentry">
Muenchow, J., A. Brenning, and M. Richter. 2012. <span>“Geomorphic Process Rates of Landslides Along a Humidity Gradient in the Tropical Andes.”</span> <em>Geomorphology</em> 139-140: 271–84. https://doi.org/<a href="https://doi.org/10.1016/j.geomorph.2011.10.029">https://doi.org/10.1016/j.geomorph.2011.10.029</a>.
</div>
<div id="ref-schratz2019" class="csl-entry" role="doc-biblioentry">
Schratz, Patrick, Jannes Muenchow, Eugenia Iturritxa, Jakob Richter, and Alexander Brenning. 2019. <span>“Hyperparameter Tuning and Performance Assessment of Statistical and Machine-Learning Algorithms Using Spatial Data.”</span> <em>Ecological Modelling</em> 406 (August): 109–20. <a href="https://doi.org/10.1016/j.ecolmodel.2019.06.002">https://doi.org/10.1016/j.ecolmodel.2019.06.002</a>.
</div>
<div id="ref-Silverman1986" class="csl-entry" role="doc-biblioentry">
Silverman, Bernard W. 1986. <em>Density Estimation for Statistics and Data Analysis</em>. Vol. 26. CRC press.
</div>
<div id="ref-mlr3proba" class="csl-entry" role="doc-biblioentry">
Sonabend, Raphael, Franz J Király, Andreas Bender, Bernd Bischl, and Michel Lang. 2021. <span>“<span class="nocase">mlr3proba</span>: An <span>R</span> Package for Machine Learning in Survival Analysis.”</span> <em>Bioinformatics</em>, February. <a href="https://doi.org/10.1093/bioinformatics/btab039">https://doi.org/10.1093/bioinformatics/btab039</a>.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./preprocessing.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Preprocessing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./technical.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Technical</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb101" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 1</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 1</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 2</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 2</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> TODO (150-200 WORDS)</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># Special Tasks {#sec-special}</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup.qmd &gt;}}</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>This chapter explores the different functions of <span class="in">`r mlr3`</span> when dealing with specific data sets that require further statistical modification to undertake sensible analysis.</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>Following topics are discussed:</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>**Survival Analysis**</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>This sub-chapter explains how to conduct sound <span class="co">[</span><span class="ot">survival analysis</span><span class="co">](#survival)</span> in mlr3.</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Survival analysis</span><span class="co">](#survival)</span> is used to monitor the period of time until a specific event takes places.</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>This specific event could be, e.g., death, the transmission of a disease, marriage, or divorce.</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>Two considerations are important when conducting <span class="co">[</span><span class="ot">survival analysis</span><span class="co">](#survival)</span>:</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Whether the event occurred within the frame of the given data</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>How much time it took until the event occurred</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>In summary, this sub-chapter explains how to account for these considerations and conduct survival analysis using the <span class="in">`mlr3proba`</span> extension package.</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>**Density Estimation**</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>This sub-chapter explains how to conduct (unconditional) <span class="co">[</span><span class="ot">density estimation</span><span class="co">](#density)</span> in mlr3.</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Density estimation</span><span class="co">](#density)</span> is used to estimate the probability density function of a continuous variable. Unconditional density estimation is an unsupervised task, so there is no 'value' to predict. Instead, densities are *estimated*.</span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>This sub-chapter explains how to estimate probability distributions for continuous variables using the <span class="in">`mlr3proba`</span> extension package.</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>**Spatiotemporal Analysis**</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Spatiotemporal analysis</span><span class="co">](#spatiotemporal)</span> data observations entail reference information about spatial and temporal characteristics.</span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>One of the largest issues of <span class="co">[</span><span class="ot">spatiotemporal data analysis</span><span class="co">](#spatiotemporal)</span> is the inevitable presence of auto-correlation in the data.</span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>Auto-correlation is especially severe in data with a marginal spatiotemporal variation.</span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>The sub-chapter on <span class="co">[</span><span class="ot">Spatiotemporal analysis</span><span class="co">](#spatiotemporal)</span> provides instructions on how to account for spatiotemporal data.</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>**Multilabel Classification**</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Multilabel classification</span><span class="co">](#multilabel)</span> deals with objects that can belong to more than one category at the same time.</span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>Numerous target labels are attributed to a single observation.</span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a>Working with multilabel data requires one to use modified algorithms, to accommodate data specific characteristics.</span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>Two approaches to <span class="co">[</span><span class="ot">multilabel classification</span><span class="co">](#multilabel)</span> are prominently used:</span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The problem transformation method</span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The algorithm adaption method</span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a>Instructions on how to deal with <span class="co">[</span><span class="ot">multilabel classification</span><span class="co">](#multilabel)</span> in<span class="in">`r mlr3`</span>can be found in this sub-chapter.</span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a>**Cost Sensitive Classification**</span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a>This sub-chapter deals with the implementation of <span class="co">[</span><span class="ot">cost-sensitive classification</span><span class="co">](#cost-sens)</span>.</span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a>Regular classification aims to minimize the misclassification rate and thus all types of misclassification errors are deemed equally severe.</span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Cost-sensitive classification</span><span class="co">](#cost-sens)</span> is a setting where the costs caused by different kinds of errors are not assumed to be equal.</span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a>The objective is to minimize the expected costs.</span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a>Analytical data for a big credit institution is used as a use case to illustrate the different features.</span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a>Firstly, the sub-chapter provides guidance on how to implement a first model.</span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a>Subsequently, the sub-chapter contains instructions on how to modify cost sensitivity measures, thresholding and threshold tuning.</span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a>**Cluster Analysis**</span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Cluster analysis</span><span class="co">](#cluster)</span> aims to group data into clusters such that objects that are similar end up in the same cluster.</span>
<span id="cb101-75"><a href="#cb101-75" aria-hidden="true" tabindex="-1"></a>Fundamentally, clustering and classification are similar.</span>
<span id="cb101-76"><a href="#cb101-76" aria-hidden="true" tabindex="-1"></a>However, clustering is an unsupervised task because observations do not contain true labels while in classification, labels are needed in order to train a model.</span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a>This sub-chapter explains how to perform <span class="co">[</span><span class="ot">cluster analysis</span><span class="co">](#cluster)</span> in<span class="in">`r mlr3`</span>with the help of <span class="in">`mlr3cluster`</span> extension package.</span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>**Coming soon**</span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a>In development we are also working on</span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Multilabel classification - <span class="in">`r ref_pkg("mlr-org/mlr3multioutput", FALSE)`</span></span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Functional data analysis - <span class="in">`r ref_pkg("mlr-org/mlr3fda", FALSE)`</span></span>
<span id="cb101-86"><a href="#cb101-86" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Ordinal analysis - <span class="in">`r ref_pkg("mlr3ordinal", FALSE)`</span></span>
<span id="cb101-87"><a href="#cb101-87" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Time-series analysis / forecasting - <span class="in">`r ref_pkg("mlr3temporal", FALSE)`</span></span>
<span id="cb101-88"><a href="#cb101-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-89"><a href="#cb101-89" aria-hidden="true" tabindex="-1"></a>Send us a message if you want to help out on any of these!</span>
<span id="cb101-90"><a href="#cb101-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-91"><a href="#cb101-91" aria-hidden="true" tabindex="-1"></a><span class="fu">## Survival Analysis {#survival}</span></span>
<span id="cb101-92"><a href="#cb101-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-93"><a href="#cb101-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-001, include = FALSE}</span></span>
<span id="cb101-94"><a href="#cb101-94" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb101-95"><a href="#cb101-95" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb101-96"><a href="#cb101-96" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3viz)</span>
<span id="cb101-97"><a href="#cb101-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-98"><a href="#cb101-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-99"><a href="#cb101-99" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-100"><a href="#cb101-100" aria-hidden="true" tabindex="-1"></a>Survival analysis with {mlr3proba} is currently in a fragile state after its removal from CRAN.</span>
<span id="cb101-101"><a href="#cb101-101" aria-hidden="true" tabindex="-1"></a>Hence most code examples listed in this page will not work for the time being.</span>
<span id="cb101-102"><a href="#cb101-102" aria-hidden="true" tabindex="-1"></a>We are actively working on a solution!</span>
<span id="cb101-103"><a href="#cb101-103" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-104"><a href="#cb101-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-105"><a href="#cb101-105" aria-hidden="true" tabindex="-1"></a>Survival analysis is a sub-field of supervised machine learning in which the aim is to predict the survival distribution of a given individual.</span>
<span id="cb101-106"><a href="#cb101-106" aria-hidden="true" tabindex="-1"></a>Arguably the main feature of survival analysis is that, unlike classification and regression, learners are trained on two features:</span>
<span id="cb101-107"><a href="#cb101-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-108"><a href="#cb101-108" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>the time until the event takes place</span>
<span id="cb101-109"><a href="#cb101-109" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>the event type: either censoring or death.</span>
<span id="cb101-110"><a href="#cb101-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-111"><a href="#cb101-111" aria-hidden="true" tabindex="-1"></a>At a particular time-point, an individual is either: alive, dead, or censored.</span>
<span id="cb101-112"><a href="#cb101-112" aria-hidden="true" tabindex="-1"></a>Censoring occurs if it is unknown if an individual is alive or dead.</span>
<span id="cb101-113"><a href="#cb101-113" aria-hidden="true" tabindex="-1"></a>For example, say we are interested in patients in hospital and every day it is recorded if they are alive or dead, then after a patient leaves, it is unknown if they are alive or dead.</span>
<span id="cb101-114"><a href="#cb101-114" aria-hidden="true" tabindex="-1"></a>Hence they are censored.</span>
<span id="cb101-115"><a href="#cb101-115" aria-hidden="true" tabindex="-1"></a>If there was no censoring, then ordinary regression analysis could be used instead.</span>
<span id="cb101-116"><a href="#cb101-116" aria-hidden="true" tabindex="-1"></a>Furthermore, survival data contains solely positive values and therefore needs to be transformed to avoid biases.</span>
<span id="cb101-117"><a href="#cb101-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-118"><a href="#cb101-118" aria-hidden="true" tabindex="-1"></a>Note that survival analysis accounts for both censored and uncensored observations while adjusting respective model parameters.</span>
<span id="cb101-119"><a href="#cb101-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-120"><a href="#cb101-120" aria-hidden="true" tabindex="-1"></a>The package <span class="in">`r mlr3proba`</span> <span class="co">[</span><span class="ot">@mlr3proba</span><span class="co">]</span> extends <span class="in">`r mlr3`</span> with the following objects for survival analysis:</span>
<span id="cb101-121"><a href="#cb101-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-122"><a href="#cb101-122" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::TaskSurv", text = "TaskSurv")`</span> to define (censored) survival tasks</span>
<span id="cb101-123"><a href="#cb101-123" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::LearnerSurv", text = "LearnerSurv")`</span> as base class for survival learners</span>
<span id="cb101-124"><a href="#cb101-124" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::PredictionSurv", text = "PredictionSurv")`</span> as specialized class for <span class="in">`r ref("Prediction")`</span> objects</span>
<span id="cb101-125"><a href="#cb101-125" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::MeasureSurv", text = "MeasureSurv")`</span> as specialized class for performance measures</span>
<span id="cb101-126"><a href="#cb101-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-127"><a href="#cb101-127" aria-hidden="true" tabindex="-1"></a>For a good introduction to survival analysis see *Modelling Survival Data in Medical Research* <span class="co">[</span><span class="ot">@Collett2014</span><span class="co">]</span>.</span>
<span id="cb101-128"><a href="#cb101-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-129"><a href="#cb101-129" aria-hidden="true" tabindex="-1"></a><span class="fu">### TaskSurv</span></span>
<span id="cb101-130"><a href="#cb101-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-131"><a href="#cb101-131" aria-hidden="true" tabindex="-1"></a>Unlike <span class="in">`r ref("TaskClassif")`</span> and <span class="in">`r ref("TaskRegr")`</span> which have a single 'target' argument, <span class="in">`r ref("TaskSurv")`</span> mimics the</span>
<span id="cb101-132"><a href="#cb101-132" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("survival::Surv")`</span> object and has three to four target arguments (dependent on censoring type).</span>
<span id="cb101-133"><a href="#cb101-133" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("TaskSurv")`</span> can be constructed with the function <span class="in">`r ref("as_task_surv()")`</span>:</span>
<span id="cb101-134"><a href="#cb101-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-135"><a href="#cb101-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-002, eval=FALSE}</span></span>
<span id="cb101-136"><a href="#cb101-136" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb101-137"><a href="#cb101-137" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3proba"</span>)</span>
<span id="cb101-138"><a href="#cb101-138" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"survival"</span>)</span>
<span id="cb101-139"><a href="#cb101-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-140"><a href="#cb101-140" aria-hidden="true" tabindex="-1"></a><span class="fu">as_task_surv</span>(survival<span class="sc">::</span>bladder2[, <span class="sc">-</span>1L], <span class="at">id =</span> <span class="st">"interval_censored"</span>,</span>
<span id="cb101-141"><a href="#cb101-141" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"start"</span>, <span class="at">event =</span> <span class="st">"event"</span>, <span class="at">time2 =</span> <span class="st">"stop"</span>, <span class="at">type =</span> <span class="st">"interval"</span>)</span>
<span id="cb101-142"><a href="#cb101-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-143"><a href="#cb101-143" aria-hidden="true" tabindex="-1"></a><span class="co"># type = "right" is default</span></span>
<span id="cb101-144"><a href="#cb101-144" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_surv</span>(survival<span class="sc">::</span>rats, <span class="at">id =</span> <span class="st">"right_censored"</span>,</span>
<span id="cb101-145"><a href="#cb101-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"time"</span>, <span class="at">event =</span> <span class="st">"status"</span>, <span class="at">type =</span> <span class="st">"right"</span>)</span>
<span id="cb101-146"><a href="#cb101-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-147"><a href="#cb101-147" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task)</span>
<span id="cb101-148"><a href="#cb101-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-149"><a href="#cb101-149" aria-hidden="true" tabindex="-1"></a><span class="co"># the target column is a survival object:</span></span>
<span id="cb101-150"><a href="#cb101-150" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(task<span class="sc">$</span><span class="fu">truth</span>())</span>
<span id="cb101-151"><a href="#cb101-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-152"><a href="#cb101-152" aria-hidden="true" tabindex="-1"></a><span class="co"># kaplan-meier plot</span></span>
<span id="cb101-153"><a href="#cb101-153" aria-hidden="true" tabindex="-1"></a><span class="co"># library("mlr3viz")</span></span>
<span id="cb101-154"><a href="#cb101-154" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task)</span>
<span id="cb101-155"><a href="#cb101-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-156"><a href="#cb101-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-157"><a href="#cb101-157" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predict Types - crank, lp, and distr</span></span>
<span id="cb101-158"><a href="#cb101-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-159"><a href="#cb101-159" aria-hidden="true" tabindex="-1"></a>Every <span class="in">`r ref("PredictionSurv")`</span> object can predict one or more of:</span>
<span id="cb101-160"><a href="#cb101-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-161"><a href="#cb101-161" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`lp`</span> - Linear predictor calculated as the fitted coefficients multiplied by the test data.</span>
<span id="cb101-162"><a href="#cb101-162" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`distr`</span> - Predicted survival distribution, either discrete or continuous.</span>
<span id="cb101-163"><a href="#cb101-163" aria-hidden="true" tabindex="-1"></a>  Implemented in <span class="in">`r ref_pkg("distr6")`</span>.</span>
<span id="cb101-164"><a href="#cb101-164" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`crank`</span> - Continuous risk ranking.</span>
<span id="cb101-165"><a href="#cb101-165" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`response`</span> - Predicted survival time.</span>
<span id="cb101-166"><a href="#cb101-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-167"><a href="#cb101-167" aria-hidden="true" tabindex="-1"></a><span class="in">`lp`</span> and <span class="in">`crank`</span> can be used with measures of discrimination such as the concordance index.</span>
<span id="cb101-168"><a href="#cb101-168" aria-hidden="true" tabindex="-1"></a>Whilst <span class="in">`lp`</span> is a specific mathematical prediction, <span class="in">`crank`</span> is any continuous ranking that identifies who is more or less likely to experience the event.</span>
<span id="cb101-169"><a href="#cb101-169" aria-hidden="true" tabindex="-1"></a>So far the only implemented learner that only returns a continuous ranking is <span class="in">`surv.svm`</span>.</span>
<span id="cb101-170"><a href="#cb101-170" aria-hidden="true" tabindex="-1"></a>If a <span class="in">`r ref("PredictionSurv")`</span> returns an <span class="in">`lp`</span> then the <span class="in">`crank`</span> is identical to this.</span>
<span id="cb101-171"><a href="#cb101-171" aria-hidden="true" tabindex="-1"></a>Otherwise <span class="in">`crank`</span> is calculated as the expectation of the predicted survival distribution.</span>
<span id="cb101-172"><a href="#cb101-172" aria-hidden="true" tabindex="-1"></a>Note that for linear proportional hazards models, the ranking (but not necessarily the <span class="in">`crank`</span> score itself) given by <span class="in">`lp`</span> and the expectation of <span class="in">`distr`</span>, is identical.</span>
<span id="cb101-173"><a href="#cb101-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-174"><a href="#cb101-174" aria-hidden="true" tabindex="-1"></a>The example below uses the <span class="in">`r ref("mlr_tasks_rats", text = "rats")`</span> task shipped with <span class="in">`r mlr3proba`</span>.</span>
<span id="cb101-175"><a href="#cb101-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-176"><a href="#cb101-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-003}</span></span>
<span id="cb101-177"><a href="#cb101-177" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb101-178"><a href="#cb101-178" aria-hidden="true" tabindex="-1"></a>learn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.coxph"</span>)</span>
<span id="cb101-179"><a href="#cb101-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-180"><a href="#cb101-180" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">=</span> <span class="fu">sample</span>(task<span class="sc">$</span>nrow, <span class="fl">0.8</span> <span class="sc">*</span> task<span class="sc">$</span>nrow)</span>
<span id="cb101-181"><a href="#cb101-181" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train_set)</span>
<span id="cb101-182"><a href="#cb101-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-183"><a href="#cb101-183" aria-hidden="true" tabindex="-1"></a>learn<span class="sc">$</span><span class="fu">train</span>(task, <span class="at">row_ids =</span> train_set)</span>
<span id="cb101-184"><a href="#cb101-184" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learn<span class="sc">$</span><span class="fu">predict</span>(task, <span class="at">row_ids =</span> test_set)</span>
<span id="cb101-185"><a href="#cb101-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-186"><a href="#cb101-186" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(prediction)</span>
<span id="cb101-187"><a href="#cb101-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-188"><a href="#cb101-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-189"><a href="#cb101-189" aria-hidden="true" tabindex="-1"></a><span class="fu">### Composition</span></span>
<span id="cb101-190"><a href="#cb101-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-191"><a href="#cb101-191" aria-hidden="true" tabindex="-1"></a>Finally we take a look at the <span class="in">`r ref("PipeOp")`</span>s implemented in <span class="in">`r mlr3proba`</span>, which are used for composition of predict types.</span>
<span id="cb101-192"><a href="#cb101-192" aria-hidden="true" tabindex="-1"></a>For example, a predict linear predictor does not have a lot of meaning by itself, but it can be composed into a survival distribution.</span>
<span id="cb101-193"><a href="#cb101-193" aria-hidden="true" tabindex="-1"></a>See <span class="in">`r mlr3pipelines`</span> for full tutorials and details on <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb101-194"><a href="#cb101-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-195"><a href="#cb101-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-004, eval = FALSE}</span></span>
<span id="cb101-196"><a href="#cb101-196" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb101-197"><a href="#cb101-197" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>)</span>
<span id="cb101-198"><a href="#cb101-198" aria-hidden="true" tabindex="-1"></a><span class="co"># PipeOpDistrCompositor - Train one model with a baseline distribution,</span></span>
<span id="cb101-199"><a href="#cb101-199" aria-hidden="true" tabindex="-1"></a><span class="co"># (Kaplan-Meier or Nelson-Aalen), and another with a predicted linear predictor.</span></span>
<span id="cb101-200"><a href="#cb101-200" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb101-201"><a href="#cb101-201" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the factor column for support with glmnet</span></span>
<span id="cb101-202"><a href="#cb101-202" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"litter"</span>, <span class="st">"rx"</span>))</span>
<span id="cb101-203"><a href="#cb101-203" aria-hidden="true" tabindex="-1"></a>learner_lp <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.glmnet"</span>)</span>
<span id="cb101-204"><a href="#cb101-204" aria-hidden="true" tabindex="-1"></a>learner_distr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"surv.kaplan"</span>)</span>
<span id="cb101-205"><a href="#cb101-205" aria-hidden="true" tabindex="-1"></a>prediction_lp <span class="ot">=</span> learner_lp<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-206"><a href="#cb101-206" aria-hidden="true" tabindex="-1"></a>prediction_distr <span class="ot">=</span> learner_distr<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-207"><a href="#cb101-207" aria-hidden="true" tabindex="-1"></a>prediction_lp<span class="sc">$</span>distr</span>
<span id="cb101-208"><a href="#cb101-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-209"><a href="#cb101-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Doesn't need training. Base = baseline distribution. ph = Proportional hazards.</span></span>
<span id="cb101-210"><a href="#cb101-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-211"><a href="#cb101-211" aria-hidden="true" tabindex="-1"></a>pod <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"compose_distr"</span>, <span class="at">form =</span> <span class="st">"ph"</span>, <span class="at">overwrite =</span> <span class="cn">FALSE</span>)</span>
<span id="cb101-212"><a href="#cb101-212" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> pod<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(<span class="at">base =</span> prediction_distr, <span class="at">pred =</span> prediction_lp))<span class="sc">$</span>output</span>
<span id="cb101-213"><a href="#cb101-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-214"><a href="#cb101-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we have a predicted distr!</span></span>
<span id="cb101-215"><a href="#cb101-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-216"><a href="#cb101-216" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>distr</span>
<span id="cb101-217"><a href="#cb101-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-218"><a href="#cb101-218" aria-hidden="true" tabindex="-1"></a><span class="co"># This can all be simplified by using the distrcompose pipeline</span></span>
<span id="cb101-219"><a href="#cb101-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-220"><a href="#cb101-220" aria-hidden="true" tabindex="-1"></a>glm.distr <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"distrcompositor"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"surv.glmnet"</span>),</span>
<span id="cb101-221"><a href="#cb101-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator =</span> <span class="st">"kaplan"</span>, <span class="at">form =</span> <span class="st">"ph"</span>, <span class="at">overwrite =</span> <span class="cn">FALSE</span>, <span class="at">graph_learner =</span> <span class="cn">TRUE</span>)</span>
<span id="cb101-222"><a href="#cb101-222" aria-hidden="true" tabindex="-1"></a>glm.distr<span class="sc">$</span><span class="fu">train</span>(task)<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-223"><a href="#cb101-223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-224"><a href="#cb101-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-225"><a href="#cb101-225" aria-hidden="true" tabindex="-1"></a><span class="fu">### Benchmark Experiment</span></span>
<span id="cb101-226"><a href="#cb101-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-227"><a href="#cb101-227" aria-hidden="true" tabindex="-1"></a>Finally, we conduct a small benchmark study on the <span class="in">`r ref("mlr_tasks_rats", text = "rats")`</span> task using some of the integrated survival learners:</span>
<span id="cb101-228"><a href="#cb101-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-229"><a href="#cb101-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-005}</span></span>
<span id="cb101-230"><a href="#cb101-230" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>)</span>
<span id="cb101-231"><a href="#cb101-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-232"><a href="#cb101-232" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb101-233"><a href="#cb101-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-234"><a href="#cb101-234" aria-hidden="true" tabindex="-1"></a><span class="co"># some integrated learners</span></span>
<span id="cb101-235"><a href="#cb101-235" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"surv.coxph"</span>, <span class="st">"surv.kaplan"</span>, <span class="st">"surv.ranger"</span>))</span>
<span id="cb101-236"><a href="#cb101-236" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(learners)</span>
<span id="cb101-237"><a href="#cb101-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-238"><a href="#cb101-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Harrell's C-Index for survival</span></span>
<span id="cb101-239"><a href="#cb101-239" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"surv.cindex"</span>)</span>
<span id="cb101-240"><a href="#cb101-240" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(measure)</span>
<span id="cb101-241"><a href="#cb101-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-242"><a href="#cb101-242" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb101-243"><a href="#cb101-243" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)))</span>
<span id="cb101-244"><a href="#cb101-244" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measure)</span>
<span id="cb101-245"><a href="#cb101-245" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> measure)</span>
<span id="cb101-246"><a href="#cb101-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-247"><a href="#cb101-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-248"><a href="#cb101-248" aria-hidden="true" tabindex="-1"></a>The experiment indicates that both the Cox PH and the random forest have better discrimination than the Kaplan-Meier baseline estimator, but that the machine learning random forest is not consistently better than the interpretable Cox PH.</span>
<span id="cb101-249"><a href="#cb101-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-250"><a href="#cb101-250" aria-hidden="true" tabindex="-1"></a><span class="fu">## Density Estimation {#density}</span></span>
<span id="cb101-251"><a href="#cb101-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-252"><a href="#cb101-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-006, include = FALSE}</span></span>
<span id="cb101-253"><a href="#cb101-253" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb101-254"><a href="#cb101-254" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb101-255"><a href="#cb101-255" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3viz)</span>
<span id="cb101-256"><a href="#cb101-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-257"><a href="#cb101-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-258"><a href="#cb101-258" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-259"><a href="#cb101-259" aria-hidden="true" tabindex="-1"></a>Survival analysis with {mlr3proba} is currently in a fragile state after its removal from CRAN.</span>
<span id="cb101-260"><a href="#cb101-260" aria-hidden="true" tabindex="-1"></a>Hence most code examples listed in this page will not work for the time being.</span>
<span id="cb101-261"><a href="#cb101-261" aria-hidden="true" tabindex="-1"></a>We are actively working on a solution!</span>
<span id="cb101-262"><a href="#cb101-262" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-263"><a href="#cb101-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-264"><a href="#cb101-264" aria-hidden="true" tabindex="-1"></a>Density estimation is the learning task to find the unknown distribution from which an i.i.d. data set is generated.</span>
<span id="cb101-265"><a href="#cb101-265" aria-hidden="true" tabindex="-1"></a>We interpret this broadly, with this distribution not necessarily being continuous (so may possess a mass not density).</span>
<span id="cb101-266"><a href="#cb101-266" aria-hidden="true" tabindex="-1"></a>The conditional case, where a distribution is predicted conditional on covariates, is known as ‘probabilistic supervised regression’, and will be implemented in <span class="in">`r mlr3proba`</span> in the near-future.</span>
<span id="cb101-267"><a href="#cb101-267" aria-hidden="true" tabindex="-1"></a>Unconditional density estimation is viewed as an unsupervised task.</span>
<span id="cb101-268"><a href="#cb101-268" aria-hidden="true" tabindex="-1"></a>For a good overview to density estimation see *Density estimation for statistics and data analysis* <span class="co">[</span><span class="ot">@Silverman1986</span><span class="co">]</span>.</span>
<span id="cb101-269"><a href="#cb101-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-270"><a href="#cb101-270" aria-hidden="true" tabindex="-1"></a>The package <span class="in">`r mlr3proba`</span> extends <span class="in">`r mlr3`</span> with the following objects for density estimation:</span>
<span id="cb101-271"><a href="#cb101-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-272"><a href="#cb101-272" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::TaskDens", text = "TaskDens")`</span> to define density tasks</span>
<span id="cb101-273"><a href="#cb101-273" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::LearnerDens", text = "LearnerDens")`</span> as base class for density estimators</span>
<span id="cb101-274"><a href="#cb101-274" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::PredictionDens", text = "PredictionDens")`</span> as specialized class for <span class="in">`r ref("Prediction")`</span> objects</span>
<span id="cb101-275"><a href="#cb101-275" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3proba::MeasureDens", text = "MeasureDens")`</span> as specialized class for performance measures</span>
<span id="cb101-276"><a href="#cb101-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-277"><a href="#cb101-277" aria-hidden="true" tabindex="-1"></a>In this example we demonstrate the basic functionality of the package on the <span class="in">`r ref("datasets::faithful", text = "faithful")`</span> data from the <span class="in">`r ref_pkg("datasets")`</span> package.</span>
<span id="cb101-278"><a href="#cb101-278" aria-hidden="true" tabindex="-1"></a>This task ships as pre-defined <span class="in">`r ref("TaskDens")`</span> with <span class="in">`r mlr3proba`</span>.</span>
<span id="cb101-279"><a href="#cb101-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-280"><a href="#cb101-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-007}</span></span>
<span id="cb101-281"><a href="#cb101-281" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb101-282"><a href="#cb101-282" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3proba"</span>)</span>
<span id="cb101-283"><a href="#cb101-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-284"><a href="#cb101-284" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"precip"</span>)</span>
<span id="cb101-285"><a href="#cb101-285" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task)</span>
<span id="cb101-286"><a href="#cb101-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-287"><a href="#cb101-287" aria-hidden="true" tabindex="-1"></a><span class="co"># histogram and density plot</span></span>
<span id="cb101-288"><a href="#cb101-288" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3viz"</span>)</span>
<span id="cb101-289"><a href="#cb101-289" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">FIXME</span></span>
<span id="cb101-290"><a href="#cb101-290" aria-hidden="true" tabindex="-1"></a><span class="co"># autoplot(task, type = "overlay")</span></span>
<span id="cb101-291"><a href="#cb101-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-292"><a href="#cb101-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-293"><a href="#cb101-293" aria-hidden="true" tabindex="-1"></a>Unconditional density estimation is an unsupervised method.</span>
<span id="cb101-294"><a href="#cb101-294" aria-hidden="true" tabindex="-1"></a>Hence, <span class="in">`r ref("TaskDens")`</span> is an unsupervised task which inherits directly from <span class="in">`r ref("Task")`</span> unlike <span class="in">`r ref("TaskClassif")`</span> and <span class="in">`r ref("TaskRegr")`</span>.</span>
<span id="cb101-295"><a href="#cb101-295" aria-hidden="true" tabindex="-1"></a>However, <span class="in">`r ref("TaskDens")`</span> still has a <span class="in">`target`</span> argument and a <span class="in">`$truth`</span> field defined by:</span>
<span id="cb101-296"><a href="#cb101-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-297"><a href="#cb101-297" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`target`</span> - the name of the variable in the data for which to estimate density</span>
<span id="cb101-298"><a href="#cb101-298" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`$truth`</span> - the values of the <span class="in">`target`</span> column (which is *not* the true density, which is always unknown)</span>
<span id="cb101-299"><a href="#cb101-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-300"><a href="#cb101-300" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train and Predict</span></span>
<span id="cb101-301"><a href="#cb101-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-302"><a href="#cb101-302" aria-hidden="true" tabindex="-1"></a>Density learners have <span class="in">`train`</span> and <span class="in">`predict`</span> methods, though being unsupervised, 'prediction' is actually 'estimation'.</span>
<span id="cb101-303"><a href="#cb101-303" aria-hidden="true" tabindex="-1"></a>In training, a <span class="in">`r ref_pkg("distr6")`</span> object is created,</span>
<span id="cb101-304"><a href="#cb101-304" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">see here</span><span class="co">](https://alan-turing-institute.github.io/distr6/)</span> for full tutorials on how to access the probability density function, <span class="in">`pdf`</span>, cumulative distribution function, <span class="in">`cdf`</span>, and other important fields and methods.</span>
<span id="cb101-305"><a href="#cb101-305" aria-hidden="true" tabindex="-1"></a>The predict method is simply a wrapper around <span class="in">`self$model$pdf`</span> and if available <span class="in">`self$model$cdf`</span>, i.e. evaluates the pdf/cdf at given points.</span>
<span id="cb101-306"><a href="#cb101-306" aria-hidden="true" tabindex="-1"></a>Note that in prediction the points to evaluate the pdf and cdf are determined by the <span class="in">`target`</span> column in the <span class="in">`r ref("TaskDens")`</span> object used for testing.</span>
<span id="cb101-307"><a href="#cb101-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-308"><a href="#cb101-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-008}</span></span>
<span id="cb101-309"><a href="#cb101-309" aria-hidden="true" tabindex="-1"></a><span class="co"># create task and learner</span></span>
<span id="cb101-310"><a href="#cb101-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-311"><a href="#cb101-311" aria-hidden="true" tabindex="-1"></a>task_faithful <span class="ot">=</span> TaskDens<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"eruptions"</span>, <span class="at">backend =</span> datasets<span class="sc">::</span>faithful<span class="sc">$</span>eruptions)</span>
<span id="cb101-312"><a href="#cb101-312" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"dens.hist"</span>)</span>
<span id="cb101-313"><a href="#cb101-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-314"><a href="#cb101-314" aria-hidden="true" tabindex="-1"></a><span class="co"># train/test split</span></span>
<span id="cb101-315"><a href="#cb101-315" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">=</span> <span class="fu">sample</span>(task_faithful<span class="sc">$</span>nrow, <span class="fl">0.8</span> <span class="sc">*</span> task_faithful<span class="sc">$</span>nrow)</span>
<span id="cb101-316"><a href="#cb101-316" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task_faithful<span class="sc">$</span>nrow), train_set)</span>
<span id="cb101-317"><a href="#cb101-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-318"><a href="#cb101-318" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting KDE and model inspection</span></span>
<span id="cb101-319"><a href="#cb101-319" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task_faithful, <span class="at">row_ids =</span> train_set)</span>
<span id="cb101-320"><a href="#cb101-320" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb101-321"><a href="#cb101-321" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(learner<span class="sc">$</span>model)</span>
<span id="cb101-322"><a href="#cb101-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-323"><a href="#cb101-323" aria-hidden="true" tabindex="-1"></a><span class="co"># make predictions for new data</span></span>
<span id="cb101-324"><a href="#cb101-324" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task_faithful, <span class="at">row_ids =</span> test_set)</span>
<span id="cb101-325"><a href="#cb101-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-326"><a href="#cb101-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-327"><a href="#cb101-327" aria-hidden="true" tabindex="-1"></a>Every <span class="in">`r ref("PredictionDens")`</span> object can estimate:</span>
<span id="cb101-328"><a href="#cb101-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-329"><a href="#cb101-329" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`pdf`</span> - probability density function</span>
<span id="cb101-330"><a href="#cb101-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-331"><a href="#cb101-331" aria-hidden="true" tabindex="-1"></a>Some learners can estimate:</span>
<span id="cb101-332"><a href="#cb101-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-333"><a href="#cb101-333" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`cdf`</span> - cumulative distribution function</span>
<span id="cb101-334"><a href="#cb101-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-335"><a href="#cb101-335" aria-hidden="true" tabindex="-1"></a><span class="fu">### Benchmark Experiment</span></span>
<span id="cb101-336"><a href="#cb101-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-337"><a href="#cb101-337" aria-hidden="true" tabindex="-1"></a>Finally, we conduct a small benchmark study on the <span class="in">`r ref("mlr_tasks_precip", text = "precip")`</span> task using some of the integrated survival learners:</span>
<span id="cb101-338"><a href="#cb101-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-339"><a href="#cb101-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-009}</span></span>
<span id="cb101-340"><a href="#cb101-340" aria-hidden="true" tabindex="-1"></a><span class="co"># some integrated learners</span></span>
<span id="cb101-341"><a href="#cb101-341" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"dens.hist"</span>, <span class="st">"dens.kde"</span>))</span>
<span id="cb101-342"><a href="#cb101-342" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(learners)</span>
<span id="cb101-343"><a href="#cb101-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-344"><a href="#cb101-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Logloss for probabilistic predictions</span></span>
<span id="cb101-345"><a href="#cb101-345" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"dens.logloss"</span>)</span>
<span id="cb101-346"><a href="#cb101-346" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(measure)</span>
<span id="cb101-347"><a href="#cb101-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-348"><a href="#cb101-348" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb101-349"><a href="#cb101-349" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)))</span>
<span id="cb101-350"><a href="#cb101-350" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measure)</span>
<span id="cb101-351"><a href="#cb101-351" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> measure)</span>
<span id="cb101-352"><a href="#cb101-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-353"><a href="#cb101-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-354"><a href="#cb101-354" aria-hidden="true" tabindex="-1"></a>The results of this experiment show that the sophisticated Penalized Density Estimator does not outperform the baseline histogram, but that the Kernel Density Estimator has at least consistently better (i.e. lower logloss) results.</span>
<span id="cb101-355"><a href="#cb101-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-356"><a href="#cb101-356" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatiotemporal Analysis {#spatiotemporal}</span></span>
<span id="cb101-357"><a href="#cb101-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-358"><a href="#cb101-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-010, include = FALSE}</span></span>
<span id="cb101-359"><a href="#cb101-359" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3spatiotempcv)</span>
<span id="cb101-360"><a href="#cb101-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-361"><a href="#cb101-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-362"><a href="#cb101-362" aria-hidden="true" tabindex="-1"></a>Data observations may entail reference information about spatial or temporal characteristics.</span>
<span id="cb101-363"><a href="#cb101-363" aria-hidden="true" tabindex="-1"></a>Spatial information is stored as coordinates, usually named "x" and "y" or "lat"/"lon".</span>
<span id="cb101-364"><a href="#cb101-364" aria-hidden="true" tabindex="-1"></a>Treating spatiotemporal data using non-spatial data methods can lead to over-optimistic performance estimates.</span>
<span id="cb101-365"><a href="#cb101-365" aria-hidden="true" tabindex="-1"></a>Hence, methods specifically designed to account for the special nature of spatiotemporal data are needed.</span>
<span id="cb101-366"><a href="#cb101-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-367"><a href="#cb101-367" aria-hidden="true" tabindex="-1"></a>In the <span class="in">`r mlr3`</span> framework, the following packages relate to this field:</span>
<span id="cb101-368"><a href="#cb101-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-369"><a href="#cb101-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`r mlr3spatiotempcv`</span> (biased-reduced performance estimation)</span>
<span id="cb101-370"><a href="#cb101-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`r mlr3spatial`</span> (spatial prediction support)</span>
<span id="cb101-371"><a href="#cb101-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-372"><a href="#cb101-372" aria-hidden="true" tabindex="-1"></a>The following (sub-)sections introduce the potential pitfalls of spatiotemporal data in machine learning and how to account for it.</span>
<span id="cb101-373"><a href="#cb101-373" aria-hidden="true" tabindex="-1"></a>Note that not all functionality will be covered, and that some of the used packages are still in early lifecycles.</span>
<span id="cb101-374"><a href="#cb101-374" aria-hidden="true" tabindex="-1"></a>If you want to contribute to one of the packages mentioned above, please contact <span class="co">[</span><span class="ot">Patrick Schratz</span><span class="co">](https://github.com/pat-s)</span>.</span>
<span id="cb101-375"><a href="#cb101-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-376"><a href="#cb101-376" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating a spatial Task {#spatial-task}</span></span>
<span id="cb101-377"><a href="#cb101-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-378"><a href="#cb101-378" aria-hidden="true" tabindex="-1"></a>To make use of spatial resampling methods, a {mlr3} task that is aware of its spatial characteristic needs to be created.</span>
<span id="cb101-379"><a href="#cb101-379" aria-hidden="true" tabindex="-1"></a>Two <span class="in">`Task`</span> child classes exist in {mlr3spatiotempcv} for this purpose:</span>
<span id="cb101-380"><a href="#cb101-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-381"><a href="#cb101-381" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`TaskClassifST`</span></span>
<span id="cb101-382"><a href="#cb101-382" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`TaskRegrST`</span></span>
<span id="cb101-383"><a href="#cb101-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-384"><a href="#cb101-384" aria-hidden="true" tabindex="-1"></a>To create one of these, you have multiple options:</span>
<span id="cb101-385"><a href="#cb101-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-386"><a href="#cb101-386" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use the constructor of the <span class="in">`Task`</span> directly via <span class="in">`$new()`</span> - this only works for data.table backends (!)</span>
<span id="cb101-387"><a href="#cb101-387" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use the <span class="in">`as_task_*`</span> converters (e.g. if your data is stored in an <span class="in">`sf`</span> object)</span>
<span id="cb101-388"><a href="#cb101-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-389"><a href="#cb101-389" aria-hidden="true" tabindex="-1"></a>We recommend the latter, as the <span class="in">`as_task_*`</span> converters aim to make task construction easier, e.g., by creating the <span class="in">`DataBackend`</span> (which is required to create a Task in {mlr3}) automatically and setting the <span class="in">`crs`</span> and <span class="in">`coordinate_names`</span> fields.</span>
<span id="cb101-390"><a href="#cb101-390" aria-hidden="true" tabindex="-1"></a>Let's assume your (point) data is stored in with an <span class="in">`sf`</span> object, which is a common scenario for spatial analysis in R.</span>
<span id="cb101-391"><a href="#cb101-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-392"><a href="#cb101-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-011}</span></span>
<span id="cb101-393"><a href="#cb101-393" aria-hidden="true" tabindex="-1"></a><span class="co"># create 'sf' object</span></span>
<span id="cb101-394"><a href="#cb101-394" aria-hidden="true" tabindex="-1"></a>data_sf <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(ecuador, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="dv">32717</span>)</span>
<span id="cb101-395"><a href="#cb101-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-396"><a href="#cb101-396" aria-hidden="true" tabindex="-1"></a><span class="co"># create `TaskClassifST` from `sf` object</span></span>
<span id="cb101-397"><a href="#cb101-397" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(data_sf, <span class="at">id =</span> <span class="st">"ecuador_task"</span>, <span class="at">target =</span> <span class="st">"slides"</span>, <span class="at">positive =</span> <span class="st">"TRUE"</span>)</span>
<span id="cb101-398"><a href="#cb101-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-399"><a href="#cb101-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-400"><a href="#cb101-400" aria-hidden="true" tabindex="-1"></a>You can also use a plain <span class="in">`data.frame`</span>.</span>
<span id="cb101-401"><a href="#cb101-401" aria-hidden="true" tabindex="-1"></a>In this case, <span class="in">`crs`</span> and <span class="in">`coordinate_names`</span> need to be passed along explicitly as they cannot be inferred directly from the <span class="in">`sf`</span> object:</span>
<span id="cb101-402"><a href="#cb101-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-403"><a href="#cb101-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-012}</span></span>
<span id="cb101-404"><a href="#cb101-404" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(ecuador, <span class="at">id =</span> <span class="st">"ecuador_task"</span>, <span class="at">target =</span> <span class="st">"slides"</span>,</span>
<span id="cb101-405"><a href="#cb101-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">positive =</span> <span class="st">"TRUE"</span>, <span class="at">coordinate_names =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="dv">32717</span>)</span>
<span id="cb101-406"><a href="#cb101-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-407"><a href="#cb101-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-408"><a href="#cb101-408" aria-hidden="true" tabindex="-1"></a>The <span class="in">`*ST`</span> task family prints a subset of the coordinates by default:</span>
<span id="cb101-409"><a href="#cb101-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-410"><a href="#cb101-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-013}</span></span>
<span id="cb101-411"><a href="#cb101-411" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task)</span>
<span id="cb101-412"><a href="#cb101-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-413"><a href="#cb101-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-414"><a href="#cb101-414" aria-hidden="true" tabindex="-1"></a>All <span class="in">`*ST`</span> tasks can be treated as their super class equivalents <span class="in">`TaskClassif`</span> or <span class="in">`TaskRegr`</span> in subsequent {mlr3} modeling steps.</span>
<span id="cb101-415"><a href="#cb101-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-416"><a href="#cb101-416" aria-hidden="true" tabindex="-1"></a><span class="fu">### Autocorrelation {#autocorrelation}</span></span>
<span id="cb101-417"><a href="#cb101-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-418"><a href="#cb101-418" aria-hidden="true" tabindex="-1"></a>Data which includes spatial or temporal information requires special treatment in machine learning (similar to <span class="co">[</span><span class="ot">survival</span><span class="co">](#survival)</span>, <span class="co">[</span><span class="ot">ordinal</span><span class="co">](#ordinal)</span> and other task types listed in the <span class="co">[</span><span class="ot">special tasks</span><span class="co">](#special-tasks)</span> chapter).</span>
<span id="cb101-419"><a href="#cb101-419" aria-hidden="true" tabindex="-1"></a>In contrast to non-spatial/non-temporal data, observations inherit a natural grouping, either in space or time or in both space and time <span class="co">[</span><span class="ot">@legendre1993</span><span class="co">]</span>.</span>
<span id="cb101-420"><a href="#cb101-420" aria-hidden="true" tabindex="-1"></a>This grouping causes observations to be autocorrelated, either in space (spatial autocorrelation (SAC)), time (temporal autocorrelation (TAC)) or both space and time (spatiotemporal autocorrelation (STAC)).</span>
<span id="cb101-421"><a href="#cb101-421" aria-hidden="true" tabindex="-1"></a>For simplicity, the acronym STAC is used as a generic term in the following chapter for all the different characteristics introduced above.</span>
<span id="cb101-422"><a href="#cb101-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-423"><a href="#cb101-423" aria-hidden="true" tabindex="-1"></a>*What effects does STAC have in statistical/machine learning?*</span>
<span id="cb101-424"><a href="#cb101-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-425"><a href="#cb101-425" aria-hidden="true" tabindex="-1"></a>The overarching problem is that STAC violates the assumption that the observations in the train and test datasets are independent <span class="co">[</span><span class="ot">@hastie2001</span><span class="co">]</span>.</span>
<span id="cb101-426"><a href="#cb101-426" aria-hidden="true" tabindex="-1"></a>If this assumption is violated, the reliability of the resulting performance estimates, for example retrieved via cross-validation, is decreased.</span>
<span id="cb101-427"><a href="#cb101-427" aria-hidden="true" tabindex="-1"></a>The magnitude of this decrease is linked to the magnitude of STAC in the dataset, which cannot be determined easily.</span>
<span id="cb101-428"><a href="#cb101-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-429"><a href="#cb101-429" aria-hidden="true" tabindex="-1"></a>One approach to account for the existence of STAC is to use dedicated resampling methods.</span>
<span id="cb101-430"><a href="#cb101-430" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3spatiotempcv`</span> provides access to the most frequently used spatiotemporal resampling methods.</span>
<span id="cb101-431"><a href="#cb101-431" aria-hidden="true" tabindex="-1"></a>The following example showcases how a spatial dataset can be used to retrieve a bias-reduced performance estimate of a learner.</span>
<span id="cb101-432"><a href="#cb101-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-433"><a href="#cb101-433" aria-hidden="true" tabindex="-1"></a>The following examples use the <span class="in">`r ref("mlr_tasks_ecuador", text = "ecuador")`</span> dataset created by <span class="co">[</span><span class="ot">Jannes Muenchow</span><span class="co">](https://scholar.google.com/citations?user=Slq94Y4AAAAJ&amp;hl=de&amp;authuser=1&amp;oi=ao)</span>.</span>
<span id="cb101-434"><a href="#cb101-434" aria-hidden="true" tabindex="-1"></a>It contains information on the occurrence of landslides (binary) in the Andes of Southern Ecuador.</span>
<span id="cb101-435"><a href="#cb101-435" aria-hidden="true" tabindex="-1"></a>The landslides were mapped from aerial photos taken in 2000.</span>
<span id="cb101-436"><a href="#cb101-436" aria-hidden="true" tabindex="-1"></a>The dataset is well suited to serve as an example because it it relatively small and of course due to the spatial nature of the observations.</span>
<span id="cb101-437"><a href="#cb101-437" aria-hidden="true" tabindex="-1"></a>Please refer to @muenchow2012 for a detailed description of the dataset.</span>
<span id="cb101-438"><a href="#cb101-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-439"><a href="#cb101-439" aria-hidden="true" tabindex="-1"></a>To account for the spatial autocorrelation probably present in the landslide data, we will make use one of the most used spatial partitioning methods, a cluster-based k-means grouping <span class="co">[</span><span class="ot">@brenning2012</span><span class="co">]</span>, (<span class="in">`r ref("mlr_resamplings_spcv_coords", text = "spcv_coords")`</span> in <span class="in">`r mlr3spatiotempcv`</span>).</span>
<span id="cb101-440"><a href="#cb101-440" aria-hidden="true" tabindex="-1"></a>This method performs a clustering in 2D space which contrasts with the commonly used random partitioning for non-spatial data.</span>
<span id="cb101-441"><a href="#cb101-441" aria-hidden="true" tabindex="-1"></a>The grouping has the effect that train and test data are more separated in space as they would be by conducting a random partitioning, thereby reducing the effect of STAC.</span>
<span id="cb101-442"><a href="#cb101-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-443"><a href="#cb101-443" aria-hidden="true" tabindex="-1"></a>By contrast, when using the classical random partitioning approach with spatial data, train and test observations would be located side-by-side across the full study area (a visual example is provided further below).</span>
<span id="cb101-444"><a href="#cb101-444" aria-hidden="true" tabindex="-1"></a>This leads to a high similarity between train and test sets, resulting in "better" but biased performance estimates in every fold of a CV compared to the spatial CV approach.</span>
<span id="cb101-445"><a href="#cb101-445" aria-hidden="true" tabindex="-1"></a>However, these low error rates are mainly caused due to the STAC in the observations and the lack of appropriate partitioning methods and not by the power of the fitted model.</span>
<span id="cb101-446"><a href="#cb101-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-447"><a href="#cb101-447" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatiotemporal Cross-Validation and Partitioning {#spatiotemp-cv}</span></span>
<span id="cb101-448"><a href="#cb101-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-449"><a href="#cb101-449" aria-hidden="true" tabindex="-1"></a>One part of spatiotemporal machine learning is dealing with the spatiotemporal components of the data during performance estimation.</span>
<span id="cb101-450"><a href="#cb101-450" aria-hidden="true" tabindex="-1"></a>Performance is commonly estimated via cross-validation and <span class="in">`r mlr3spatiotempcv`</span> provides specialized resamplings methods for spatiotemporal data.</span>
<span id="cb101-451"><a href="#cb101-451" aria-hidden="true" tabindex="-1"></a>The following chapters showcases how these methods can be applied and how they differ compared to non-spatial resampling methods, e.g. random partitioning.</span>
<span id="cb101-452"><a href="#cb101-452" aria-hidden="true" tabindex="-1"></a>In addition, examples which show how resamplings with spatial information can be visualized using <span class="in">`r mlr3spatiotempcv`</span>.</span>
<span id="cb101-453"><a href="#cb101-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-454"><a href="#cb101-454" aria-hidden="true" tabindex="-1"></a>Besides performance estimation, prediction on spatiotemporal data is another challenging task.</span>
<span id="cb101-455"><a href="#cb101-455" aria-hidden="true" tabindex="-1"></a>See @sec-spatial-prediction for more information about how this topic is handled within the mlr3 framework.</span>
<span id="cb101-456"><a href="#cb101-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-457"><a href="#cb101-457" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatial CV vs. Non-Spatial CV {#sp-vs-nsp-cv}</span></span>
<span id="cb101-458"><a href="#cb101-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-459"><a href="#cb101-459" aria-hidden="true" tabindex="-1"></a>In the following a spatial and non-spatial CV will be applied to showcase the mentioned performance differences.</span>
<span id="cb101-460"><a href="#cb101-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-461"><a href="#cb101-461" aria-hidden="true" tabindex="-1"></a>The performance of a simple classification tree (<span class="in">`"classif.rpart"`</span>) is evaluated on a random partitioning (<span class="in">`r ref("mlr_resamplings_repeated_cv", text = "repeated_cv")`</span>) with four folds and two repetitions.</span>
<span id="cb101-462"><a href="#cb101-462" aria-hidden="true" tabindex="-1"></a>The chosen evaluation measure is "classification error" (<span class="in">`"classif.ce"`</span>).</span>
<span id="cb101-463"><a href="#cb101-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-464"><a href="#cb101-464" aria-hidden="true" tabindex="-1"></a>For the spatial example, <span class="in">`r ref("mlr_resamplings_repeated_spcv_coords", text = "repeated_spcv_coords")`</span> is chosen whereas <span class="in">`r ref("mlr_resamplings_repeated_cv", text = "repeated_cv")`</span> represents the non-spatial example.</span>
<span id="cb101-465"><a href="#cb101-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-466"><a href="#cb101-466" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb101-467"><a href="#cb101-467" aria-hidden="true" tabindex="-1"></a>The selection of <span class="in">`r ref("mlr_resamplings_repeated_spcv_coords", text = "repeated_spcv_coords")`</span> in this example is arbitrary.</span>
<span id="cb101-468"><a href="#cb101-468" aria-hidden="true" tabindex="-1"></a>For your use case, you might want to use a different spatial partitioning method (but not necessarily!).</span>
<span id="cb101-469"><a href="#cb101-469" aria-hidden="true" tabindex="-1"></a>Have a look at the <span class="co">[</span><span class="ot">"Getting Started"</span><span class="co">](https://mlr3spatiotempcv.mlr-org.com/dev/articles/mlr3spatiotempcv.html#resampling-methods)</span> vignette of <span class="in">`r mlr3spatiotempcv`</span> to see all available methods and choose one which **fits your data and its prediction purpose**.</span>
<span id="cb101-470"><a href="#cb101-470" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-471"><a href="#cb101-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-472"><a href="#cb101-472" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Non-Spatial CV {#nsp-cv}</span></span>
<span id="cb101-473"><a href="#cb101-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-474"><a href="#cb101-474" aria-hidden="true" tabindex="-1"></a>In this example the <span class="in">`r ref("mlr_tasks_ecuador", text = "ecuador")`</span> example task is taken to estimate the performance of an <span class="in">`rpart`</span> learner with fixed parameters on it.</span>
<span id="cb101-475"><a href="#cb101-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-476"><a href="#cb101-476" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-477"><a href="#cb101-477" aria-hidden="true" tabindex="-1"></a>In practice you usually might want to tune the hyperparameters of the learner in this case and apply a nested CV in which the inner loop is used for hyperparameter tuning.</span>
<span id="cb101-478"><a href="#cb101-478" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-479"><a href="#cb101-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-480"><a href="#cb101-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-014}</span></span>
<span id="cb101-481"><a href="#cb101-481" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb101-482"><a href="#cb101-482" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3spatiotempcv"</span>)</span>
<span id="cb101-483"><a href="#cb101-483" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb101-484"><a href="#cb101-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-485"><a href="#cb101-485" aria-hidden="true" tabindex="-1"></a><span class="co"># be less verbose</span></span>
<span id="cb101-486"><a href="#cb101-486" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb101-487"><a href="#cb101-487" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb101-488"><a href="#cb101-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-489"><a href="#cb101-489" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb101-490"><a href="#cb101-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-491"><a href="#cb101-491" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">maxdepth =</span> <span class="dv">3</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb101-492"><a href="#cb101-492" aria-hidden="true" tabindex="-1"></a>resampling_nsp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_cv"</span>, <span class="at">folds =</span> <span class="dv">4</span>, <span class="at">repeats =</span> <span class="dv">2</span>)</span>
<span id="cb101-493"><a href="#cb101-493" aria-hidden="true" tabindex="-1"></a>rr_nsp <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb101-494"><a href="#cb101-494" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task, <span class="at">learner =</span> learner,</span>
<span id="cb101-495"><a href="#cb101-495" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling_nsp)</span>
<span id="cb101-496"><a href="#cb101-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-497"><a href="#cb101-497" aria-hidden="true" tabindex="-1"></a>rr_nsp<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>))</span>
<span id="cb101-498"><a href="#cb101-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-499"><a href="#cb101-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-500"><a href="#cb101-500" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Spatial CV {#sp-cv}</span></span>
<span id="cb101-501"><a href="#cb101-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-502"><a href="#cb101-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-015}</span></span>
<span id="cb101-503"><a href="#cb101-503" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb101-504"><a href="#cb101-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-505"><a href="#cb101-505" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">maxdepth =</span> <span class="dv">3</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb101-506"><a href="#cb101-506" aria-hidden="true" tabindex="-1"></a>resampling_sp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"repeated_spcv_coords"</span>, <span class="at">folds =</span> <span class="dv">4</span>, <span class="at">repeats =</span> <span class="dv">2</span>)</span>
<span id="cb101-507"><a href="#cb101-507" aria-hidden="true" tabindex="-1"></a>rr_sp <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb101-508"><a href="#cb101-508" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task, <span class="at">learner =</span> learner,</span>
<span id="cb101-509"><a href="#cb101-509" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling_sp)</span>
<span id="cb101-510"><a href="#cb101-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-511"><a href="#cb101-511" aria-hidden="true" tabindex="-1"></a>rr_sp<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>))</span>
<span id="cb101-512"><a href="#cb101-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-513"><a href="#cb101-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-514"><a href="#cb101-514" aria-hidden="true" tabindex="-1"></a>Here, the performance of the classification tree learner is around 7 percentage points worse when using Spatial Cross-Validation (SpCV) compared to Non-Spatial Cross-Validation (NSpCV).</span>
<span id="cb101-515"><a href="#cb101-515" aria-hidden="true" tabindex="-1"></a>The resulting difference in performance is variable as it depends on the dataset, the magnitude of STAC and the learner itself.</span>
<span id="cb101-516"><a href="#cb101-516" aria-hidden="true" tabindex="-1"></a>For algorithms with a higher tendency of overfitting to the training set, the difference between the two methods will be larger.</span>
<span id="cb101-517"><a href="#cb101-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-518"><a href="#cb101-518" aria-hidden="true" tabindex="-1"></a>Now, what does it mean that the performance in the spatial case is worse?</span>
<span id="cb101-519"><a href="#cb101-519" aria-hidden="true" tabindex="-1"></a>Should you ditch SpCV and keep using non-spatial partitioning?</span>
<span id="cb101-520"><a href="#cb101-520" aria-hidden="true" tabindex="-1"></a>The answer is **NO**.</span>
<span id="cb101-521"><a href="#cb101-521" aria-hidden="true" tabindex="-1"></a>The reason why the spatial partitioning scenario results in a lower predictive performance is because throughout the CV the model has been trained on data that is less similar than the test data compared against the non-spatial scenario.</span>
<span id="cb101-522"><a href="#cb101-522" aria-hidden="true" tabindex="-1"></a>Or in other words: in the non-spatial scenario, train and test data are almost identical (due to spatial autocorrelation).</span>
<span id="cb101-523"><a href="#cb101-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-524"><a href="#cb101-524" aria-hidden="true" tabindex="-1"></a>This means that the result from the SpCV setting is more close to the true predictive power of the model - whereas the result from non-spatial CV is overoptimistic and biased.</span>
<span id="cb101-525"><a href="#cb101-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-526"><a href="#cb101-526" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb101-527"><a href="#cb101-527" aria-hidden="true" tabindex="-1"></a>The result of the SpCV setting is by no means the absolute truth - it is also biased, but (most often) less compared to the non-spatial setting.</span>
<span id="cb101-528"><a href="#cb101-528" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-529"><a href="#cb101-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-530"><a href="#cb101-530" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualization of Spatiotemporal Partitions {#vis-spt-partitions}</span></span>
<span id="cb101-531"><a href="#cb101-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-532"><a href="#cb101-532" aria-hidden="true" tabindex="-1"></a>Every partitioning method in <span class="in">`r mlr3spatiotempcv`</span> comes with S3 methods for <span class="in">`plot()`</span> and <span class="in">`autoplot()`</span> to visualize the created groups.</span>
<span id="cb101-533"><a href="#cb101-533" aria-hidden="true" tabindex="-1"></a>In a 2D space <span class="in">`r ref_pkg("ggplot2")`</span> is used in the backgroudn while for spatiotemporal methods 3D visualizations via <span class="in">`r ref_pkg("plotly")`</span> are created.</span>
<span id="cb101-534"><a href="#cb101-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-535"><a href="#cb101-535" aria-hidden="true" tabindex="-1"></a>The following examples shows how the <span class="in">`resampling_sp`</span> object from the previous example can be visualized.</span>
<span id="cb101-536"><a href="#cb101-536" aria-hidden="true" tabindex="-1"></a>In this case I want to look at the first four partitions of the first repetition.</span>
<span id="cb101-537"><a href="#cb101-537" aria-hidden="true" tabindex="-1"></a>The point size is adjusted via argument <span class="in">`size`</span>.</span>
<span id="cb101-538"><a href="#cb101-538" aria-hidden="true" tabindex="-1"></a>After the plot creation, additional <span class="in">`scale_*`</span> calls are used to adjust the coordinate labels on the x and y axes, respectively.</span>
<span id="cb101-539"><a href="#cb101-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-540"><a href="#cb101-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-016, fig.asp=0.8}</span></span>
<span id="cb101-541"><a href="#cb101-541" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(resampling_sp, task, <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">*</span></span>
<span id="cb101-542"><a href="#cb101-542" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">3.97</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">0.01</span>)) <span class="sc">*</span></span>
<span id="cb101-543"><a href="#cb101-543" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.06</span>, <span class="sc">-</span><span class="fl">79.08</span>, <span class="sc">-</span><span class="fl">0.02</span>))</span>
<span id="cb101-544"><a href="#cb101-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-545"><a href="#cb101-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-546"><a href="#cb101-546" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-547"><a href="#cb101-547" aria-hidden="true" tabindex="-1"></a>Note that setting the correct CRS for the given data is important which is done **during task creation**.</span>
<span id="cb101-548"><a href="#cb101-548" aria-hidden="true" tabindex="-1"></a>Spatial offsets of up to multiple meters may occur if the wrong CRS is supplied initially.</span>
<span id="cb101-549"><a href="#cb101-549" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-550"><a href="#cb101-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-551"><a href="#cb101-551" aria-hidden="true" tabindex="-1"></a>This example used a built-in mlr3 task via <span class="in">`r ref("tsk()")`</span>.</span>
<span id="cb101-552"><a href="#cb101-552" aria-hidden="true" tabindex="-1"></a>In practice however, one needs to create a spatiotemporal task via <span class="in">`r ref("TaskClassifST")`</span>/<span class="in">`r ref("TaskRegrST")`</span> and set the <span class="in">`crs`</span> argument (unless a <span class="in">`sf`</span> object is handed over).</span>
<span id="cb101-553"><a href="#cb101-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-554"><a href="#cb101-554" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3spatiotempcv`</span> can also visualize non-spatial partitonings.</span>
<span id="cb101-555"><a href="#cb101-555" aria-hidden="true" tabindex="-1"></a>This helps to visually compare differences.</span>
<span id="cb101-556"><a href="#cb101-556" aria-hidden="true" tabindex="-1"></a>Let's use the objects from the previous example again, this time <span class="in">`resampling_nsp`</span>.</span>
<span id="cb101-557"><a href="#cb101-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-558"><a href="#cb101-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-017, fig.asp=0.8}</span></span>
<span id="cb101-559"><a href="#cb101-559" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(resampling_nsp, task, <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">*</span></span>
<span id="cb101-560"><a href="#cb101-560" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">3.97</span>, <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">0.01</span>)) <span class="sc">*</span></span>
<span id="cb101-561"><a href="#cb101-561" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.06</span>, <span class="sc">-</span><span class="fl">79.08</span>, <span class="sc">-</span><span class="fl">0.02</span>))</span>
<span id="cb101-562"><a href="#cb101-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-563"><a href="#cb101-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-564"><a href="#cb101-564" aria-hidden="true" tabindex="-1"></a>The visualization show very well how close train and test observations are located next to each other.</span>
<span id="cb101-565"><a href="#cb101-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-566"><a href="#cb101-566" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatial Block Visualization {#vis-spatial-block}</span></span>
<span id="cb101-567"><a href="#cb101-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-568"><a href="#cb101-568" aria-hidden="true" tabindex="-1"></a>This examples showcases another SpCV method: <span class="in">`r ref("mlr_resamplings_spcv_block", text = "spcv_block")`</span>.</span>
<span id="cb101-569"><a href="#cb101-569" aria-hidden="true" tabindex="-1"></a>This method makes use of rectangular blocks to divide the study area into equally-sized parts.</span>
<span id="cb101-570"><a href="#cb101-570" aria-hidden="true" tabindex="-1"></a>{mlr3spatiotempcv} has support for visualizing the created blocks and displaying their respective fold ID to get a better understanding how the final folds were composed out of the partitions.</span>
<span id="cb101-571"><a href="#cb101-571" aria-hidden="true" tabindex="-1"></a>E.g. the "Fold 1 Repetition 1" plot shows that the test set is composed out of two "blocks" with the ID "1" in this case.</span>
<span id="cb101-572"><a href="#cb101-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-573"><a href="#cb101-573" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb101-574"><a href="#cb101-574" aria-hidden="true" tabindex="-1"></a>The use of <span class="in">`range = 1000L`</span> is arbitrary here and should not be copy-pasted into a real application.</span>
<span id="cb101-575"><a href="#cb101-575" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-576"><a href="#cb101-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-577"><a href="#cb101-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-018}</span></span>
<span id="cb101-578"><a href="#cb101-578" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"ecuador"</span>)</span>
<span id="cb101-579"><a href="#cb101-579" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"spcv_block"</span>, <span class="at">range =</span> 1000L)</span>
<span id="cb101-580"><a href="#cb101-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-581"><a href="#cb101-581" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize train/test splits of multiple folds</span></span>
<span id="cb101-582"><a href="#cb101-582" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(resampling, task, <span class="at">size =</span> <span class="fl">0.7</span>,</span>
<span id="cb101-583"><a href="#cb101-583" aria-hidden="true" tabindex="-1"></a>  <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">show_blocks =</span> <span class="cn">TRUE</span>, <span class="at">show_labels =</span> <span class="cn">TRUE</span>) <span class="sc">*</span></span>
<span id="cb101-584"><a href="#cb101-584" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">79.085</span>, <span class="sc">-</span><span class="fl">79.055</span>, <span class="fl">0.02</span>))</span>
<span id="cb101-585"><a href="#cb101-585" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-586"><a href="#cb101-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-587"><a href="#cb101-587" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatiotemporal Visualization {#vis-spatiotemp}</span></span>
<span id="cb101-588"><a href="#cb101-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-589"><a href="#cb101-589" aria-hidden="true" tabindex="-1"></a>When going spatiotemporal, two dimensions are not enough anymore.</span>
<span id="cb101-590"><a href="#cb101-590" aria-hidden="true" tabindex="-1"></a>To visualize space and time together, a 3D solution is needed.</span>
<span id="cb101-591"><a href="#cb101-591" aria-hidden="true" tabindex="-1"></a>{mlr3spatiotempcv} makes use of <span class="in">`r ref_pkg("plotly")`</span> for this purpose.</span>
<span id="cb101-592"><a href="#cb101-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-593"><a href="#cb101-593" aria-hidden="true" tabindex="-1"></a>The following examples uses a modified version of the <span class="in">`cookfarm_mlr3`</span> task for showcasing reasons.</span>
<span id="cb101-594"><a href="#cb101-594" aria-hidden="true" tabindex="-1"></a>By adjusting some levels, the individual partitions can be recognized very well.</span>
<span id="cb101-595"><a href="#cb101-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-596"><a href="#cb101-596" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-597"><a href="#cb101-597" aria-hidden="true" tabindex="-1"></a>In practice, you should not modify your data to achieve "good looking" visualizations as done in this example.</span>
<span id="cb101-598"><a href="#cb101-598" aria-hidden="true" tabindex="-1"></a>This is only done for (visual) demonstration purposes.</span>
<span id="cb101-599"><a href="#cb101-599" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-600"><a href="#cb101-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-601"><a href="#cb101-601" aria-hidden="true" tabindex="-1"></a>In the following we use the <span class="in">`r ref("mlr_resamplings_sptcv_cstf", text = "sptcv_cstf")`</span> method after @meyer2018.</span>
<span id="cb101-602"><a href="#cb101-602" aria-hidden="true" tabindex="-1"></a>Only the temporal variable is used in this first example, denoted by setting the column role "time" to variable "Date".</span>
<span id="cb101-603"><a href="#cb101-603" aria-hidden="true" tabindex="-1"></a>This column role is then picked up by the resampling method.</span>
<span id="cb101-604"><a href="#cb101-604" aria-hidden="true" tabindex="-1"></a>Last, <span class="in">`autoplot()`</span> is called with an explicit definition of <span class="in">`plot3D = TRUE`</span>.</span>
<span id="cb101-605"><a href="#cb101-605" aria-hidden="true" tabindex="-1"></a>This is because <span class="in">`r ref("mlr_resamplings_sptcv_cstf", text = "sptcv_cstf")`</span> can also be visualized in 2D (which only makes sense if the "space" column role is used for partitioning).</span>
<span id="cb101-606"><a href="#cb101-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-607"><a href="#cb101-607" aria-hidden="true" tabindex="-1"></a>Last, <span class="in">`sample_fold_n`</span> is used to take a stratified random sample from all partitions.</span>
<span id="cb101-608"><a href="#cb101-608" aria-hidden="true" tabindex="-1"></a>The call to <span class="in">`r ref("plotly::layout()")`</span> only adjusts the default viewing angle of the plot - in interactive visualizations, this is not needed and the viewing angle can be adjusted with the mouse.</span>
<span id="cb101-609"><a href="#cb101-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-610"><a href="#cb101-610" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb101-611"><a href="#cb101-611" aria-hidden="true" tabindex="-1"></a>This is done to reduce the final plot size and keep things small for demos like this one.</span>
<span id="cb101-612"><a href="#cb101-612" aria-hidden="true" tabindex="-1"></a>We don't recommend doing this in actual studies - unless you prominently communicate this alongside the resulting plot.</span>
<span id="cb101-613"><a href="#cb101-613" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-614"><a href="#cb101-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-615"><a href="#cb101-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-019, eval = FALSE}</span></span>
<span id="cb101-616"><a href="#cb101-616" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> cookfarm_mlr3</span>
<span id="cb101-617"><a href="#cb101-617" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb101-618"><a href="#cb101-618" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Date <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">rep</span>(<span class="fu">c</span>(</span>
<span id="cb101-619"><a href="#cb101-619" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2020-01-01"</span>, <span class="st">"2020-02-01"</span>, <span class="st">"2020-03-01"</span>, <span class="st">"2020-04-01"</span>,</span>
<span id="cb101-620"><a href="#cb101-620" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2020-05-01"</span>), <span class="at">times =</span> <span class="dv">1</span>, <span class="at">each =</span> <span class="dv">35768</span>))</span>
<span id="cb101-621"><a href="#cb101-621" aria-hidden="true" tabindex="-1"></a>task_spt <span class="ot">=</span> <span class="fu">as_task_regr_st</span>(data,</span>
<span id="cb101-622"><a href="#cb101-622" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"cookfarm"</span>, <span class="at">target =</span> <span class="st">"PHIHOX"</span>,</span>
<span id="cb101-623"><a href="#cb101-623" aria-hidden="true" tabindex="-1"></a>  <span class="at">coordinate_names =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">coords_as_features =</span> <span class="cn">FALSE</span>,</span>
<span id="cb101-624"><a href="#cb101-624" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">26911</span>)</span>
<span id="cb101-625"><a href="#cb101-625" aria-hidden="true" tabindex="-1"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"Date"</span>, <span class="at">roles =</span> <span class="st">"time"</span>)</span>
<span id="cb101-626"><a href="#cb101-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-627"><a href="#cb101-627" aria-hidden="true" tabindex="-1"></a>rsmp_cstf_time <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"sptcv_cstf"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb101-628"><a href="#cb101-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-629"><a href="#cb101-629" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_time,</span>
<span id="cb101-630"><a href="#cb101-630" aria-hidden="true" tabindex="-1"></a>  <span class="at">fold_id =</span> <span class="dv">5</span>, <span class="at">task =</span> task_spt, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-631"><a href="#cb101-631" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_fold_n =</span> 3000L</span>
<span id="cb101-632"><a href="#cb101-632" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-633"><a href="#cb101-633" aria-hidden="true" tabindex="-1"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(plot, <span class="at">scene =</span> <span class="fu">list</span>(<span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>))))</span>
<span id="cb101-634"><a href="#cb101-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-635"><a href="#cb101-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-636"><a href="#cb101-636" aria-hidden="true" tabindex="-1"></a>If both space and time are used for partitioning in <span class="in">`r ref("mlr_resamplings_sptcv_cstf", text = "sptcv_cstf")`</span>, the visualization becomes even more powerful as it allows to also show the observations which are omitted, i.e., not being used in either train and test sets for a specific fold.</span>
<span id="cb101-637"><a href="#cb101-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-638"><a href="#cb101-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-020, eval = FALSE}</span></span>
<span id="cb101-639"><a href="#cb101-639" aria-hidden="true" tabindex="-1"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"SOURCEID"</span>, <span class="at">roles =</span> <span class="st">"space"</span>)</span>
<span id="cb101-640"><a href="#cb101-640" aria-hidden="true" tabindex="-1"></a>task_spt<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"Date"</span>, <span class="at">roles =</span> <span class="st">"time"</span>)</span>
<span id="cb101-641"><a href="#cb101-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-642"><a href="#cb101-642" aria-hidden="true" tabindex="-1"></a>rsmp_cstf_space_time <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"sptcv_cstf"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb101-643"><a href="#cb101-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-644"><a href="#cb101-644" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_space_time,</span>
<span id="cb101-645"><a href="#cb101-645" aria-hidden="true" tabindex="-1"></a>  <span class="at">fold_id =</span> <span class="dv">4</span>, <span class="at">task =</span> task_spt, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-646"><a href="#cb101-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_omitted =</span> <span class="cn">TRUE</span>, <span class="at">sample_fold_n =</span> 3000L)</span>
<span id="cb101-647"><a href="#cb101-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-648"><a href="#cb101-648" aria-hidden="true" tabindex="-1"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(plot, <span class="at">scene =</span> <span class="fu">list</span>(<span class="at">camera =</span></span>
<span id="cb101-649"><a href="#cb101-649" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))))</span>
<span id="cb101-650"><a href="#cb101-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-651"><a href="#cb101-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-652"><a href="#cb101-652" aria-hidden="true" tabindex="-1"></a>Combining multiple spatiotemporal plots with <span class="in">`r ref("plotly::layout()")`</span> is possible but somewhat cumbersome.</span>
<span id="cb101-653"><a href="#cb101-653" aria-hidden="true" tabindex="-1"></a>First, a list of plots containing the individuals plots must be created.</span>
<span id="cb101-654"><a href="#cb101-654" aria-hidden="true" tabindex="-1"></a>These plots can then be passed to <span class="in">`r ref("plotly::subplot()")`</span>.</span>
<span id="cb101-655"><a href="#cb101-655" aria-hidden="true" tabindex="-1"></a>This return is then passed to <span class="in">`r ref("plotly::layout()")`</span>.</span>
<span id="cb101-656"><a href="#cb101-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-657"><a href="#cb101-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-021, eval = FALSE}</span></span>
<span id="cb101-658"><a href="#cb101-658" aria-hidden="true" tabindex="-1"></a>pl <span class="ot">=</span> <span class="fu">autoplot</span>(rsmp_cstf_space_time, <span class="at">task =</span> task_spt,</span>
<span id="cb101-659"><a href="#cb101-659" aria-hidden="true" tabindex="-1"></a>  <span class="at">fold_id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), <span class="at">point_size =</span> <span class="dv">3</span>,</span>
<span id="cb101-660"><a href="#cb101-660" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis_label_fontsize =</span> <span class="dv">10</span>, <span class="at">plot3D =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-661"><a href="#cb101-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_fold_n =</span> 3000L, <span class="at">show_omitted =</span> <span class="cn">TRUE</span></span>
<span id="cb101-662"><a href="#cb101-662" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-663"><a href="#cb101-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-664"><a href="#cb101-664" aria-hidden="true" tabindex="-1"></a><span class="co"># Warnings can be ignored</span></span>
<span id="cb101-665"><a href="#cb101-665" aria-hidden="true" tabindex="-1"></a>pl_subplot <span class="ot">=</span> plotly<span class="sc">::</span><span class="fu">subplot</span>(pl)</span>
<span id="cb101-666"><a href="#cb101-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-667"><a href="#cb101-667" aria-hidden="true" tabindex="-1"></a>plotly<span class="sc">::</span><span class="fu">layout</span>(pl_subplot,</span>
<span id="cb101-668"><a href="#cb101-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Individual Folds"</span>,</span>
<span id="cb101-669"><a href="#cb101-669" aria-hidden="true" tabindex="-1"></a>  <span class="at">scene =</span> <span class="fu">list</span>(</span>
<span id="cb101-670"><a href="#cb101-670" aria-hidden="true" tabindex="-1"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)),</span>
<span id="cb101-671"><a href="#cb101-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb101-672"><a href="#cb101-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.20</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb101-673"><a href="#cb101-673" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb101-674"><a href="#cb101-674" aria-hidden="true" tabindex="-1"></a>  <span class="at">scene2 =</span> <span class="fu">list</span>(</span>
<span id="cb101-675"><a href="#cb101-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)),</span>
<span id="cb101-676"><a href="#cb101-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb101-677"><a href="#cb101-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.1</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb101-678"><a href="#cb101-678" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb101-679"><a href="#cb101-679" aria-hidden="true" tabindex="-1"></a>  <span class="at">scene3 =</span> <span class="fu">list</span>(</span>
<span id="cb101-680"><a href="#cb101-680" aria-hidden="true" tabindex="-1"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb101-681"><a href="#cb101-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb101-682"><a href="#cb101-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.1</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb101-683"><a href="#cb101-683" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb101-684"><a href="#cb101-684" aria-hidden="true" tabindex="-1"></a>  <span class="at">scene4 =</span> <span class="fu">list</span>(</span>
<span id="cb101-685"><a href="#cb101-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">domain =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb101-686"><a href="#cb101-686" aria-hidden="true" tabindex="-1"></a>    <span class="at">aspectmode =</span> <span class="st">"cube"</span>,</span>
<span id="cb101-687"><a href="#cb101-687" aria-hidden="true" tabindex="-1"></a>    <span class="at">camera =</span> <span class="fu">list</span>(<span class="at">eye =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="fl">0.58</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">1.4</span>, <span class="at">y =</span> <span class="fl">1.6</span>))</span>
<span id="cb101-688"><a href="#cb101-688" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-689"><a href="#cb101-689" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-690"><a href="#cb101-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-691"><a href="#cb101-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-692"><a href="#cb101-692" aria-hidden="true" tabindex="-1"></a>Unfortunately, titles in subplots cannot be created dynamically. However, there is a manual workaround via annotations show in <span class="co">[</span><span class="ot">this RPubs post</span><span class="co">](https://rpubs.com/bcd/subplot-titles)</span>.</span>
<span id="cb101-693"><a href="#cb101-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-694"><a href="#cb101-694" aria-hidden="true" tabindex="-1"></a><span class="fu">### Choosing a Resampling Method {#choose-spt-rsmp}</span></span>
<span id="cb101-695"><a href="#cb101-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-696"><a href="#cb101-696" aria-hidden="true" tabindex="-1"></a>While the example in this section made use of the <span class="in">`r ref("mlr_resamplings_spcv_coords", text = "spcv_coords")`</span> method, this should by no means infer that this method is the best or only method suitable for this task.</span>
<span id="cb101-697"><a href="#cb101-697" aria-hidden="true" tabindex="-1"></a>Even though this method is quite popular, it was mainly chosen because of the clear visual grouping differences when being applied on the <span class="in">`r ref("mlr_tasks_ecuador", text = "ecuador")`</span> task when compared to random partitioning.</span>
<span id="cb101-698"><a href="#cb101-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-699"><a href="#cb101-699" aria-hidden="true" tabindex="-1"></a>In fact, most often multiple spatial partitioning methods can be used for a dataset.</span>
<span id="cb101-700"><a href="#cb101-700" aria-hidden="true" tabindex="-1"></a>It is recommended (required) that users familiarize themselves with each implemented method and decide which method to choose based on the specific characteristics of the dataset.</span>
<span id="cb101-701"><a href="#cb101-701" aria-hidden="true" tabindex="-1"></a>For almost all methods implemented in <span class="in">`r mlr3spatiotempcv`</span>, there is a scientific publication describing the strengths and weaknesses of the respective approach (either linked in the help file of <span class="in">`r mlr3spatiotempcv`</span> or its respective dependency packages).</span>
<span id="cb101-702"><a href="#cb101-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-703"><a href="#cb101-703" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb101-704"><a href="#cb101-704" aria-hidden="true" tabindex="-1"></a>In the example above, a cross-validation without hyperparameter tuning was shown.</span>
<span id="cb101-705"><a href="#cb101-705" aria-hidden="true" tabindex="-1"></a>If a nested CV is desired, it is recommended to use the same spatial partitioning method for the inner loop (= tuning level).</span>
<span id="cb101-706"><a href="#cb101-706" aria-hidden="true" tabindex="-1"></a>See @schratz2019 for more details and chapter 11 of <span class="co">[</span><span class="ot">Geocomputation with R</span><span class="co">](https://geocompr.robinlovelace.net/spatial-cv.html)</span> <span class="co">[</span><span class="ot">@lovelace2019</span><span class="co">]</span>.</span>
<span id="cb101-707"><a href="#cb101-707" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-708"><a href="#cb101-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-709"><a href="#cb101-709" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb101-710"><a href="#cb101-710" aria-hidden="true" tabindex="-1"></a>A list of all implemented methods in <span class="in">`r mlr3spatiotempcv`</span> can be found in the <span class="co">[</span><span class="ot">Getting Started</span><span class="co">](https://mlr3spatiotempcv.mlr-org.com/articles/mlr3spatiotempcv.html#resampling-methods)</span> vignette of the package.</span>
<span id="cb101-711"><a href="#cb101-711" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-712"><a href="#cb101-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-713"><a href="#cb101-713" aria-hidden="true" tabindex="-1"></a>If you want to learn even more about the field of spatial partitioning, STAC and the problems associated with it, the works of <span class="co">[</span><span class="ot">Prof. Hanna Meyer</span><span class="co">](https://scholar.google.com/citations?user=9YibxW0AAAAJ&amp;hl=en)</span> and <span class="co">[</span><span class="ot">Prof. Alexander Brenning</span><span class="co">](https://scholar.google.com/citations?hl=en&amp;user=GD5bzTgAAAAJ)</span> are very much recommended for further reference.</span>
<span id="cb101-714"><a href="#cb101-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-715"><a href="#cb101-715" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatial Prediction {#sec-spatial-prediction}</span></span>
<span id="cb101-716"><a href="#cb101-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-717"><a href="#cb101-717" aria-hidden="true" tabindex="-1"></a>Support for (parallel) spatial prediction with <span class="in">`r ref_pkg("terra")`</span>, <span class="in">`r ref_pkg("raster")`</span>, <span class="in">`r ref_pkg("stars")`</span> and <span class="in">`r ref_pkg("sf")`</span> objects is available via <span class="in">`r mlr3spatial`</span>.</span>
<span id="cb101-718"><a href="#cb101-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-719"><a href="#cb101-719" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3spatial`</span> has two main scopes:</span>
<span id="cb101-720"><a href="#cb101-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-721"><a href="#cb101-721" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Provide DataBackends for spatial objects (vector and raster data)</span>
<span id="cb101-722"><a href="#cb101-722" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simplify spatial prediction tasks</span>
<span id="cb101-723"><a href="#cb101-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-724"><a href="#cb101-724" aria-hidden="true" tabindex="-1"></a>Overall it aims to reduce the roundtripping between spatial objects -&gt; data.frame / data.table -&gt; spatial object during modeling.</span>
<span id="cb101-725"><a href="#cb101-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-726"><a href="#cb101-726" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatial Data Backends {#spatial-data-backends}</span></span>
<span id="cb101-727"><a href="#cb101-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-728"><a href="#cb101-728" aria-hidden="true" tabindex="-1"></a>A common scenario is the existence of spatial information in (point) vector data.</span>
<span id="cb101-729"><a href="#cb101-729" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3spatial`</span> provides <span class="in">`as_task_*`</span> helpers to directly convert these into a spatiotemporal (ST) task:</span>
<span id="cb101-730"><a href="#cb101-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-731"><a href="#cb101-731" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE}</span></span>
<span id="cb101-732"><a href="#cb101-732" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb101-733"><a href="#cb101-733" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3spatial)</span>
<span id="cb101-734"><a href="#cb101-734" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb101-735"><a href="#cb101-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-736"><a href="#cb101-736" aria-hidden="true" tabindex="-1"></a><span class="co"># load sample points</span></span>
<span id="cb101-737"><a href="#cb101-737" aria-hidden="true" tabindex="-1"></a>leipzig_vector <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>,</span>
<span id="cb101-738"><a href="#cb101-738" aria-hidden="true" tabindex="-1"></a>  <span class="st">"leipzig_points.gpkg"</span>, <span class="at">package =</span> <span class="st">"mlr3spatial"</span>),</span>
<span id="cb101-739"><a href="#cb101-739" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb101-740"><a href="#cb101-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-741"><a href="#cb101-741" aria-hidden="true" tabindex="-1"></a><span class="co"># create land cover task</span></span>
<span id="cb101-742"><a href="#cb101-742" aria-hidden="true" tabindex="-1"></a>tsk_leipzig <span class="ot">=</span> <span class="fu">as_task_classif_st</span>(leipzig_vector, <span class="at">target =</span> <span class="st">"land_cover"</span>)</span>
<span id="cb101-743"><a href="#cb101-743" aria-hidden="true" tabindex="-1"></a>tsk_leipzig</span>
<span id="cb101-744"><a href="#cb101-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-745"><a href="#cb101-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-746"><a href="#cb101-746" aria-hidden="true" tabindex="-1"></a>This saves users from stripping the coordinates from the vector data or transforming the <span class="in">`sf`</span> object to a <span class="in">`data.frame`</span> or <span class="in">`data.table`</span> in the first place.</span>
<span id="cb101-747"><a href="#cb101-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-748"><a href="#cb101-748" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3spatial`</span> adds support for the following spatial data classes:</span>
<span id="cb101-749"><a href="#cb101-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-750"><a href="#cb101-750" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`stars`</span> (from package <span class="in">`r ref_pkg("stars")`</span>)</span>
<span id="cb101-751"><a href="#cb101-751" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`SpatRaster`</span> (from package <span class="in">`r ref_pkg("terra")`</span>)</span>
<span id="cb101-752"><a href="#cb101-752" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`RasterLayer`</span> (from package <span class="in">`r ref_pkg("raster")`</span>)</span>
<span id="cb101-753"><a href="#cb101-753" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`RasterStack`</span> (from package <span class="in">`r ref_pkg("raster")`</span>)</span>
<span id="cb101-754"><a href="#cb101-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-755"><a href="#cb101-755" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatial prediction {#spatial-prediction}</span></span>
<span id="cb101-756"><a href="#cb101-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-757"><a href="#cb101-757" aria-hidden="true" tabindex="-1"></a>The goal of spatial prediction is usually a raster image that covers a specific area.</span>
<span id="cb101-758"><a href="#cb101-758" aria-hidden="true" tabindex="-1"></a>Most often this area is quite large and contains millions of pixels.</span>
<span id="cb101-759"><a href="#cb101-759" aria-hidden="true" tabindex="-1"></a>The goal is to predict on each pixel and return a raster image containing these predictions.</span>
<span id="cb101-760"><a href="#cb101-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-761"><a href="#cb101-761" aria-hidden="true" tabindex="-1"></a>To save users from having to go the extra mile of extracting the final model and using it with the respective <span class="in">`predict()`</span> function of the spatial R package of their desired outcome class, <span class="in">`r mlr3spatial`</span> provides <span class="in">`r ref("predict_spatial()")`</span>.</span>
<span id="cb101-762"><a href="#cb101-762" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("predict_spatial()")`</span> let's users</span>
<span id="cb101-763"><a href="#cb101-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-764"><a href="#cb101-764" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>choose the output class of the resulting raster image</span>
<span id="cb101-765"><a href="#cb101-765" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>optionally predict in parallel via the <span class="in">`r ref_pkg("future")`</span> package, using a parallel backend of their choice</span>
<span id="cb101-766"><a href="#cb101-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-767"><a href="#cb101-767" aria-hidden="true" tabindex="-1"></a>To use a raster image for prediction, it must be wrapped into a <span class="in">`r ref("TaskUnsupervised")`</span> for internal <span class="in">`r mlr3`</span> reasons.</span>
<span id="cb101-768"><a href="#cb101-768" aria-hidden="true" tabindex="-1"></a>Next, the learner can be used to predict on the task.</span>
<span id="cb101-769"><a href="#cb101-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-770"><a href="#cb101-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache.lazy=FALSE, cache=FALSE, eval=FALSE}</span></span>
<span id="cb101-771"><a href="#cb101-771" aria-hidden="true" tabindex="-1"></a>leipzig_raster <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"leipzig_raster.tif"</span>,</span>
<span id="cb101-772"><a href="#cb101-772" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">"mlr3spatial"</span>))</span>
<span id="cb101-773"><a href="#cb101-773" aria-hidden="true" tabindex="-1"></a>tsk_predict <span class="ot">=</span> <span class="fu">as_task_unsupervised</span>(leipzig_raster)</span>
<span id="cb101-774"><a href="#cb101-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-775"><a href="#cb101-775" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb101-776"><a href="#cb101-776" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span><span class="fu">train</span>(tsk_leipzig)</span>
<span id="cb101-777"><a href="#cb101-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-778"><a href="#cb101-778" aria-hidden="true" tabindex="-1"></a><span class="co"># plan("multisession") # optional parallelization</span></span>
<span id="cb101-779"><a href="#cb101-779" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict_spatial</span>(tsk_predict, lrn, <span class="at">format =</span> <span class="st">"terra"</span>)</span>
<span id="cb101-780"><a href="#cb101-780" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(pred)</span>
<span id="cb101-781"><a href="#cb101-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-782"><a href="#cb101-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-783"><a href="#cb101-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache.lazy=FALSE, cache=FALSE, echo=FALSE}</span></span>
<span id="cb101-784"><a href="#cb101-784" aria-hidden="true" tabindex="-1"></a><span class="co"># need to load mlr3spatial explicitily as quarto does not take over NS loads from previous chunks - or caching interfers somehow</span></span>
<span id="cb101-785"><a href="#cb101-785" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3spatial)</span>
<span id="cb101-786"><a href="#cb101-786" aria-hidden="true" tabindex="-1"></a>leipzig_raster <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"leipzig_raster.tif"</span>,</span>
<span id="cb101-787"><a href="#cb101-787" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">"mlr3spatial"</span>))</span>
<span id="cb101-788"><a href="#cb101-788" aria-hidden="true" tabindex="-1"></a>tsk_predict <span class="ot">=</span> <span class="fu">as_task_unsupervised</span>(leipzig_raster)</span>
<span id="cb101-789"><a href="#cb101-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-790"><a href="#cb101-790" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb101-791"><a href="#cb101-791" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span><span class="fu">train</span>(tsk_leipzig)</span>
<span id="cb101-792"><a href="#cb101-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-793"><a href="#cb101-793" aria-hidden="true" tabindex="-1"></a><span class="co"># plan("multisession") # optional parallelization</span></span>
<span id="cb101-794"><a href="#cb101-794" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict_spatial</span>(tsk_predict, lrn, <span class="at">format =</span> <span class="st">"terra"</span>)</span>
<span id="cb101-795"><a href="#cb101-795" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(pred)</span>
<span id="cb101-796"><a href="#cb101-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-797"><a href="#cb101-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-798"><a href="#cb101-798" aria-hidden="true" tabindex="-1"></a>The resulting object can be visualized and treated as any other <span class="in">`terra`</span> object.</span>
<span id="cb101-799"><a href="#cb101-799" aria-hidden="true" tabindex="-1"></a>Thanks to the improved handling of factor variables in <span class="in">`r ref_pkg("terra")`</span>, the raster image contains the correct labeled classes from the prediction right away.</span>
<span id="cb101-800"><a href="#cb101-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-801"><a href="#cb101-801" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, cache.lazy=FALSE, cache=FALSE}</span></span>
<span id="cb101-802"><a href="#cb101-802" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra, <span class="at">exclude =</span> <span class="st">"resample"</span>)</span>
<span id="cb101-803"><a href="#cb101-803" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#440154FF"</span>, <span class="st">"#443A83FF"</span>, <span class="st">"#31688EFF"</span>,</span>
<span id="cb101-804"><a href="#cb101-804" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#21908CFF"</span>, <span class="st">"#35B779FF"</span>, <span class="st">"#8FD744FF"</span>, <span class="st">"#FDE725FF"</span>))</span>
<span id="cb101-805"><a href="#cb101-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-806"><a href="#cb101-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-807"><a href="#cb101-807" aria-hidden="true" tabindex="-1"></a>If you are interested in the performance of parallel spatial prediction, have a look at the <span class="co">[</span><span class="ot">Spatial Prediction Benchmark</span><span class="co">](https://mlr3spatial.mlr-org.com/articles/benchmark.html)</span> vignette - the resulting plot is shown below.</span>
<span id="cb101-808"><a href="#cb101-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-809"><a href="#cb101-809" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning appearance="simple"}</span>
<span id="cb101-810"><a href="#cb101-810" aria-hidden="true" tabindex="-1"></a>The results of the shown benchmark results should be taken with care as something seems to go wrong when using all-core parallelization with <span class="in">`terra::predict()`</span>.</span>
<span id="cb101-811"><a href="#cb101-811" aria-hidden="true" tabindex="-1"></a>Also both relative and absolute numbers will vary on your local machine and results might change depending on eventual package updates in the future.</span>
<span id="cb101-812"><a href="#cb101-812" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb101-813"><a href="#cb101-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-814"><a href="#cb101-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb101-815"><a href="#cb101-815" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb101-816"><a href="#cb101-816" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: '`r mlr3spatial`'</span></span>
<span id="cb101-817"><a href="#cb101-817" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"https://mlr3spatial.mlr-org.com/dev/articles/plot-benchmark-1.png"</span>, <span class="at">auto_pdf =</span> <span class="cn">TRUE</span>)</span>
<span id="cb101-818"><a href="#cb101-818" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-819"><a href="#cb101-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-820"><a href="#cb101-820" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cost-Sensitive Classification {#cost-sens}</span></span>
<span id="cb101-821"><a href="#cb101-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-822"><a href="#cb101-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-823"><a href="#cb101-823" aria-hidden="true" tabindex="-1"></a>In regular classification, the aim is to minimize the misclassification rate, and thus all types of misclassification errors are deemed equally severe.</span>
<span id="cb101-824"><a href="#cb101-824" aria-hidden="true" tabindex="-1"></a>A more general setting is cost-sensitive classification.</span>
<span id="cb101-825"><a href="#cb101-825" aria-hidden="true" tabindex="-1"></a>Cost-sensitive classification does not assume that the costs caused by different kinds of errors are equal.</span>
<span id="cb101-826"><a href="#cb101-826" aria-hidden="true" tabindex="-1"></a>The objective of cost-sensitive classification is to minimize the expected costs.</span>
<span id="cb101-827"><a href="#cb101-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-828"><a href="#cb101-828" aria-hidden="true" tabindex="-1"></a>Imagine you are an analyst for a big credit institution.</span>
<span id="cb101-829"><a href="#cb101-829" aria-hidden="true" tabindex="-1"></a>Let's also assume that a correct bank decision would result in 35% of the profit at the end of a specific period.</span>
<span id="cb101-830"><a href="#cb101-830" aria-hidden="true" tabindex="-1"></a>A correct decision means that the bank predicts that a customer will pay their bills (hence would obtain a loan), and the customer indeed has good credit.</span>
<span id="cb101-831"><a href="#cb101-831" aria-hidden="true" tabindex="-1"></a>On the other hand, a wrong decision means that the bank predicts that the customer's credit is in good standing, but the opposite is true.</span>
<span id="cb101-832"><a href="#cb101-832" aria-hidden="true" tabindex="-1"></a>This would result in a loss of 100% of the given loan.</span>
<span id="cb101-833"><a href="#cb101-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-834"><a href="#cb101-834" aria-hidden="true" tabindex="-1"></a>|                           | Good Customer (truth)       | Bad Customer (truth)       |</span>
<span id="cb101-835"><a href="#cb101-835" aria-hidden="true" tabindex="-1"></a>| :-----------------------: | :-------------------------: | :------------------------: |</span>
<span id="cb101-836"><a href="#cb101-836" aria-hidden="true" tabindex="-1"></a>| Good Customer (predicted) | + 0.35                      | - 1.0                      |</span>
<span id="cb101-837"><a href="#cb101-837" aria-hidden="true" tabindex="-1"></a>| Bad Customer (predicted)  | 0                           | 0                          |</span>
<span id="cb101-838"><a href="#cb101-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-839"><a href="#cb101-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-840"><a href="#cb101-840" aria-hidden="true" tabindex="-1"></a>Expressed as costs (instead of profit), we can write down the cost-matrix as follows:</span>
<span id="cb101-841"><a href="#cb101-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-842"><a href="#cb101-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-022}</span></span>
<span id="cb101-843"><a href="#cb101-843" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.35</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb101-844"><a href="#cb101-844" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(costs) <span class="ot">=</span> <span class="fu">list</span>(<span class="at">response =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>), <span class="at">truth =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>))</span>
<span id="cb101-845"><a href="#cb101-845" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(costs)</span>
<span id="cb101-846"><a href="#cb101-846" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-847"><a href="#cb101-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-848"><a href="#cb101-848" aria-hidden="true" tabindex="-1"></a>An exemplary data set for such a problem is the <span class="in">`r ref("mlr_tasks_german_credit", text = "German Credit")`</span> task:</span>
<span id="cb101-849"><a href="#cb101-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-850"><a href="#cb101-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-023}</span></span>
<span id="cb101-851"><a href="#cb101-851" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3verse"</span>)</span>
<span id="cb101-852"><a href="#cb101-852" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb101-853"><a href="#cb101-853" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(task<span class="sc">$</span><span class="fu">truth</span>())</span>
<span id="cb101-854"><a href="#cb101-854" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-855"><a href="#cb101-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-856"><a href="#cb101-856" aria-hidden="true" tabindex="-1"></a>The data has 70% of customers who can pay back their credit and 30% of bad customers who default on their debt.</span>
<span id="cb101-857"><a href="#cb101-857" aria-hidden="true" tabindex="-1"></a>A manager, who doesn't have any model, could decide to give either everybody credit or to give nobody credit.</span>
<span id="cb101-858"><a href="#cb101-858" aria-hidden="true" tabindex="-1"></a>The resulting costs for the German credit data are:</span>
<span id="cb101-859"><a href="#cb101-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-860"><a href="#cb101-860" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-024}</span></span>
<span id="cb101-861"><a href="#cb101-861" aria-hidden="true" tabindex="-1"></a><span class="co"># nobody:</span></span>
<span id="cb101-862"><a href="#cb101-862" aria-hidden="true" tabindex="-1"></a>(<span class="dv">700</span> <span class="sc">*</span> costs[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">300</span> <span class="sc">*</span> costs[<span class="dv">2</span>, <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb101-863"><a href="#cb101-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-864"><a href="#cb101-864" aria-hidden="true" tabindex="-1"></a><span class="co"># everybody</span></span>
<span id="cb101-865"><a href="#cb101-865" aria-hidden="true" tabindex="-1"></a>(<span class="dv">700</span> <span class="sc">*</span> costs[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">300</span> <span class="sc">*</span> costs[<span class="dv">1</span>, <span class="dv">2</span>]) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb101-866"><a href="#cb101-866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-867"><a href="#cb101-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-868"><a href="#cb101-868" aria-hidden="true" tabindex="-1"></a>If the average loan is $20,000, the credit institute will lose more than one million dollars if it would grant everybody a credit:</span>
<span id="cb101-869"><a href="#cb101-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-870"><a href="#cb101-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-025}</span></span>
<span id="cb101-871"><a href="#cb101-871" aria-hidden="true" tabindex="-1"></a><span class="co"># average profit * average loan * number of customers</span></span>
<span id="cb101-872"><a href="#cb101-872" aria-hidden="true" tabindex="-1"></a><span class="fl">0.055</span> <span class="sc">*</span> <span class="dv">20000</span> <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb101-873"><a href="#cb101-873" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-874"><a href="#cb101-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-875"><a href="#cb101-875" aria-hidden="true" tabindex="-1"></a>Our goal is to find a model that minimizes the costs (and maximizes the expected profit).</span>
<span id="cb101-876"><a href="#cb101-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-877"><a href="#cb101-877" aria-hidden="true" tabindex="-1"></a><span class="fu">### A First Model</span></span>
<span id="cb101-878"><a href="#cb101-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-879"><a href="#cb101-879" aria-hidden="true" tabindex="-1"></a>For our first model, we choose an ordinary logistic regression (implemented in add-on package <span class="in">`r mlr3learners`</span>).</span>
<span id="cb101-880"><a href="#cb101-880" aria-hidden="true" tabindex="-1"></a>We first create a classification task, then resample the model using 10-fold cross-validation and extract the resulting confusion matrix:</span>
<span id="cb101-881"><a href="#cb101-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-882"><a href="#cb101-882" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-026}</span></span>
<span id="cb101-883"><a href="#cb101-883" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>)</span>
<span id="cb101-884"><a href="#cb101-884" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>))</span>
<span id="cb101-885"><a href="#cb101-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-886"><a href="#cb101-886" aria-hidden="true" tabindex="-1"></a>confusion <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">prediction</span>()<span class="sc">$</span>confusion</span>
<span id="cb101-887"><a href="#cb101-887" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(confusion)</span>
<span id="cb101-888"><a href="#cb101-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-889"><a href="#cb101-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-890"><a href="#cb101-890" aria-hidden="true" tabindex="-1"></a>To calculate the average costs like above, we can simply multiply the elements of the confusion matrix with the elements of the previously introduced cost matrix and sum the values of the resulting matrix:</span>
<span id="cb101-891"><a href="#cb101-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-892"><a href="#cb101-892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-027}</span></span>
<span id="cb101-893"><a href="#cb101-893" aria-hidden="true" tabindex="-1"></a>avg_costs <span class="ot">=</span> <span class="fu">sum</span>(confusion <span class="sc">*</span> costs) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb101-894"><a href="#cb101-894" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(avg_costs)</span>
<span id="cb101-895"><a href="#cb101-895" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-896"><a href="#cb101-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-897"><a href="#cb101-897" aria-hidden="true" tabindex="-1"></a>With an average loan of \$20,000, the logistic regression yields the following costs:</span>
<span id="cb101-898"><a href="#cb101-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-899"><a href="#cb101-899" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-028}</span></span>
<span id="cb101-900"><a href="#cb101-900" aria-hidden="true" tabindex="-1"></a>avg_costs <span class="sc">*</span> <span class="dv">20000</span> <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb101-901"><a href="#cb101-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-902"><a href="#cb101-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-903"><a href="#cb101-903" aria-hidden="true" tabindex="-1"></a>Instead of losing over \$1,000,000, the credit institute now can expect a profit of more than \$1,000,000.</span>
<span id="cb101-904"><a href="#cb101-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-905"><a href="#cb101-905" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cost-sensitive Measure</span></span>
<span id="cb101-906"><a href="#cb101-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-907"><a href="#cb101-907" aria-hidden="true" tabindex="-1"></a>Our natural next step would be to further improve the modeling step in order to maximize the profit.</span>
<span id="cb101-908"><a href="#cb101-908" aria-hidden="true" tabindex="-1"></a>For this purpose, we first create a cost-sensitive classification measure that calculates the costs based on our cost matrix.</span>
<span id="cb101-909"><a href="#cb101-909" aria-hidden="true" tabindex="-1"></a>This allows us to conveniently quantify and compare modeling decisions.</span>
<span id="cb101-910"><a href="#cb101-910" aria-hidden="true" tabindex="-1"></a>Fortunately, there already is a predefined measure <span class="in">`r ref("Measure")`</span> for this purpose: <span class="in">`r ref("MeasureClassifCosts")`</span>.</span>
<span id="cb101-911"><a href="#cb101-911" aria-hidden="true" tabindex="-1"></a>The costs have to be provided as a numeric matrix whose columns and rows are named with class labels (just like the previously constructed <span class="in">`costs`</span> matrix):</span>
<span id="cb101-912"><a href="#cb101-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-913"><a href="#cb101-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-029}</span></span>
<span id="cb101-914"><a href="#cb101-914" aria-hidden="true" tabindex="-1"></a>cost_measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.costs"</span>, <span class="at">costs =</span> costs)</span>
<span id="cb101-915"><a href="#cb101-915" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cost_measure)</span>
<span id="cb101-916"><a href="#cb101-916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-917"><a href="#cb101-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-918"><a href="#cb101-918" aria-hidden="true" tabindex="-1"></a>If we now call <span class="in">`r ref("resample()")`</span> or <span class="in">`r ref("benchmark()")`</span>, the cost-sensitive measures will be evaluated.</span>
<span id="cb101-919"><a href="#cb101-919" aria-hidden="true" tabindex="-1"></a>We compare the logistic regression to a simple featureless learner and to a random forest from package <span class="in">`r ref_pkg("ranger")`</span> :</span>
<span id="cb101-920"><a href="#cb101-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-921"><a href="#cb101-921" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-030}</span></span>
<span id="cb101-922"><a href="#cb101-922" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb101-923"><a href="#cb101-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>),</span>
<span id="cb101-924"><a href="#cb101-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.featureless"</span>),</span>
<span id="cb101-925"><a href="#cb101-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb101-926"><a href="#cb101-926" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-927"><a href="#cb101-927" aria-hidden="true" tabindex="-1"></a>cv10 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">10</span>)</span>
<span id="cb101-928"><a href="#cb101-928" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, cv10))</span>
<span id="cb101-929"><a href="#cb101-929" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> cost_measure) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span>
<span id="cb101-930"><a href="#cb101-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-931"><a href="#cb101-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-932"><a href="#cb101-932" aria-hidden="true" tabindex="-1"></a>As expected, the featureless learner is performing comparably badly.</span>
<span id="cb101-933"><a href="#cb101-933" aria-hidden="true" tabindex="-1"></a>The logistic regression and the random forest both yield a profit on average.</span>
<span id="cb101-934"><a href="#cb101-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-935"><a href="#cb101-935" aria-hidden="true" tabindex="-1"></a><span class="fu">### Thresholding</span></span>
<span id="cb101-936"><a href="#cb101-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-937"><a href="#cb101-937" aria-hidden="true" tabindex="-1"></a>Although we now correctly evaluate the models in a cost-sensitive fashion, the models themselves are unaware of the classification costs.</span>
<span id="cb101-938"><a href="#cb101-938" aria-hidden="true" tabindex="-1"></a>They assume the same costs for both wrong classification decisions (false positives and false negatives).</span>
<span id="cb101-939"><a href="#cb101-939" aria-hidden="true" tabindex="-1"></a>Some learners natively support cost-sensitive classification (e.g., XXX).</span>
<span id="cb101-940"><a href="#cb101-940" aria-hidden="true" tabindex="-1"></a>However, we will concentrate on a more generic approach that works for all models which can predict probabilities for class labels: thresholding.</span>
<span id="cb101-941"><a href="#cb101-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-942"><a href="#cb101-942" aria-hidden="true" tabindex="-1"></a>Most learners can calculate the probability $p$ for the positive class.</span>
<span id="cb101-943"><a href="#cb101-943" aria-hidden="true" tabindex="-1"></a>If $p$ exceeds the threshold $0.5$, they predict the positive class and the negative class otherwise.</span>
<span id="cb101-944"><a href="#cb101-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-945"><a href="#cb101-945" aria-hidden="true" tabindex="-1"></a>For our binary classification case of the credit data, we primarily want to minimize the errors where the model predicts "good", but truth is "bad" (i.e., the number of false positives) as this is the more expensive error.</span>
<span id="cb101-946"><a href="#cb101-946" aria-hidden="true" tabindex="-1"></a>If we now increase the threshold to values $&gt; 0.5$, we reduce the number of false negatives.</span>
<span id="cb101-947"><a href="#cb101-947" aria-hidden="true" tabindex="-1"></a>Note that we increase the number of false positives simultaneously, or, in other words, we are trading false positives for false negatives.</span>
<span id="cb101-948"><a href="#cb101-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-949"><a href="#cb101-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-031}</span></span>
<span id="cb101-950"><a href="#cb101-950" aria-hidden="true" tabindex="-1"></a><span class="co"># fit models with probability prediction</span></span>
<span id="cb101-951"><a href="#cb101-951" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb101-952"><a href="#cb101-952" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>))</span>
<span id="cb101-953"><a href="#cb101-953" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> rr<span class="sc">$</span><span class="fu">prediction</span>()</span>
<span id="cb101-954"><a href="#cb101-954" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb101-955"><a href="#cb101-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-956"><a href="#cb101-956" aria-hidden="true" tabindex="-1"></a><span class="co"># helper function to try different threshold values interactively</span></span>
<span id="cb101-957"><a href="#cb101-957" aria-hidden="true" tabindex="-1"></a>with_threshold <span class="ot">=</span> <span class="cf">function</span>(p, th) {</span>
<span id="cb101-958"><a href="#cb101-958" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span><span class="fu">set_threshold</span>(th)</span>
<span id="cb101-959"><a href="#cb101-959" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion =</span> p<span class="sc">$</span>confusion, <span class="at">costs =</span> p<span class="sc">$</span><span class="fu">score</span>(<span class="at">measures =</span> cost_measure))</span>
<span id="cb101-960"><a href="#cb101-960" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-961"><a href="#cb101-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-962"><a href="#cb101-962" aria-hidden="true" tabindex="-1"></a><span class="fu">with_threshold</span>(p, <span class="fl">0.5</span>)</span>
<span id="cb101-963"><a href="#cb101-963" aria-hidden="true" tabindex="-1"></a><span class="fu">with_threshold</span>(p, <span class="fl">0.75</span>)</span>
<span id="cb101-964"><a href="#cb101-964" aria-hidden="true" tabindex="-1"></a><span class="fu">with_threshold</span>(p, <span class="fl">1.0</span>)</span>
<span id="cb101-965"><a href="#cb101-965" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-966"><a href="#cb101-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-967"><a href="#cb101-967" aria-hidden="true" tabindex="-1"></a>There is also an <span class="in">`autoplot()`</span> method which systematically varies the threshold between 0 and 1 and calculates the corresponding scores:</span>
<span id="cb101-970"><a href="#cb101-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb101-971"><a href="#cb101-971" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(p, <span class="at">type =</span> <span class="st">"threshold"</span>, <span class="at">measure =</span> cost_measure)</span>
<span id="cb101-972"><a href="#cb101-972" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-973"><a href="#cb101-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-974"><a href="#cb101-974" aria-hidden="true" tabindex="-1"></a>Instead of manually or visually searching for good values, the base R function <span class="in">`r ref("optimize()")`</span> can do the job for us:</span>
<span id="cb101-975"><a href="#cb101-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-976"><a href="#cb101-976" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-032}</span></span>
<span id="cb101-977"><a href="#cb101-977" aria-hidden="true" tabindex="-1"></a><span class="co"># simple wrapper function that takes a threshold and returns the resulting model performance</span></span>
<span id="cb101-978"><a href="#cb101-978" aria-hidden="true" tabindex="-1"></a><span class="co"># this wrapper is passed to optimize() to find its minimum for thresholds in [0.5, 1]</span></span>
<span id="cb101-979"><a href="#cb101-979" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> <span class="cf">function</span>(th) {</span>
<span id="cb101-980"><a href="#cb101-980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with_threshold</span>(p, th)<span class="sc">$</span>costs</span>
<span id="cb101-981"><a href="#cb101-981" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-982"><a href="#cb101-982" aria-hidden="true" tabindex="-1"></a>best <span class="ot">=</span> <span class="fu">optimize</span>(f, <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb101-983"><a href="#cb101-983" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(best)</span>
<span id="cb101-984"><a href="#cb101-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-985"><a href="#cb101-985" aria-hidden="true" tabindex="-1"></a><span class="co"># optimized confusion matrix:</span></span>
<span id="cb101-986"><a href="#cb101-986" aria-hidden="true" tabindex="-1"></a><span class="fu">with_threshold</span>(p, best<span class="sc">$</span>minimum)<span class="sc">$</span>confusion</span>
<span id="cb101-987"><a href="#cb101-987" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-988"><a href="#cb101-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-989"><a href="#cb101-989" aria-hidden="true" tabindex="-1"></a>Note that the function <span class="in">`"optimize()"`</span> is intended for unimodal functions and, therefore, may converge to a local optimum here.</span>
<span id="cb101-990"><a href="#cb101-990" aria-hidden="true" tabindex="-1"></a>See the next section for better alternatives to tune the threshold.</span>
<span id="cb101-991"><a href="#cb101-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-992"><a href="#cb101-992" aria-hidden="true" tabindex="-1"></a><span class="fu">### Threshold Tuning</span></span>
<span id="cb101-993"><a href="#cb101-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-994"><a href="#cb101-994" aria-hidden="true" tabindex="-1"></a>Currently <span class="in">`r mlr3pipelines`</span> offers two main strategies towards adjusting <span class="in">`classification thresholds`</span>.</span>
<span id="cb101-995"><a href="#cb101-995" aria-hidden="true" tabindex="-1"></a>We can either expose the thresholds as a <span class="in">`hyperparameter`</span> of the Learner by using <span class="in">`r ref("PipeOpThreshold")`</span>.</span>
<span id="cb101-996"><a href="#cb101-996" aria-hidden="true" tabindex="-1"></a>This allows us to tune the <span class="in">`thresholds`</span> via an outside optimizer from <span class="in">`r mlr3tuning`</span>.</span>
<span id="cb101-997"><a href="#cb101-997" aria-hidden="true" tabindex="-1"></a>Alternatively, we can also use <span class="in">`r ref("PipeOpTuneThreshold")`</span> which automatically tunes the threshold after each learner is fit.</span>
<span id="cb101-998"><a href="#cb101-998" aria-hidden="true" tabindex="-1"></a>Both methods are described in the following subsections.</span>
<span id="cb101-999"><a href="#cb101-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1000"><a href="#cb101-1000" aria-hidden="true" tabindex="-1"></a><span class="fu">### PipeOpThreshold</span></span>
<span id="cb101-1001"><a href="#cb101-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1002"><a href="#cb101-1002" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOpThreshold")`</span> can be put directly after a <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb101-1003"><a href="#cb101-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1004"><a href="#cb101-1004" aria-hidden="true" tabindex="-1"></a>A simple example would be:</span>
<span id="cb101-1005"><a href="#cb101-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1006"><a href="#cb101-1006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-034}</span></span>
<span id="cb101-1007"><a href="#cb101-1007" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"threshold"</span>)</span>
<span id="cb101-1008"><a href="#cb101-1008" aria-hidden="true" tabindex="-1"></a>l <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb101-1009"><a href="#cb101-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1010"><a href="#cb101-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1011"><a href="#cb101-1011" aria-hidden="true" tabindex="-1"></a>Note, that <span class="in">`predict_type = "prob"`</span> is required for <span class="in">`po("threshold")`</span> to have any effect.</span>
<span id="cb101-1012"><a href="#cb101-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1013"><a href="#cb101-1013" aria-hidden="true" tabindex="-1"></a>The <span class="in">`thresholds`</span> are now exposed as a <span class="in">`hyperparameter`</span> of the <span class="in">`r ref("GraphLearner")`</span> we created:</span>
<span id="cb101-1014"><a href="#cb101-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1015"><a href="#cb101-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-035}</span></span>
<span id="cb101-1016"><a href="#cb101-1016" aria-hidden="true" tabindex="-1"></a>l<span class="sc">$</span>param_set</span>
<span id="cb101-1017"><a href="#cb101-1017" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1018"><a href="#cb101-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1019"><a href="#cb101-1019" aria-hidden="true" tabindex="-1"></a>We can now tune those thresholds from the outside as follows:</span>
<span id="cb101-1020"><a href="#cb101-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1021"><a href="#cb101-1021" aria-hidden="true" tabindex="-1"></a>Before tuning, we have to define which hyperparameters we want to tune over.</span>
<span id="cb101-1022"><a href="#cb101-1022" aria-hidden="true" tabindex="-1"></a>In this example, we only tune over the <span class="in">`thresholds`</span> parameter of the <span class="in">`threshold`</span> pipe operator.</span>
<span id="cb101-1023"><a href="#cb101-1023" aria-hidden="true" tabindex="-1"></a>You can easily imagine that we can also jointly tune over additional hyperparameters, i.e., rpart's <span class="in">`cp`</span> parameter.</span>
<span id="cb101-1024"><a href="#cb101-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1025"><a href="#cb101-1025" aria-hidden="true" tabindex="-1"></a>As the <span class="in">`r ref("Task")`</span> we aim to optimize for is a binary task, we can simply specify the threshold param:</span>
<span id="cb101-1026"><a href="#cb101-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1027"><a href="#cb101-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-036}</span></span>
<span id="cb101-1028"><a href="#cb101-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb101-1029"><a href="#cb101-1029" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">=</span> <span class="fu">ps</span>(<span class="at">threshold.thresholds =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>))</span>
<span id="cb101-1030"><a href="#cb101-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1031"><a href="#cb101-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1032"><a href="#cb101-1032" aria-hidden="true" tabindex="-1"></a>We now create a <span class="in">`r ref("AutoTuner")`</span> which automatically tunes the supplied learner over the <span class="in">`r ref("ParamSet")`</span> we supplied above.</span>
<span id="cb101-1033"><a href="#cb101-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1034"><a href="#cb101-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-037}</span></span>
<span id="cb101-1035"><a href="#cb101-1035" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> AutoTuner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb101-1036"><a href="#cb101-1036" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> l,</span>
<span id="cb101-1037"><a href="#cb101-1037" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> 3L),</span>
<span id="cb101-1038"><a href="#cb101-1038" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb101-1039"><a href="#cb101-1039" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> ps,</span>
<span id="cb101-1040"><a href="#cb101-1040" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> 5L),</span>
<span id="cb101-1041"><a href="#cb101-1041" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb101-1042"><a href="#cb101-1042" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-1043"><a href="#cb101-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1044"><a href="#cb101-1044" aria-hidden="true" tabindex="-1"></a>at<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"german_credit"</span>))</span>
<span id="cb101-1045"><a href="#cb101-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1046"><a href="#cb101-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1047"><a href="#cb101-1047" aria-hidden="true" tabindex="-1"></a>Inside the <span class="in">`trafo`</span>, we simply collect all set params into a named vector via <span class="in">`map_dbl`</span> and store it</span>
<span id="cb101-1048"><a href="#cb101-1048" aria-hidden="true" tabindex="-1"></a>in the <span class="in">`threshold.thresholds`</span> slot expected by the learner.</span>
<span id="cb101-1049"><a href="#cb101-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1050"><a href="#cb101-1050" aria-hidden="true" tabindex="-1"></a>Again, we create a <span class="in">`r ref("AutoTuner")`</span>, which automatically tunes the supplied learner over the <span class="in">`r ref("ParamSet")`</span> we supplied above.</span>
<span id="cb101-1051"><a href="#cb101-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1052"><a href="#cb101-1052" aria-hidden="true" tabindex="-1"></a>One drawback of this strategy is that this requires us to fit a new model for each new threshold setting.</span>
<span id="cb101-1053"><a href="#cb101-1053" aria-hidden="true" tabindex="-1"></a>While setting a threshold and computing performance is relatively cheap, fitting the learner is often</span>
<span id="cb101-1054"><a href="#cb101-1054" aria-hidden="true" tabindex="-1"></a>more computationally demanding.</span>
<span id="cb101-1055"><a href="#cb101-1055" aria-hidden="true" tabindex="-1"></a>An often better strategy is, therefore, to optimize the thresholds separately after each model fit.</span>
<span id="cb101-1056"><a href="#cb101-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1057"><a href="#cb101-1057" aria-hidden="true" tabindex="-1"></a><span class="fu">### PipeOpTunethreshold</span></span>
<span id="cb101-1058"><a href="#cb101-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1059"><a href="#cb101-1059" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOpTuneThreshold")`</span> on the other hand works together with <span class="in">`r ref("PipeOpLearnerCV")`</span>.</span>
<span id="cb101-1060"><a href="#cb101-1060" aria-hidden="true" tabindex="-1"></a>It directly optimizes the <span class="in">`cross-validated`</span> predictions made by this <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb101-1061"><a href="#cb101-1061" aria-hidden="true" tabindex="-1"></a>This is necessary to avoid over-fitting the threshold tuning.</span>
<span id="cb101-1062"><a href="#cb101-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1063"><a href="#cb101-1063" aria-hidden="true" tabindex="-1"></a>A simple example would be:</span>
<span id="cb101-1064"><a href="#cb101-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1065"><a href="#cb101-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-038}</span></span>
<span id="cb101-1066"><a href="#cb101-1066" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"tunethreshold"</span>)</span>
<span id="cb101-1067"><a href="#cb101-1067" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb101-1068"><a href="#cb101-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1069"><a href="#cb101-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1070"><a href="#cb101-1070" aria-hidden="true" tabindex="-1"></a>Note, that <span class="in">`predict_type`</span> = "prob" is required for <span class="in">`po("tunethreshold")`</span> to work.</span>
<span id="cb101-1071"><a href="#cb101-1071" aria-hidden="true" tabindex="-1"></a>Additionally, note that this time no <span class="in">`threshold`</span> parameter is exposed, and it is automatically tuned internally.</span>
<span id="cb101-1072"><a href="#cb101-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1073"><a href="#cb101-1073" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-039}</span></span>
<span id="cb101-1074"><a href="#cb101-1074" aria-hidden="true" tabindex="-1"></a>l2<span class="sc">$</span>param_set</span>
<span id="cb101-1075"><a href="#cb101-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1076"><a href="#cb101-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1077"><a href="#cb101-1077" aria-hidden="true" tabindex="-1"></a>Note that we can set <span class="in">`rsmp("intask")`</span> as a resampling strategy for "learner_cv" in order to evaluate</span>
<span id="cb101-1078"><a href="#cb101-1078" aria-hidden="true" tabindex="-1"></a>predictions on the "training" data.</span>
<span id="cb101-1079"><a href="#cb101-1079" aria-hidden="true" tabindex="-1"></a>This is generally not advised, as it might lead to over-fitting on the thresholds but can significantly reduce runtime.</span>
<span id="cb101-1080"><a href="#cb101-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1081"><a href="#cb101-1081" aria-hidden="true" tabindex="-1"></a>For more information, see the post on Threshold Tuning on the <span class="co">[</span><span class="ot">mlr3 gallery</span><span class="co">](https://mlr3gallery.mlr-org.com/)</span>.</span>
<span id="cb101-1082"><a href="#cb101-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1083"><a href="#cb101-1083" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cluster Analysis {#cluster}</span></span>
<span id="cb101-1084"><a href="#cb101-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1085"><a href="#cb101-1085" aria-hidden="true" tabindex="-1"></a>Cluster analysis is a type of unsupervised machine learning where the goal is to group data into clusters, where each cluster contains similar observations.</span>
<span id="cb101-1086"><a href="#cb101-1086" aria-hidden="true" tabindex="-1"></a>The similarity is based on specified metrics that are task and application-dependent.</span>
<span id="cb101-1087"><a href="#cb101-1087" aria-hidden="true" tabindex="-1"></a>Cluster analysis is closely related to classification in the sense that each observation needs to be assigned to a cluster or a class.</span>
<span id="cb101-1088"><a href="#cb101-1088" aria-hidden="true" tabindex="-1"></a>However, unlike classification problems where each observation is labeled, clustering works on data sets without true labels or class assignments.</span>
<span id="cb101-1089"><a href="#cb101-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1090"><a href="#cb101-1090" aria-hidden="true" tabindex="-1"></a>The package <span class="in">`r mlr3cluster`</span> extends <span class="in">`r mlr3`</span> with the following objects for cluster analysis:</span>
<span id="cb101-1091"><a href="#cb101-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1092"><a href="#cb101-1092" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3cluster::TaskClust", text = "TaskClust")`</span> to define clustering tasks</span>
<span id="cb101-1093"><a href="#cb101-1093" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3cluster::LearnerClust", text = "LearnerClust")`</span> as base class for clustering learners</span>
<span id="cb101-1094"><a href="#cb101-1094" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3cluster::PredictionClust", text = "PredictionClust")`</span> as specialized class for <span class="in">`r ref("Prediction")`</span> objects</span>
<span id="cb101-1095"><a href="#cb101-1095" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("mlr3cluster::MeasureClust", text = "MeasureClust")`</span> as specialized class for performance measures</span>
<span id="cb101-1096"><a href="#cb101-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1097"><a href="#cb101-1097" aria-hidden="true" tabindex="-1"></a>Since clustering is a type of unsupervised learning, <span class="in">`TaskClust`</span> is slightly different from <span class="in">`r ref("TaskRegr")`</span> and <span class="in">`r ref("TaskClassif")`</span> objects.</span>
<span id="cb101-1098"><a href="#cb101-1098" aria-hidden="true" tabindex="-1"></a>More specifically:</span>
<span id="cb101-1099"><a href="#cb101-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1100"><a href="#cb101-1100" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`truth()`</span> function is missing because observations are not labeled.</span>
<span id="cb101-1101"><a href="#cb101-1101" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`target`</span> field is empty and will return <span class="in">`character(0)`</span> if accessed anyway.</span>
<span id="cb101-1102"><a href="#cb101-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1103"><a href="#cb101-1103" aria-hidden="true" tabindex="-1"></a>Additionally, <span class="in">`LearnerClust`</span> provides two extra fields that are absent from supervised learners:</span>
<span id="cb101-1104"><a href="#cb101-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1105"><a href="#cb101-1105" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`assignments`</span> returns cluster assignments for training data. It returns <span class="in">`NULL`</span> if accessed before training.</span>
<span id="cb101-1106"><a href="#cb101-1106" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`save_assignments`</span> is a boolean field that controls whether or not to store training set assignments in a learner.</span>
<span id="cb101-1107"><a href="#cb101-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1108"><a href="#cb101-1108" aria-hidden="true" tabindex="-1"></a>Finally, <span class="in">`PredictionClust`</span> contains two additional fields:</span>
<span id="cb101-1109"><a href="#cb101-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1110"><a href="#cb101-1110" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`partition`</span> stores cluster partitions.</span>
<span id="cb101-1111"><a href="#cb101-1111" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`prob`</span> stores cluster probabilities for each observation.</span>
<span id="cb101-1112"><a href="#cb101-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1113"><a href="#cb101-1113" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train and Predict</span></span>
<span id="cb101-1114"><a href="#cb101-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1115"><a href="#cb101-1115" aria-hidden="true" tabindex="-1"></a>Clustering learners provide both <span class="in">`train`</span> and <span class="in">`predict`</span> methods.</span>
<span id="cb101-1116"><a href="#cb101-1116" aria-hidden="true" tabindex="-1"></a>The analysis typically consists of building clusters using all available data.</span>
<span id="cb101-1117"><a href="#cb101-1117" aria-hidden="true" tabindex="-1"></a>To be consistent with the rest of the library, we refer to this process as training.</span>
<span id="cb101-1118"><a href="#cb101-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1119"><a href="#cb101-1119" aria-hidden="true" tabindex="-1"></a>Some learners can assign new observations to existing groups with <span class="in">`predict`</span>.</span>
<span id="cb101-1120"><a href="#cb101-1120" aria-hidden="true" tabindex="-1"></a>However, prediction does not always make sense, as is the case for hierarchical clustering.</span>
<span id="cb101-1121"><a href="#cb101-1121" aria-hidden="true" tabindex="-1"></a>In hierarchical clustering, the goal is to build a hierarchy of nested clusters by either splitting large clusters into smaller ones or merging smaller clusters into bigger ones.</span>
<span id="cb101-1122"><a href="#cb101-1122" aria-hidden="true" tabindex="-1"></a>The final result is a tree or dendrogram which can change if a new data point is added.</span>
<span id="cb101-1123"><a href="#cb101-1123" aria-hidden="true" tabindex="-1"></a>For consistency with the rest of the ecosystem, <span class="in">`r mlr3cluster`</span> offers <span class="in">`predict`</span> method for hierarchical clusterers but it simply assigns all points to a specified number of clusters by cutting the resulting tree at a corresponding level.</span>
<span id="cb101-1124"><a href="#cb101-1124" aria-hidden="true" tabindex="-1"></a>Moreover, some learners estimate the probability of each observation belonging to a given cluster.</span>
<span id="cb101-1125"><a href="#cb101-1125" aria-hidden="true" tabindex="-1"></a><span class="in">`predict_types`</span> field gives a list of prediction types for each learner.</span>
<span id="cb101-1126"><a href="#cb101-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1127"><a href="#cb101-1127" aria-hidden="true" tabindex="-1"></a>After training, the <span class="in">`model`</span> field stores a learner's model that looks different for each learner depending on the underlying library.</span>
<span id="cb101-1128"><a href="#cb101-1128" aria-hidden="true" tabindex="-1"></a><span class="in">`predict`</span> returns a <span class="in">`PredictionClust`</span> object that gives a simplified view of the learned model.</span>
<span id="cb101-1129"><a href="#cb101-1129" aria-hidden="true" tabindex="-1"></a>If the data given to the <span class="in">`predict`</span> method is the same as the one on which the learner was trained, <span class="in">`predict`</span> simply returns cluster assignments for the "training" observations.</span>
<span id="cb101-1130"><a href="#cb101-1130" aria-hidden="true" tabindex="-1"></a>On the other hand, if the test set contains new data, <span class="in">`predict`</span> will estimate cluster assignments for that data set.</span>
<span id="cb101-1131"><a href="#cb101-1131" aria-hidden="true" tabindex="-1"></a>Some learners do not support estimating cluster partitions on new data and will instead return assignments for training data and print a warning message.</span>
<span id="cb101-1132"><a href="#cb101-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1133"><a href="#cb101-1133" aria-hidden="true" tabindex="-1"></a>In the following example, a <span class="in">`r ref("mlr_learners_clust.kmeans", text = "$k$-means learner")`</span> is applied on the <span class="in">`r ref("mlr_tasks_usarrests", text = "US arrest data set")`</span>.</span>
<span id="cb101-1134"><a href="#cb101-1134" aria-hidden="true" tabindex="-1"></a>The class labels are predicted and the contribution of the task features to assignment of the respective class are visualized.</span>
<span id="cb101-1135"><a href="#cb101-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1136"><a href="#cb101-1136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-040, message=FALSE, warning=FALSE}</span></span>
<span id="cb101-1137"><a href="#cb101-1137" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb101-1138"><a href="#cb101-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3cluster"</span>)</span>
<span id="cb101-1139"><a href="#cb101-1139" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3viz"</span>)</span>
<span id="cb101-1140"><a href="#cb101-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(1L)</span>
<span id="cb101-1141"><a href="#cb101-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1142"><a href="#cb101-1142" aria-hidden="true" tabindex="-1"></a><span class="co"># create an example task</span></span>
<span id="cb101-1143"><a href="#cb101-1143" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"usarrests"</span>)</span>
<span id="cb101-1144"><a href="#cb101-1144" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(task)</span>
<span id="cb101-1145"><a href="#cb101-1145" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(task)</span>
<span id="cb101-1146"><a href="#cb101-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1147"><a href="#cb101-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># create a k-means learner</span></span>
<span id="cb101-1148"><a href="#cb101-1148" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb101-1149"><a href="#cb101-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1150"><a href="#cb101-1150" aria-hidden="true" tabindex="-1"></a><span class="co"># assigning each observation to one of the two clusters (default in clust.kmeans)</span></span>
<span id="cb101-1151"><a href="#cb101-1151" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-1152"><a href="#cb101-1152" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb101-1153"><a href="#cb101-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1154"><a href="#cb101-1154" aria-hidden="true" tabindex="-1"></a><span class="co"># make "predictions" for the same data</span></span>
<span id="cb101-1155"><a href="#cb101-1155" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-1156"><a href="#cb101-1156" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, task)</span>
<span id="cb101-1157"><a href="#cb101-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1158"><a href="#cb101-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1159"><a href="#cb101-1159" aria-hidden="true" tabindex="-1"></a><span class="fu">### Measures</span></span>
<span id="cb101-1160"><a href="#cb101-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1161"><a href="#cb101-1161" aria-hidden="true" tabindex="-1"></a>The difference between supervised and unsupervised learning is that there is no ground truth data in unsupervised learning.</span>
<span id="cb101-1162"><a href="#cb101-1162" aria-hidden="true" tabindex="-1"></a>In a supervised setting, such as classification, we would need to compare our predictions to true labels.</span>
<span id="cb101-1163"><a href="#cb101-1163" aria-hidden="true" tabindex="-1"></a>Since clustering is an example of unsupervised learning, there are no true labels to which we can compare.</span>
<span id="cb101-1164"><a href="#cb101-1164" aria-hidden="true" tabindex="-1"></a>However, we can still measure the quality of cluster assignments by quantifying how closely objects within the same cluster are related (cluster cohesion) as well as how distinct different clusters are from each other (cluster separation).</span>
<span id="cb101-1165"><a href="#cb101-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1166"><a href="#cb101-1166" aria-hidden="true" tabindex="-1"></a>There are a few built-in evaluation metrics available to assess the quality of clustering.</span>
<span id="cb101-1167"><a href="#cb101-1167" aria-hidden="true" tabindex="-1"></a>One of them is <span class="in">`r ref("mlr_measures_clust.wss", text = "within sum of squares (WSS)")`</span> which calculates the sum of squared differences between observations and centroids.</span>
<span id="cb101-1168"><a href="#cb101-1168" aria-hidden="true" tabindex="-1"></a>WSS is useful because it quantifies cluster cohesion.</span>
<span id="cb101-1169"><a href="#cb101-1169" aria-hidden="true" tabindex="-1"></a>The range of this measure is $[0, \infty)$ where a smaller value means that clusters are more compact.</span>
<span id="cb101-1170"><a href="#cb101-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1171"><a href="#cb101-1171" aria-hidden="true" tabindex="-1"></a>Another measure is <span class="in">`r ref("mlr_measures_clust.silhouette", text = "silhouette quality index")`</span> that quantifies how well each point belongs to its assigned cluster versus neighboring cluster.</span>
<span id="cb101-1172"><a href="#cb101-1172" aria-hidden="true" tabindex="-1"></a>Silhouette values are in $<span class="co">[</span><span class="ot">-1, 1</span><span class="co">]</span>$ range.</span>
<span id="cb101-1173"><a href="#cb101-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1174"><a href="#cb101-1174" aria-hidden="true" tabindex="-1"></a>Points with silhouette closer to:</span>
<span id="cb101-1175"><a href="#cb101-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1176"><a href="#cb101-1176" aria-hidden="true" tabindex="-1"></a><span class="ss">   * </span>1 are well clustered</span>
<span id="cb101-1177"><a href="#cb101-1177" aria-hidden="true" tabindex="-1"></a><span class="ss">   * </span>0 lie between two clusters</span>
<span id="cb101-1178"><a href="#cb101-1178" aria-hidden="true" tabindex="-1"></a><span class="ss">   * </span>-1 likely placed in the wrong cluster</span>
<span id="cb101-1179"><a href="#cb101-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1180"><a href="#cb101-1180" aria-hidden="true" tabindex="-1"></a>The following is an example of conducting a benchmark experiment with various learners on <span class="in">`r ref("mlr_tasks_iris", text = "iris data set")`</span> without target variable and assessing the quality of each learner with both within sum of squares and silhouette measures.</span>
<span id="cb101-1181"><a href="#cb101-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1182"><a href="#cb101-1182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-041, message=FALSE, warning=FALSE}</span></span>
<span id="cb101-1183"><a href="#cb101-1183" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb101-1184"><a href="#cb101-1184" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>]),</span>
<span id="cb101-1185"><a href="#cb101-1185" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(</span>
<span id="cb101-1186"><a href="#cb101-1186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> 3L),</span>
<span id="cb101-1187"><a href="#cb101-1187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"clust.pam"</span>, <span class="at">k =</span> 2L),</span>
<span id="cb101-1188"><a href="#cb101-1188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"clust.cmeans"</span>, <span class="at">centers =</span> 3L)),</span>
<span id="cb101-1189"><a href="#cb101-1189" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"insample"</span>))</span>
<span id="cb101-1190"><a href="#cb101-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(design)</span>
<span id="cb101-1191"><a href="#cb101-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1192"><a href="#cb101-1192" aria-hidden="true" tabindex="-1"></a><span class="co"># execute benchmark</span></span>
<span id="cb101-1193"><a href="#cb101-1193" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb101-1194"><a href="#cb101-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1195"><a href="#cb101-1195" aria-hidden="true" tabindex="-1"></a><span class="co"># define measure</span></span>
<span id="cb101-1196"><a href="#cb101-1196" aria-hidden="true" tabindex="-1"></a>measures <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">msr</span>(<span class="st">"clust.wss"</span>), <span class="fu">msr</span>(<span class="st">"clust.silhouette"</span>))</span>
<span id="cb101-1197"><a href="#cb101-1197" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measures)</span>
<span id="cb101-1198"><a href="#cb101-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1199"><a href="#cb101-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1200"><a href="#cb101-1200" aria-hidden="true" tabindex="-1"></a>The experiment shows that using k-means algorithm with three centers produces a better within sum of squares score than any other learner considered. However, pam (partitioning around medoids) learner with two clusters performs the best when considering silhouette measure which takes into the account both cluster cohesion and separation.</span>
<span id="cb101-1201"><a href="#cb101-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1202"><a href="#cb101-1202" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualization</span></span>
<span id="cb101-1203"><a href="#cb101-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1204"><a href="#cb101-1204" aria-hidden="true" tabindex="-1"></a>Cluster analysis in <span class="in">`r mlr3`</span> is integrated with <span class="in">`r mlr3viz`</span> which provides a number of useful plots. Some of those plots are shown below.</span>
<span id="cb101-1205"><a href="#cb101-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1206"><a href="#cb101-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-042, message=FALSE, warning=FALSE}</span></span>
<span id="cb101-1207"><a href="#cb101-1207" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>])</span>
<span id="cb101-1208"><a href="#cb101-1208" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb101-1209"><a href="#cb101-1209" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-1210"><a href="#cb101-1210" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-1211"><a href="#cb101-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1212"><a href="#cb101-1212" aria-hidden="true" tabindex="-1"></a><span class="co"># performing PCA on task and showing assignments</span></span>
<span id="cb101-1213"><a href="#cb101-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"pca"</span>)</span>
<span id="cb101-1214"><a href="#cb101-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1215"><a href="#cb101-1215" aria-hidden="true" tabindex="-1"></a><span class="co"># same as above but with probability ellipse that assumes normal distribution</span></span>
<span id="cb101-1216"><a href="#cb101-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"pca"</span>, <span class="at">frame =</span> <span class="cn">TRUE</span>, <span class="at">frame.type =</span> <span class="st">"norm"</span>)</span>
<span id="cb101-1217"><a href="#cb101-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1218"><a href="#cb101-1218" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"usarrests"</span>)</span>
<span id="cb101-1219"><a href="#cb101-1219" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.hclust"</span>)</span>
<span id="cb101-1220"><a href="#cb101-1220" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-1221"><a href="#cb101-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1222"><a href="#cb101-1222" aria-hidden="true" tabindex="-1"></a><span class="co"># dendrogram for hierarchical clustering</span></span>
<span id="cb101-1223"><a href="#cb101-1223" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(learner, <span class="at">task =</span> task)</span>
<span id="cb101-1224"><a href="#cb101-1224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1225"><a href="#cb101-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1226"><a href="#cb101-1226" aria-hidden="true" tabindex="-1"></a>Silhouette plots can help to visually assess the quality of the analysis and help choose a number of clusters for a given data set.</span>
<span id="cb101-1227"><a href="#cb101-1227" aria-hidden="true" tabindex="-1"></a>The red dotted line shows the mean silhouette value and each bar represents a data point.</span>
<span id="cb101-1228"><a href="#cb101-1228" aria-hidden="true" tabindex="-1"></a>If most points in each cluster have an index around or higher than mean silhouette, the number of clusters is chosen well.</span>
<span id="cb101-1229"><a href="#cb101-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1230"><a href="#cb101-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-043, message=FALSE, warning=FALSE}</span></span>
<span id="cb101-1231"><a href="#cb101-1231" aria-hidden="true" tabindex="-1"></a><span class="co"># silhouette plot allows to visually inspect the quality of clustering</span></span>
<span id="cb101-1232"><a href="#cb101-1232" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> TaskClust<span class="sc">$</span><span class="fu">new</span>(<span class="st">"iris"</span>, iris[<span class="sc">-</span><span class="dv">5</span>])</span>
<span id="cb101-1233"><a href="#cb101-1233" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb101-1234"><a href="#cb101-1234" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">centers =</span> 5L)</span>
<span id="cb101-1235"><a href="#cb101-1235" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-1236"><a href="#cb101-1236" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-1237"><a href="#cb101-1237" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"sil"</span>)</span>
<span id="cb101-1238"><a href="#cb101-1238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1239"><a href="#cb101-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1240"><a href="#cb101-1240" aria-hidden="true" tabindex="-1"></a>The plot shows that all points in cluster 5 and almost all points in clusters 4, 2 and 1 are below average silhouette index.</span>
<span id="cb101-1241"><a href="#cb101-1241" aria-hidden="true" tabindex="-1"></a>This means that a lot of observations lie either on the border of clusters or are likely assigned to the wrong cluster.</span>
<span id="cb101-1242"><a href="#cb101-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1243"><a href="#cb101-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r special-044, message=FALSE, warning=FALSE}</span></span>
<span id="cb101-1244"><a href="#cb101-1244" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>)</span>
<span id="cb101-1245"><a href="#cb101-1245" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">centers =</span> 2L)</span>
<span id="cb101-1246"><a href="#cb101-1246" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-1247"><a href="#cb101-1247" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb101-1248"><a href="#cb101-1248" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(prediction, task, <span class="at">type =</span> <span class="st">"sil"</span>)</span>
<span id="cb101-1249"><a href="#cb101-1249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb101-1250"><a href="#cb101-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-1251"><a href="#cb101-1251" aria-hidden="true" tabindex="-1"></a>Setting the number of centers to two improves both the average silhouette score as well as the overall quality of clustering because almost all points in cluster 1 are higher than, and a lot of points in cluster 2 are close to the mean silhouette.</span>
<span id="cb101-1252"><a href="#cb101-1252" aria-hidden="true" tabindex="-1"></a>Hence, having two centers might be a better choice for the number of clusters.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licenced under <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>.</div>   
      <div class="nav-footer-center"><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></div>
    <div class="nav-footer-right">Written with <i class="bi bi-heart-fill"></i> for #rstats, ML and FOSS by the mlr-org team.</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>