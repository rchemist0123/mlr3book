<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Author 1">
<meta name="author" content="Author 2">
<title>Flexible and Robust Machine Learning Using mlr3 in R - 11&nbsp; Extending</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./interpretation.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script async="" src="https://hypothes.is/embed.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Extending</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Flexible and Robust Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="./Flexible-and-Robust-Machine-Learning-Using-mlr3-in-R.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Resampling and Benchmarking</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Feature Selection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pipelines.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pipelines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preprocessing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Preprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./special.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Special Tasks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./technical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Technical</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpretation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Interpretation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extending.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Extending</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Appendices</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Glossary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tasks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview-tables.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Overview Tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Session Info</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-extending-learners" id="toc-sec-extending-learners" class="nav-link active" data-scroll-target="#sec-extending-learners"><span class="toc-section-number">11.1</span>  Adding new Learners</a>
  <ul class="collapse">
<li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="toc-section-number">11.1.1</span>  Setting-up mlr3extralearners</a></li>
  <li><a href="#create-learner" id="toc-create-learner" class="nav-link" data-scroll-target="#create-learner"><span class="toc-section-number">11.1.2</span>  Calling create_learner</a></li>
  <li><a href="#learner_package_type_key.r" id="toc-learner_package_type_key.r" class="nav-link" data-scroll-target="#learner_package_type_key.r"><span class="toc-section-number">11.1.3</span>  <code>learner_package_type_key.R</code></a></li>
  <li><a href="#learner-meta-information" id="toc-learner-meta-information" class="nav-link" data-scroll-target="#learner-meta-information"><span class="toc-section-number">11.1.4</span>  Meta-information</a></li>
  <li><a href="#param-set" id="toc-param-set" class="nav-link" data-scroll-target="#param-set"><span class="toc-section-number">11.1.5</span>  ParamSet</a></li>
  <li><a href="#learner-train" id="toc-learner-train" class="nav-link" data-scroll-target="#learner-train"><span class="toc-section-number">11.1.6</span>  Train function</a></li>
  <li><a href="#learner-predict" id="toc-learner-predict" class="nav-link" data-scroll-target="#learner-predict"><span class="toc-section-number">11.1.7</span>  Predict function</a></li>
  <li><a href="#optional-extractors" id="toc-optional-extractors" class="nav-link" data-scroll-target="#optional-extractors"><span class="toc-section-number">11.1.8</span>  Optional Extractors</a></li>
  <li><a href="#hotstarting" id="toc-hotstarting" class="nav-link" data-scroll-target="#hotstarting"><span class="toc-section-number">11.1.9</span>  Hotstarting</a></li>
  <li><a href="#learner-control" id="toc-learner-control" class="nav-link" data-scroll-target="#learner-control"><span class="toc-section-number">11.1.10</span>  Control objects/functions of learners</a></li>
  <li><a href="#adding-the-description" id="toc-adding-the-description" class="nav-link" data-scroll-target="#adding-the-description"><span class="toc-section-number">11.1.11</span>  Adding the description</a></li>
  <li><a href="#learner-test" id="toc-learner-test" class="nav-link" data-scroll-target="#learner-test"><span class="toc-section-number">11.1.12</span>  Testing the learner</a></li>
  <li><a href="#cleaning" id="toc-cleaning" class="nav-link" data-scroll-target="#cleaning"><span class="toc-section-number">11.1.13</span>  Package Cleaning</a></li>
  <li><a href="#thanks-and-maintenance" id="toc-thanks-and-maintenance" class="nav-link" data-scroll-target="#thanks-and-maintenance"><span class="toc-section-number">11.1.14</span>  Thanks and Maintenance</a></li>
  <li><a href="#learner-faq" id="toc-learner-faq" class="nav-link" data-scroll-target="#learner-faq"><span class="toc-section-number">11.1.15</span>  Learner FAQ</a></li>
  </ul>
</li>
  <li><a href="#extending-measures" id="toc-extending-measures" class="nav-link" data-scroll-target="#extending-measures"><span class="toc-section-number">11.2</span>  Adding new Measures</a></li>
  <li>
<a href="#extending-pipeops" id="toc-extending-pipeops" class="nav-link" data-scroll-target="#extending-pipeops"><span class="toc-section-number">11.3</span>  Adding new PipeOps</a>
  <ul class="collapse">
<li><a href="#ext-pipeopcopy" id="toc-ext-pipeopcopy" class="nav-link" data-scroll-target="#ext-pipeopcopy"><span class="toc-section-number">11.3.1</span>  General Case Example: <code>PipeOpCopy</code></a></li>
  <li><a href="#ext-pipe-preproc" id="toc-ext-pipe-preproc" class="nav-link" data-scroll-target="#ext-pipe-preproc"><span class="toc-section-number">11.3.2</span>  Special Case: Preprocessing</a></li>
  <li><a href="#special-case-preprocessing-with-simple-train" id="toc-special-case-preprocessing-with-simple-train" class="nav-link" data-scroll-target="#special-case-preprocessing-with-simple-train"><span class="toc-section-number">11.3.3</span>  Special Case: Preprocessing with Simple Train</a></li>
  <li><a href="#ext-pipe-hyperpars" id="toc-ext-pipe-hyperpars" class="nav-link" data-scroll-target="#ext-pipe-hyperpars"><span class="toc-section-number">11.3.4</span>  Hyperparameters</a></li>
  </ul>
</li>
  <li>
<a href="#extending-tuners" id="toc-extending-tuners" class="nav-link" data-scroll-target="#extending-tuners"><span class="toc-section-number">11.4</span>  Adding new Tuners</a>
  <ul class="collapse">
<li><a href="#extending-tuners-summary" id="toc-extending-tuners-summary" class="nav-link" data-scroll-target="#extending-tuners-summary"><span class="toc-section-number">11.4.1</span>  Adding a new Tuner</a></li>
  <li><a href="#tuner-template" id="toc-tuner-template" class="nav-link" data-scroll-target="#tuner-template"><span class="toc-section-number">11.4.2</span>  Template</a></li>
  <li><a href="#tuner-optimize" id="toc-tuner-optimize" class="nav-link" data-scroll-target="#tuner-optimize"><span class="toc-section-number">11.4.3</span>  Optimize method</a></li>
  <li><a href="#tuner-add-result" id="toc-tuner-add-result" class="nav-link" data-scroll-target="#tuner-add-result"><span class="toc-section-number">11.4.4</span>  Assign result method</a></li>
  <li><a href="#tuner-from-optimizer" id="toc-tuner-from-optimizer" class="nav-link" data-scroll-target="#tuner-from-optimizer"><span class="toc-section-number">11.4.5</span>  Transform optimizer to tuner</a></li>
  <li><a href="#tuner-test" id="toc-tuner-test" class="nav-link" data-scroll-target="#tuner-test"><span class="toc-section-number">11.4.6</span>  Add unit tests</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mlr-org/mlr3book/edit/main/book/extending.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/mlr-org/mlr3book/blob/main/book/extending.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-extending" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Extending</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    Author 1 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 1
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    Author 2 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 2
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    TODO (150-200 WORDS)
  </div>
</div>

</header><p>This chapter gives instructions on how to extend <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> and its extension packages with custom objects.</p>
<p>The approach is always the same:</p>
<ol type="1">
<li>determine the base class you want to inherit from,</li>
<li>extend the class with your custom functionality,</li>
<li>test your implementation</li>
<li>(optionally) add new object to the respective <a href="https://mlr3misc.mlr-org.com/reference/Dictionary.html"><code>Dictionary</code></a>.</li>
</ol>
<p>The chapter <a href="#extending-learners">Create a new learner</a> illustrates the steps needed to create a custom learner in <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>.</p>
<div class="callout-important callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
This section of the book might be complex for some readers.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<section id="sec-extending-learners" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="sec-extending-learners">
<span class="header-section-number">11.1</span> Adding new Learners</h2>
<p>Although many learners are already included in the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ecosystem, there might be a situation in which your algorithm of choice is not implemented. Here, we show how to create a custom mlr3learner step-by-step using <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>. If you intend to add a learner to mlr3extralearners, <strong>it is strongly recommended</strong> to <strong>first</strong> open a <a href="https://github.com/mlr-org/mlr3extralearners/issues/new?assignees=&amp;labels=new+learner&amp;template=learner-request-template.md&amp;title=%5BLRNRQ%5D+Add+%3Calgorithm%3E+from+package+%3Cpackage%3E">learner request issue</a> to inform the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> team about your idea. This allows to discuss the implementation details and potential peculiarities of the learner before putting actual work in.</p>
<p>This section gives insights on how a mlr3learner is constructed and how to troubleshoot issues. See the <a href="#learner-faq">Learner FAQ subsection</a> for help.</p>
<p><strong>Summary of steps for adding a new learner</strong></p>
<ol type="1">
<li>Check that the learner does not already exist <a href="https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html">here</a>.</li>
<li>
<a href="#setup">Install</a> <a href="https://mlr3extralearners.mlr-org.com"><code>mlr3extralearners</code></a> and if you want to create a PR, also <a href="#setup">fork and clone</a> it.</li>
<li>
<a href="#create-learner">Run</a> <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner()</code></a>.</li>
<li>Add the learner’s <a href="#param-set"><code>ParamSet</code></a>.</li>
<li>Manually add <a href="#learner-train"><code>.train</code></a> and <a href="#learner-predict"><code>.predict</code></a> private methods to the learner.</li>
<li>Implement supported <a href="#optional-extractors">optional extractors</a> and <a href="#hotstarting">hotstarting</a> if applicable.</li>
<li>Fill out the missing parts in the learner’s description. To add references you first need to create an entry in bibentries.R</li>
<li>Check that <a href="#learner-test">unit tests</a> and <a href="#learner-test">parameter tests</a> pass (these are automatically created).</li>
<li>Run <a href="#cleaning">cleaning functions</a>.</li>
<li>Open a <a href="https://github.com/mlr-org/mlr3extralearners/pulls">pull request</a> with the “new learner” template.</li>
</ol>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do not copy/paste the code shown in this section. Use <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>create_learner()</code></a> to start.</p>
</div>
</div>
<section id="setup" class="level3" data-number="11.1.1"><h3 data-number="11.1.1" class="anchored" data-anchor-id="setup">
<span class="header-section-number">11.1.1</span> Setting-up mlr3extralearners</h3>
<p>In order to use <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a> you must have mlr3extralearners installed. Note that mlr3extralearners is not on CRAN and has to be installed from GitHub. To ensure that you have the latest version, run <code>remotes::install_github("mlr-org/mlr3extralearners")</code> before proceeding.</p>
<p>If you want to create a pull request to mlr3extralearners you also need to</p>
<ol type="1">
<li>
<a href="https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/fork-a-repo">Fork</a> the <a href="https://github.com/mlr-org/mlr3extralearners">repository</a>
</li>
<li>
<a href="https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/cloning-a-repository">Clone</a> a local copy of your forked repository.</li>
</ol></section><section id="create-learner" class="level3" data-number="11.1.2"><h3 data-number="11.1.2" class="anchored" data-anchor-id="create-learner">
<span class="header-section-number">11.1.2</span> Calling create_learner</h3>
<p>The learner <code>classif.rpart</code> will be used as a running example throughout this section.</p>
<div class="cell" data-hash="extending_cache/html/extending-002_42ce7996861d8b4c825e6d026d90956e">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(<span class="st">"mlr3extralearners"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">create_learner</span>(</span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="at">path =</span> <span class="st">"path/to/a/folder"</span>,</span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="at">classname =</span> <span class="st">"Rpart"</span>,</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="at">type =</span> <span class="st">"classif"</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="at">key =</span> <span class="st">"rpart"</span>,</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="at">algorithm =</span> <span class="st">"Decision Tree"</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="at">package =</span> <span class="st">"rpart"</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="at">caller =</span> <span class="st">"rpart"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="at">feature_types =</span> <span class="fu">c</span>(<span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span>),</span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="at">predict_types =</span> <span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"prob"</span>),</span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span>),</span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="at">gh_name =</span> <span class="st">"RaphaelS1"</span>,</span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="at">label =</span> <span class="st">"Regression and Partition Tree"</span>,</span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="at">data_formats =</span> <span class="st">"data.table"</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The full documentation for the function arguments is in <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>, in this example we are doing the following:</p>
<ol type="1">
<li>
<code>path = "path/to/a/folder"</code> - This determines where the templates are being generated. If the path is the root of an R package, the learner is created in the ./R directory and the test files in ./tests/testthat. Otherwise, all files are being created in the folder pointed to by path. Already existing files will not be modified.</li>
<li>
<code>classname = "Rpart"</code> - Set the R6 class name to LearnerClassifRpart (classif is below)</li>
<li>
<code>algorithm = "Decision Tree"</code> - Create the title as “Classification Decision Tree Learner”, where “Classification” is determined automatically from <code>type</code> and “Learner” is added for all learners.</li>
<li>
<code>type = "classif"</code> - Setting the learner as a classification learner, automatically filling the title, class name, id (<code>"classif.rpart"</code>) and task type.</li>
<li>
<code>key = "rpart"</code> - Used with <code>type</code> to create the unique ID of the learner, <code>"classif.rpart"</code>.</li>
<li>
<code>package = "rpart"</code> - Setting the package from which the learner is implemented, this fills in things like the training function (along with <code>caller</code>) and the <code>man</code> field.</li>
<li>
<code>caller = "rpart"</code> - This tells the <code>.train</code> function, and the description which function is called to run the algorithm, with <code>package</code> this automatically fills <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart</a></code>.</li>
<li>
<code>feature_types = c("logical", "integer", "numeric", "factor", "ordered")</code> - Sets the type of features that can be handled by the learner. See <a href="#learner-meta-information">meta information</a>.</li>
<li>
<code>predict_types = c("response", "prob"),</code> - Sets the available prediction types as response (pointwise prediction) and prob (probabilities). See <a href="#learner-meta-information">meta information</a>.</li>
<li>
<code>properties = c("importance", "missings", "multiclass", "twoclass", "weights")</code> - Sets the properties the learner supports. By including <code>"importance"</code> a public method called <code>importance</code> will be created that must be manually filled. See <a href="#learner-meta-information">meta information</a> and <a href="#optional-extractors">optional extractors</a>.</li>
<li>
<code>gh_name = "RaphaelS1"</code> - Fills the ‘@author’ tag with my GitHub handle, this is required as it identifies the maintainer of the learner.</li>
</ol>
<p>The sections below show an exemplary execution of <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>.</p>
</section><section id="learner_package_type_key.r" class="level3" data-number="11.1.3"><h3 data-number="11.1.3" class="anchored" data-anchor-id="learner_package_type_key.r">
<span class="header-section-number">11.1.3</span> <code>learner_package_type_key.R</code>
</h3>
<p>The first generated file which must be updated after running <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>create_learner()</code></a> is the one following the structure <code>learner_&lt;package&gt;_&lt;type&gt;_&lt;key&gt;.R</code>; in this example <code>learner_rpart_classif_rpart.R</code>.</p>
<p>For our example, the resulting script looks like this:</p>
<div class="cell" data-hash="extending_cache/html/extending-003_0449925dc3fc7a776652707a35512157">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">#' @title Classification Decision Tree Learner</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#' @author RaphaelS1</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#' @name mlr_learners_classif.rpart</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#'</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#' @description</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: BRIEF DESCRIPTION OF THE LEARNER.</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#' Calls [rpart::rpart()] from </span><span class="al">FIXME</span><span class="co">: (CRAN VS NO CRAN): \CRANpkg{rpart} | 'rpart'.</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#'</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#' @section Custom mlr3 parameters:</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: DEVIATIONS FROM UPSTREAM PARAMETERS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">#'</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: DEVIATIONS FROM UPSTREAM DEFAULTS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">#'</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">#' @section Installation:</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: CUSTOM INSTALLATION INSTRUCTIONS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">#'</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">#' @templateVar id classif.rpart</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">#' @template learner</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">#'</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">#' @references</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: ADD REFERENCES</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">#'</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">#' @template seealso_learner</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">#' @template example</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">#' @export</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>LearnerClassifRpart <span class="ot">=</span> <span class="fu">R6Class</span>(<span class="st">"LearnerClassifRpart"</span>,</span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="at">inherit =</span> LearnerClassif,</span>
<span id="cb2-29"><a href="#cb2-29"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="co">#' @description</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>    <span class="co">#' Creates a new instance of this [R6][R6::R6Class] class.</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb2-33"><a href="#cb2-33"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: MANUALLY ADD PARAMETERS BELOW AND THEN DELETE THIS LINE</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>      param_set <span class="ot">=</span> <span class="fu">ps</span>()</span>
<span id="cb2-35"><a href="#cb2-35"></a></span>
<span id="cb2-36"><a href="#cb2-36"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: MANUALLY UPDATE PARAM VALUES BELOW IF APPLICABLE THEN DELETE THIS LINE.</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>      param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb2-38"><a href="#cb2-38"></a></span>
<span id="cb2-39"><a href="#cb2-39"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb2-40"><a href="#cb2-40"></a>        <span class="at">id =</span> <span class="st">"classif.rpart"</span>,</span>
<span id="cb2-41"><a href="#cb2-41"></a>        <span class="at">packages =</span> <span class="st">"rpart"</span>,</span>
<span id="cb2-42"><a href="#cb2-42"></a>        <span class="at">feature_types =</span> <span class="fu">c</span>(<span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span>),</span>
<span id="cb2-43"><a href="#cb2-43"></a>        <span class="at">predict_types =</span> <span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"prob"</span>),</span>
<span id="cb2-44"><a href="#cb2-44"></a>        <span class="at">param_set =</span> param_set,</span>
<span id="cb2-45"><a href="#cb2-45"></a>        <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span>),</span>
<span id="cb2-46"><a href="#cb2-46"></a>        <span class="at">man =</span> <span class="st">"mlr3extralearners::mlr_learners_classif.rpart"</span>,</span>
<span id="cb2-47"><a href="#cb2-47"></a>        <span class="at">label =</span> <span class="st">"Regression and Partition Tree"</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>      )</span>
<span id="cb2-49"><a href="#cb2-49"></a>    },</span>
<span id="cb2-50"><a href="#cb2-50"></a>    <span class="co"># </span><span class="al">FIXME</span><span class="co">: ADD IMPORTANCE METHOD IF APPLICABLE AND DELETE OTHERWISE</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>    <span class="co"># SEE mlr3extralearners::LearnerRegrRandomForest FOR AN EXAMPLE</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>    <span class="co">#' @description</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>    <span class="co">#' The importance scores are extracted from the slot </span><span class="al">FIXME</span><span class="co">:.</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>    <span class="co">#' @return Named `numeric()`.</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>    <span class="at">importance =</span> <span class="cf">function</span>() {</span>
<span id="cb2-56"><a href="#cb2-56"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"importance"</span>)</span>
<span id="cb2-57"><a href="#cb2-57"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: Implement importance</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>    }</span>
<span id="cb2-59"><a href="#cb2-59"></a>  ),</span>
<span id="cb2-60"><a href="#cb2-60"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb2-61"><a href="#cb2-61"></a>    <span class="at">.train =</span> <span class="cf">function</span>(task) {</span>
<span id="cb2-62"><a href="#cb2-62"></a>      <span class="co"># get parameters for training</span></span>
<span id="cb2-63"><a href="#cb2-63"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb2-64"><a href="#cb2-64"></a></span>
<span id="cb2-65"><a href="#cb2-65"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: IF LEARNER DOES NOT HAVE 'weights' PROPERTY THEN DELETE THESE LINES.</span></span>
<span id="cb2-66"><a href="#cb2-66"></a>      <span class="cf">if</span> (<span class="st">"weights"</span> <span class="sc">%in%</span> task<span class="sc">$</span>properties) {</span>
<span id="cb2-67"><a href="#cb2-67"></a>        <span class="co"># Add weights to learner</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>      }</span>
<span id="cb2-69"><a href="#cb2-69"></a></span>
<span id="cb2-70"><a href="#cb2-70"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: CREATE OBJECTS FOR THE TRAIN CALL</span></span>
<span id="cb2-71"><a href="#cb2-71"></a>      <span class="co"># AT LEAST "data" AND "formula" ARE REQUIRED</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>      formula <span class="ot">=</span> task<span class="sc">$</span><span class="fu">formula</span>()</span>
<span id="cb2-73"><a href="#cb2-73"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb2-74"><a href="#cb2-74"></a></span>
<span id="cb2-75"><a href="#cb2-75"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: HERE IS SPACE FOR SOME CUSTOM ADJUSTMENTS BEFORE PROCEEDING TO THE</span></span>
<span id="cb2-76"><a href="#cb2-76"></a>      <span class="co"># TRAIN CALL. CHECK OTHER LEARNERS FOR WHAT CAN BE DONE HERE</span></span>
<span id="cb2-77"><a href="#cb2-77"></a>      <span class="co"># USE THE mlr3misc::invoke FUNCTION (IT'S SIMILAR TO do.call())</span></span>
<span id="cb2-78"><a href="#cb2-78"></a></span>
<span id="cb2-79"><a href="#cb2-79"></a>      <span class="fu">invoke</span>(</span>
<span id="cb2-80"><a href="#cb2-80"></a>        rpart<span class="sc">::</span>rpart,</span>
<span id="cb2-81"><a href="#cb2-81"></a>        <span class="at">formula =</span> formula,</span>
<span id="cb2-82"><a href="#cb2-82"></a>        <span class="at">data =</span> data,</span>
<span id="cb2-83"><a href="#cb2-83"></a>        <span class="at">.args =</span> pars</span>
<span id="cb2-84"><a href="#cb2-84"></a>      )</span>
<span id="cb2-85"><a href="#cb2-85"></a>    },</span>
<span id="cb2-86"><a href="#cb2-86"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(task) {</span>
<span id="cb2-87"><a href="#cb2-87"></a>      <span class="co"># get parameters with tag "predict"</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"predict"</span>)</span>
<span id="cb2-89"><a href="#cb2-89"></a></span>
<span id="cb2-90"><a href="#cb2-90"></a>      <span class="co"># get newdata and ensure same ordering in train and predict</span></span>
<span id="cb2-91"><a href="#cb2-91"></a>      newdata <span class="ot">=</span> <span class="fu">ordered_features</span>(task, self)</span>
<span id="cb2-92"><a href="#cb2-92"></a></span>
<span id="cb2-93"><a href="#cb2-93"></a>      <span class="co"># Calculate predictions for the selected predict type.</span></span>
<span id="cb2-94"><a href="#cb2-94"></a>      type <span class="ot">=</span> self<span class="sc">$</span>predict_type</span>
<span id="cb2-95"><a href="#cb2-95"></a></span>
<span id="cb2-96"><a href="#cb2-96"></a>      pred <span class="ot">=</span> <span class="fu">invoke</span>(predict, self<span class="sc">$</span>model, <span class="at">newdata =</span> newdata, <span class="at">type =</span> type, <span class="at">.args =</span> pars)</span>
<span id="cb2-97"><a href="#cb2-97"></a></span>
<span id="cb2-98"><a href="#cb2-98"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: ADD PREDICTIONS TO LIST BELOW</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>      <span class="fu">list</span>()</span>
<span id="cb2-100"><a href="#cb2-100"></a>    }</span>
<span id="cb2-101"><a href="#cb2-101"></a>  )</span>
<span id="cb2-102"><a href="#cb2-102"></a>)</span>
<span id="cb2-103"><a href="#cb2-103"></a></span>
<span id="cb2-104"><a href="#cb2-104"></a>.extralrns_dict<span class="sc">$</span><span class="fu">add</span>(<span class="st">"classif.rpart"</span>, LearnerClassifRpart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have to do the following (the description will be addressed later):</p>
<ol type="1">
<li>Add the learner’s parameters to the <a href="#param-set">ParamSet</a>.</li>
<li>Optionally <a href="#param-set">change default values</a> for the parameters.</li>
<li>Fill in the private <a href="#learner-train"><code>.train</code></a> method, which takes a (filtered) <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> and returns a model.</li>
<li>Fill in the private <a href="#learner-predict"><code>.predict</code></a> method, which operates on the model in <code>self$model</code> (stored during <code>$train()</code>) and a (differently subsetted) <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> to return a named list of predictions.</li>
<li>As we included “importance” in <code>properties</code>, we have to add the public method <code>importance()</code> which returns a named numeric vectors with the decreasingly sorted importance scores (values) for the different features (names).</li>
</ol></section><section id="learner-meta-information" class="level3" data-number="11.1.4"><h3 data-number="11.1.4" class="anchored" data-anchor-id="learner-meta-information">
<span class="header-section-number">11.1.4</span> Meta-information</h3>
<p>In the constructor (<code>initialize()</code>) the constructor of the super class (e.g.&nbsp;<a href="https://mlr3.mlr-org.com/reference/LearnerClassif.html"><code>LearnerClassif</code></a>) is called with meta information about the learner which should be constructed. This includes:</p>
<ul>
<li>
<code>id</code>: The ID of the new learner. Usually consists of <code>&lt;type&gt;.&lt;key&gt;</code>, for example: <code>"classif.rpart"</code>.</li>
<li>
<code>packages</code>: The upstream package name(s) of the implemented learner.</li>
<li>
<code>param_set</code>: A set of hyperparameters and their descriptions provided as a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>paradox::ParamSet</code></a>. For each hyperparameter the appropriate class needs to be chosen. When using the <a href="https://paradox.mlr-org.com/reference/ps.html"><code>paradox::ps</code></a> shortcut, a short constructor of the form <code>p_***</code> can be used:
<ul>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamLgl.html"><code>paradox::ParamLgl</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_lgl</code></a> for scalar logical hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamInt.html"><code>paradox::ParamInt</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_int</code></a> for scalar integer hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamDbl.html"><code>paradox::ParamDbl</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_dbl</code></a> for scalar numeric hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamFct.html"><code>paradox::ParamFct</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_fct</code></a> for scalar factor hyperparameters (this includes characters).</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamUty.html"><code>paradox::ParamUty</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_uty</code></a> for everything else (e.g.&nbsp;vector paramters or list parameters).</li>
</ul>
</li>
<li>
<code>predict_types</code>: Set of predict types the learner supports. These differ depending on the type of the learner. See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$learner_predict_types</code></a> for the full list of predict types supported by <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>.
<ul>
<li>
<a href="https://mlr3.mlr-org.com/reference/LearnerClassif.html"><code>LearnerClassif</code></a>
<ul>
<li>
<code>response</code>: Only predicts a class label for each observation.</li>
<li>
<code>prob</code>: Also predicts the posterior probability for each class for each observation.</li>
</ul>
</li>
<li>
<a href="https://mlr3.mlr-org.com/reference/LearnerRegr.html"><code>LearnerRegr</code></a>
<ul>
<li>
<code>response</code>: Only predicts a numeric response for each observation.</li>
<li>
<code>se</code>: Also predicts the standard error for each value of response.</li>
</ul>
</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerSurv.html"><code>LearnerSurv</code></a>
<ul>
<li>
<code>lp</code> - Linear predictor calculated as the fitted coefficients multiplied by the test data.</li>
<li>
<code>distr</code> - Predicted survival distribution, either discrete or continuous. Implemented in <a href="https://cran.r-project.org/package=distr6"><code>distr6</code></a>.</li>
<li>
<code>crank</code> - Continuous risk ranking.</li>
<li>
<code>response</code> - Predicted survival time.</li>
</ul>
</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerDens.html"><code>LearnerDens</code></a>
<ul>
<li>
<code>pdf</code>- Predicts the probability density function.</li>
<li>
<code>cdf</code> - Predicts the cumulative distribution function.</li>
<li>
<code>distr</code> - Predicts a distribution as implemented in <a href="https://cran.r-project.org/package=distr6"><code>distr6</code></a>.</li>
</ul>
</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/LearnerClust.html"><code>LearnerClust</code></a>
<ul>
<li>
<code>partition</code> - Assigns the observation to a partition.</li>
<li>
<code>prob</code> - Returns a probability for each partition.</li>
</ul>
</li>
</ul>
</li>
<li>
<code>feature_types</code>: Set of feature types the learner is able to handle. See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$task_feature_types</code></a> for feature types supported by <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>.</li>
<li>
<code>properties</code>: Set of properties of the learner. See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$learner_properties</code></a> for the full list of learner properties supported by <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>. The list of properties includes:
<ul>
<li>
<code>"twoclass"</code>: The learner works on binary classification problems.</li>
<li>
<code>"multiclass"</code>: The learner works on multi-class classification problems.</li>
<li>
<code>"missings"</code>: The learner can natively handle missing values.</li>
<li>
<code>"weights"</code>: The learner can work on tasks which have observation weights / case weights.</li>
<li>
<code>"importance"</code>: The learner supports extracting importance values for features.</li>
<li>
<code>"selected_features"</code>: The learner supports extracting the features which were selected by the model.</li>
<li>
<code>"oob_error"</code>: The learner supports extracting the out of bag error.</li>
<li>
<code>"loglik"</code>: The learner supports extracting the log-likelihood of the learner.</li>
<li>
<code>"hotstart_forward"</code>: The learner allows to continue training the model e.g.&nbsp;by adding more trees to a random forest.</li>
<li>
<code>"hotstart_backward"</code>: The learner allows to “undo” some of the training, e.g.&nbsp;by removing some trees from a model.</li>
</ul>
</li>
<li>
<code>man</code>: The roxygen identifier of the learner. This is used within the <code>$help()</code> method of the super class to open the help page of the learner.</li>
<li>
<code>label</code>: The label of the learner. This should briefly describe the learner (similar to the description’s title) and is for example used for printing.</li>
</ul></section><section id="param-set" class="level3" data-number="11.1.5"><h3 data-number="11.1.5" class="anchored" data-anchor-id="param-set">
<span class="header-section-number">11.1.5</span> ParamSet</h3>
<p>The <code>ParamSet</code> is the set of hyperparameters used in model training and predicting, this is given as a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>paradox::ParamSet</code></a>. The set consists of a list of hyperparameters, where each has a specific class for the hyperparameter type (see above). In addition, each parameter has one or more tags, that determine in which method they are used.</p>
<p>Beyond that there are other tags that serve specific purposes:</p>
<ul>
<li>The tag <code>"threads"</code> should be used (if applicable) to tag the parameter that determines the number of threads used for the learner’s internal parallelization. This parameter can be set using <a href="https://mlr3.mlr-org.com/reference/set_threads.html"><code>set_threads</code></a>.</li>
<li>The tag <code>"required"</code> should be used to tag parameters that must be provided for the algorithm to be executable.</li>
<li>In case <a href="#optional-extractors">optional extractors</a> are available, the can (although this is rarely the case) also have parameters and can be tagged accordingly.</li>
<li>If <a href="#hotstarting">hotstarting</a> is available, the fidelity parameter should be tagged with <code>"hotstart"</code>.</li>
</ul>
<p>For <code>classif.rpart</code> the <code>param_set</code> can be defined as follows</p>
<div class="cell" data-hash="extending_cache/html/extending-004_823bea281580c6595a0a8ac6ac1b89dd">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>param_set <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="at">minsplit =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">default =</span> 20L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="at">minbucket =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">cp =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="fl">0.01</span>, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="at">maxcompete =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 4L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="at">maxsurrogate =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 5L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="at">maxdepth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">upper =</span> 30L, <span class="at">default =</span> 30L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="at">usesurrogate =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">upper =</span> 2L, <span class="at">default =</span> 2L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="at">surrogatestyle =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">upper =</span> 1L, <span class="at">default =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="at">xval =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="at">keep_model =</span> <span class="fu">p_lgl</span>(<span class="at">default =</span> <span class="cn">FALSE</span>, <span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb3-12"><a href="#cb3-12"></a>)</span>
<span id="cb3-13"><a href="#cb3-13"></a>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">xval =</span> 0L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Within <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> packages we suggest to stick to the shorthand notation above for consistency, however the <code>param_set</code> can be written with the underlying R6 classes as shown here</p>
<div class="cell" data-hash="extending_cache/html/extending-005_26fb869d57b7c7fb3ce82eea750abef0">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>param_set <span class="ot">=</span> ParamSet<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"minsplit"</span>, <span class="at">default =</span> 20L, <span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-3"><a href="#cb4-3"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"minbucket"</span>, <span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-4"><a href="#cb4-4"></a>  ParamDbl<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"cp"</span>, <span class="at">default =</span> <span class="fl">0.01</span>, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-5"><a href="#cb4-5"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxcompete"</span>, <span class="at">default =</span> 4L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-6"><a href="#cb4-6"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxsurrogate"</span>, <span class="at">default =</span> 5L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-7"><a href="#cb4-7"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxdepth"</span>, <span class="at">default =</span> 30L, <span class="at">lower =</span> 1L, <span class="at">upper =</span> 30L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-8"><a href="#cb4-8"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"usesurrogate"</span>, <span class="at">default =</span> 2L, <span class="at">lower =</span> 0L, <span class="at">upper =</span> 2L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-9"><a href="#cb4-9"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"surrogatestyle"</span>, <span class="at">default =</span> 0L, <span class="at">lower =</span> 0L, <span class="at">upper =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-10"><a href="#cb4-10"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"xval"</span>, <span class="at">default =</span> 0L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb4-11"><a href="#cb4-11"></a>  ParamLgl<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"keep_model"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>, <span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb4-12"><a href="#cb4-12"></a>))</span>
<span id="cb4-13"><a href="#cb4-13"></a>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">xval =</span> 0L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should read though the learner documentation to find the full list of available parameters. Just looking at some of these in this example:</p>
<ul>
<li>
<code>"cp"</code> is numeric, has a feasible range of <code>[0,1]</code> and defaults to <code>0.01</code>. The parameter is used during <code>"train"</code>.</li>
<li>
<code>"xval"</code> is integer has a lower bound of <code>0</code>, a default of <code>0</code> and the parameter is used during <code>"train"</code>.</li>
<li>
<code>"keep_model"</code> is logical with a default of <code>FALSE</code> and is used during <code>"train"</code>.</li>
</ul>
<p>In some rare cases you may want to change the default parameter values. You can do this by changing the <code>param_set$values</code>. You can see we have done this for <code>"classif.rpart"</code> where the default for <code>xval</code> is changed to <code>0</code>. Note that the default in the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> is recorded as our changed default (0), and not the original (10). It is strongly recommended to only change the defaults if absolutely required, when this is the case add the following to the learner documentation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span><span class="co">#' - `&lt;parameter&gt;`:</span></span>
<span><span class="co">#'   - Actual default: &lt;value&gt;</span></span>
<span><span class="co">#'   - Adjusted default: &lt;value&gt;</span></span>
<span><span class="co">#'   - Reason for change: &lt;text&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="learner-train" class="level3" data-number="11.1.6"><h3 data-number="11.1.6" class="anchored" data-anchor-id="learner-train">
<span class="header-section-number">11.1.6</span> Train function</h3>
<p>The train function takes a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> as input and must return a model. Let’s say we want to translate the following call of <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart()</a></code> into code that can be used inside the <code>.train()</code> method.</p>
<p>First, we write something down that works completely without <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>:</p>
<div class="cell" data-hash="extending_cache/html/extending-006_0fda14eefb7bacd5fbbabaeaf8b4022d">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>data <span class="ot">=</span> iris</span>
<span id="cb6-2"><a href="#cb6-2"></a>model <span class="ot">=</span> rpart<span class="sc">::</span><span class="fu">rpart</span>(Species <span class="sc">~</span> ., <span class="at">data =</span> iris, <span class="at">xval =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to pass the formula notation <code>Species ~ .</code>, the data and the hyperparameters. To get the hyperparameters, we call <code>self$param_set$get_values(tag = "train")</code> and thereby query all parameters that are using during <code>"train"</code>. Then, the dataset is extracted from the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. Because the learner has the property <code>"weights"</code>, we insert the weights of the task if there are any.</p>
<p>Last, we call the upstream function <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart()</a></code> with the data and pass all hyperparameters via argument <code>.args</code> using the <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> function. The latter is simply an optimized version of <code><a href="https://rdrr.io/r/base/do.call.html">do.call()</a></code> that we use within the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ecosystem.</p>
<div class="cell" data-hash="extending_cache/html/extending-007_3253e6a276ee7e2d86908dae113d934b">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="cf">if</span> (<span class="st">"weights"</span> <span class="sc">%in%</span> task<span class="sc">$</span>properties) {</span>
<span id="cb7-4"><a href="#cb7-4"></a>    pars<span class="sc">$</span>weights <span class="ot">=</span> task<span class="sc">$</span>weights<span class="sc">$</span>weight</span>
<span id="cb7-5"><a href="#cb7-5"></a>  }</span>
<span id="cb7-6"><a href="#cb7-6"></a>  formula <span class="ot">=</span> task<span class="sc">$</span><span class="fu">formula</span>()</span>
<span id="cb7-7"><a href="#cb7-7"></a>  data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="fu">invoke</span>(</span>
<span id="cb7-9"><a href="#cb7-9"></a>    rpart<span class="sc">::</span>rpart,</span>
<span id="cb7-10"><a href="#cb7-10"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb7-11"><a href="#cb7-11"></a>    <span class="at">data =</span> data,</span>
<span id="cb7-12"><a href="#cb7-12"></a>    <span class="at">.args =</span> pars</span>
<span id="cb7-13"><a href="#cb7-13"></a>  )</span>
<span id="cb7-14"><a href="#cb7-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="learner-predict" class="level3" data-number="11.1.7"><h3 data-number="11.1.7" class="anchored" data-anchor-id="learner-predict">
<span class="header-section-number">11.1.7</span> Predict function</h3>
<p>The internal predict method <code>.predict()</code> also operates on a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> as well as on the fitted model that has been created by the <code>train()</code> call previously and has been stored in <code>self$model</code>.</p>
<p>The return value is a <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> object. We proceed analogously to what we did in the previous section. We start with a version without any <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> objects and continue to replace objects until we have reached the desired interface:</p>
<div class="cell" data-hash="extending_cache/html/extending-008_37278df8201aee9a06a39dea1abd05d1">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># inputs:</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a>self <span class="ot">=</span> <span class="fu">list</span>(<span class="at">model =</span> rpart<span class="sc">::</span><span class="fu">rpart</span>(task<span class="sc">$</span><span class="fu">formula</span>(), <span class="at">data =</span> task<span class="sc">$</span><span class="fu">data</span>()))</span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a>data <span class="ot">=</span> iris</span>
<span id="cb8-6"><a href="#cb8-6"></a>response <span class="ot">=</span> <span class="fu">predict</span>(self<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"class"</span>)</span>
<span id="cb8-7"><a href="#cb8-7"></a>prob <span class="ot">=</span> <span class="fu">predict</span>(self<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"prob"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>"rpart::predict.rpart()"</code> function predicts class labels if argument <code>type</code> is set to to <code>"class"</code>, and class probabilities if set to <code>"prob"</code>.</p>
<p>Next, we transition from <code>data</code> to a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> again and construct a list with the return type requested by the user, this is stored in the <code>$predict_type</code> slot of a learner class. Note that the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> is automatically passed to the prediction object, so all you need to do is return the predictions! Make sure the list names are identical to the task predict types.</p>
<p>The final <code>.predict()</code> method is below, we could omit the <code>pars</code> line as there are no parameters with the <code>"predict"</code> tag but we keep it here to be consistent:</p>
<div class="cell" data-hash="extending_cache/html/extending-009_55f7d28f10161524870cd3e711441519">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb9-2"><a href="#cb9-2"></a>  pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"predict"</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="co"># get newdata and ensure same ordering in train and predict</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  newdata <span class="ot">=</span> <span class="fu">ordered_features</span>(task, self)</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="cf">if</span> (self<span class="sc">$</span>predict_type <span class="sc">==</span> <span class="st">"response"</span>) {</span>
<span id="cb9-6"><a href="#cb9-6"></a>    response <span class="ot">=</span> <span class="fu">invoke</span>(</span>
<span id="cb9-7"><a href="#cb9-7"></a>      predict,</span>
<span id="cb9-8"><a href="#cb9-8"></a>      self<span class="sc">$</span>model,</span>
<span id="cb9-9"><a href="#cb9-9"></a>      <span class="at">newdata =</span> newdata,</span>
<span id="cb9-10"><a href="#cb9-10"></a>      <span class="at">type =</span> <span class="st">"class"</span>,</span>
<span id="cb9-11"><a href="#cb9-11"></a>      <span class="at">.args =</span> pars</span>
<span id="cb9-12"><a href="#cb9-12"></a>    )</span>
<span id="cb9-13"><a href="#cb9-13"></a></span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">response =</span> response))</span>
<span id="cb9-15"><a href="#cb9-15"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-16"><a href="#cb9-16"></a>    prob <span class="ot">=</span> <span class="fu">invoke</span>(</span>
<span id="cb9-17"><a href="#cb9-17"></a>      predict,</span>
<span id="cb9-18"><a href="#cb9-18"></a>      self<span class="sc">$</span>model,</span>
<span id="cb9-19"><a href="#cb9-19"></a>      <span class="at">newdata =</span> newdata,</span>
<span id="cb9-20"><a href="#cb9-20"></a>      <span class="at">type =</span> <span class="st">"prob"</span>,</span>
<span id="cb9-21"><a href="#cb9-21"></a>      <span class="at">.args =</span> pars</span>
<span id="cb9-22"><a href="#cb9-22"></a>    )</span>
<span id="cb9-23"><a href="#cb9-23"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">prob =</span> prob))</span>
<span id="cb9-24"><a href="#cb9-24"></a>  }</span>
<span id="cb9-25"><a href="#cb9-25"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>You cannot rely on the column order of the data returned by <code>task$data()</code> as the order of columns may be different from the order of the columns during <code>$.train</code>. The <code>newdata</code> line ensures the ordering is the same by calling the same order as in train!</p>
</div>
</div>
</section><section id="optional-extractors" class="level3" data-number="11.1.8"><h3 data-number="11.1.8" class="anchored" data-anchor-id="optional-extractors">
<span class="header-section-number">11.1.8</span> Optional Extractors</h3>
<p>Specific learner implementations are free to implement additional getters to ease the access of certain parts of the model in the inherited subclasses. The blueprint for these methods is only included in the generated learner template, if the property is set when calling <code>create_learner()</code>. The comments in the templates will include references to other learners that have this property and can be used as guiding examples. To determine whether these methods are applicable, one has to determine whether the learner supports this method in principle <strong>and</strong> whether it is implemented in the upstream package.</p>
<p>For the following operations, extractors are standardized:</p>
<ul>
<li>
<code>importance(...)</code> - Returns the feature importance score as numeric vector. The higher the score, the more important the variable. The returned vector is named with feature names and sorted in decreasing order. Note that the model might omit features it has not used at all. The learner must be tagged with property <code>"importance"</code>.</li>
<li>
<code>selected_features(...)</code> - Returns a subset of selected features as character(). The learner must be tagged with property <code>"selected_features"</code>.</li>
<li>
<code>oob_error(...)</code> - Returns the out-of-bag error of the model as <code>numeric(1)</code>. The learner must be tagged with property <code>"oob_error"</code>.</li>
<li>
<code>loglik(...)</code> - Extracts the log-likelihood (c.f. <code><a href="https://rdrr.io/r/stats/logLik.html">stats::logLik()</a></code>). The learner must be tagged with property <code>"loglik"</code>.</li>
</ul>
<p>In this case, we only have to implement the <code>importance()</code> method.</p>
<div class="cell" data-hash="extending_cache/html/extending-010_6a72a7522b9b575022e665759423b5e7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>importance <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">stopf</span>(<span class="st">"No model stored"</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a>  }</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>  importance <span class="ot">=</span> <span class="fu">sort</span>(self<span class="sc">$</span>model<span class="sc">$</span>variable.importance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(importance)) {</span>
<span id="cb10-8"><a href="#cb10-8"></a>    importance <span class="ot">=</span> mlr3misc<span class="sc">::</span><span class="fu">set_names</span>(<span class="fu">numeric</span>())</span>
<span id="cb10-9"><a href="#cb10-9"></a>  }</span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="fu">return</span>(importance)</span>
<span id="cb10-11"><a href="#cb10-11"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="hotstarting" class="level3" data-number="11.1.9"><h3 data-number="11.1.9" class="anchored" data-anchor-id="hotstarting">
<span class="header-section-number">11.1.9</span> Hotstarting</h3>
<p>Some learners support resuming or continuing from an already fitted model. We assume that hotstarting is only possible if a single hyperparameter (also called the fidelity parameter, usually controlling the complexity or expensiveness) is altered and all other hyperparameters are identical. The fidelity parameters should be tagged with <code>"hotstart"</code>. Examples are:</p>
<ul>
<li>Random Forest: Starting from a model with n trees, a random forest with n + k trees can be obtained by adding k trees (<code>"hotstart_forward"</code>) and a random forest with n - k trees can be obtained by removing k trees (<code>"hotstart_backward"</code>).</li>
<li>Gradient Boosting: When having fitted a model with n iterations, we only need k iterations to obtain a model with n + k iterations. (<code>"hotstart_forward"</code>).</li>
</ul>
<p>For more information see <a href="https://mlr3.mlr-org.com/reference/HotstartStack.html"><code>HotstartStack</code></a>.</p>
</section><section id="learner-control" class="level3" data-number="11.1.10"><h3 data-number="11.1.10" class="anchored" data-anchor-id="learner-control">
<span class="header-section-number">11.1.10</span> Control objects/functions of learners</h3>
<p>Some learners rely on a “control” object/function such as <code><a href="https://glmnet.stanford.edu/reference/glmnet.control.html">glmnet::glmnet.control()</a></code>. Accounting for such depends on how the underlying package works:</p>
<ul>
<li>If the package forwards the control parameters via <code>...</code> and makes it possible to just pass control parameters as additional parameters directly to the train call, there is no need to distinguish both <code>"train"</code> and <code>"control"</code> parameters.</li>
<li>If the control parameters need to be passed via a separate argument, one can e.g.&nbsp;use <code>formalArgs(glmnet::glmnet.control)</code> to get the names of the control parameters and then extract them from the <code>pars</code> like shown below.</li>
</ul>
<div class="cell" data-hash="extending_cache/html/extending-011_423533c2ed158e9e935b7eac9dd6daa8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a>ii <span class="ot">=</span> <span class="fu">names</span>(pars) <span class="sc">%in%</span> <span class="fu">formalArgs</span>(glmnet<span class="sc">::</span>glmnet.control)</span>
<span id="cb11-3"><a href="#cb11-3"></a>pars_ctrl <span class="ot">=</span> pars[ii]</span>
<span id="cb11-4"><a href="#cb11-4"></a>pars_train <span class="ot">=</span> pars[<span class="sc">!</span>ii]</span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="fu">invoke</span>([...], <span class="at">.args =</span> pars_train, <span class="at">control =</span> pars_ctrl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="adding-the-description" class="level3" data-number="11.1.11"><h3 data-number="11.1.11" class="anchored" data-anchor-id="adding-the-description">
<span class="header-section-number">11.1.11</span> Adding the description</h3>
<p>Once the learner is implemented - and is not only intended for personal use - it’s description should be filled out. Most steps should be clear from the instructions given in the template. For the section ‘@references’, the entry first has to be added to the file <code>bibentries.R</code>, essentially by converting the bibtex file to a R <code>bibentry</code> function call.</p>
</section><section id="learner-test" class="level3" data-number="11.1.12"><h3 data-number="11.1.12" class="anchored" data-anchor-id="learner-test">
<span class="header-section-number">11.1.12</span> Testing the learner</h3>
<p>Once your learner is created, you are ready to start testing if it works, there are three types of tests: <a href="#learner-test-manual">manual</a>, <a href="#learner-test-unit">unit</a> and <a href="#learner-test-parameter">parameter</a>.</p>
<section id="learner-test-manual" class="level4" data-number="11.1.12.1"><h4 data-number="11.1.12.1" class="anchored" data-anchor-id="learner-test-manual">
<span class="header-section-number">11.1.12.1</span> Train and Predict</h4>
<p>For a bare-bone check you can just try to run a simple <code>train()</code> call locally.</p>
<div class="cell" data-hash="extending_cache/html/extending-012_acd3e7e5284170ec75d482ab5f55db93">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>) <span class="co"># assuming a Classif learner</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a>lrn<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb12-4"><a href="#cb12-4"></a>p <span class="ot">=</span> lrn<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb12-5"><a href="#cb12-5"></a>p<span class="sc">$</span>confusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If it runs without erroring, that’s a very good start!</p>
</section><section id="learner-test-unit" class="level4" data-number="11.1.12.2"><h4 data-number="11.1.12.2" class="anchored" data-anchor-id="learner-test-unit">
<span class="header-section-number">11.1.12.2</span> Autotest</h4>
<p>To ensure that your learner is able to handle all kinds of different properties and feature types, we have written an “autotest” that checks the learner for different combinations of such.</p>
<p>The “autotest” setup is generated automatically by <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>create_learner()</code></a>. It will have a name with the form <code>test_package_type_key.R</code>, in our case this will actually be <code>test_rpart_classif_rpart.R</code>. This will create the following script, for which no changes are required to pass (assuming the learner was correctly created):</p>
<div class="cell" data-hash="extending_cache/html/extending-013_5e49c570409a7a7f4ed51e7e0b17c75d">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">test_that</span>(<span class="st">"autotest"</span>, {</span>
<span id="cb13-2"><a href="#cb13-2"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="fu">expect_learner</span>(learner)</span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="co"># note that you can skip tests using the exclude argument</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  result <span class="ot">=</span> <span class="fu">run_autotest</span>(learner)</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="fu">expect_true</span>(result, <span class="at">info =</span> result<span class="sc">$</span>error)</span>
<span id="cb13-7"><a href="#cb13-7"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For some learners that have required parameters, it is needed to set some values for required parameters after construction so that the learner can be run in the first place.</p>
<p>You can also exclude some specific test arrangements within the “autotest” via the argument <code>exclude</code> in the <code>run_autotest()</code> function. Currently the <code>run_autotest()</code> function lives in <a href="https://github.com/mlr-org/mlr3/blob/f16326bf34bcac59c3b0a2fdbcf90dbebb3b4bbc/inst/testthat/helper_autotest.R">inst/testthat</a> of the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> and still lacks documentation. This should change in the near future.</p>
<p>To finally run the test suite, call <code><a href="https://devtools.r-lib.org/reference/test.html">devtools::test()</a></code> or hit <code>CTRL + Shift + T</code> if you are using RStudio.</p>
</section><section id="learner-test-parameter" class="level4" data-number="11.1.12.3"><h4 data-number="11.1.12.3" class="anchored" data-anchor-id="learner-test-parameter">
<span class="header-section-number">11.1.12.3</span> Checking Parameters</h4>
<p>Some learners have a high number of parameters and it is easy to miss out on some during the creation of a new learner. In addition, if the maintainer of the upstream package changes something with respect to the arguments of the algorithm, the learner is in danger to break. Also, new arguments could be added upstream and manually checking for new additions all the time is tedious.</p>
<p>Therefore we have written a “Parameter Check” that runs regularly for every learner. This “Parameter Check” compares the parameters of the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ParamSet against all arguments available in the upstream function that is called during <code>$train()</code> and <code>$predict()</code>. Again the file is automatically created by <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>create_learner()</code></a>. This will be named like <code>test_paramtest_package_type_key.R</code>, so in our example <code>test_paramtest_rpart_classif_rpart.R</code>. When the <code>.train</code> function calls multiple functions (e.g.&nbsp;a control function as described above), a list of functions can be passed to the parameter test.</p>
<p>The test comes with an <code>exclude</code> argument that should be used to <em>exclude and explain</em> why certain arguments of the upstream function are not within the ParamSet of the mlr3learner. This will likely be required for all learners as common arguments like <code>x</code>, <code>target</code> or <code>data</code> are handled by the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> interface and are therefore not included within the ParamSet.</p>
<p>However, there might be more parameters that need to be excluded, for example:</p>
<ul>
<li>Type dependent parameters, i.e.&nbsp;parameters that only apply for classification or regression learners.</li>
<li>Parameters that are actually deprecated by the upstream package and which were therefore not included in the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ParamSet.</li>
</ul>
<p>All excluded parameters should have a comment justifying their exclusion.</p>
<p>In our example, the final paramtest script looks like:</p>
<div class="cell" data-hash="extending_cache/html/extending-014_afbe042ac480023caa48b68972281298">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">test_that</span>(<span class="st">"classif.rpart train"</span>, {</span>
<span id="cb14-2"><a href="#cb14-2"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="co"># this can also be a list of functions</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  fun <span class="ot">=</span> rpart<span class="sc">::</span>rpart</span>
<span id="cb14-5"><a href="#cb14-5"></a>  exclude <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="st">"formula"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="st">"model"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="st">"data"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>    <span class="st">"weights"</span>, <span class="co"># handled by task</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>    <span class="st">"subset"</span>, <span class="co"># handled by task</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="st">"na.action"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>    <span class="st">"method"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>    <span class="st">"x"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>    <span class="st">"y"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>    <span class="st">"parms"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="st">"control"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>    <span class="st">"cost"</span> <span class="co"># handled internally</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>  )</span>
<span id="cb14-19"><a href="#cb14-19"></a></span>
<span id="cb14-20"><a href="#cb14-20"></a>  paramtest <span class="ot">=</span> <span class="fu">run_paramtest</span>(learner, fun, exclude, <span class="at">tag =</span> <span class="st">"train"</span>)</span>
<span id="cb14-21"><a href="#cb14-21"></a>  <span class="fu">expect_paramtest</span>(paramtest)</span>
<span id="cb14-22"><a href="#cb14-22"></a>})</span>
<span id="cb14-23"><a href="#cb14-23"></a></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="fu">test_that</span>(<span class="st">"classif.rpart predict"</span>, {</span>
<span id="cb14-25"><a href="#cb14-25"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb14-26"><a href="#cb14-26"></a>  fun <span class="ot">=</span> rpart<span class="sc">:::</span>predict.rpart</span>
<span id="cb14-27"><a href="#cb14-27"></a>  exclude <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb14-28"><a href="#cb14-28"></a>    <span class="st">"object"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-29"><a href="#cb14-29"></a>    <span class="st">"newdata"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-30"><a href="#cb14-30"></a>    <span class="st">"type"</span>, <span class="co"># handled internally</span></span>
<span id="cb14-31"><a href="#cb14-31"></a>    <span class="st">"na.action"</span> <span class="co"># handled internally</span></span>
<span id="cb14-32"><a href="#cb14-32"></a>  )</span>
<span id="cb14-33"><a href="#cb14-33"></a></span>
<span id="cb14-34"><a href="#cb14-34"></a>  paramtest <span class="ot">=</span> <span class="fu">run_paramtest</span>(learner, fun, exclude, <span class="at">tag =</span> <span class="st">"predict"</span>)</span>
<span id="cb14-35"><a href="#cb14-35"></a>  <span class="fu">expect_paramtest</span>(paramtest)</span>
<span id="cb14-36"><a href="#cb14-36"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="cleaning" class="level3" data-number="11.1.13"><h3 data-number="11.1.13" class="anchored" data-anchor-id="cleaning">
<span class="header-section-number">11.1.13</span> Package Cleaning</h3>
<p>Once all tests are passing, run the following functions to ensure that the package remains clean and tidy</p>
<ol type="1">
<li><code>devtools::document(roclets = c('rd', 'collate', 'namespace'))</code></li>
<li>If you haven’t done this before run: <code>remotes::install_github('mlr-org/styler.mlr')</code>
</li>
<li><code>styler::style_pkg(style = styler.mlr::mlr_style)</code></li>
<li><code><a href="https://usethis.r-lib.org/reference/tidyverse.html">usethis::use_tidy_description()</a></code></li>
<li><code><a href="https://lintr.r-lib.org/reference/lint.html">lintr::lint_package()</a></code></li>
</ol>
<p>Please fix any errors indicated by <code>lintr</code> before creating a pull request. Finally ensure that all <code>FIXME</code> are resolved and deleted in the generated files.</p>
<p>You are now ready to add your learner to the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ecosystem! Simply open a pull request to with the new learner template and complete the checklist in there. Creating this request will trigger an automated workflow that checks whether various conditions (such as <code><a href="http://r-lib.github.io/rcmdcheck/reference/rcmdcheck.html">rcmdcheck::rcmdcheck()</a></code>) are satisfied. Once the pull request is approved and merged, your learner will automatically appear on the <a href="https://mlr3extralearners.mlr-org.com/">package website</a>.</p>
</section><section id="thanks-and-maintenance" class="level3" data-number="11.1.14"><h3 data-number="11.1.14" class="anchored" data-anchor-id="thanks-and-maintenance">
<span class="header-section-number">11.1.14</span> Thanks and Maintenance</h3>
<p>Thank you for contributing to the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> ecosystem!</p>
<p>When you created the learner you would have given your GitHub handle, meaning that you are now listed as the learner author and maintainer. This means that if the learner breaks it is your responsibility to fix the learner - you can view the status of your learner <a href="https://mlr3extralearners.mlr-org.com/articles/learners/test_overview.html">here</a>.</p>
</section><section id="learner-faq" class="level3" data-number="11.1.15"><h3 data-number="11.1.15" class="anchored" data-anchor-id="learner-faq">
<span class="header-section-number">11.1.15</span> Learner FAQ</h3>
<p><strong>Question 1</strong></p>
<p>How to deal with Parameters which have no default?</p>
<p><strong>Answer</strong></p>
<p>If the learner does not work without providing a value, set a reasonable default in <code>param_set$values</code>, add tag <code>"required"</code> to the parameter and document your default properly.</p>
<p><strong>Question 2</strong></p>
<p>Where to add the package of the upstream package in the DESCRIPTION file?</p>
<p>Add it to the “Suggests” section.</p>
<p><strong>Question 3</strong></p>
<p>How to handle arguments from external “control” functions such as <code>glmnet::glmnet_control()</code>?</p>
<p><strong>Answer</strong></p>
<p>See <a href="#learner-control">“Control objects/functions of learners”</a>.</p>
<p><strong>Question 4</strong></p>
<p>How to document if my learner uses a custom default value that differs to the default of the upstream package?</p>
<p><strong>Answer</strong></p>
<p>If you set a custom default for the mlr3learner that does not cope with the one of the upstream package (think twice if this is really needed!), add this information to the help page of the respective learner.</p>
<p>You can use the following skeleton for this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span><span class="co">#' * `&lt;parameter&gt;`:</span></span>
<span><span class="co">#'   * Actual default: &lt;value&gt;</span></span>
<span><span class="co">#'   * Adjusted default: &lt;value&gt;</span></span>
<span><span class="co">#'   * Reason for change: &lt;text&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Question 5</strong></p>
<p>When should the <code>"required"</code> tag be used when defining Params and what is its purpose?</p>
<p><strong>Answer</strong></p>
<p>The <code>"required"</code> tag should be used when the following conditions are met:</p>
<ul>
<li>The upstream function cannot be run without setting this parameter, i.e.&nbsp;it would throw an error.</li>
<li>The parameter has no default in the upstream function.</li>
</ul>
<p>In <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> we follow the principle that every learner should be constructable without setting custom parameters. Therefore, if a parameter has no default in the upstream function, a custom value is usually set for this parameter in the mlr3learner (remember to document such changes in the help page of the learner).</p>
<p>Even though this practice ensures that no parameter is unset in an mlr3learner and partially removes the usefulness of the <code>"required"</code> tag, the tag is still useful in the following scenario:</p>
<p>If a user sets custom parameters after construction of the learner</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"&lt;id&gt;"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"&lt;param&gt;"</span> <span class="ot">=</span> <span class="er">&lt;</span>value<span class="sc">&gt;</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, all parameters besides the ones set in the list would be unset. See <code><a href="https://paradox.mlr-org.com/reference/ParamSet.html">paradox::ParamSet</a></code> for more information. If a parameter is tagged as <code>"required"</code> in the ParamSet, the call above would error and prompt the user that required parameters are missing.</p>
<p><strong>Question 6</strong></p>
<p>What is this error when I run <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"."</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>Loading mlr3extralearners</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>Warning message<span class="sc">:</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>.onUnload failed <span class="cf">in</span> <span class="fu">unloadNamespace</span>() <span class="cf">for</span> <span class="st">'mlr3extralearners'</span>, details<span class="sc">:</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  call<span class="sc">:</span> <span class="fu">vapply</span>(hooks, <span class="cf">function</span>(x) <span class="fu">environment</span>(x)<span class="sc">$</span>pkgname, <span class="cn">NA_character_</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  error<span class="sc">:</span> values must be length <span class="dv">1</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a> but <span class="fu">FUN</span>(X[[<span class="dv">1</span>]]) result is length <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Answer</strong></p>
<p>This is not an error but a warning and you can safely ignore it!</p>
</section></section><section id="extending-measures" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="extending-measures">
<span class="header-section-number">11.2</span> Adding new Measures</h2>
<p>In this section we showcase how to implement a custom performance measure.</p>
<p>A good starting point is writing down the loss function independently of <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> (we also did this in the <a href="https://cran.r-project.org/package=mlr3measures"><code>mlr3measures</code></a> package). Here, we illustrate writing measure by implementing the root of the mean squared error for regression problems:</p>
<div class="cell" data-hash="extending_cache/html/extending-015_1e81b64fb34e48d63fb81b1f52781ebd">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>root_mse <span class="ot">=</span> <span class="cf">function</span>(truth, response) {</span>
<span id="cb18-2"><a href="#cb18-2"></a>  mse <span class="ot">=</span> <span class="fu">mean</span>((truth <span class="sc">-</span> response)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">sqrt</span>(mse)</span>
<span id="cb18-4"><a href="#cb18-4"></a>}</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="fu">root_mse</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4082483</code></pre>
</div>
</div>
<p>In the next step, we embed the <code>root_mse()</code> function into a new <a href="https://cran.r-project.org/package=R6"><code>R6</code></a> class inheriting from base classes <a href="https://mlr3.mlr-org.com/reference/MeasureRegr.html"><code>MeasureRegr</code></a>/<a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a>. For classification measures, use <a href="https://mlr3.mlr-org.com/reference/MeasureClassif.html"><code>MeasureClassif</code></a>. We keep it simple here and only explain the most important parts of the <a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a> class:</p>
<div class="cell" data-hash="extending_cache/html/extending-016_87c4e62b549ea7645845d6e79347617c">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>MeasureRootMSE <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"MeasureRootMSE"</span>,</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="at">inherit =</span> mlr3<span class="sc">::</span>MeasureRegr,</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb20-5"><a href="#cb20-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb20-6"><a href="#cb20-6"></a>        <span class="co"># custom id for the measure</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>        <span class="at">id =</span> <span class="st">"root_mse"</span>,</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a>        <span class="co"># additional packages required to calculate this measure</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>        <span class="at">packages =</span> <span class="fu">character</span>(),</span>
<span id="cb20-11"><a href="#cb20-11"></a></span>
<span id="cb20-12"><a href="#cb20-12"></a>        <span class="co"># properties, see below</span></span>
<span id="cb20-13"><a href="#cb20-13"></a>        <span class="at">properties =</span> <span class="fu">character</span>(),</span>
<span id="cb20-14"><a href="#cb20-14"></a></span>
<span id="cb20-15"><a href="#cb20-15"></a>        <span class="co"># required predict type of the learner</span></span>
<span id="cb20-16"><a href="#cb20-16"></a>        <span class="at">predict_type =</span> <span class="st">"response"</span>,</span>
<span id="cb20-17"><a href="#cb20-17"></a></span>
<span id="cb20-18"><a href="#cb20-18"></a>        <span class="co"># feasible range of values</span></span>
<span id="cb20-19"><a href="#cb20-19"></a>        <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb20-20"><a href="#cb20-20"></a></span>
<span id="cb20-21"><a href="#cb20-21"></a>        <span class="co"># minimize during tuning?</span></span>
<span id="cb20-22"><a href="#cb20-22"></a>        <span class="at">minimize =</span> <span class="cn">TRUE</span></span>
<span id="cb20-23"><a href="#cb20-23"></a>      )</span>
<span id="cb20-24"><a href="#cb20-24"></a>    }</span>
<span id="cb20-25"><a href="#cb20-25"></a>  ),</span>
<span id="cb20-26"><a href="#cb20-26"></a></span>
<span id="cb20-27"><a href="#cb20-27"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb20-28"><a href="#cb20-28"></a>    <span class="co"># custom scoring function operating on the prediction object</span></span>
<span id="cb20-29"><a href="#cb20-29"></a>    <span class="at">.score =</span> <span class="cf">function</span>(prediction, ...) {</span>
<span id="cb20-30"><a href="#cb20-30"></a>      root_mse <span class="ot">=</span> <span class="cf">function</span>(truth, response) {</span>
<span id="cb20-31"><a href="#cb20-31"></a>        mse <span class="ot">=</span> <span class="fu">mean</span>((truth <span class="sc">-</span> response)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb20-32"><a href="#cb20-32"></a>        <span class="fu">sqrt</span>(mse)</span>
<span id="cb20-33"><a href="#cb20-33"></a>      }</span>
<span id="cb20-34"><a href="#cb20-34"></a></span>
<span id="cb20-35"><a href="#cb20-35"></a>      <span class="fu">root_mse</span>(prediction<span class="sc">$</span>truth, prediction<span class="sc">$</span>response)</span>
<span id="cb20-36"><a href="#cb20-36"></a>    }</span>
<span id="cb20-37"><a href="#cb20-37"></a>  )</span>
<span id="cb20-38"><a href="#cb20-38"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This class can be used as template for most performance measures. If something is missing, you might want to consider having a deeper dive into the following arguments:</p>
<ul>
<li>
<code>properties</code>: If you tag you measure with the property <code>"requires_task"</code>, the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> is automatically passed to your <code>.score()</code> function (don’t forget to add the argument <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> in the signature). The same is possible with <code>"requires_learner"</code> if you need to operate on the <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> and <code>"requires_train_set"</code> if you want to access the set of training indices in the score function.</li>
<li>
<code>aggregator</code>: This function (defaulting to <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>) controls how multiple performance scores, i.e.&nbsp;from different resampling iterations, are aggregated into a single numeric value if <code>average</code> is set to micro averaging. This is ignored for macro averaging.</li>
<li>
<code>predict_sets</code>: Prediction sets (subset of <code>("train", "test")</code>) to operate on. Defaults to the “test” set.</li>
</ul>
<p>Finally, if you want to use your custom measure just like any other measure shipped with <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> and access it via the <a href="https://mlr3.mlr-org.com/reference/mlr_measures.html"><code>mlr_measures</code></a> dictionary, you can easily add it:</p>
<div class="cell" data-hash="extending_cache/html/extending-017_8594656c5d687e2f6b148e077c1bae67">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>mlr3<span class="sc">::</span>mlr_measures<span class="sc">$</span><span class="fu">add</span>(<span class="st">"root_mse"</span>, MeasureRootMSE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Typically it is a good idea to put the measure together with the call to <code>mlr_measures$add()</code> in a new R file and just source it in your project.</p>
<div class="cell" data-hash="extending_cache/html/extending-018_7ccbb455f241be9793764f0c09ae4ff7">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="do">## source("measure_root_mse.R")</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">msr</span>(<span class="st">"root_mse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureRootMSE:root_mse&gt;
* Packages: mlr3
* Range: [0, Inf]
* Minimize: TRUE
* Average: macro
* Parameters: list()
* Properties: -
* Predict type: response</code></pre>
</div>
</div>
</section><section id="extending-pipeops" class="level2" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="extending-pipeops">
<span class="header-section-number">11.3</span> Adding new PipeOps</h2>
<p>This section showcases how the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package can be extended to include custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. To run the following examples, we will need a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>; we are using the well-known “Iris” task:</p>
<div class="cell" data-hash="extending_cache/html/extending-020_e8759bbeb7fc48383f199b652a73b204">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb24-3"><a href="#cb24-3"></a>task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa          1.4         0.2          5.1         3.5
  2:    setosa          1.4         0.2          4.9         3.0
  3:    setosa          1.3         0.2          4.7         3.2
  4:    setosa          1.5         0.2          4.6         3.1
  5:    setosa          1.4         0.2          5.0         3.6
 ---                                                            
146: virginica          5.2         2.3          6.7         3.0
147: virginica          5.0         1.9          6.3         2.5
148: virginica          5.2         2.0          6.5         3.0
149: virginica          5.4         2.3          6.2         3.4
150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is fundamentally built around <a href="https://r6.r-lib.org/"><code>R6</code></a>. When planning to create custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html">familiarize yourself with it</a>.</p>
<p>In principle, all a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> must do is inherit from the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> R6 class and implement the <code>.train()</code> and <code>.predict()</code> functions. There are, however, several auxiliary subclasses that can make the creation of <em>certain</em> operations much easier.</p>
<section id="ext-pipeopcopy" class="level3" data-number="11.3.1"><h3 data-number="11.3.1" class="anchored" data-anchor-id="ext-pipeopcopy">
<span class="header-section-number">11.3.1</span> General Case Example: <code>PipeOpCopy</code>
</h3>
<p>A very simple yet useful <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is <code>PipeOpCopy</code>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data. It is a simple example that showcases the important steps in defining a custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. We will show a simplified version here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly two copies of its input data.</p>
<p>The following figure visualizes how our <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is situated in the <code>Pipeline</code> and the significant in- and outputs.</p>
<div class="cell" data-hash="extending_cache/html/extending-021_422447c939212e3637e22b02cc84d78f">
<div class="cell-output-display">
<p><img src="Figures/po_multi_viz.png" class="img-fluid" width="430"></p>
</div>
</div>
<section id="first-steps-inheriting-from-pipeop" class="level4" data-number="11.3.1.1"><h4 data-number="11.3.1.1" class="anchored" data-anchor-id="first-steps-inheriting-from-pipeop">
<span class="header-section-number">11.3.1.1</span> First Steps: Inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>
</h4>
<p>The first part of creating a custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. We make a mental note that we need to implement a <code>.train()</code> and a <code>.predict()</code> function, and that we probably want to have an <code>initialize()</code> as well:</p>
<div class="cell" data-hash="extending_cache/html/extending-022_4b0803f4a3c99b67daed446d6ba6b75e">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb26-5"><a href="#cb26-5"></a>      ....</span>
<span id="cb26-6"><a href="#cb26-6"></a>    },</span>
<span id="cb26-7"><a href="#cb26-7"></a>  ),</span>
<span id="cb26-8"><a href="#cb26-8"></a>  private <span class="sc">==</span> <span class="fu">list</span>(</span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb26-10"><a href="#cb26-10"></a>      ....</span>
<span id="cb26-11"><a href="#cb26-11"></a>    },</span>
<span id="cb26-12"><a href="#cb26-12"></a></span>
<span id="cb26-13"><a href="#cb26-13"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb26-14"><a href="#cb26-14"></a>      ....</span>
<span id="cb26-15"><a href="#cb26-15"></a>    }</span>
<span id="cb26-16"><a href="#cb26-16"></a>  )</span>
<span id="cb26-17"><a href="#cb26-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, that <strong>private</strong> methods, e.g.&nbsp;<code>.train</code> and <code>.predict</code> etc are prefixed with a <code>.</code>.</p>
</section><section id="channel-definitions" class="level4" data-number="11.3.1.2"><h4 data-number="11.3.1.2" class="anchored" data-anchor-id="channel-definitions">
<span class="header-section-number">11.3.1.2</span> Channel Definitions</h4>
<p>We need to tell the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable. This is done on initialization of the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> (using a <code>super$initialize</code> call) by giving the <code>input</code> and <code>output</code> <code>data.table</code> objects. These must have three columns: a <code>"name"</code> column giving the names of input and output channels, and a <code>"train"</code> and <code>"predict"</code> column naming the class of objects we expect during training and prediction as input / output. A special value for these classes is <code>"*"</code>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</p>
<p>By convention, we name a single channel <code>"input"</code> or <code>"output"</code>, and a group of channels [<code>"input1"</code>, <code>"input2"</code>, …], unless there is a reason to give specific different names. Therefore, our <code>input</code> <code>data.table</code> will have a single row <code>&lt;"input", "*", "*"&gt;</code>, and our <code>output</code> table will have two rows, <code>&lt;"output1", "*", "*"&gt;</code> and <code>&lt;"output2", "*", "*"&gt;</code>.</p>
<p>All of this is given to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> creator. Our <code>initialize()</code> will thus look as follows:</p>
<div class="cell" data-hash="extending_cache/html/extending-023_fd87b7a5231c2aecd20e9a8bfe74beb0">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>initialize <span class="ot">=</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb27-2"><a href="#cb27-2"></a>  input <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="co"># and `predict` cols with "*"</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  output <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb27-6"><a href="#cb27-6"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb27-7"><a href="#cb27-7"></a>    <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>  )</span>
<span id="cb27-9"><a href="#cb27-9"></a>  super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb27-10"><a href="#cb27-10"></a>    <span class="at">input =</span> input,</span>
<span id="cb27-11"><a href="#cb27-11"></a>    <span class="at">output =</span> output</span>
<span id="cb27-12"><a href="#cb27-12"></a>  )</span>
<span id="cb27-13"><a href="#cb27-13"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="train-and-predict" class="level4" data-number="11.3.1.3"><h4 data-number="11.3.1.3" class="anchored" data-anchor-id="train-and-predict">
<span class="header-section-number">11.3.1.3</span> Train and Predict</h4>
<p>Both <code>.train()</code> and <code>.predict()</code> will receive a <code>list</code> as input and must give a <code>list</code> in return. According to our <code>input</code> and <code>output</code> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <code>c(inputs, inputs)</code>.</p>
<p>Two things to consider:</p>
<ul>
<li><p>The <code>.train()</code> function must always modify the <code>self$state</code> variable to something that is not <code>NULL</code> or <code>NO_OP</code>. This is because the <code>$state</code> slot is used as a signal that <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> has been trained on data, even if the state itself is not important to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> (as in our case). Therefore, our <code>.train()</code> will set <code>self$state = list()</code>.</p></li>
<li><p>It is not necessary to “clone” our input or make deep copies, because we don’t modify the data. However, if we were changing a reference-passed object, for example by changing data in a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, we would have to make a deep copy first. This is because a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> may never modify its input object by reference.</p></li>
</ul>
<p>Our <code>.train()</code> and <code>.predict()</code> functions are now:</p>
<div class="cell" data-hash="extending_cache/html/extending-024_633eb15934d9f9652ae0b7b2e756f1b3">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb28-2"><a href="#cb28-2"></a>  self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb28-4"><a href="#cb28-4"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-025_fb34d01d515d386c3a35d656baa37a38">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb29-3"><a href="#cb29-3"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="putting-it-together" class="level4" data-number="11.3.1.4"><h4 data-number="11.3.1.4" class="anchored" data-anchor-id="putting-it-together">
<span class="header-section-number">11.3.1.4</span> Putting it Together</h4>
<p>The whole definition thus becomes</p>
<div class="cell" data-hash="extending_cache/html/extending-026_9668bec02277c0467e7b2b916bf6c941">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb30-5"><a href="#cb30-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb30-6"><a href="#cb30-6"></a>        <span class="at">input =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>),</span>
<span id="cb30-7"><a href="#cb30-7"></a>        <span class="at">output =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb30-8"><a href="#cb30-8"></a>                            <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb30-9"><a href="#cb30-9"></a>      )</span>
<span id="cb30-10"><a href="#cb30-10"></a>    }</span>
<span id="cb30-11"><a href="#cb30-11"></a>  ),</span>
<span id="cb30-12"><a href="#cb30-12"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb30-13"><a href="#cb30-13"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb30-14"><a href="#cb30-14"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb30-15"><a href="#cb30-15"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb30-16"><a href="#cb30-16"></a>    },</span>
<span id="cb30-17"><a href="#cb30-17"></a></span>
<span id="cb30-18"><a href="#cb30-18"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb30-19"><a href="#cb30-19"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb30-20"><a href="#cb30-20"></a>    }</span>
<span id="cb30-21"><a href="#cb30-21"></a>  )</span>
<span id="cb30-22"><a href="#cb30-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can create an instance of our <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, put it in a graph, and see what happens when we train it on something:</p>
<div class="cell" data-hash="extending_cache/html/extending-027_108eb6d61bdda5cd8634fb2d2ee877eb">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb31-2"><a href="#cb31-2"></a>poct <span class="ot">=</span> PipeOpCopyTwo<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb31-3"><a href="#cb31-3"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb31-4"><a href="#cb31-4"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(poct)</span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="fu">print</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 1 PipeOps:
       ID         State sccssors prdcssors
 copy.two &lt;&lt;UNTRAINED&gt;&gt;                   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="fu">str</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ copy.two.output1:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; 
 $ copy.two.output2:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; </code></pre>
</div>
</div>
</section></section><section id="ext-pipe-preproc" class="level3" data-number="11.3.2"><h3 data-number="11.3.2" class="anchored" data-anchor-id="ext-pipe-preproc">
<span class="header-section-number">11.3.2</span> Special Case: Preprocessing</h3>
<p>Many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s perform an operation on exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, and return exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. They may even not care about the “Target” / “Outcome” variable of that task, and only do some modification of some input data. However, it is usually important to them that the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> on which they perform prediction has the same data columns as the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> on which they train. For these cases, the auxiliary base class <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> exists. It inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> itself, and other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s should use it if they fall in the kind of use-case named above.</p>
<p>When inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one must either implement the private methods <code>.train_task()</code> and <code>.predict_task()</code>, or the methods <code>.train_dt()</code>, <code>.predict_dt()</code>, depending on whether wants to operate on a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> object or on its data as <code>data.table</code>s. In the second case, one can optionally also overload the <code>.select_cols()</code> method, which chooses which of the incoming <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s features are given to the <code>.train_dt()</code> / <code>.predict_dt()</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>, which removes a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s rows with missing values during training (and implements <code>.train_task()</code> and <code>.predict_task()</code>), and <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, which scales a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s numeric columns (and implements <code>.train_dt()</code>, <code>.predict_dt()</code>, and <code>.select_cols()</code>).</p>
<section id="example-pipeopdropna" class="level4" data-number="11.3.2.1"><h4 data-number="11.3.2.1" class="anchored" data-anchor-id="example-pipeopdropna">
<span class="header-section-number">11.3.2.1</span> Example: <code>PipeOpDropNA</code>
</h4>
<p>Dropping rows with missing values may be important when training a model that can not handle them.</p>
<p>Because <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <code>"Task", text = "Tasks")</code> only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values. Instead, the rows can be removed using the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s <code>$filter</code> method, which modifies the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> in-place. This is done in the private method <code>.train_task()</code>. We take care that we also set the <code>$state</code> slot to signal that the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> was trained.</p>
<p>The private method <code>.predict_task()</code> does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows. Furthermore, <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> expects a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> to always return just as many predictions as it was given input rows, so a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that removes <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> rows during training can not be used inside a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>.</p>
<p>When we inherit from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, it sets the <code>input</code> and <code>output</code> <code>data.table</code>s for us to only accept a single <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. The only thing we do during <code>initialize()</code> is therefore to set an <code>id</code> (which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as follows. Note that it inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="cell" data-hash="extending_cache/html/extending-028_da0b403dfb442773bc6688ca6b23f70f">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>PipeOpDropNA <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropNA"</span>,</span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.na"</span>) {</span>
<span id="cb35-5"><a href="#cb35-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id)</span>
<span id="cb35-6"><a href="#cb35-6"></a>    }</span>
<span id="cb35-7"><a href="#cb35-7"></a>  ),</span>
<span id="cb35-8"><a href="#cb35-8"></a></span>
<span id="cb35-9"><a href="#cb35-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb35-10"><a href="#cb35-10"></a>    <span class="at">.train_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb35-11"><a href="#cb35-11"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb35-12"><a href="#cb35-12"></a>      featuredata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb35-13"><a href="#cb35-13"></a>      exclude <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">is.na</span>(featuredata), <span class="dv">1</span>, any)</span>
<span id="cb35-14"><a href="#cb35-14"></a>      task<span class="sc">$</span><span class="fu">filter</span>(task<span class="sc">$</span>row_ids[<span class="sc">!</span>exclude])</span>
<span id="cb35-15"><a href="#cb35-15"></a>    },</span>
<span id="cb35-16"><a href="#cb35-16"></a></span>
<span id="cb35-17"><a href="#cb35-17"></a>    <span class="at">.predict_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb35-18"><a href="#cb35-18"></a>      <span class="co"># nothing to be done</span></span>
<span id="cb35-19"><a href="#cb35-19"></a>      task</span>
<span id="cb35-20"><a href="#cb35-20"></a>    }</span>
<span id="cb35-21"><a href="#cb35-21"></a>  )</span>
<span id="cb35-22"><a href="#cb35-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To test this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, we create a small task with missing values:</p>
<div class="cell" data-hash="extending_cache/html/extending-029_1c95dcd2a5cc25065d0ff56020226d86">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>smalliris <span class="ot">=</span> iris[(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">30</span>, ]</span>
<span id="cb36-2"><a href="#cb36-2"></a>smalliris[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>smalliris[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>sitask <span class="ot">=</span> <span class="fu">as_task_classif</span>(smalliris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="fu">print</span>(sitask<span class="sc">$</span><span class="fu">data</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:     setosa          1.6         0.2           NA         3.2
2: versicolor          3.9         1.4          5.2          NA
3: versicolor          4.0         1.3          5.5         2.5
4:  virginica          5.0         1.5          6.0         2.2
5:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
<p>We test this by feeding it to a new <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that uses <code>PipeOpDropNA</code>.</p>
<div class="cell" data-hash="extending_cache/html/extending-030_e20031a699d3120f2b8e32448ea5d2b9">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb38-2"><a href="#cb38-2"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropNA<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb38-3"><a href="#cb38-3"></a></span>
<span id="cb38-4"><a href="#cb38-4"></a>filtered_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(sitask)[[<span class="dv">1</span>]]</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="fu">print</span>(filtered_task<span class="sc">$</span><span class="fu">data</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1: versicolor          4.0         1.3          5.5         2.5
2:  virginica          5.0         1.5          6.0         2.2
3:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
</section><section id="example-pipeopscalealways" class="level4" data-number="11.3.2.2"><h4 data-number="11.3.2.2" class="anchored" data-anchor-id="example-pipeopscalealways">
<span class="header-section-number">11.3.2.2</span> Example: <code>PipeOpScaleAlways</code>
</h4>
<p>An often-applied preprocessing step is to simply <strong>center</strong> and/or <strong>scale</strong> the data to mean <span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>. This fits the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> pattern quite well. Because it always replaces all columns that it operates on, and does not require any information about the task’s target, it only needs to overload the <code>.train_dt()</code> and <code>.predict_dt()</code> functions. This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to instruct <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> to give us only these numeric columns. We do this by overloading the <code>.select_cols()</code> function: It is called by the class to determine which columns to pass to <code>.train_dt()</code> and <code>.predict_dt()</code>. Its input is the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> that is being transformed, and it should return a <code>character</code> vector of all features to work with. When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns. Because the <code><a href="https://rdrr.io/r/base/levels.html">levels()</a></code> of the data table given to <code>.train_dt()</code> and <code>.predict_dt()</code> may be different from the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s levels, these functions must also take a <code>levels</code> argument that is a named list of column names indicating their levels. When working with numeric data, this argument can be ignored, but it should be used instead of <code>levels(dt[[column]])</code> for factorial or character columns.</p>
<p>This is the first <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> where we will be using the <code>$state</code> slot for something useful: We save the centering offset and scaling coefficient and use it in <code>$.predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always scale and center all data. Compare this <code>PipeOpScaleAlways</code> operator to the one defined inside the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package, <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>.</p>
<div class="cell" data-hash="extending_cache/html/extending-031_cb5e5f1188669faf4b08634f57bd3d7a">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>PipeOpScaleAlways <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlways"</span>,</span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb40-4"><a href="#cb40-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always"</span>) {</span>
<span id="cb40-5"><a href="#cb40-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb40-6"><a href="#cb40-6"></a>    }</span>
<span id="cb40-7"><a href="#cb40-7"></a>  ),</span>
<span id="cb40-8"><a href="#cb40-8"></a></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb40-10"><a href="#cb40-10"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb40-11"><a href="#cb40-11"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb40-12"><a href="#cb40-12"></a>    },</span>
<span id="cb40-13"><a href="#cb40-13"></a></span>
<span id="cb40-14"><a href="#cb40-14"></a>    <span class="at">.train_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb40-15"><a href="#cb40-15"></a>      sc <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">as.matrix</span>(dt))</span>
<span id="cb40-16"><a href="#cb40-16"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb40-17"><a href="#cb40-17"></a>        <span class="at">center =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:center"</span>),</span>
<span id="cb40-18"><a href="#cb40-18"></a>        <span class="at">scale =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:scale"</span>)</span>
<span id="cb40-19"><a href="#cb40-19"></a>      )</span>
<span id="cb40-20"><a href="#cb40-20"></a>      sc</span>
<span id="cb40-21"><a href="#cb40-21"></a>    },</span>
<span id="cb40-22"><a href="#cb40-22"></a></span>
<span id="cb40-23"><a href="#cb40-23"></a>    <span class="at">.predict_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb40-24"><a href="#cb40-24"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb40-25"><a href="#cb40-25"></a>    }</span>
<span id="cb40-26"><a href="#cb40-26"></a>  )</span>
<span id="cb40-27"><a href="#cb40-27"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code> from the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package, you will notice that is uses “<code>get("type")</code>” and “<code>get("id")</code>” instead of “<code>type</code>” and “<code>id</code>”, because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a “problem” with <code>data.table</code> and not exclusive to <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>.)</em></p>
<p>We can, again, create a new <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that uses this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to test it. Compare the resulting data to the original “iris” <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> data printed at the beginning:</p>
<div class="cell" data-hash="extending_cache/html/extending-032_9202a68c4750322cb10dd760e4815a6e">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb41-2"><a href="#cb41-2"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb41-3"><a href="#cb41-3"></a></span>
<span id="cb41-4"><a href="#cb41-4"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb41-5"><a href="#cb41-5"></a></span>
<span id="cb41-6"><a href="#cb41-6"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
</section></section><section id="special-case-preprocessing-with-simple-train" class="level3" data-number="11.3.3"><h3 data-number="11.3.3" class="anchored" data-anchor-id="special-case-preprocessing-with-simple-train">
<span class="header-section-number">11.3.3</span> Special Case: Preprocessing with Simple Train</h3>
<p>It is possible to make even further simplifications for many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s that perform mostly the same operation during training and prediction. The point of <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level. However, what features get removed must be decided during <em>training</em>, and may only depend on training data. Furthermore, the actual process of removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a private method <code>.get_state(task)</code> which sets the <code>$state</code> slot during training, and a private method <code>.transform(task)</code>, which gets called both during training <em>and</em> prediction. This is done in the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> class. Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one can inherit from this and overload these functions to get a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that performs preprocessing with very little boilerplate code.</p>
<p>Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> offers the possibility to instead overload the <code>.get_state_dt(dt, levels)</code> and <code>.transform_dt(dt, levels)</code> methods (and optionally, again, the <code>.select_cols(task)</code> function) to operate on <code>data.table</code> feature data instead of the whole <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>.</p>
<p>Even some methods that do not use <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> <em>could</em> work in a similar way: The <code>PipeOpScaleAlways</code> example from above will be shown to also work with this paradigm.</p>
<section id="example-pipeopdropconst" class="level4" data-number="11.3.3.1"><h4 data-number="11.3.3.1" class="anchored" data-anchor-id="example-pipeopdropconst">
<span class="header-section-number">11.3.3.1</span> Example: <code>PipeOpDropConst</code>
</h4>
<p>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training. One simple example of this is dropping constant features. Because the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <code>$select()</code> function, so the <code>.get_state_dt(dt, levels)</code> / <code>.transform_dt(dt, levels)</code> functions will <em>not</em> get used; instead we overload the <code>.get_state(task)</code> and <code>.transform(task)</code> methods.</p>
<p>The <code>.get_state()</code> function’s result is saved to the <code>$state</code> slot, so we want to return something that is useful for dropping features. We choose to save the names of all the columns that have nonzero variance. For brevity, we use <code>length(unique(column)) &gt; 1</code> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</p>
<p>The <code>.transform()</code> method is evaluated both during training <em>and</em> prediction, and can rely on the <code>$state</code> slot being present. All it does here is call the <code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> could be written as follows:</p>
<div class="cell" data-hash="extending_cache/html/extending-033_b627c440e9fef641c5ff26c385e227d6">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>PipeOpDropConst <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropConst"</span>,</span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.const"</span>) {</span>
<span id="cb43-5"><a href="#cb43-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb43-6"><a href="#cb43-6"></a>    }</span>
<span id="cb43-7"><a href="#cb43-7"></a>  ),</span>
<span id="cb43-8"><a href="#cb43-8"></a></span>
<span id="cb43-9"><a href="#cb43-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb43-10"><a href="#cb43-10"></a>    <span class="at">.get_state =</span> <span class="cf">function</span>(task) {</span>
<span id="cb43-11"><a href="#cb43-11"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb43-12"><a href="#cb43-12"></a>      nonconst <span class="ot">=</span> <span class="fu">sapply</span>(data, <span class="cf">function</span>(column) <span class="fu">length</span>(<span class="fu">unique</span>(column)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb43-13"><a href="#cb43-13"></a>      <span class="fu">list</span>(<span class="at">cnames =</span> <span class="fu">colnames</span>(data)[nonconst])</span>
<span id="cb43-14"><a href="#cb43-14"></a>    },</span>
<span id="cb43-15"><a href="#cb43-15"></a></span>
<span id="cb43-16"><a href="#cb43-16"></a>    <span class="at">.transform =</span> <span class="cf">function</span>(task) {</span>
<span id="cb43-17"><a href="#cb43-17"></a>      task<span class="sc">$</span><span class="fu">select</span>(self<span class="sc">$</span>state<span class="sc">$</span>cnames)</span>
<span id="cb43-18"><a href="#cb43-18"></a>    }</span>
<span id="cb43-19"><a href="#cb43-19"></a>  )</span>
<span id="cb43-20"><a href="#cb43-20"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This can be tested using the first five rows of the “Iris” <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, for which one feature (<code>"Petal.Width"</code>) is constant:</p>
<div class="cell" data-hash="extending_cache/html/extending-034_8b03b1752d7ee322ed66a09aec961031">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>irishead <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb44-2"><a href="#cb44-2"></a>irishead<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa          1.4         0.2          5.1         3.5
2:  setosa          1.4         0.2          4.9         3.0
3:  setosa          1.3         0.2          4.7         3.2
4:  setosa          1.5         0.2          4.6         3.1
5:  setosa          1.4         0.2          5.0         3.6</code></pre>
</div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-035_a75d438ae228c4dbeb1715b16f9e8db1">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropConst<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb46-2"><a href="#cb46-2"></a>dropped_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(irishead)[[<span class="dv">1</span>]]</span>
<span id="cb46-3"><a href="#cb46-3"></a></span>
<span id="cb46-4"><a href="#cb46-4"></a>dropped_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Sepal.Length Sepal.Width
1:  setosa          1.4          5.1         3.5
2:  setosa          1.4          4.9         3.0
3:  setosa          1.3          4.7         3.2
4:  setosa          1.5          4.6         3.1
5:  setosa          1.4          5.0         3.6</code></pre>
</div>
</div>
<p>We can also see that the <code>$state</code> was correctly set. Calling <code>$.predict()</code> with this graph, even with different data (the whole Iris <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>!) will still drop the <code>"Petal.Width"</code> column, as it should.</p>
<div class="cell" data-hash="extending_cache/html/extending-036_38ced7e4ce8f1282410286a8af540074">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>gr<span class="sc">$</span>pipeops<span class="sc">$</span>drop.const<span class="sc">$</span>state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$cnames
[1] "Petal.Length" "Sepal.Length" "Sepal.Width" 

$affected_cols
[1] "Petal.Length" "Petal.Width"  "Sepal.Length" "Sepal.Width" 

$intasklayout
             id    type
1: Petal.Length numeric
2:  Petal.Width numeric
3: Sepal.Length numeric
4:  Sepal.Width numeric

$outtasklayout
             id    type
1: Petal.Length numeric
2: Sepal.Length numeric
3:  Sepal.Width numeric

$outtaskshell
Empty data.table (0 rows and 4 cols): Species,Petal.Length,Sepal.Length,Sepal.Width</code></pre>
</div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-037_d4ce26f416a4870ff589032e5f17f90c">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>dropped_predict <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a>dropped_predict<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Sepal.Length Sepal.Width
  1:    setosa          1.4          5.1         3.5
  2:    setosa          1.4          4.9         3.0
  3:    setosa          1.3          4.7         3.2
  4:    setosa          1.5          4.6         3.1
  5:    setosa          1.4          5.0         3.6
 ---                                                
146: virginica          5.2          6.7         3.0
147: virginica          5.0          6.3         2.5
148: virginica          5.2          6.5         3.0
149: virginica          5.4          6.2         3.4
150: virginica          5.1          5.9         3.0</code></pre>
</div>
</div>
</section><section id="example-pipeopscalealwayssimple" class="level4" data-number="11.3.3.2"><h4 data-number="11.3.3.2" class="anchored" data-anchor-id="example-pipeopscalealwayssimple">
<span class="header-section-number">11.3.3.2</span> Example: <code>PipeOpScaleAlwaysSimple</code>
</h4>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can be used when only working on feature data in form of a <code>data.table</code>. Instead of calling the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function, the <code>center</code> and <code>scale</code> values are calculated directly and saved to the <code>$state</code> slot. The <code>.transform_dt()</code> function will then perform the same operation during both training and prediction: subtract the <code>center</code> and divide by the <code>scale</code> value. As in the <a href="#example-pipeopscalealways"><code>PipeOpScaleAlways</code> example above</a>, we use <code>.select_cols()</code> so that we only work on numeric columns.</p>
<div class="cell" data-hash="extending_cache/html/extending-038_e171561c7211b3a65a0a65c1ed3ae61a">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>PipeOpScaleAlwaysSimple <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlwaysSimple"</span>,</span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb52-4"><a href="#cb52-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always.simple"</span>) {</span>
<span id="cb52-5"><a href="#cb52-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb52-6"><a href="#cb52-6"></a>    }</span>
<span id="cb52-7"><a href="#cb52-7"></a>  ),</span>
<span id="cb52-8"><a href="#cb52-8"></a></span>
<span id="cb52-9"><a href="#cb52-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb52-10"><a href="#cb52-10"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb52-11"><a href="#cb52-11"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb52-12"><a href="#cb52-12"></a>    },</span>
<span id="cb52-13"><a href="#cb52-13"></a></span>
<span id="cb52-14"><a href="#cb52-14"></a>    <span class="at">.get_state_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb52-15"><a href="#cb52-15"></a>      <span class="fu">list</span>(</span>
<span id="cb52-16"><a href="#cb52-16"></a>        <span class="at">center =</span> <span class="fu">sapply</span>(dt, mean),</span>
<span id="cb52-17"><a href="#cb52-17"></a>        <span class="at">scale =</span> <span class="fu">sapply</span>(dt, sd)</span>
<span id="cb52-18"><a href="#cb52-18"></a>      )</span>
<span id="cb52-19"><a href="#cb52-19"></a>    },</span>
<span id="cb52-20"><a href="#cb52-20"></a></span>
<span id="cb52-21"><a href="#cb52-21"></a>    <span class="at">.transform_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb52-22"><a href="#cb52-22"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb52-23"><a href="#cb52-23"></a>    }</span>
<span id="cb52-24"><a href="#cb52-24"></a>  )</span>
<span id="cb52-25"><a href="#cb52-25"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can compare this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to the one above to show that it behaves the same.</p>
<div class="cell" data-hash="extending_cache/html/extending-039_2057dbf36d2e03ce3949f7f624e9e364">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb53-2"><a href="#cb53-2"></a>result_posa <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb53-3"><a href="#cb53-3"></a></span>
<span id="cb53-4"><a href="#cb53-4"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb53-5"><a href="#cb53-5"></a>result_posa_simple <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-040_2666120a1aca2d01300e265fadca3feb">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>result_posa<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-041_dd894d0a1dba7efc00a0e08686c86e2e">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>result_posa_simple<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
</section></section><section id="ext-pipe-hyperpars" class="level3" data-number="11.3.4"><h3 data-number="11.3.4" class="anchored" data-anchor-id="ext-pipe-hyperpars">
<span class="header-section-number">11.3.4</span> Hyperparameters</h3>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> uses the <a href="https://paradox.mlr-org.com">[<code>paradox</code>](https://paradox.mlr-org.com)</a> package to define parameter spaces for <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. Parameters for <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s can modify their behavior in certain ways, e.g.&nbsp;switch centering or scaling off in the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> operator. The unified interface makes it possible to have parameters for whole <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s that modify the individual <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s behavior. The <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s, when encapsulated in <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>s, can even be tuned using the tuning functionality in <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>.</p>
<p>Hyperparameters are declared during initialization, when calling the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s <code>$initialize()</code> function, by giving a <code>param_set</code> argument. The <code>param_set</code> must be a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> from the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package; see <a href="#searchspace">the tuning chapter</a> or <a href="technical.html#sec-paradox"><span>Section&nbsp;9.4</span></a> for more information on how to define parameter spaces. After construction, the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> can be accessed through the <code>$param_set</code> slot. While it is <em>possible</em> to modify this <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a>, using e.g.&nbsp;the <code>$add()</code> and <code>$add_dep()</code> functions, <em>after</em> adding it to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the <code>$values</code> slot. When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <code>$param_set</code>, so it is not necessary to type check them. Be aware that it is always possible to <em>remove</em> hyperparameter values.</p>
<p>When a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is initialized, it usually does not have any parameter values—<code>$values</code> takes the value <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>. It is possible to set initial parameter values in the <code>$initialize()</code> constructor; this must be done <em>after</em> the <code>super$initialize()</code> call where the corresponding <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> must be supplied. This is because setting <code>$values</code> checks against the current <code>$param_set</code>, which would fail if the <code>$param_set</code> was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code> function in <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, say), then there is usually a “default” behaviour of that function when a parameter is not given. It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed). This can easily be done when using the <a href="https://mlr3misc.mlr-org.com"><code>mlr3misc</code></a> library’s <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> function, which has functionality similar to <code>"do.call()"</code>.</p>
<section id="hyperparameter-example-pipeopscale" class="level4" data-number="11.3.4.1"><h4 data-number="11.3.4.1" class="anchored" data-anchor-id="hyperparameter-example-pipeopscale">
<span class="header-section-number">11.3.4.1</span> Hyperparameter Example: <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>
</h4>
<p>How to use hyperparameters can best be shown through the example of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, which is very similar to the example above, <code>PipeOpScaleAlways</code>. The difference is made by the presence of hyperparameters. <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> constructs a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> in its <code>$initialize</code> function and passes this on to the <code>super$initialize</code> function:</p>
<div class="cell" data-hash="extending_cache/html/extending-042_f5237e33b9d4e2d53a5c0df9ad377a8d">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>PipeOpScale<span class="sc">$</span>public_methods<span class="sc">$</span>initialize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (id = "scale", param_vals = list()) 
.__PipeOpScale__initialize(self = self, private = private, super = super, 
    id = id, param_vals = param_vals)
&lt;environment: namespace:mlr3pipelines&gt;</code></pre>
</div>
</div>
<p>The user has access to this and can set and get parameters. Types are automatically checked:</p>
<div class="cell" data-hash="extending_cache/html/extending-043_9fdd723c2c2bef049999de6812307f20">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>pss <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet:scale&gt;
               id    class lower upper nlevels        default value
1:         center ParamLgl    NA    NA       2           TRUE      
2:          scale ParamLgl    NA    NA       2           TRUE      
3:         robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt; FALSE
4: affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;      </code></pre>
</div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-044_456c152079918123b81d659d09fb0551">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set<span class="sc">$</span>values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$robust
[1] FALSE

$center
[1] FALSE</code></pre>
</div>
</div>
<div class="cell" data-hash="extending_cache/html/extending-045_066a1e2bf2dd8474465a4ba8ae34038c">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="st">"TRUE"</span> <span class="co"># bad input is checked!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in self$assert(xs): Assertion on 'xs' failed: scale: Must be of type 'logical flag', not 'character'.</code></pre>
</div>
</div>
<p>How <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> handles its parameters can be seen in its <code>$.train_dt</code> method: It gets the relevant parameters from its <code>$values</code> slot and uses them in the <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> call. This has the advantage over calling <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> directly that if a parameter is not given, its default value from the <code>"scale()"</code> function will be used.</p>
<div class="cell" data-hash="extending_cache/html/extending-046_8b1c0d32f338f52ae497a6f897e8c658">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>PipeOpScale<span class="sc">$</span>private_methods<span class="sc">$</span>.train_dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (dt, levels, target) 
.__PipeOpScale__.train_dt(self = self, private = private, super = super, 
    dt = dt, levels = levels, target = target)
&lt;environment: namespace:mlr3pipelines&gt;</code></pre>
</div>
</div>
<p>Another change that is necessary compared to <code>PipeOpScaleAlways</code> is that the attributes <code>"scaled:scale"</code> and <code>"scaled:center"</code> are not always present, depending on parameters, and possibly need to be set to default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> with both <code>scale</code> and <code>center</code> set to <code>FALSE</code>, which returns the original dataset, unchanged.</p>
<div class="cell" data-hash="extending_cache/html/extending-047_c3550ceb8062405bc13ae63a72b264c5">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb68-3"><a href="#cb68-3"></a></span>
<span id="cb68-4"><a href="#cb68-4"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb68-5"><a href="#cb68-5"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(pss)</span>
<span id="cb68-6"><a href="#cb68-6"></a></span>
<span id="cb68-7"><a href="#cb68-7"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb68-8"><a href="#cb68-8"></a></span>
<span id="cb68-9"><a href="#cb68-9"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa          1.4         0.2          5.1         3.5
  2:    setosa          1.4         0.2          4.9         3.0
  3:    setosa          1.3         0.2          4.7         3.2
  4:    setosa          1.5         0.2          4.6         3.1
  5:    setosa          1.4         0.2          5.0         3.6
 ---                                                            
146: virginica          5.2         2.3          6.7         3.0
147: virginica          5.0         1.9          6.3         2.5
148: virginica          5.2         2.0          6.5         3.0
149: virginica          5.4         2.3          6.2         3.4
150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
</section></section></section><section id="extending-tuners" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="extending-tuners">
<span class="header-section-number">11.4</span> Adding new Tuners</h2>
<p>In this section, we show how to implement a custom tuner for <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>. The main task of a tuner is to iteratively propose new hyperparameter configurations that we want to evaluate for a given task, learner and validation strategy. The second task is to decide which configuration should be returned as a tuning result - usually it is the configuration that led to the best observed performance value. If you want to implement your own tuner, you have to implement an R6-Object that offers an <a href="#tuner-optimize"><code>.optimize</code></a> method that implements the iterative proposal and you are free to implement <a href="#tuner-add-result"><code>.assign_result</code></a> to differ from the before-mentioned default process of determining the result.</p>
<p>Before you start with the implementation make yourself familiar with the main R6-Objects in <a href="https://bbotk.mlr-org.com"><code>bbotk</code></a> (Black-Box Optimization Toolkit). This package does not only provide basic black box optimization algorithms and but also the objects that represent the optimization problem (<a href="https://bbotk.mlr-org.com/reference/OptimInstance.html"><code>OptimInstance</code></a>) and the log of all evaluated configurations (<a href="https://bbotk.mlr-org.com/reference/Archive.html"><code>Archive</code></a>).</p>
<p>There are two ways to implement a new tuner: a ) If your new tuner can be applied to any kind of optimization problem it should be implemented as a <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a>. Any <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a> can be easily transformed to a <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>. b) If the new custom tuner is only usable for hyperparameter tuning, for example because it needs to access the task, learner or resampling objects it should be directly implemented in <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a> as a <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>.</p>
<section id="extending-tuners-summary" class="level3" data-number="11.4.1"><h3 data-number="11.4.1" class="anchored" data-anchor-id="extending-tuners-summary">
<span class="header-section-number">11.4.1</span> Adding a new Tuner</h3>
<p>This is a summary of steps for adding a new tuner. The fifth step is only required if the new tuner is added via <a href="https://bbotk.mlr-org.com"><code>bbotk</code></a>.</p>
<ol type="1">
<li>Check the tuner does not already exist as a <a href="https://github.com/mlr-org/bbotk/tree/master/R">[<code>Optimizer</code>](https://bbotk.mlr-org.com/reference/Optimizer.html)</a> or <a href="https://github.com/mlr-org/mlr3tuning/tree/master/R">[<code>Tuner</code>](https://mlr3tuning.mlr-org.com/reference/Tuner.html)</a> in the GitHub repositories.</li>
<li>Use one of the existing optimizers / tuners as a <a href="#tuner-template">template</a>.</li>
<li>Overwrite the <a href="#tuner-optimize"><code>.optimize</code></a> private method of the optimizer / tuner.</li>
<li>Optionally, overwrite the default <a href="#tuner-add-result"><code>.assign_result</code></a> private method.</li>
<li>Use the <a href="#tuner-from-optimizer"><code>mlr3tuning::TunerFromOptimizer</code></a> class to transform the <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a> to a <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>.</li>
<li>Add <a href="#tuner-test">unit tests</a> for the tuner and optionally for the optimizer.</li>
<li>Open a new pull request for the <a href="https://github.com/mlr-org/mlr3tuning/pulls">[<code>Tuner</code>](https://mlr3tuning.mlr-org.com/reference/Tuner.html)</a> and optionally a second one for the <a href="https://github.com/mlr-org/bbotk/pulls">[<code>Optimizer</code>](https://bbotk.mlr-org.com/reference/Optimizer.html)</a>.</li>
</ol></section><section id="tuner-template" class="level3" data-number="11.4.2"><h3 data-number="11.4.2" class="anchored" data-anchor-id="tuner-template">
<span class="header-section-number">11.4.2</span> Template</h3>
<p>If the new custom tuner is implemented via <a href="https://bbotk.mlr-org.com"><code>bbotk</code></a>, use one of the existing optimizer as a template e.g.&nbsp;<a href="https://github.com/mlr-org/bbotk/blob/master/R/OptimizerRandomSearch.R"><code>bbotk::OptimizerRandomSearch</code></a>. There are currently only two tuners that are not based on a <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a>: <a href="https://github.com/mlr-org/mlr3hyperband/blob/master/R/TunerHyperband.R"><code>mlr3hyperband::TunerHyperband</code></a> and <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R"><code>mlr3tuning::TunerIrace</code></a>. Both are rather complex but you can still use the documentation and class structure as a template. The following steps are identical for optimizers and tuners.</p>
<p>Rewrite the meta information in the documentation and create a new class name. Scientific sources can be added in <code>R/bibentries.R</code> which are added under <code>@source</code> in the documentation. The example and dictionary sections of the documentation are auto-generated based on the <code>@templateVar id &lt;tuner_id&gt;</code>. Change the parameter set of the optimizer / tuner and document them under <code>@section Parameters</code>. Do not forget to change <code>mlr_optimizers$add()</code> / <code>mlr_tuners$add()</code> in the last line which adds the optimizer / tuner to the dictionary.</p>
</section><section id="tuner-optimize" class="level3" data-number="11.4.3"><h3 data-number="11.4.3" class="anchored" data-anchor-id="tuner-optimize">
<span class="header-section-number">11.4.3</span> Optimize method</h3>
<p>The <code>$.optimize()</code> private method is the main part of the tuner. It takes an instance, proposes new points and calls the <code>$eval_batch()</code> method of the instance to evaluate them. Here you can go two ways: Implement the iterative process yourself or call an external optimization function that resides in another package.</p>
<section id="writing-a-custom-iteration" class="level4" data-number="11.4.3.1"><h4 data-number="11.4.3.1" class="anchored" data-anchor-id="writing-a-custom-iteration">
<span class="header-section-number">11.4.3.1</span> Writing a custom iteration</h4>
<p>Usually, the proposal and evaluation is done in a <code>repeat</code>-loop which you have to implement. Please consider the following points:</p>
<ul>
<li>You can evaluate one or multiple points per iteration</li>
<li>You don’t have to care about termination, as <code>$eval_batch()</code> won’t allow more evaluations then allowed by the <code><a href="https://bbotk.mlr-org.com/reference/Terminator.html">bbotk::Terminator</a></code>. This implies, that code after the <code>repeat</code>-loop will not be executed.</li>
<li>You don’t have to care about keeping track of the evaluations as every evaluation is automatically stored in <code>inst$archive</code>.</li>
<li>If you want to log additional information for each evaluation of the <a href="https://bbotk.mlr-org.com/reference/Objective.html"><code>Objective</code></a> in the <a href="https://bbotk.mlr-org.com/reference/Archive.html"><code>Archive</code></a> you can simply add columns to the <code>data.table</code> object that is passed to <code>$eval_batch()</code>.</li>
</ul></section><section id="calling-an-external-optimization-function" class="level4" data-number="11.4.3.2"><h4 data-number="11.4.3.2" class="anchored" data-anchor-id="calling-an-external-optimization-function">
<span class="header-section-number">11.4.3.2</span> Calling an external optimization function</h4>
<p>Optimization functions from external packages usually take an objective function as an argument. In this case, you can pass <code>inst$objective_function</code> which internally calls <code>$eval_batch()</code>. Check out <a href="https://github.com/mlr-org/bbotk/blob/master/R/OptimizerGenSA.R"><code>OptimizerGenSA</code></a> for an example.</p>
</section></section><section id="tuner-add-result" class="level3" data-number="11.4.4"><h3 data-number="11.4.4" class="anchored" data-anchor-id="tuner-add-result">
<span class="header-section-number">11.4.4</span> Assign result method</h3>
<p>The default <code>$.assign_result()</code> private method simply obtains the best performing result from the archive. The default method can be overwritten if the new tuner determines the result of the optimization in a different way. The new function must call the <code>$assign_result()</code> method of the instance to write the final result to the instance. See <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R"><code>mlr3tuning::TunerIrace</code></a> for an implementation of <code>$.assign_result()</code>.</p>
</section><section id="tuner-from-optimizer" class="level3" data-number="11.4.5"><h3 data-number="11.4.5" class="anchored" data-anchor-id="tuner-from-optimizer">
<span class="header-section-number">11.4.5</span> Transform optimizer to tuner</h3>
<p>This step is only needed if you implement via <a href="https://bbotk.mlr-org.com"><code>bbotk</code></a>. The <code><a href="https://mlr3tuning.mlr-org.com/reference/TunerFromOptimizer.html">mlr3tuning::TunerFromOptimizer</a></code> class transforms a <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a> to a <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>. Just add the <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a> to the <code>optimizer</code> field. See <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerRandomSearch.R"><code>mlr3tuning::TunerRandomSearch</code></a> for an example.</p>
</section><section id="tuner-test" class="level3" data-number="11.4.6"><h3 data-number="11.4.6" class="anchored" data-anchor-id="tuner-test">
<span class="header-section-number">11.4.6</span> Add unit tests</h3>
<p>The new custom tuner should be thoroughly tested with unit tests. <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>s can be tested with the <code>test_tuner()</code> helper function. If you added the Tuner via a <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a>, you should additionally test the <a href="https://bbotk.mlr-org.com/reference/Optimizer.html"><code>Optimizer</code></a> with the <code>test_optimizer()</code> helper function.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./interpretation.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Interpretation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb70" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 1</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 1</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 2</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 2</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> TODO (150-200 WORDS)</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># Extending {#sec-extending}</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup.qmd &gt;}}</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>This chapter gives instructions on how to extend <span class="in">`r mlr3`</span> and its extension packages with custom objects.</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>The approach is always the same:</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>determine the base class you want to inherit from,</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>extend the class with your custom functionality,</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>test your implementation</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>(optionally) add new object to the respective <span class="in">`r ref("Dictionary")`</span>.</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>The chapter <span class="co">[</span><span class="ot">Create a new learner</span><span class="co">](#extending-learners)</span> illustrates the steps needed to create a custom learner in <span class="in">`r mlr3`</span>.</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>{{&lt; include _complex.qmd &gt;}}</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding new Learners {#sec-extending-learners}</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-001, include = F}</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3book)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>Although many learners are already included in the <span class="in">`r mlr3`</span> ecosystem, there might be a situation in which your algorithm of choice is not implemented.</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>Here, we show how to create a custom mlr3learner step-by-step using <span class="in">`r ref("mlr3extralearners::create_learner")`</span>.</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>If you intend to add a learner to mlr3extralearners, **it is strongly recommended** to **first** open a <span class="co">[</span><span class="ot">learner request issue</span><span class="co">](https://github.com/mlr-org/mlr3extralearners/issues/new?assignees=&amp;labels=new+learner&amp;template=learner-request-template.md&amp;title=%5BLRNRQ%5D+Add+%3Calgorithm%3E+from+package+%3Cpackage%3E)</span> to inform the <span class="in">`r mlr3`</span> team about your idea.</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>This allows to discuss the implementation details and potential peculiarities of the learner before putting actual work in.</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>This section gives insights on how a mlr3learner is constructed and how to troubleshoot issues.</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>See the <span class="co">[</span><span class="ot">Learner FAQ subsection</span><span class="co">](#learner-faq)</span> for help.</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>**Summary of steps for adding a new learner**</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Check that the learner does not already exist <span class="co">[</span><span class="ot">here</span><span class="co">](https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html)</span>.</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="co">[</span><span class="ot">Install</span><span class="co">](#setup)</span> <span class="in">`r mlr3extralearners`</span> and if you want to create a PR, also <span class="co">[</span><span class="ot">fork and clone</span><span class="co">](#setup)</span> it.</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="co">[</span><span class="ot">Run</span><span class="co">](#create-learner)</span> <span class="in">`r ref("mlr3extralearners::create_learner()")`</span>.</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Add the learner's <span class="co">[</span><span class="ot">`ParamSet`</span><span class="co">](#param-set)</span>.</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Manually add <span class="co">[</span><span class="ot">`.train`</span><span class="co">](#learner-train)</span> and <span class="co">[</span><span class="ot">`.predict`</span><span class="co">](#learner-predict)</span> private methods to the learner.</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Implement supported <span class="co">[</span><span class="ot">optional extractors</span><span class="co">](#optional-extractors)</span> and <span class="co">[</span><span class="ot">hotstarting</span><span class="co">](#hotstarting)</span> if applicable.</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Fill out the missing parts in the learner's description.</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>   To add references you first need to create an entry in bibentries.R</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Check that <span class="co">[</span><span class="ot">unit tests</span><span class="co">](#learner-test)</span> and <span class="co">[</span><span class="ot">parameter tests</span><span class="co">](#learner-test)</span> pass (these are automatically created).</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Run <span class="co">[</span><span class="ot">cleaning functions</span><span class="co">](#cleaning)</span>.</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Open a <span class="co">[</span><span class="ot">pull request</span><span class="co">](https://github.com/mlr-org/mlr3extralearners/pulls)</span> with the "new learner" template.</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>Do not copy/paste the code shown in this section.</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`r ref("create_learner()")`</span> to start.</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a><span class="fu">### Setting-up mlr3extralearners {#setup}</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>In order to use <span class="in">`r ref("mlr3extralearners::create_learner")`</span> you must have mlr3extralearners installed.</span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>Note that mlr3extralearners is not on CRAN and has to be installed from GitHub.</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>To ensure that you have the latest version, run <span class="in">`remotes::install_github("mlr-org/mlr3extralearners")`</span> before proceeding.</span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>If you want to create a pull request to mlr3extralearners you also need to</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="co">[</span><span class="ot">Fork</span><span class="co">](https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/fork-a-repo)</span> the <span class="co">[</span><span class="ot">repository</span><span class="co">](https://github.com/mlr-org/mlr3extralearners)</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span><span class="co">[</span><span class="ot">Clone</span><span class="co">](https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/cloning-a-repository)</span> a local copy of your forked repository.</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calling create_learner {#create-learner}</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>The learner <span class="in">`classif.rpart`</span> will be used as a running example throughout this section.</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-002, eval = FALSE, tidy = FALSE}</span></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3extralearners"</span>)</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a><span class="fu">create_learner</span>(</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="st">"path/to/a/folder"</span>,</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">classname =</span> <span class="st">"Rpart"</span>,</span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"classif"</span>,</span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">key =</span> <span class="st">"rpart"</span>,</span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">algorithm =</span> <span class="st">"Decision Tree"</span>,</span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">"rpart"</span>,</span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">caller =</span> <span class="st">"rpart"</span>,</span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_types =</span> <span class="fu">c</span>(<span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span>),</span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">predict_types =</span> <span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"prob"</span>),</span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span>),</span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">gh_name =</span> <span class="st">"RaphaelS1"</span>,</span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"Regression and Partition Tree"</span>,</span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_formats =</span> <span class="st">"data.table"</span></span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a>The full documentation for the function arguments is in <span class="in">`r ref("mlr3extralearners::create_learner")`</span>, in this example we are doing the following:</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`path = "path/to/a/folder"`</span> - This determines where the templates are being generated.</span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a>If the path is the root of an R package, the learner is created in the ./R directory and the test files in ./tests/testthat.</span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a>Otherwise, all files are being created in the folder pointed to by path.</span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>Already existing files will not be modified.</span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`classname = "Rpart"`</span> - Set the R6 class name to LearnerClassifRpart (classif is below)</span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`algorithm = "Decision Tree"`</span> - Create the title as "Classification Decision Tree Learner", where "Classification" is determined automatically from <span class="in">`type`</span> and "Learner" is added for all learners.</span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`type = "classif"`</span> - Setting the learner as a classification learner, automatically filling the title, class name, id (<span class="in">`"classif.rpart"`</span>) and task type.</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`key = "rpart"`</span> - Used with <span class="in">`type`</span> to create the unique ID of the learner, <span class="in">`"classif.rpart"`</span>.</span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`package = "rpart"`</span> - Setting the package from which the learner is implemented, this fills in things like the training function (along with <span class="in">`caller`</span>) and the <span class="in">`man`</span> field.</span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`caller = "rpart"`</span> - This tells the <span class="in">`.train`</span> function, and the description which function is called to run the algorithm, with <span class="in">`package`</span> this automatically fills <span class="in">`rpart::rpart`</span>.</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`feature_types = c("logical", "integer", "numeric", "factor", "ordered")`</span> - Sets the type of features that can be handled by the learner. See <span class="co">[</span><span class="ot">meta information</span><span class="co">](#learner-meta-information)</span>.</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`predict_types = c("response", "prob"),`</span> - Sets the available prediction types as response (pointwise prediction) and prob (probabilities). See <span class="co">[</span><span class="ot">meta information</span><span class="co">](#learner-meta-information)</span>.</span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`properties = c("importance", "missings", "multiclass", "twoclass", "weights")`</span> - Sets the properties the learner supports.</span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>By including <span class="in">`"importance"`</span> a public method called <span class="in">`importance`</span> will be created that must be manually filled.</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">meta information</span><span class="co">](#learner-meta-information)</span> and <span class="co">[</span><span class="ot">optional extractors</span><span class="co">](#optional-extractors)</span>.</span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`gh_name = "RaphaelS1"`</span> - Fills the '\@author' tag with my GitHub handle, this is required as it identifies the maintainer of the learner.</span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a>The sections below show an exemplary execution of <span class="in">`r ref("mlr3extralearners::create_learner")`</span>.</span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a><span class="fu">### `learner_package_type_key.R`</span></span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>The first generated file which must be updated after running <span class="in">`r ref("create_learner()")`</span> is the one following the structure <span class="in">`learner_&lt;package&gt;_&lt;type&gt;_&lt;key&gt;.R`</span>; in this example <span class="in">`learner_rpart_classif_rpart.R`</span>.</span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>For our example, the resulting script looks like this:</span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-003, eval = FALSE, tidy = FALSE}</span></span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a><span class="co">#' @title Classification Decision Tree Learner</span></span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a><span class="co">#' @author RaphaelS1</span></span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a><span class="co">#' @name mlr_learners_classif.rpart</span></span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description</span></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: BRIEF DESCRIPTION OF THE LEARNER.</span></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a><span class="co">#' Calls [rpart::rpart()] from </span><span class="al">FIXME</span><span class="co">: (CRAN VS NO CRAN): \CRANpkg{rpart} | 'rpart'.</span></span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Custom mlr3 parameters:</span></span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: DEVIATIONS FROM UPSTREAM PARAMETERS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: DEVIATIONS FROM UPSTREAM DEFAULTS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Installation:</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: CUSTOM INSTALLATION INSTRUCTIONS. DELETE IF NOT APPLICABLE.</span></span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a><span class="co">#' @templateVar id classif.rpart</span></span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template learner</span></span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a><span class="co">#' @references</span></span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span><span class="al">FIXME</span><span class="co">: ADD REFERENCES</span></span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template seealso_learner</span></span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template example</span></span>
<span id="cb70-154"><a href="#cb70-154" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a>LearnerClassifRpart <span class="ot">=</span> <span class="fu">R6Class</span>(<span class="st">"LearnerClassifRpart"</span>,</span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> LearnerClassif,</span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @description</span></span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Creates a new instance of this [R6][R6::R6Class] class.</span></span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: MANUALLY ADD PARAMETERS BELOW AND THEN DELETE THIS LINE</span></span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a>      param_set <span class="ot">=</span> <span class="fu">ps</span>()</span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: MANUALLY UPDATE PARAM VALUES BELOW IF APPLICABLE THEN DELETE THIS LINE.</span></span>
<span id="cb70-165"><a href="#cb70-165" aria-hidden="true" tabindex="-1"></a>      param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb70-166"><a href="#cb70-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"classif.rpart"</span>,</span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a>        <span class="at">packages =</span> <span class="st">"rpart"</span>,</span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a>        <span class="at">feature_types =</span> <span class="fu">c</span>(<span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span>),</span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a>        <span class="at">predict_types =</span> <span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"prob"</span>),</span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a>        <span class="at">param_set =</span> param_set,</span>
<span id="cb70-173"><a href="#cb70-173" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span>),</span>
<span id="cb70-174"><a href="#cb70-174" aria-hidden="true" tabindex="-1"></a>        <span class="at">man =</span> <span class="st">"mlr3extralearners::mlr_learners_classif.rpart"</span>,</span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="st">"Regression and Partition Tree"</span></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">FIXME</span><span class="co">: ADD IMPORTANCE METHOD IF APPLICABLE AND DELETE OTHERWISE</span></span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SEE mlr3extralearners::LearnerRegrRandomForest FOR AN EXAMPLE</span></span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @description</span></span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' The importance scores are extracted from the slot </span><span class="al">FIXME</span><span class="co">:.</span></span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @return Named `numeric()`.</span></span>
<span id="cb70-183"><a href="#cb70-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">importance =</span> <span class="cf">function</span>() {</span>
<span id="cb70-184"><a href="#cb70-184" aria-hidden="true" tabindex="-1"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"importance"</span>)</span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: Implement importance</span></span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-190"><a href="#cb70-190" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get parameters for training</span></span>
<span id="cb70-191"><a href="#cb70-191" aria-hidden="true" tabindex="-1"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-193"><a href="#cb70-193" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: IF LEARNER DOES NOT HAVE 'weights' PROPERTY THEN DELETE THESE LINES.</span></span>
<span id="cb70-194"><a href="#cb70-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"weights"</span> <span class="sc">%in%</span> task<span class="sc">$</span>properties) {</span>
<span id="cb70-195"><a href="#cb70-195" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add weights to learner</span></span>
<span id="cb70-196"><a href="#cb70-196" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-197"><a href="#cb70-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-198"><a href="#cb70-198" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: CREATE OBJECTS FOR THE TRAIN CALL</span></span>
<span id="cb70-199"><a href="#cb70-199" aria-hidden="true" tabindex="-1"></a>      <span class="co"># AT LEAST "data" AND "formula" ARE REQUIRED</span></span>
<span id="cb70-200"><a href="#cb70-200" aria-hidden="true" tabindex="-1"></a>      formula <span class="ot">=</span> task<span class="sc">$</span><span class="fu">formula</span>()</span>
<span id="cb70-201"><a href="#cb70-201" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-202"><a href="#cb70-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-203"><a href="#cb70-203" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: HERE IS SPACE FOR SOME CUSTOM ADJUSTMENTS BEFORE PROCEEDING TO THE</span></span>
<span id="cb70-204"><a href="#cb70-204" aria-hidden="true" tabindex="-1"></a>      <span class="co"># TRAIN CALL. CHECK OTHER LEARNERS FOR WHAT CAN BE DONE HERE</span></span>
<span id="cb70-205"><a href="#cb70-205" aria-hidden="true" tabindex="-1"></a>      <span class="co"># USE THE mlr3misc::invoke FUNCTION (IT'S SIMILAR TO do.call())</span></span>
<span id="cb70-206"><a href="#cb70-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-207"><a href="#cb70-207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">invoke</span>(</span>
<span id="cb70-208"><a href="#cb70-208" aria-hidden="true" tabindex="-1"></a>        rpart<span class="sc">::</span>rpart,</span>
<span id="cb70-209"><a href="#cb70-209" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> formula,</span>
<span id="cb70-210"><a href="#cb70-210" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> data,</span>
<span id="cb70-211"><a href="#cb70-211" aria-hidden="true" tabindex="-1"></a>        <span class="at">.args =</span> pars</span>
<span id="cb70-212"><a href="#cb70-212" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-213"><a href="#cb70-213" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-214"><a href="#cb70-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-215"><a href="#cb70-215" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get parameters with tag "predict"</span></span>
<span id="cb70-216"><a href="#cb70-216" aria-hidden="true" tabindex="-1"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"predict"</span>)</span>
<span id="cb70-217"><a href="#cb70-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-218"><a href="#cb70-218" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get newdata and ensure same ordering in train and predict</span></span>
<span id="cb70-219"><a href="#cb70-219" aria-hidden="true" tabindex="-1"></a>      newdata <span class="ot">=</span> <span class="fu">ordered_features</span>(task, self)</span>
<span id="cb70-220"><a href="#cb70-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-221"><a href="#cb70-221" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate predictions for the selected predict type.</span></span>
<span id="cb70-222"><a href="#cb70-222" aria-hidden="true" tabindex="-1"></a>      type <span class="ot">=</span> self<span class="sc">$</span>predict_type</span>
<span id="cb70-223"><a href="#cb70-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-224"><a href="#cb70-224" aria-hidden="true" tabindex="-1"></a>      pred <span class="ot">=</span> <span class="fu">invoke</span>(predict, self<span class="sc">$</span>model, <span class="at">newdata =</span> newdata, <span class="at">type =</span> type, <span class="at">.args =</span> pars)</span>
<span id="cb70-225"><a href="#cb70-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-226"><a href="#cb70-226" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co">: ADD PREDICTIONS TO LIST BELOW</span></span>
<span id="cb70-227"><a href="#cb70-227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>()</span>
<span id="cb70-228"><a href="#cb70-228" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-229"><a href="#cb70-229" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-230"><a href="#cb70-230" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-231"><a href="#cb70-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-232"><a href="#cb70-232" aria-hidden="true" tabindex="-1"></a>.extralrns_dict<span class="sc">$</span><span class="fu">add</span>(<span class="st">"classif.rpart"</span>, LearnerClassifRpart)</span>
<span id="cb70-233"><a href="#cb70-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-234"><a href="#cb70-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-235"><a href="#cb70-235" aria-hidden="true" tabindex="-1"></a>Now we have to do the following (the description will be addressed later):</span>
<span id="cb70-236"><a href="#cb70-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-237"><a href="#cb70-237" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Add the learner's parameters to the <span class="co">[</span><span class="ot">ParamSet</span><span class="co">](#param-set)</span>.</span>
<span id="cb70-238"><a href="#cb70-238" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Optionally <span class="co">[</span><span class="ot">change default values</span><span class="co">](#param-set)</span> for the parameters.</span>
<span id="cb70-239"><a href="#cb70-239" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Fill in the private <span class="co">[</span><span class="ot">`.train`</span><span class="co">](#learner-train)</span> method, which takes a (filtered) <span class="in">`r ref("Task")`</span> and returns a model.</span>
<span id="cb70-240"><a href="#cb70-240" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Fill in the private <span class="co">[</span><span class="ot">`.predict`</span><span class="co">](#learner-predict)</span> method, which operates on the model in <span class="in">`self$model`</span> (stored during <span class="in">`$train()`</span>) and a (differently subsetted) <span class="in">`r ref("Task")`</span> to return a named list of predictions.</span>
<span id="cb70-241"><a href="#cb70-241" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>As we included "importance" in <span class="in">`properties`</span>, we have to add the public method <span class="in">`importance()`</span> which returns a named numeric vectors with the decreasingly sorted importance scores (values) for the different features (names).</span>
<span id="cb70-242"><a href="#cb70-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-243"><a href="#cb70-243" aria-hidden="true" tabindex="-1"></a><span class="fu">### Meta-information {#learner-meta-information}</span></span>
<span id="cb70-244"><a href="#cb70-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-245"><a href="#cb70-245" aria-hidden="true" tabindex="-1"></a>In the constructor (<span class="in">`initialize()`</span>) the constructor of the super class (e.g. <span class="in">`r ref("LearnerClassif")`</span>) is called with meta information about the learner which should be constructed.</span>
<span id="cb70-246"><a href="#cb70-246" aria-hidden="true" tabindex="-1"></a>This includes:</span>
<span id="cb70-247"><a href="#cb70-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-248"><a href="#cb70-248" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`id`</span>: The ID of the new learner. Usually consists of <span class="in">`&lt;type&gt;.&lt;key&gt;`</span>, for example: <span class="in">`"classif.rpart"`</span>.</span>
<span id="cb70-249"><a href="#cb70-249" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`packages`</span>: The upstream package name(s) of the implemented learner.</span>
<span id="cb70-250"><a href="#cb70-250" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`param_set`</span>: A set of hyperparameters and their descriptions provided as a <span class="in">`r ref("paradox::ParamSet")`</span>.</span>
<span id="cb70-251"><a href="#cb70-251" aria-hidden="true" tabindex="-1"></a>  For each hyperparameter the appropriate class needs to be chosen. When using the <span class="in">`r ref("paradox::ps")`</span> shortcut, a short constructor of the form <span class="in">`p_***`</span> can be used:</span>
<span id="cb70-252"><a href="#cb70-252" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("paradox::ParamLgl")`</span> / <span class="co">[</span><span class="ot">`paradox::p_lgl`</span><span class="co">](https://paradox.mlr-org.com/reference/Domain.html)</span> for scalar logical hyperparameters.</span>
<span id="cb70-253"><a href="#cb70-253" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("paradox::ParamInt")`</span> / <span class="co">[</span><span class="ot">`paradox::p_int`</span><span class="co">](https://paradox.mlr-org.com/reference/Domain.html)</span> for scalar integer hyperparameters.</span>
<span id="cb70-254"><a href="#cb70-254" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("paradox::ParamDbl")`</span> / <span class="co">[</span><span class="ot">`paradox::p_dbl`</span><span class="co">](https://paradox.mlr-org.com/reference/Domain.html)</span> for scalar numeric hyperparameters.</span>
<span id="cb70-255"><a href="#cb70-255" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("paradox::ParamFct")`</span> / <span class="co">[</span><span class="ot">`paradox::p_fct`</span><span class="co">](https://paradox.mlr-org.com/reference/Domain.html)</span> for scalar factor hyperparameters (this includes characters).</span>
<span id="cb70-256"><a href="#cb70-256" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("paradox::ParamUty")`</span> / <span class="co">[</span><span class="ot">`paradox::p_uty`</span><span class="co">](https://paradox.mlr-org.com/reference/Domain.html)</span> for everything else (e.g. vector paramters or list parameters).</span>
<span id="cb70-257"><a href="#cb70-257" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`predict_types`</span>: Set of predict types the learner supports.</span>
<span id="cb70-258"><a href="#cb70-258" aria-hidden="true" tabindex="-1"></a>  These differ depending on the type of the learner. See <span class="in">`r ref("mlr_reflections", text = "mlr_reflections$learner_predict_types")`</span> for the full list of predict types supported by <span class="in">`r mlr3`</span>.</span>
<span id="cb70-259"><a href="#cb70-259" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("LearnerClassif")`</span></span>
<span id="cb70-260"><a href="#cb70-260" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`response`</span>: Only predicts a class label for each observation.</span>
<span id="cb70-261"><a href="#cb70-261" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`prob`</span>: Also predicts the posterior probability for each class for each observation.</span>
<span id="cb70-262"><a href="#cb70-262" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("LearnerRegr")`</span></span>
<span id="cb70-263"><a href="#cb70-263" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`response`</span>: Only predicts a numeric response for each observation.</span>
<span id="cb70-264"><a href="#cb70-264" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`se`</span>: Also predicts the standard error for each value of response.</span>
<span id="cb70-265"><a href="#cb70-265" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("LearnerSurv")`</span></span>
<span id="cb70-266"><a href="#cb70-266" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`lp`</span> - Linear predictor calculated as the fitted coefficients multiplied by the test data.</span>
<span id="cb70-267"><a href="#cb70-267" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`distr`</span> - Predicted survival distribution, either discrete or continuous.</span>
<span id="cb70-268"><a href="#cb70-268" aria-hidden="true" tabindex="-1"></a>      Implemented in <span class="in">`r ref_pkg("distr6")`</span>.</span>
<span id="cb70-269"><a href="#cb70-269" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`crank`</span> - Continuous risk ranking.</span>
<span id="cb70-270"><a href="#cb70-270" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`response`</span> - Predicted survival time.</span>
<span id="cb70-271"><a href="#cb70-271" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("LearnerDens")`</span></span>
<span id="cb70-272"><a href="#cb70-272" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`pdf`</span>- Predicts the probability density function.</span>
<span id="cb70-273"><a href="#cb70-273" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`cdf`</span> - Predicts the cumulative distribution function.</span>
<span id="cb70-274"><a href="#cb70-274" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`distr`</span> - Predicts a distribution as implemented in <span class="in">`r ref_pkg("distr6")`</span>.</span>
<span id="cb70-275"><a href="#cb70-275" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`r ref("LearnerClust")`</span></span>
<span id="cb70-276"><a href="#cb70-276" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`partition`</span> - Assigns the observation to a partition.</span>
<span id="cb70-277"><a href="#cb70-277" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span><span class="in">`prob`</span> - Returns a probability for each partition.</span>
<span id="cb70-278"><a href="#cb70-278" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`feature_types`</span>: Set of feature types the learner is able to handle.</span>
<span id="cb70-279"><a href="#cb70-279" aria-hidden="true" tabindex="-1"></a>  See <span class="in">`r ref("mlr_reflections", text = "mlr_reflections$task_feature_types")`</span> for feature types supported by <span class="in">`r mlr3`</span>.</span>
<span id="cb70-280"><a href="#cb70-280" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`properties`</span>: Set of properties of the learner. See <span class="in">`r ref("mlr_reflections", text = "mlr_reflections$learner_properties")`</span> for the full list of learner properties supported by <span class="in">`r mlr3`</span>.</span>
<span id="cb70-281"><a href="#cb70-281" aria-hidden="true" tabindex="-1"></a>  The list of properties includes:</span>
<span id="cb70-282"><a href="#cb70-282" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"twoclass"`</span>: The learner works on binary classification problems.</span>
<span id="cb70-283"><a href="#cb70-283" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"multiclass"`</span>: The learner works on multi-class classification problems.</span>
<span id="cb70-284"><a href="#cb70-284" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"missings"`</span>: The learner can natively handle missing values.</span>
<span id="cb70-285"><a href="#cb70-285" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"weights"`</span>: The learner can work on tasks which have observation weights / case weights.</span>
<span id="cb70-286"><a href="#cb70-286" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"importance"`</span>: The learner supports extracting importance values for features.</span>
<span id="cb70-287"><a href="#cb70-287" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"selected_features"`</span>: The learner supports extracting the features which were selected by the model.</span>
<span id="cb70-288"><a href="#cb70-288" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"oob_error"`</span>: The learner supports extracting the out of bag error.</span>
<span id="cb70-289"><a href="#cb70-289" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"loglik"`</span>: The learner supports extracting the log-likelihood of the learner.</span>
<span id="cb70-290"><a href="#cb70-290" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"hotstart_forward"`</span>: The learner allows to continue training the model e.g. by adding more trees to a random forest.</span>
<span id="cb70-291"><a href="#cb70-291" aria-hidden="true" tabindex="-1"></a><span class="ss">  * </span><span class="in">`"hotstart_backward"`</span>: The learner allows to "undo" some of the training, e.g. by removing some trees from a model.</span>
<span id="cb70-292"><a href="#cb70-292" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`man`</span>: The roxygen identifier of the learner.</span>
<span id="cb70-293"><a href="#cb70-293" aria-hidden="true" tabindex="-1"></a>  This is used within the <span class="in">`$help()`</span> method of the super class to open the help page of the learner.</span>
<span id="cb70-294"><a href="#cb70-294" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`label`</span>: The label of the learner.</span>
<span id="cb70-295"><a href="#cb70-295" aria-hidden="true" tabindex="-1"></a>  This should briefly describe the learner (similar to the description's title) and is for example used for printing.</span>
<span id="cb70-296"><a href="#cb70-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-297"><a href="#cb70-297" aria-hidden="true" tabindex="-1"></a><span class="fu">### ParamSet {#param-set}</span></span>
<span id="cb70-298"><a href="#cb70-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-299"><a href="#cb70-299" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ParamSet`</span> is the set of hyperparameters used in model training and predicting, this is given as a <span class="in">`r ref("paradox::ParamSet")`</span>.</span>
<span id="cb70-300"><a href="#cb70-300" aria-hidden="true" tabindex="-1"></a>The set consists of a list of hyperparameters, where each has a specific class for the hyperparameter type (see above).</span>
<span id="cb70-301"><a href="#cb70-301" aria-hidden="true" tabindex="-1"></a>In addition, each parameter has one or more tags, that determine in which method they are used.</span>
<span id="cb70-302"><a href="#cb70-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-303"><a href="#cb70-303" aria-hidden="true" tabindex="-1"></a>Beyond that there are other tags that serve specific purposes:</span>
<span id="cb70-304"><a href="#cb70-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-305"><a href="#cb70-305" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The tag <span class="in">`"threads"`</span> should be used (if applicable) to tag the parameter that determines the number of threads used for the learner's internal parallelization.</span>
<span id="cb70-306"><a href="#cb70-306" aria-hidden="true" tabindex="-1"></a>  This parameter can be set using <span class="in">`r ref("set_threads")`</span>.</span>
<span id="cb70-307"><a href="#cb70-307" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The tag <span class="in">`"required"`</span> should be used to tag parameters that must be provided for the algorithm to be executable.</span>
<span id="cb70-308"><a href="#cb70-308" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>In case <span class="co">[</span><span class="ot">optional extractors</span><span class="co">](#optional-extractors)</span> are available, the can (although this is rarely the case) also have parameters and can be tagged accordingly.</span>
<span id="cb70-309"><a href="#cb70-309" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If <span class="co">[</span><span class="ot">hotstarting</span><span class="co">](#hotstarting)</span> is available, the fidelity parameter should be tagged with <span class="in">`"hotstart"`</span>.</span>
<span id="cb70-310"><a href="#cb70-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-311"><a href="#cb70-311" aria-hidden="true" tabindex="-1"></a>For <span class="in">`classif.rpart`</span> the <span class="in">`param_set`</span> can be defined as follows</span>
<span id="cb70-312"><a href="#cb70-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-313"><a href="#cb70-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-004, eval = FALSE}</span></span>
<span id="cb70-314"><a href="#cb70-314" aria-hidden="true" tabindex="-1"></a>param_set <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb70-315"><a href="#cb70-315" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">default =</span> 20L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-316"><a href="#cb70-316" aria-hidden="true" tabindex="-1"></a>  <span class="at">minbucket =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-317"><a href="#cb70-317" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="fl">0.01</span>, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-318"><a href="#cb70-318" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxcompete =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 4L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-319"><a href="#cb70-319" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxsurrogate =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 5L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-320"><a href="#cb70-320" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxdepth =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 1L, <span class="at">upper =</span> 30L, <span class="at">default =</span> 30L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-321"><a href="#cb70-321" aria-hidden="true" tabindex="-1"></a>  <span class="at">usesurrogate =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">upper =</span> 2L, <span class="at">default =</span> 2L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-322"><a href="#cb70-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogatestyle =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">upper =</span> 1L, <span class="at">default =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-323"><a href="#cb70-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">xval =</span> <span class="fu">p_int</span>(<span class="at">lower =</span> 0L, <span class="at">default =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-324"><a href="#cb70-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">keep_model =</span> <span class="fu">p_lgl</span>(<span class="at">default =</span> <span class="cn">FALSE</span>, <span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb70-325"><a href="#cb70-325" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-326"><a href="#cb70-326" aria-hidden="true" tabindex="-1"></a>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">xval =</span> 0L)</span>
<span id="cb70-327"><a href="#cb70-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-328"><a href="#cb70-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-329"><a href="#cb70-329" aria-hidden="true" tabindex="-1"></a>Within <span class="in">`r mlr3`</span> packages we suggest to stick to the shorthand notation above for consistency, however the <span class="in">`param_set`</span> can be written with the underlying R6 classes as shown here</span>
<span id="cb70-330"><a href="#cb70-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-331"><a href="#cb70-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-005, eval = FALSE}</span></span>
<span id="cb70-332"><a href="#cb70-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-333"><a href="#cb70-333" aria-hidden="true" tabindex="-1"></a>param_set <span class="ot">=</span> ParamSet<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb70-334"><a href="#cb70-334" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"minsplit"</span>, <span class="at">default =</span> 20L, <span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-335"><a href="#cb70-335" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"minbucket"</span>, <span class="at">lower =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-336"><a href="#cb70-336" aria-hidden="true" tabindex="-1"></a>  ParamDbl<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"cp"</span>, <span class="at">default =</span> <span class="fl">0.01</span>, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-337"><a href="#cb70-337" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxcompete"</span>, <span class="at">default =</span> 4L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-338"><a href="#cb70-338" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxsurrogate"</span>, <span class="at">default =</span> 5L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-339"><a href="#cb70-339" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"maxdepth"</span>, <span class="at">default =</span> 30L, <span class="at">lower =</span> 1L, <span class="at">upper =</span> 30L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-340"><a href="#cb70-340" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"usesurrogate"</span>, <span class="at">default =</span> 2L, <span class="at">lower =</span> 0L, <span class="at">upper =</span> 2L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-341"><a href="#cb70-341" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"surrogatestyle"</span>, <span class="at">default =</span> 0L, <span class="at">lower =</span> 0L, <span class="at">upper =</span> 1L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-342"><a href="#cb70-342" aria-hidden="true" tabindex="-1"></a>  ParamInt<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"xval"</span>, <span class="at">default =</span> 0L, <span class="at">lower =</span> 0L, <span class="at">tags =</span> <span class="st">"train"</span>),</span>
<span id="cb70-343"><a href="#cb70-343" aria-hidden="true" tabindex="-1"></a>  ParamLgl<span class="sc">$</span><span class="fu">new</span>(<span class="at">id =</span> <span class="st">"keep_model"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>, <span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb70-344"><a href="#cb70-344" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb70-345"><a href="#cb70-345" aria-hidden="true" tabindex="-1"></a>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="at">xval =</span> 0L)</span>
<span id="cb70-346"><a href="#cb70-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-347"><a href="#cb70-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-348"><a href="#cb70-348" aria-hidden="true" tabindex="-1"></a>You should read though the learner documentation to find the full list of available parameters. Just looking at some of these in this example:</span>
<span id="cb70-349"><a href="#cb70-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-350"><a href="#cb70-350" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`"cp"`</span> is numeric, has a feasible range of <span class="in">`[0,1]`</span> and defaults to <span class="in">`0.01`</span>.</span>
<span id="cb70-351"><a href="#cb70-351" aria-hidden="true" tabindex="-1"></a>  The parameter is used during <span class="in">`"train"`</span>.</span>
<span id="cb70-352"><a href="#cb70-352" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`"xval"`</span> is integer has a lower bound of <span class="in">`0`</span>, a default of <span class="in">`0`</span> and the parameter is used during <span class="in">`"train"`</span>.</span>
<span id="cb70-353"><a href="#cb70-353" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`"keep_model"`</span> is logical with a default of <span class="in">`FALSE`</span> and is used during <span class="in">`"train"`</span>.</span>
<span id="cb70-354"><a href="#cb70-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-355"><a href="#cb70-355" aria-hidden="true" tabindex="-1"></a>In some rare cases you may want to change the default parameter values.</span>
<span id="cb70-356"><a href="#cb70-356" aria-hidden="true" tabindex="-1"></a>You can do this by changing the <span class="in">`param_set$values`</span>.</span>
<span id="cb70-357"><a href="#cb70-357" aria-hidden="true" tabindex="-1"></a>You can see we have done this for <span class="in">`"classif.rpart"`</span> where the default for <span class="in">`xval`</span> is changed to <span class="in">`0`</span>.</span>
<span id="cb70-358"><a href="#cb70-358" aria-hidden="true" tabindex="-1"></a>Note that the default in the <span class="in">`r ref("ParamSet")`</span> is recorded as our changed default (0), and not the original (10).</span>
<span id="cb70-359"><a href="#cb70-359" aria-hidden="true" tabindex="-1"></a>It is strongly recommended to only change the defaults if absolutely required, when this is the case add the following to the learner documentation:</span>
<span id="cb70-360"><a href="#cb70-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-361"><a href="#cb70-361" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb70-362"><a href="#cb70-362" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span id="cb70-363"><a href="#cb70-363" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `&lt;parameter&gt;`:</span></span>
<span id="cb70-364"><a href="#cb70-364" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - Actual default: &lt;value&gt;</span></span>
<span id="cb70-365"><a href="#cb70-365" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - Adjusted default: &lt;value&gt;</span></span>
<span id="cb70-366"><a href="#cb70-366" aria-hidden="true" tabindex="-1"></a><span class="co">#'   - Reason for change: &lt;text&gt;</span></span>
<span id="cb70-367"><a href="#cb70-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-368"><a href="#cb70-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-369"><a href="#cb70-369" aria-hidden="true" tabindex="-1"></a><span class="fu">### Train function {#learner-train}</span></span>
<span id="cb70-370"><a href="#cb70-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-371"><a href="#cb70-371" aria-hidden="true" tabindex="-1"></a>The train function takes a <span class="in">`r ref("Task")`</span> as input and must return a model.</span>
<span id="cb70-372"><a href="#cb70-372" aria-hidden="true" tabindex="-1"></a>Let's say we want to translate the following call of <span class="in">`rpart::rpart()`</span> into code that can be used inside the <span class="in">`.train()`</span> method.</span>
<span id="cb70-373"><a href="#cb70-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-374"><a href="#cb70-374" aria-hidden="true" tabindex="-1"></a>First, we write something down that works completely without <span class="in">`r mlr3`</span>:</span>
<span id="cb70-375"><a href="#cb70-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-376"><a href="#cb70-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-006,eval=TRUE}</span></span>
<span id="cb70-377"><a href="#cb70-377" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> iris</span>
<span id="cb70-378"><a href="#cb70-378" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> rpart<span class="sc">::</span><span class="fu">rpart</span>(Species <span class="sc">~</span> ., <span class="at">data =</span> iris, <span class="at">xval =</span> <span class="dv">0</span>)</span>
<span id="cb70-379"><a href="#cb70-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-380"><a href="#cb70-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-381"><a href="#cb70-381" aria-hidden="true" tabindex="-1"></a>We need to pass the formula notation <span class="in">`Species ~ .`</span>, the data and the hyperparameters.</span>
<span id="cb70-382"><a href="#cb70-382" aria-hidden="true" tabindex="-1"></a>To get the hyperparameters, we call <span class="in">`self$param_set$get_values(tag = "train")`</span> and thereby query all parameters that are using during <span class="in">`"train"`</span>.</span>
<span id="cb70-383"><a href="#cb70-383" aria-hidden="true" tabindex="-1"></a>Then, the dataset is extracted from the <span class="in">`r ref("Task")`</span>.</span>
<span id="cb70-384"><a href="#cb70-384" aria-hidden="true" tabindex="-1"></a>Because the learner has the property <span class="in">`"weights"`</span>, we insert the weights of the task if there are any.</span>
<span id="cb70-385"><a href="#cb70-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-386"><a href="#cb70-386" aria-hidden="true" tabindex="-1"></a>Last, we call the upstream function <span class="in">`rpart::rpart()`</span> with the data and pass all hyperparameters via argument <span class="in">`.args`</span> using the <span class="in">`r ref("mlr3misc::invoke()")`</span> function.</span>
<span id="cb70-387"><a href="#cb70-387" aria-hidden="true" tabindex="-1"></a>The latter is simply an optimized version of <span class="in">`do.call()`</span> that we use within the <span class="in">`r mlr3`</span> ecosystem.</span>
<span id="cb70-388"><a href="#cb70-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-389"><a href="#cb70-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-007,eval=TRUE}</span></span>
<span id="cb70-390"><a href="#cb70-390" aria-hidden="true" tabindex="-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-391"><a href="#cb70-391" aria-hidden="true" tabindex="-1"></a>  pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb70-392"><a href="#cb70-392" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"weights"</span> <span class="sc">%in%</span> task<span class="sc">$</span>properties) {</span>
<span id="cb70-393"><a href="#cb70-393" aria-hidden="true" tabindex="-1"></a>    pars<span class="sc">$</span>weights <span class="ot">=</span> task<span class="sc">$</span>weights<span class="sc">$</span>weight</span>
<span id="cb70-394"><a href="#cb70-394" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-395"><a href="#cb70-395" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">=</span> task<span class="sc">$</span><span class="fu">formula</span>()</span>
<span id="cb70-396"><a href="#cb70-396" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-397"><a href="#cb70-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invoke</span>(</span>
<span id="cb70-398"><a href="#cb70-398" aria-hidden="true" tabindex="-1"></a>    rpart<span class="sc">::</span>rpart,</span>
<span id="cb70-399"><a href="#cb70-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb70-400"><a href="#cb70-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb70-401"><a href="#cb70-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">.args =</span> pars</span>
<span id="cb70-402"><a href="#cb70-402" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-403"><a href="#cb70-403" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-404"><a href="#cb70-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-405"><a href="#cb70-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-406"><a href="#cb70-406" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predict function {#learner-predict}</span></span>
<span id="cb70-407"><a href="#cb70-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-408"><a href="#cb70-408" aria-hidden="true" tabindex="-1"></a>The internal predict method <span class="in">`.predict()`</span> also operates on a <span class="in">`r ref("Task")`</span> as well as on the fitted model that has been created by the <span class="in">`train()`</span> call previously and has been stored in <span class="in">`self$model`</span>.</span>
<span id="cb70-409"><a href="#cb70-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-410"><a href="#cb70-410" aria-hidden="true" tabindex="-1"></a>The return value is a <span class="in">`r ref("Prediction")`</span> object.</span>
<span id="cb70-411"><a href="#cb70-411" aria-hidden="true" tabindex="-1"></a>We proceed analogously to what we did in the previous section.</span>
<span id="cb70-412"><a href="#cb70-412" aria-hidden="true" tabindex="-1"></a>We start with a version without any <span class="in">`r mlr3`</span> objects and continue to replace objects until we have reached the desired interface:</span>
<span id="cb70-413"><a href="#cb70-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-414"><a href="#cb70-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-008,eval=TRUE}</span></span>
<span id="cb70-415"><a href="#cb70-415" aria-hidden="true" tabindex="-1"></a><span class="co"># inputs:</span></span>
<span id="cb70-416"><a href="#cb70-416" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb70-417"><a href="#cb70-417" aria-hidden="true" tabindex="-1"></a>self <span class="ot">=</span> <span class="fu">list</span>(<span class="at">model =</span> rpart<span class="sc">::</span><span class="fu">rpart</span>(task<span class="sc">$</span><span class="fu">formula</span>(), <span class="at">data =</span> task<span class="sc">$</span><span class="fu">data</span>()))</span>
<span id="cb70-418"><a href="#cb70-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-419"><a href="#cb70-419" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> iris</span>
<span id="cb70-420"><a href="#cb70-420" aria-hidden="true" tabindex="-1"></a>response <span class="ot">=</span> <span class="fu">predict</span>(self<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"class"</span>)</span>
<span id="cb70-421"><a href="#cb70-421" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">=</span> <span class="fu">predict</span>(self<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb70-422"><a href="#cb70-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-423"><a href="#cb70-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-424"><a href="#cb70-424" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"rpart::predict.rpart()"`</span> function predicts class labels if argument <span class="in">`type`</span> is set to to <span class="in">`"class"`</span>, and class probabilities if set to <span class="in">`"prob"`</span>.</span>
<span id="cb70-425"><a href="#cb70-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-426"><a href="#cb70-426" aria-hidden="true" tabindex="-1"></a>Next, we transition from <span class="in">`data`</span> to a <span class="in">`r ref("Task")`</span> again and construct a list with the return type requested by the user, this is stored in the <span class="in">`$predict_type`</span> slot of a learner class. Note that the <span class="in">`r ref("Task")`</span> is automatically passed to the prediction object, so all you need to do is return the predictions! Make sure the list names are identical to the task predict types.</span>
<span id="cb70-427"><a href="#cb70-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-428"><a href="#cb70-428" aria-hidden="true" tabindex="-1"></a>The final <span class="in">`.predict()`</span> method is below, we could omit the <span class="in">`pars`</span> line as there are no parameters with the <span class="in">`"predict"`</span> tag but we keep it here to be consistent:</span>
<span id="cb70-429"><a href="#cb70-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-430"><a href="#cb70-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-009, eval = TRUE}</span></span>
<span id="cb70-431"><a href="#cb70-431" aria-hidden="true" tabindex="-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-432"><a href="#cb70-432" aria-hidden="true" tabindex="-1"></a>  pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"predict"</span>)</span>
<span id="cb70-433"><a href="#cb70-433" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get newdata and ensure same ordering in train and predict</span></span>
<span id="cb70-434"><a href="#cb70-434" aria-hidden="true" tabindex="-1"></a>  newdata <span class="ot">=</span> <span class="fu">ordered_features</span>(task, self)</span>
<span id="cb70-435"><a href="#cb70-435" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (self<span class="sc">$</span>predict_type <span class="sc">==</span> <span class="st">"response"</span>) {</span>
<span id="cb70-436"><a href="#cb70-436" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">=</span> <span class="fu">invoke</span>(</span>
<span id="cb70-437"><a href="#cb70-437" aria-hidden="true" tabindex="-1"></a>      predict,</span>
<span id="cb70-438"><a href="#cb70-438" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>model,</span>
<span id="cb70-439"><a href="#cb70-439" aria-hidden="true" tabindex="-1"></a>      <span class="at">newdata =</span> newdata,</span>
<span id="cb70-440"><a href="#cb70-440" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"class"</span>,</span>
<span id="cb70-441"><a href="#cb70-441" aria-hidden="true" tabindex="-1"></a>      <span class="at">.args =</span> pars</span>
<span id="cb70-442"><a href="#cb70-442" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-443"><a href="#cb70-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-444"><a href="#cb70-444" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">response =</span> response))</span>
<span id="cb70-445"><a href="#cb70-445" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb70-446"><a href="#cb70-446" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">=</span> <span class="fu">invoke</span>(</span>
<span id="cb70-447"><a href="#cb70-447" aria-hidden="true" tabindex="-1"></a>      predict,</span>
<span id="cb70-448"><a href="#cb70-448" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>model,</span>
<span id="cb70-449"><a href="#cb70-449" aria-hidden="true" tabindex="-1"></a>      <span class="at">newdata =</span> newdata,</span>
<span id="cb70-450"><a href="#cb70-450" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"prob"</span>,</span>
<span id="cb70-451"><a href="#cb70-451" aria-hidden="true" tabindex="-1"></a>      <span class="at">.args =</span> pars</span>
<span id="cb70-452"><a href="#cb70-452" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-453"><a href="#cb70-453" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">prob =</span> prob))</span>
<span id="cb70-454"><a href="#cb70-454" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-455"><a href="#cb70-455" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-456"><a href="#cb70-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-457"><a href="#cb70-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-458"><a href="#cb70-458" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb70-459"><a href="#cb70-459" aria-hidden="true" tabindex="-1"></a>You cannot rely on the column order of the data returned by <span class="in">`task$data()`</span> as the order of columns may be different from the order of the columns during <span class="in">`$.train`</span>.</span>
<span id="cb70-460"><a href="#cb70-460" aria-hidden="true" tabindex="-1"></a>The <span class="in">`newdata`</span> line ensures the ordering is the same by calling the same order as in train!</span>
<span id="cb70-461"><a href="#cb70-461" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb70-462"><a href="#cb70-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-463"><a href="#cb70-463" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optional Extractors {#optional-extractors}</span></span>
<span id="cb70-464"><a href="#cb70-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-465"><a href="#cb70-465" aria-hidden="true" tabindex="-1"></a>Specific learner implementations are free to implement additional getters to ease the access of certain parts of the model in the inherited subclasses.</span>
<span id="cb70-466"><a href="#cb70-466" aria-hidden="true" tabindex="-1"></a>The blueprint for these methods is only included in the generated learner template, if the property is set when calling <span class="in">`create_learner()`</span>.</span>
<span id="cb70-467"><a href="#cb70-467" aria-hidden="true" tabindex="-1"></a>The comments in the templates will include references to other learners that have this property and can be used as guiding examples.</span>
<span id="cb70-468"><a href="#cb70-468" aria-hidden="true" tabindex="-1"></a>To determine whether these methods are applicable, one has to determine whether the learner supports this method in principle **and** whether it is implemented in the upstream package.</span>
<span id="cb70-469"><a href="#cb70-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-470"><a href="#cb70-470" aria-hidden="true" tabindex="-1"></a>For the following operations, extractors are standardized:</span>
<span id="cb70-471"><a href="#cb70-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-472"><a href="#cb70-472" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`importance(...)`</span> - Returns the feature importance score as numeric vector.</span>
<span id="cb70-473"><a href="#cb70-473" aria-hidden="true" tabindex="-1"></a>  The higher the score, the more important the variable.</span>
<span id="cb70-474"><a href="#cb70-474" aria-hidden="true" tabindex="-1"></a>  The returned vector is named with feature names and sorted in decreasing order.</span>
<span id="cb70-475"><a href="#cb70-475" aria-hidden="true" tabindex="-1"></a>  Note that the model might omit features it has not used at all. The learner must be tagged with property <span class="in">`"importance"`</span>.</span>
<span id="cb70-476"><a href="#cb70-476" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`selected_features(...)`</span> - Returns a subset of selected features as character().</span>
<span id="cb70-477"><a href="#cb70-477" aria-hidden="true" tabindex="-1"></a>  The learner must be tagged with property <span class="in">`"selected_features"`</span>.</span>
<span id="cb70-478"><a href="#cb70-478" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`oob_error(...)`</span> - Returns the out-of-bag error of the model as <span class="in">`numeric(1)`</span>.</span>
<span id="cb70-479"><a href="#cb70-479" aria-hidden="true" tabindex="-1"></a>  The learner must be tagged with property <span class="in">`"oob_error"`</span>.</span>
<span id="cb70-480"><a href="#cb70-480" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`loglik(...)`</span> - Extracts the log-likelihood (c.f. <span class="in">`stats::logLik()`</span>).</span>
<span id="cb70-481"><a href="#cb70-481" aria-hidden="true" tabindex="-1"></a>  The learner must be tagged with property <span class="in">`"loglik"`</span>.</span>
<span id="cb70-482"><a href="#cb70-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-483"><a href="#cb70-483" aria-hidden="true" tabindex="-1"></a>In this case, we only have to implement the <span class="in">`importance()`</span> method.</span>
<span id="cb70-484"><a href="#cb70-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-485"><a href="#cb70-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-010, eval = FALSE}</span></span>
<span id="cb70-486"><a href="#cb70-486" aria-hidden="true" tabindex="-1"></a>importance <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb70-487"><a href="#cb70-487" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb70-488"><a href="#cb70-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopf</span>(<span class="st">"No model stored"</span>)</span>
<span id="cb70-489"><a href="#cb70-489" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-490"><a href="#cb70-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-491"><a href="#cb70-491" aria-hidden="true" tabindex="-1"></a>  importance <span class="ot">=</span> <span class="fu">sort</span>(self<span class="sc">$</span>model<span class="sc">$</span>variable.importance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-492"><a href="#cb70-492" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(importance)) {</span>
<span id="cb70-493"><a href="#cb70-493" aria-hidden="true" tabindex="-1"></a>    importance <span class="ot">=</span> mlr3misc<span class="sc">::</span><span class="fu">set_names</span>(<span class="fu">numeric</span>())</span>
<span id="cb70-494"><a href="#cb70-494" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-495"><a href="#cb70-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(importance)</span>
<span id="cb70-496"><a href="#cb70-496" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-497"><a href="#cb70-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-498"><a href="#cb70-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-499"><a href="#cb70-499" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hotstarting  {#hotstarting}</span></span>
<span id="cb70-500"><a href="#cb70-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-501"><a href="#cb70-501" aria-hidden="true" tabindex="-1"></a>Some learners support resuming or continuing from an already fitted model.</span>
<span id="cb70-502"><a href="#cb70-502" aria-hidden="true" tabindex="-1"></a>We assume that hotstarting is only possible if a single hyperparameter (also called the fidelity parameter, usually controlling the complexity or expensiveness) is altered and all other hyperparameters are identical.</span>
<span id="cb70-503"><a href="#cb70-503" aria-hidden="true" tabindex="-1"></a>The fidelity parameters should be tagged with <span class="in">`"hotstart"`</span>.</span>
<span id="cb70-504"><a href="#cb70-504" aria-hidden="true" tabindex="-1"></a>Examples are:</span>
<span id="cb70-505"><a href="#cb70-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-506"><a href="#cb70-506" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Random Forest: Starting from a model with n trees, a random forest with n + k trees can be obtained by adding k trees (<span class="in">`"hotstart_forward"`</span>) and a random forest with n - k trees can be obtained by removing k trees (<span class="in">`"hotstart_backward"`</span>).</span>
<span id="cb70-507"><a href="#cb70-507" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Gradient Boosting: When having fitted a model with n iterations, we only need k iterations to obtain a model with n + k iterations. (<span class="in">`"hotstart_forward"`</span>).</span>
<span id="cb70-508"><a href="#cb70-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-509"><a href="#cb70-509" aria-hidden="true" tabindex="-1"></a>For more information see <span class="in">`r ref("HotstartStack")`</span>.</span>
<span id="cb70-510"><a href="#cb70-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-511"><a href="#cb70-511" aria-hidden="true" tabindex="-1"></a><span class="fu">### Control objects/functions of learners {#learner-control}</span></span>
<span id="cb70-512"><a href="#cb70-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-513"><a href="#cb70-513" aria-hidden="true" tabindex="-1"></a>Some learners rely on a "control" object/function such as <span class="in">`glmnet::glmnet.control()`</span>.</span>
<span id="cb70-514"><a href="#cb70-514" aria-hidden="true" tabindex="-1"></a>Accounting for such depends on how the underlying package works:</span>
<span id="cb70-515"><a href="#cb70-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-516"><a href="#cb70-516" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the package forwards the control parameters via <span class="in">`...`</span> and makes it possible to just pass control parameters as additional parameters directly to the train call, there is no need to distinguish both <span class="in">`"train"`</span> and <span class="in">`"control"`</span> parameters.</span>
<span id="cb70-517"><a href="#cb70-517" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the control parameters need to be passed via a separate argument, one can e.g. use</span>
<span id="cb70-518"><a href="#cb70-518" aria-hidden="true" tabindex="-1"></a>  <span class="in">`formalArgs(glmnet::glmnet.control)`</span> to get the names of the control parameters and then extract them from the <span class="in">`pars`</span> like shown below.</span>
<span id="cb70-519"><a href="#cb70-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-520"><a href="#cb70-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-011, eval = FALSE}</span></span>
<span id="cb70-521"><a href="#cb70-521" aria-hidden="true" tabindex="-1"></a>pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb70-522"><a href="#cb70-522" aria-hidden="true" tabindex="-1"></a>ii <span class="ot">=</span> <span class="fu">names</span>(pars) <span class="sc">%in%</span> <span class="fu">formalArgs</span>(glmnet<span class="sc">::</span>glmnet.control)</span>
<span id="cb70-523"><a href="#cb70-523" aria-hidden="true" tabindex="-1"></a>pars_ctrl <span class="ot">=</span> pars[ii]</span>
<span id="cb70-524"><a href="#cb70-524" aria-hidden="true" tabindex="-1"></a>pars_train <span class="ot">=</span> pars[<span class="sc">!</span>ii]</span>
<span id="cb70-525"><a href="#cb70-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-526"><a href="#cb70-526" aria-hidden="true" tabindex="-1"></a><span class="fu">invoke</span>([...], <span class="at">.args =</span> pars_train, <span class="at">control =</span> pars_ctrl)</span>
<span id="cb70-527"><a href="#cb70-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-528"><a href="#cb70-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-529"><a href="#cb70-529" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding the description</span></span>
<span id="cb70-530"><a href="#cb70-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-531"><a href="#cb70-531" aria-hidden="true" tabindex="-1"></a>Once the learner is implemented - and is not only intended for personal use - it's description should be filled out.</span>
<span id="cb70-532"><a href="#cb70-532" aria-hidden="true" tabindex="-1"></a>Most steps should be clear from the instructions given in the template.</span>
<span id="cb70-533"><a href="#cb70-533" aria-hidden="true" tabindex="-1"></a>For the section '\@references', the entry first has to be added to the file <span class="in">`bibentries.R`</span>, essentially by converting the bibtex file to a R <span class="in">`bibentry`</span> function call.</span>
<span id="cb70-534"><a href="#cb70-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-535"><a href="#cb70-535" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing the learner {#learner-test}</span></span>
<span id="cb70-536"><a href="#cb70-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-537"><a href="#cb70-537" aria-hidden="true" tabindex="-1"></a>Once your learner is created, you are ready to start testing if it works, there are three types of tests: <span class="co">[</span><span class="ot">manual</span><span class="co">](#learner-test-manual)</span>, <span class="co">[</span><span class="ot">unit</span><span class="co">](#learner-test-unit)</span> and <span class="co">[</span><span class="ot">parameter</span><span class="co">](#learner-test-parameter)</span>.</span>
<span id="cb70-538"><a href="#cb70-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-539"><a href="#cb70-539" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Train and Predict {#learner-test-manual}</span></span>
<span id="cb70-540"><a href="#cb70-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-541"><a href="#cb70-541" aria-hidden="true" tabindex="-1"></a>For a bare-bone check you can just try to run a simple <span class="in">`train()`</span> call locally.</span>
<span id="cb70-542"><a href="#cb70-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-543"><a href="#cb70-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-012, eval = FALSE}</span></span>
<span id="cb70-544"><a href="#cb70-544" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>) <span class="co"># assuming a Classif learner</span></span>
<span id="cb70-545"><a href="#cb70-545" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb70-546"><a href="#cb70-546" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb70-547"><a href="#cb70-547" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> lrn<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb70-548"><a href="#cb70-548" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>confusion</span>
<span id="cb70-549"><a href="#cb70-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-550"><a href="#cb70-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-551"><a href="#cb70-551" aria-hidden="true" tabindex="-1"></a>If it runs without erroring, that's a very good start!</span>
<span id="cb70-552"><a href="#cb70-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-553"><a href="#cb70-553" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Autotest {#learner-test-unit}</span></span>
<span id="cb70-554"><a href="#cb70-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-555"><a href="#cb70-555" aria-hidden="true" tabindex="-1"></a>To ensure that your learner is able to handle all kinds of different properties and feature types, we have written an "autotest" that checks the learner for different combinations of such.</span>
<span id="cb70-556"><a href="#cb70-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-557"><a href="#cb70-557" aria-hidden="true" tabindex="-1"></a>The "autotest" setup is generated automatically by <span class="in">`r ref("create_learner()")`</span>.</span>
<span id="cb70-558"><a href="#cb70-558" aria-hidden="true" tabindex="-1"></a>It will have a name with the form <span class="in">`test_package_type_key.R`</span>, in our case this will actually be <span class="in">`test_rpart_classif_rpart.R`</span>.</span>
<span id="cb70-559"><a href="#cb70-559" aria-hidden="true" tabindex="-1"></a>This will create the following script, for which no changes are required to pass (assuming the learner was correctly created):</span>
<span id="cb70-560"><a href="#cb70-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-561"><a href="#cb70-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-013, eval = FALSE}</span></span>
<span id="cb70-562"><a href="#cb70-562" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"autotest"</span>, {</span>
<span id="cb70-563"><a href="#cb70-563" aria-hidden="true" tabindex="-1"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb70-564"><a href="#cb70-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_learner</span>(learner)</span>
<span id="cb70-565"><a href="#cb70-565" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note that you can skip tests using the exclude argument</span></span>
<span id="cb70-566"><a href="#cb70-566" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">run_autotest</span>(learner)</span>
<span id="cb70-567"><a href="#cb70-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(result, <span class="at">info =</span> result<span class="sc">$</span>error)</span>
<span id="cb70-568"><a href="#cb70-568" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-569"><a href="#cb70-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-570"><a href="#cb70-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-571"><a href="#cb70-571" aria-hidden="true" tabindex="-1"></a>For some learners that have required parameters, it is needed to set some values for required parameters after construction so that the learner can be run in the first place.</span>
<span id="cb70-572"><a href="#cb70-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-573"><a href="#cb70-573" aria-hidden="true" tabindex="-1"></a>You can also exclude some specific test arrangements within the "autotest" via the argument <span class="in">`exclude`</span> in the <span class="in">`run_autotest()`</span> function.</span>
<span id="cb70-574"><a href="#cb70-574" aria-hidden="true" tabindex="-1"></a>Currently the <span class="in">`run_autotest()`</span> function lives in <span class="co">[</span><span class="ot">inst/testthat</span><span class="co">](https://github.com/mlr-org/mlr3/blob/f16326bf34bcac59c3b0a2fdbcf90dbebb3b4bbc/inst/testthat/helper_autotest.R)</span> of the <span class="in">`r mlr3`</span> and still lacks documentation.</span>
<span id="cb70-575"><a href="#cb70-575" aria-hidden="true" tabindex="-1"></a>This should change in the near future.</span>
<span id="cb70-576"><a href="#cb70-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-577"><a href="#cb70-577" aria-hidden="true" tabindex="-1"></a>To finally run the test suite, call <span class="in">`devtools::test()`</span> or hit <span class="in">`CTRL + Shift + T`</span> if you are using RStudio.</span>
<span id="cb70-578"><a href="#cb70-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-579"><a href="#cb70-579" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Checking Parameters {#learner-test-parameter}</span></span>
<span id="cb70-580"><a href="#cb70-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-581"><a href="#cb70-581" aria-hidden="true" tabindex="-1"></a>Some learners have a high number of parameters and it is easy to miss out on some during the creation of a new learner.</span>
<span id="cb70-582"><a href="#cb70-582" aria-hidden="true" tabindex="-1"></a>In addition, if the maintainer of the upstream package changes something with respect to the arguments of the algorithm, the learner is in danger to break.</span>
<span id="cb70-583"><a href="#cb70-583" aria-hidden="true" tabindex="-1"></a>Also, new arguments could be added upstream and manually checking for new additions all the time is tedious.</span>
<span id="cb70-584"><a href="#cb70-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-585"><a href="#cb70-585" aria-hidden="true" tabindex="-1"></a>Therefore we have written a "Parameter Check" that runs regularly for every learner.</span>
<span id="cb70-586"><a href="#cb70-586" aria-hidden="true" tabindex="-1"></a>This "Parameter Check" compares the parameters of the <span class="in">`r mlr3`</span> ParamSet against all arguments available in the upstream function that is called during <span class="in">`$train()`</span> and <span class="in">`$predict()`</span>.</span>
<span id="cb70-587"><a href="#cb70-587" aria-hidden="true" tabindex="-1"></a>Again the file is automatically created by <span class="in">`r ref("create_learner()")`</span>.</span>
<span id="cb70-588"><a href="#cb70-588" aria-hidden="true" tabindex="-1"></a>This will be named like <span class="in">`test_paramtest_package_type_key.R`</span>, so in our example <span class="in">`test_paramtest_rpart_classif_rpart.R`</span>.</span>
<span id="cb70-589"><a href="#cb70-589" aria-hidden="true" tabindex="-1"></a>When the <span class="in">`.train`</span> function calls multiple functions (e.g. a control function as described above), a list of functions can be passed to the parameter test.</span>
<span id="cb70-590"><a href="#cb70-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-591"><a href="#cb70-591" aria-hidden="true" tabindex="-1"></a>The test comes with an <span class="in">`exclude`</span> argument that should be used to _exclude and explain_ why certain arguments of the upstream function are not within the ParamSet of the mlr3learner.</span>
<span id="cb70-592"><a href="#cb70-592" aria-hidden="true" tabindex="-1"></a>This will likely be required for all learners as common arguments like <span class="in">`x`</span>, <span class="in">`target`</span> or <span class="in">`data`</span> are handled by the <span class="in">`r mlr3`</span> interface and are therefore not included within the ParamSet.</span>
<span id="cb70-593"><a href="#cb70-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-594"><a href="#cb70-594" aria-hidden="true" tabindex="-1"></a>However, there might be more parameters that need to be excluded, for example:</span>
<span id="cb70-595"><a href="#cb70-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-596"><a href="#cb70-596" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Type dependent parameters, i.e. parameters that only apply for classification or regression learners.</span>
<span id="cb70-597"><a href="#cb70-597" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Parameters that are actually deprecated by the upstream package and which were therefore not included in the <span class="in">`r mlr3`</span> ParamSet.</span>
<span id="cb70-598"><a href="#cb70-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-599"><a href="#cb70-599" aria-hidden="true" tabindex="-1"></a>All excluded parameters should have a comment justifying their exclusion.</span>
<span id="cb70-600"><a href="#cb70-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-601"><a href="#cb70-601" aria-hidden="true" tabindex="-1"></a>In our example, the final paramtest script looks like:</span>
<span id="cb70-602"><a href="#cb70-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-603"><a href="#cb70-603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-014, eval = FALSE}</span></span>
<span id="cb70-604"><a href="#cb70-604" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"classif.rpart train"</span>, {</span>
<span id="cb70-605"><a href="#cb70-605" aria-hidden="true" tabindex="-1"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb70-606"><a href="#cb70-606" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this can also be a list of functions</span></span>
<span id="cb70-607"><a href="#cb70-607" aria-hidden="true" tabindex="-1"></a>  fun <span class="ot">=</span> rpart<span class="sc">::</span>rpart</span>
<span id="cb70-608"><a href="#cb70-608" aria-hidden="true" tabindex="-1"></a>  exclude <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb70-609"><a href="#cb70-609" aria-hidden="true" tabindex="-1"></a>    <span class="st">"formula"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-610"><a href="#cb70-610" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-611"><a href="#cb70-611" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-612"><a href="#cb70-612" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weights"</span>, <span class="co"># handled by task</span></span>
<span id="cb70-613"><a href="#cb70-613" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subset"</span>, <span class="co"># handled by task</span></span>
<span id="cb70-614"><a href="#cb70-614" aria-hidden="true" tabindex="-1"></a>    <span class="st">"na.action"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-615"><a href="#cb70-615" aria-hidden="true" tabindex="-1"></a>    <span class="st">"method"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-616"><a href="#cb70-616" aria-hidden="true" tabindex="-1"></a>    <span class="st">"x"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-617"><a href="#cb70-617" aria-hidden="true" tabindex="-1"></a>    <span class="st">"y"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-618"><a href="#cb70-618" aria-hidden="true" tabindex="-1"></a>    <span class="st">"parms"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-619"><a href="#cb70-619" aria-hidden="true" tabindex="-1"></a>    <span class="st">"control"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-620"><a href="#cb70-620" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cost"</span> <span class="co"># handled internally</span></span>
<span id="cb70-621"><a href="#cb70-621" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-622"><a href="#cb70-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-623"><a href="#cb70-623" aria-hidden="true" tabindex="-1"></a>  paramtest <span class="ot">=</span> <span class="fu">run_paramtest</span>(learner, fun, exclude, <span class="at">tag =</span> <span class="st">"train"</span>)</span>
<span id="cb70-624"><a href="#cb70-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_paramtest</span>(paramtest)</span>
<span id="cb70-625"><a href="#cb70-625" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-626"><a href="#cb70-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-627"><a href="#cb70-627" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"classif.rpart predict"</span>, {</span>
<span id="cb70-628"><a href="#cb70-628" aria-hidden="true" tabindex="-1"></a>  learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb70-629"><a href="#cb70-629" aria-hidden="true" tabindex="-1"></a>  fun <span class="ot">=</span> rpart<span class="sc">:::</span>predict.rpart</span>
<span id="cb70-630"><a href="#cb70-630" aria-hidden="true" tabindex="-1"></a>  exclude <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb70-631"><a href="#cb70-631" aria-hidden="true" tabindex="-1"></a>    <span class="st">"object"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-632"><a href="#cb70-632" aria-hidden="true" tabindex="-1"></a>    <span class="st">"newdata"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-633"><a href="#cb70-633" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span>, <span class="co"># handled internally</span></span>
<span id="cb70-634"><a href="#cb70-634" aria-hidden="true" tabindex="-1"></a>    <span class="st">"na.action"</span> <span class="co"># handled internally</span></span>
<span id="cb70-635"><a href="#cb70-635" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-636"><a href="#cb70-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-637"><a href="#cb70-637" aria-hidden="true" tabindex="-1"></a>  paramtest <span class="ot">=</span> <span class="fu">run_paramtest</span>(learner, fun, exclude, <span class="at">tag =</span> <span class="st">"predict"</span>)</span>
<span id="cb70-638"><a href="#cb70-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_paramtest</span>(paramtest)</span>
<span id="cb70-639"><a href="#cb70-639" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-640"><a href="#cb70-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-641"><a href="#cb70-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-642"><a href="#cb70-642" aria-hidden="true" tabindex="-1"></a><span class="fu">### Package Cleaning {#cleaning}</span></span>
<span id="cb70-643"><a href="#cb70-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-644"><a href="#cb70-644" aria-hidden="true" tabindex="-1"></a>Once all tests are passing, run the following functions to ensure that the package remains clean and tidy</span>
<span id="cb70-645"><a href="#cb70-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-646"><a href="#cb70-646" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`devtools::document(roclets = c('rd', 'collate', 'namespace'))`</span></span>
<span id="cb70-647"><a href="#cb70-647" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>If you haven't done this before run: <span class="in">`remotes::install_github('mlr-org/styler.mlr')`</span></span>
<span id="cb70-648"><a href="#cb70-648" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`styler::style_pkg(style = styler.mlr::mlr_style)`</span></span>
<span id="cb70-649"><a href="#cb70-649" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`usethis::use_tidy_description()`</span></span>
<span id="cb70-650"><a href="#cb70-650" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`lintr::lint_package()`</span></span>
<span id="cb70-651"><a href="#cb70-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-652"><a href="#cb70-652" aria-hidden="true" tabindex="-1"></a>Please fix any errors indicated by <span class="in">`lintr`</span> before creating a pull request. Finally ensure that all <span class="in">`FIXME`</span> are resolved and deleted in the generated files.</span>
<span id="cb70-653"><a href="#cb70-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-654"><a href="#cb70-654" aria-hidden="true" tabindex="-1"></a>You are now ready to add your learner to the <span class="in">`r mlr3`</span> ecosystem!</span>
<span id="cb70-655"><a href="#cb70-655" aria-hidden="true" tabindex="-1"></a>Simply open a pull request to \url{https://github.com/mlr-org/mlr3extralearners/pulls} with the new learner template and complete the checklist in there.</span>
<span id="cb70-656"><a href="#cb70-656" aria-hidden="true" tabindex="-1"></a>Creating this request will trigger an automated workflow that checks whether various conditions (such as <span class="in">`rcmdcheck::rcmdcheck()`</span>) are satisfied.</span>
<span id="cb70-657"><a href="#cb70-657" aria-hidden="true" tabindex="-1"></a>Once the pull request is approved and merged, your learner will automatically appear on the <span class="co">[</span><span class="ot">package website</span><span class="co">](https://mlr3extralearners.mlr-org.com/)</span>.</span>
<span id="cb70-658"><a href="#cb70-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-659"><a href="#cb70-659" aria-hidden="true" tabindex="-1"></a><span class="fu">### Thanks and Maintenance</span></span>
<span id="cb70-660"><a href="#cb70-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-661"><a href="#cb70-661" aria-hidden="true" tabindex="-1"></a>Thank you for contributing to the <span class="in">`r mlr3`</span> ecosystem!</span>
<span id="cb70-662"><a href="#cb70-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-663"><a href="#cb70-663" aria-hidden="true" tabindex="-1"></a>When you created the learner you would have given your GitHub handle, meaning that you are now listed as the learner author and maintainer. This means that if the learner breaks it is your responsibility to fix the learner - you can view the status of your learner <span class="co">[</span><span class="ot">here</span><span class="co">](https://mlr3extralearners.mlr-org.com/articles/learners/test_overview.html)</span>.</span>
<span id="cb70-664"><a href="#cb70-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-665"><a href="#cb70-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-666"><a href="#cb70-666" aria-hidden="true" tabindex="-1"></a><span class="fu">### Learner FAQ {#learner-faq}</span></span>
<span id="cb70-667"><a href="#cb70-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-668"><a href="#cb70-668" aria-hidden="true" tabindex="-1"></a>**Question 1**</span>
<span id="cb70-669"><a href="#cb70-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-670"><a href="#cb70-670" aria-hidden="true" tabindex="-1"></a>How to deal with Parameters which have no default?</span>
<span id="cb70-671"><a href="#cb70-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-672"><a href="#cb70-672" aria-hidden="true" tabindex="-1"></a>**Answer**</span>
<span id="cb70-673"><a href="#cb70-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-674"><a href="#cb70-674" aria-hidden="true" tabindex="-1"></a>If the learner does not work without providing a value, set a reasonable default in <span class="in">`param_set$values`</span>, add tag <span class="in">`"required"`</span> to the parameter and document your default properly.</span>
<span id="cb70-675"><a href="#cb70-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-676"><a href="#cb70-676" aria-hidden="true" tabindex="-1"></a>**Question 2**</span>
<span id="cb70-677"><a href="#cb70-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-678"><a href="#cb70-678" aria-hidden="true" tabindex="-1"></a>Where to add the package of the upstream package in the DESCRIPTION file?</span>
<span id="cb70-679"><a href="#cb70-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-680"><a href="#cb70-680" aria-hidden="true" tabindex="-1"></a>Add it to the "Suggests" section.</span>
<span id="cb70-681"><a href="#cb70-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-682"><a href="#cb70-682" aria-hidden="true" tabindex="-1"></a>**Question 3**</span>
<span id="cb70-683"><a href="#cb70-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-684"><a href="#cb70-684" aria-hidden="true" tabindex="-1"></a>How to handle arguments from external "control" functions such as <span class="in">`glmnet::glmnet_control()`</span>?</span>
<span id="cb70-685"><a href="#cb70-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-686"><a href="#cb70-686" aria-hidden="true" tabindex="-1"></a>**Answer**</span>
<span id="cb70-687"><a href="#cb70-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-688"><a href="#cb70-688" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">"Control objects/functions of learners"</span><span class="co">](#learner-control)</span>.</span>
<span id="cb70-689"><a href="#cb70-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-690"><a href="#cb70-690" aria-hidden="true" tabindex="-1"></a>**Question 4**</span>
<span id="cb70-691"><a href="#cb70-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-692"><a href="#cb70-692" aria-hidden="true" tabindex="-1"></a>How to document if my learner uses a custom default value that differs to the default of the upstream package?</span>
<span id="cb70-693"><a href="#cb70-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-694"><a href="#cb70-694" aria-hidden="true" tabindex="-1"></a>**Answer**</span>
<span id="cb70-695"><a href="#cb70-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-696"><a href="#cb70-696" aria-hidden="true" tabindex="-1"></a>If you set a custom default for the mlr3learner that does not cope with the one of the upstream package (think twice if this is really needed!), add this information to the help page of the respective learner.</span>
<span id="cb70-697"><a href="#cb70-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-698"><a href="#cb70-698" aria-hidden="true" tabindex="-1"></a>You can use the following skeleton for this:</span>
<span id="cb70-699"><a href="#cb70-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-700"><a href="#cb70-700" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb70-701"><a href="#cb70-701" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Custom mlr3 defaults:</span></span>
<span id="cb70-702"><a href="#cb70-702" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `&lt;parameter&gt;`:</span></span>
<span id="cb70-703"><a href="#cb70-703" aria-hidden="true" tabindex="-1"></a><span class="co">#'   * Actual default: &lt;value&gt;</span></span>
<span id="cb70-704"><a href="#cb70-704" aria-hidden="true" tabindex="-1"></a><span class="co">#'   * Adjusted default: &lt;value&gt;</span></span>
<span id="cb70-705"><a href="#cb70-705" aria-hidden="true" tabindex="-1"></a><span class="co">#'   * Reason for change: &lt;text&gt;</span></span>
<span id="cb70-706"><a href="#cb70-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-707"><a href="#cb70-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-708"><a href="#cb70-708" aria-hidden="true" tabindex="-1"></a>**Question 5**</span>
<span id="cb70-709"><a href="#cb70-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-710"><a href="#cb70-710" aria-hidden="true" tabindex="-1"></a>When should the <span class="in">`"required"`</span> tag be used when defining Params and what is its purpose?</span>
<span id="cb70-711"><a href="#cb70-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-712"><a href="#cb70-712" aria-hidden="true" tabindex="-1"></a>**Answer**</span>
<span id="cb70-713"><a href="#cb70-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-714"><a href="#cb70-714" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"required"`</span> tag should be used when the following conditions are met:</span>
<span id="cb70-715"><a href="#cb70-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-716"><a href="#cb70-716" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The upstream function cannot be run without setting this parameter, i.e. it would throw an error.</span>
<span id="cb70-717"><a href="#cb70-717" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The parameter has no default in the upstream function.</span>
<span id="cb70-718"><a href="#cb70-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-719"><a href="#cb70-719" aria-hidden="true" tabindex="-1"></a>In <span class="in">`r mlr3`</span> we follow the principle that every learner should be constructable without setting custom parameters.</span>
<span id="cb70-720"><a href="#cb70-720" aria-hidden="true" tabindex="-1"></a>Therefore, if a parameter has no default in the upstream function, a custom value is usually set for this parameter in the mlr3learner (remember to document such changes in the help page of the learner).</span>
<span id="cb70-721"><a href="#cb70-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-722"><a href="#cb70-722" aria-hidden="true" tabindex="-1"></a>Even though this practice ensures that no parameter is unset in an mlr3learner and partially removes the usefulness of the <span class="in">`"required"`</span> tag, the tag is still useful in the following scenario:</span>
<span id="cb70-723"><a href="#cb70-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-724"><a href="#cb70-724" aria-hidden="true" tabindex="-1"></a>If a user sets custom parameters after construction of the learner</span>
<span id="cb70-725"><a href="#cb70-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-726"><a href="#cb70-726" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb70-727"><a href="#cb70-727" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"&lt;id&gt;"</span>)</span>
<span id="cb70-728"><a href="#cb70-728" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"&lt;param&gt;"</span> <span class="ot">=</span> <span class="er">&lt;</span>value<span class="sc">&gt;</span>)</span>
<span id="cb70-729"><a href="#cb70-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-730"><a href="#cb70-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-731"><a href="#cb70-731" aria-hidden="true" tabindex="-1"></a>Here, all parameters besides the ones set in the list would be unset.</span>
<span id="cb70-732"><a href="#cb70-732" aria-hidden="true" tabindex="-1"></a>See <span class="in">`paradox::ParamSet`</span> for more information.</span>
<span id="cb70-733"><a href="#cb70-733" aria-hidden="true" tabindex="-1"></a>If a parameter is tagged as <span class="in">`"required"`</span> in the ParamSet, the call above would error and prompt the user that required parameters are missing.</span>
<span id="cb70-734"><a href="#cb70-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-735"><a href="#cb70-735" aria-hidden="true" tabindex="-1"></a>**Question 6**</span>
<span id="cb70-736"><a href="#cb70-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-737"><a href="#cb70-737" aria-hidden="true" tabindex="-1"></a>What is this error when I run <span class="in">`devtools::load_all()`</span></span>
<span id="cb70-738"><a href="#cb70-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-739"><a href="#cb70-739" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb70-740"><a href="#cb70-740" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"."</span>)</span>
<span id="cb70-741"><a href="#cb70-741" aria-hidden="true" tabindex="-1"></a>Loading mlr3extralearners</span>
<span id="cb70-742"><a href="#cb70-742" aria-hidden="true" tabindex="-1"></a>Warning message<span class="sc">:</span></span>
<span id="cb70-743"><a href="#cb70-743" aria-hidden="true" tabindex="-1"></a>.onUnload failed <span class="cf">in</span> <span class="fu">unloadNamespace</span>() <span class="cf">for</span> <span class="st">'mlr3extralearners'</span>, details<span class="sc">:</span></span>
<span id="cb70-744"><a href="#cb70-744" aria-hidden="true" tabindex="-1"></a>  call<span class="sc">:</span> <span class="fu">vapply</span>(hooks, <span class="cf">function</span>(x) <span class="fu">environment</span>(x)<span class="sc">$</span>pkgname, <span class="cn">NA_character_</span>)</span>
<span id="cb70-745"><a href="#cb70-745" aria-hidden="true" tabindex="-1"></a>  error<span class="sc">:</span> values must be length <span class="dv">1</span>,</span>
<span id="cb70-746"><a href="#cb70-746" aria-hidden="true" tabindex="-1"></a> but <span class="fu">FUN</span>(X[[<span class="dv">1</span>]]) result is length <span class="dv">0</span></span>
<span id="cb70-747"><a href="#cb70-747" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-748"><a href="#cb70-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-749"><a href="#cb70-749" aria-hidden="true" tabindex="-1"></a>**Answer**</span>
<span id="cb70-750"><a href="#cb70-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-751"><a href="#cb70-751" aria-hidden="true" tabindex="-1"></a>This is not an error but a warning and you can safely ignore it!</span>
<span id="cb70-752"><a href="#cb70-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-753"><a href="#cb70-753" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding new Measures {#extending-measures}</span></span>
<span id="cb70-754"><a href="#cb70-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-755"><a href="#cb70-755" aria-hidden="true" tabindex="-1"></a>In this section we showcase how to implement a custom performance measure.</span>
<span id="cb70-756"><a href="#cb70-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-757"><a href="#cb70-757" aria-hidden="true" tabindex="-1"></a>A good starting point is writing down the loss function independently of <span class="in">`r mlr3`</span> (we also did this in the <span class="in">`r ref_pkg("mlr3measures")`</span> package).</span>
<span id="cb70-758"><a href="#cb70-758" aria-hidden="true" tabindex="-1"></a>Here, we illustrate writing measure by implementing the root of the mean squared error for regression problems:</span>
<span id="cb70-759"><a href="#cb70-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-760"><a href="#cb70-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-015}</span></span>
<span id="cb70-761"><a href="#cb70-761" aria-hidden="true" tabindex="-1"></a>root_mse <span class="ot">=</span> <span class="cf">function</span>(truth, response) {</span>
<span id="cb70-762"><a href="#cb70-762" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">=</span> <span class="fu">mean</span>((truth <span class="sc">-</span> response)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb70-763"><a href="#cb70-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(mse)</span>
<span id="cb70-764"><a href="#cb70-764" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-765"><a href="#cb70-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-766"><a href="#cb70-766" aria-hidden="true" tabindex="-1"></a><span class="fu">root_mse</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb70-767"><a href="#cb70-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-768"><a href="#cb70-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-769"><a href="#cb70-769" aria-hidden="true" tabindex="-1"></a>In the next step, we embed the <span class="in">`root_mse()`</span> function into a new <span class="in">`r ref_pkg("R6")`</span> class inheriting from base classes <span class="in">`r ref("MeasureRegr")`</span>/<span class="in">`r ref("Measure")`</span>.</span>
<span id="cb70-770"><a href="#cb70-770" aria-hidden="true" tabindex="-1"></a>For classification measures, use <span class="in">`r ref("MeasureClassif")`</span>.</span>
<span id="cb70-771"><a href="#cb70-771" aria-hidden="true" tabindex="-1"></a>We keep it simple here and only explain the most important parts of the <span class="in">`r ref("Measure")`</span> class:</span>
<span id="cb70-772"><a href="#cb70-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-773"><a href="#cb70-773" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-016}</span></span>
<span id="cb70-774"><a href="#cb70-774" aria-hidden="true" tabindex="-1"></a>MeasureRootMSE <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"MeasureRootMSE"</span>,</span>
<span id="cb70-775"><a href="#cb70-775" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3<span class="sc">::</span>MeasureRegr,</span>
<span id="cb70-776"><a href="#cb70-776" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-777"><a href="#cb70-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb70-778"><a href="#cb70-778" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb70-779"><a href="#cb70-779" aria-hidden="true" tabindex="-1"></a>        <span class="co"># custom id for the measure</span></span>
<span id="cb70-780"><a href="#cb70-780" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"root_mse"</span>,</span>
<span id="cb70-781"><a href="#cb70-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-782"><a href="#cb70-782" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional packages required to calculate this measure</span></span>
<span id="cb70-783"><a href="#cb70-783" aria-hidden="true" tabindex="-1"></a>        <span class="at">packages =</span> <span class="fu">character</span>(),</span>
<span id="cb70-784"><a href="#cb70-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-785"><a href="#cb70-785" aria-hidden="true" tabindex="-1"></a>        <span class="co"># properties, see below</span></span>
<span id="cb70-786"><a href="#cb70-786" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="fu">character</span>(),</span>
<span id="cb70-787"><a href="#cb70-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-788"><a href="#cb70-788" aria-hidden="true" tabindex="-1"></a>        <span class="co"># required predict type of the learner</span></span>
<span id="cb70-789"><a href="#cb70-789" aria-hidden="true" tabindex="-1"></a>        <span class="at">predict_type =</span> <span class="st">"response"</span>,</span>
<span id="cb70-790"><a href="#cb70-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-791"><a href="#cb70-791" aria-hidden="true" tabindex="-1"></a>        <span class="co"># feasible range of values</span></span>
<span id="cb70-792"><a href="#cb70-792" aria-hidden="true" tabindex="-1"></a>        <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb70-793"><a href="#cb70-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-794"><a href="#cb70-794" aria-hidden="true" tabindex="-1"></a>        <span class="co"># minimize during tuning?</span></span>
<span id="cb70-795"><a href="#cb70-795" aria-hidden="true" tabindex="-1"></a>        <span class="at">minimize =</span> <span class="cn">TRUE</span></span>
<span id="cb70-796"><a href="#cb70-796" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-797"><a href="#cb70-797" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-798"><a href="#cb70-798" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-799"><a href="#cb70-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-800"><a href="#cb70-800" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-801"><a href="#cb70-801" aria-hidden="true" tabindex="-1"></a>    <span class="co"># custom scoring function operating on the prediction object</span></span>
<span id="cb70-802"><a href="#cb70-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">.score =</span> <span class="cf">function</span>(prediction, ...) {</span>
<span id="cb70-803"><a href="#cb70-803" aria-hidden="true" tabindex="-1"></a>      root_mse <span class="ot">=</span> <span class="cf">function</span>(truth, response) {</span>
<span id="cb70-804"><a href="#cb70-804" aria-hidden="true" tabindex="-1"></a>        mse <span class="ot">=</span> <span class="fu">mean</span>((truth <span class="sc">-</span> response)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb70-805"><a href="#cb70-805" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sqrt</span>(mse)</span>
<span id="cb70-806"><a href="#cb70-806" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-807"><a href="#cb70-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-808"><a href="#cb70-808" aria-hidden="true" tabindex="-1"></a>      <span class="fu">root_mse</span>(prediction<span class="sc">$</span>truth, prediction<span class="sc">$</span>response)</span>
<span id="cb70-809"><a href="#cb70-809" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-810"><a href="#cb70-810" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-811"><a href="#cb70-811" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-812"><a href="#cb70-812" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-813"><a href="#cb70-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-814"><a href="#cb70-814" aria-hidden="true" tabindex="-1"></a>This class can be used as template for most performance measures.</span>
<span id="cb70-815"><a href="#cb70-815" aria-hidden="true" tabindex="-1"></a>If something is missing, you might want to consider having a deeper dive into the following arguments:</span>
<span id="cb70-816"><a href="#cb70-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-817"><a href="#cb70-817" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`properties`</span>: If you tag you measure with the property <span class="in">`"requires_task"`</span>, the <span class="in">`r ref("Task")`</span> is automatically passed to your <span class="in">`.score()`</span> function (don't forget to add the argument <span class="in">`r ref("Task")`</span> in the signature).</span>
<span id="cb70-818"><a href="#cb70-818" aria-hidden="true" tabindex="-1"></a>  The same is possible with <span class="in">`"requires_learner"`</span> if you need to operate on the <span class="in">`r ref("Learner")`</span> and <span class="in">`"requires_train_set"`</span> if you want to access the set of training indices in the score function.</span>
<span id="cb70-819"><a href="#cb70-819" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`aggregator`</span>: This function (defaulting to <span class="in">`mean()`</span>) controls how multiple performance scores, i.e. from different resampling iterations, are aggregated into a single numeric value if <span class="in">`average`</span> is set to micro averaging.</span>
<span id="cb70-820"><a href="#cb70-820" aria-hidden="true" tabindex="-1"></a>  This is ignored for macro averaging.</span>
<span id="cb70-821"><a href="#cb70-821" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`predict_sets`</span>: Prediction sets (subset of <span class="in">`("train", "test")`</span>) to operate on.</span>
<span id="cb70-822"><a href="#cb70-822" aria-hidden="true" tabindex="-1"></a>  Defaults to the "test" set.</span>
<span id="cb70-823"><a href="#cb70-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-824"><a href="#cb70-824" aria-hidden="true" tabindex="-1"></a>Finally, if you want to use your custom measure just like any other measure shipped with <span class="in">`r mlr3`</span> and access it via the <span class="in">`r ref("mlr_measures")`</span> dictionary, you can easily add it:</span>
<span id="cb70-825"><a href="#cb70-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-826"><a href="#cb70-826" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-017}</span></span>
<span id="cb70-827"><a href="#cb70-827" aria-hidden="true" tabindex="-1"></a>mlr3<span class="sc">::</span>mlr_measures<span class="sc">$</span><span class="fu">add</span>(<span class="st">"root_mse"</span>, MeasureRootMSE)</span>
<span id="cb70-828"><a href="#cb70-828" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-829"><a href="#cb70-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-830"><a href="#cb70-830" aria-hidden="true" tabindex="-1"></a>Typically it is a good idea to put the measure together with the call to <span class="in">`mlr_measures$add()`</span> in a new R file and just source it in your project.</span>
<span id="cb70-831"><a href="#cb70-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-018, eval = -1}</span></span>
<span id="cb70-832"><a href="#cb70-832" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"measure_root_mse.R"</span>)</span>
<span id="cb70-833"><a href="#cb70-833" aria-hidden="true" tabindex="-1"></a><span class="fu">msr</span>(<span class="st">"root_mse"</span>)</span>
<span id="cb70-834"><a href="#cb70-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-835"><a href="#cb70-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-836"><a href="#cb70-836" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-019, include = FALSE}</span></span>
<span id="cb70-837"><a href="#cb70-837" aria-hidden="true" tabindex="-1"></a>mlr_measures<span class="sc">$</span><span class="fu">remove</span>(<span class="st">"root_mse"</span>)</span>
<span id="cb70-838"><a href="#cb70-838" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-839"><a href="#cb70-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-840"><a href="#cb70-840" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding new PipeOps {#extending-pipeops}</span></span>
<span id="cb70-841"><a href="#cb70-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-842"><a href="#cb70-842" aria-hidden="true" tabindex="-1"></a>This section showcases how the <span class="in">`r mlr3pipelines`</span> package can be extended to include custom <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb70-843"><a href="#cb70-843" aria-hidden="true" tabindex="-1"></a>To run the following examples, we will need a <span class="in">`r ref("Task")`</span>; we are using the well-known "Iris" task:</span>
<span id="cb70-844"><a href="#cb70-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-845"><a href="#cb70-845" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-020}</span></span>
<span id="cb70-846"><a href="#cb70-846" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb70-847"><a href="#cb70-847" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb70-848"><a href="#cb70-848" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-849"><a href="#cb70-849" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-850"><a href="#cb70-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-851"><a href="#cb70-851" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> is fundamentally built around <span class="co">[</span><span class="ot">`R6`</span><span class="co">](https://r6.r-lib.org/)</span>.</span>
<span id="cb70-852"><a href="#cb70-852" aria-hidden="true" tabindex="-1"></a>When planning to create custom <span class="in">`r ref("PipeOp")`</span> objects, it can only help to <span class="co">[</span><span class="ot">familiarize yourself with it</span><span class="co">](https://adv-r.hadley.nz/r6.html)</span>.</span>
<span id="cb70-853"><a href="#cb70-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-854"><a href="#cb70-854" aria-hidden="true" tabindex="-1"></a>In principle, all a <span class="in">`r ref("PipeOp")`</span> must do is inherit from the <span class="in">`r ref("PipeOp")`</span> R6 class and implement the <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> functions.</span>
<span id="cb70-855"><a href="#cb70-855" aria-hidden="true" tabindex="-1"></a>There are, however, several auxiliary subclasses that can make the creation of *certain* operations much easier.</span>
<span id="cb70-856"><a href="#cb70-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-857"><a href="#cb70-857" aria-hidden="true" tabindex="-1"></a><span class="fu">### General Case Example: `PipeOpCopy` {#ext-pipeopcopy}</span></span>
<span id="cb70-858"><a href="#cb70-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-859"><a href="#cb70-859" aria-hidden="true" tabindex="-1"></a>A very simple yet useful <span class="in">`r ref("PipeOp")`</span> is <span class="in">`PipeOpCopy`</span>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data.</span>
<span id="cb70-860"><a href="#cb70-860" aria-hidden="true" tabindex="-1"></a>It is a simple example that showcases the important steps in defining a custom <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb70-861"><a href="#cb70-861" aria-hidden="true" tabindex="-1"></a>We will show a simplified version here, **`PipeOpCopyTwo`**, that creates exactly two copies of its input data.</span>
<span id="cb70-862"><a href="#cb70-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-863"><a href="#cb70-863" aria-hidden="true" tabindex="-1"></a>The following figure visualizes how our <span class="in">`r ref("PipeOp")`</span> is situated in the <span class="in">`Pipeline`</span> and the significant in- and outputs.</span>
<span id="cb70-864"><a href="#cb70-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-865"><a href="#cb70-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-021, echo=FALSE}</span></span>
<span id="cb70-866"><a href="#cb70-866" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_multi_viz.png"</span>)</span>
<span id="cb70-867"><a href="#cb70-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-868"><a href="#cb70-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-869"><a href="#cb70-869" aria-hidden="true" tabindex="-1"></a><span class="fu">#### First Steps: Inheriting from `r ref("PipeOp")`</span></span>
<span id="cb70-870"><a href="#cb70-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-871"><a href="#cb70-871" aria-hidden="true" tabindex="-1"></a>The first part of creating a custom <span class="in">`r ref("PipeOp")`</span> is inheriting from <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb70-872"><a href="#cb70-872" aria-hidden="true" tabindex="-1"></a>We make a mental note that we need to implement a <span class="in">`.train()`</span> and a <span class="in">`.predict()`</span> function, and that we probably want to have an <span class="in">`initialize()`</span> as well:</span>
<span id="cb70-873"><a href="#cb70-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-874"><a href="#cb70-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-022, eval = FALSE, tidy = FALSE}</span></span>
<span id="cb70-875"><a href="#cb70-875" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb70-876"><a href="#cb70-876" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb70-877"><a href="#cb70-877" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-878"><a href="#cb70-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb70-879"><a href="#cb70-879" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb70-880"><a href="#cb70-880" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-881"><a href="#cb70-881" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-882"><a href="#cb70-882" aria-hidden="true" tabindex="-1"></a>  private <span class="sc">==</span> <span class="fu">list</span>(</span>
<span id="cb70-883"><a href="#cb70-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-884"><a href="#cb70-884" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb70-885"><a href="#cb70-885" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-886"><a href="#cb70-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-887"><a href="#cb70-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-888"><a href="#cb70-888" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb70-889"><a href="#cb70-889" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-890"><a href="#cb70-890" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-891"><a href="#cb70-891" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-892"><a href="#cb70-892" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-893"><a href="#cb70-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-894"><a href="#cb70-894" aria-hidden="true" tabindex="-1"></a>Note, that **private** methods, e.g. <span class="in">`.train`</span> and <span class="in">`.predict`</span> etc are prefixed with a <span class="in">`.`</span>.</span>
<span id="cb70-895"><a href="#cb70-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-896"><a href="#cb70-896" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Channel Definitions</span></span>
<span id="cb70-897"><a href="#cb70-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-898"><a href="#cb70-898" aria-hidden="true" tabindex="-1"></a>We need to tell the <span class="in">`r ref("PipeOp")`</span> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable.</span>
<span id="cb70-899"><a href="#cb70-899" aria-hidden="true" tabindex="-1"></a>This is done on initialization of the <span class="in">`r ref("PipeOp")`</span> (using a <span class="in">`super$initialize`</span> call) by giving the <span class="in">`input`</span> and <span class="in">`output`</span> <span class="in">`data.table`</span> objects.</span>
<span id="cb70-900"><a href="#cb70-900" aria-hidden="true" tabindex="-1"></a>These must have three columns: a <span class="in">`"name"`</span> column giving the names of input and output channels, and a <span class="in">`"train"`</span> and <span class="in">`"predict"`</span> column naming the class of objects we expect during training and prediction as input / output.</span>
<span id="cb70-901"><a href="#cb70-901" aria-hidden="true" tabindex="-1"></a>A special value for these classes is <span class="in">`"*"`</span>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</span>
<span id="cb70-902"><a href="#cb70-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-903"><a href="#cb70-903" aria-hidden="true" tabindex="-1"></a>By convention, we name a single channel <span class="in">`"input"`</span> or <span class="in">`"output"`</span>, and a group of channels <span class="co">[</span><span class="ot">`"input1"`, `"input2"`, ...</span><span class="co">]</span>, unless there is a reason to give specific different names. Therefore, our <span class="in">`input`</span> <span class="in">`data.table`</span> will have a single row <span class="in">`&lt;"input", "*", "*"&gt;`</span>, and our <span class="in">`output`</span> table will have two rows, <span class="in">`&lt;"output1", "*", "*"&gt;`</span> and <span class="in">`&lt;"output2", "*", "*"&gt;`</span>.</span>
<span id="cb70-904"><a href="#cb70-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-905"><a href="#cb70-905" aria-hidden="true" tabindex="-1"></a>All of this is given to the <span class="in">`r ref("PipeOp")`</span> creator. Our <span class="in">`initialize()`</span> will thus look as follows:</span>
<span id="cb70-906"><a href="#cb70-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-907"><a href="#cb70-907" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-023, eval = FALSE}</span></span>
<span id="cb70-908"><a href="#cb70-908" aria-hidden="true" tabindex="-1"></a>initialize <span class="ot">=</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb70-909"><a href="#cb70-909" aria-hidden="true" tabindex="-1"></a>  input <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb70-910"><a href="#cb70-910" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span id="cb70-911"><a href="#cb70-911" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and `predict` cols with "*"</span></span>
<span id="cb70-912"><a href="#cb70-912" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb70-913"><a href="#cb70-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb70-914"><a href="#cb70-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span></span>
<span id="cb70-915"><a href="#cb70-915" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-916"><a href="#cb70-916" aria-hidden="true" tabindex="-1"></a>  super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb70-917"><a href="#cb70-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">input =</span> input,</span>
<span id="cb70-918"><a href="#cb70-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> output</span>
<span id="cb70-919"><a href="#cb70-919" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-920"><a href="#cb70-920" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-921"><a href="#cb70-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-922"><a href="#cb70-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-923"><a href="#cb70-923" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Train and Predict</span></span>
<span id="cb70-924"><a href="#cb70-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-925"><a href="#cb70-925" aria-hidden="true" tabindex="-1"></a>Both <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> will receive a <span class="in">`list`</span> as input and must give a <span class="in">`list`</span> in return.</span>
<span id="cb70-926"><a href="#cb70-926" aria-hidden="true" tabindex="-1"></a>According to our <span class="in">`input`</span> and <span class="in">`output`</span> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <span class="in">`c(inputs, inputs)`</span>.</span>
<span id="cb70-927"><a href="#cb70-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-928"><a href="#cb70-928" aria-hidden="true" tabindex="-1"></a>Two things to consider:</span>
<span id="cb70-929"><a href="#cb70-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-930"><a href="#cb70-930" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The <span class="in">`.train()`</span> function must always modify the <span class="in">`self$state`</span> variable to something that is not <span class="in">`NULL`</span> or <span class="in">`NO_OP`</span>.</span>
<span id="cb70-931"><a href="#cb70-931" aria-hidden="true" tabindex="-1"></a>  This is because the <span class="in">`$state`</span> slot is used as a signal that <span class="in">`r ref("PipeOp")`</span>  has been trained on data, even if the state itself is not important to the <span class="in">`r ref("PipeOp")`</span> (as in our case).</span>
<span id="cb70-932"><a href="#cb70-932" aria-hidden="true" tabindex="-1"></a>  Therefore, our <span class="in">`.train()`</span> will set <span class="in">`self$state = list()`</span>.</span>
<span id="cb70-933"><a href="#cb70-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-934"><a href="#cb70-934" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is not necessary to "clone" our input or make deep copies, because we don't modify the data.</span>
<span id="cb70-935"><a href="#cb70-935" aria-hidden="true" tabindex="-1"></a>  However, if we were changing a reference-passed object, for example by changing data in a <span class="in">`r ref("Task")`</span>, we would have to make a deep copy first.</span>
<span id="cb70-936"><a href="#cb70-936" aria-hidden="true" tabindex="-1"></a>  This is because a <span class="in">`r ref("PipeOp")`</span> may never modify its input object by reference.</span>
<span id="cb70-937"><a href="#cb70-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-938"><a href="#cb70-938" aria-hidden="true" tabindex="-1"></a>Our <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> functions are now:</span>
<span id="cb70-939"><a href="#cb70-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-940"><a href="#cb70-940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-024, eval = FALSE}</span></span>
<span id="cb70-941"><a href="#cb70-941" aria-hidden="true" tabindex="-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-942"><a href="#cb70-942" aria-hidden="true" tabindex="-1"></a>  self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb70-943"><a href="#cb70-943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb70-944"><a href="#cb70-944" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-945"><a href="#cb70-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-946"><a href="#cb70-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-025, eval = FALSE}</span></span>
<span id="cb70-947"><a href="#cb70-947" aria-hidden="true" tabindex="-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-948"><a href="#cb70-948" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb70-949"><a href="#cb70-949" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-950"><a href="#cb70-950" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-951"><a href="#cb70-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-952"><a href="#cb70-952" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Putting it Together</span></span>
<span id="cb70-953"><a href="#cb70-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-954"><a href="#cb70-954" aria-hidden="true" tabindex="-1"></a>The whole definition thus becomes</span>
<span id="cb70-955"><a href="#cb70-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-956"><a href="#cb70-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-026, tidy = FALSE}</span></span>
<span id="cb70-957"><a href="#cb70-957" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb70-958"><a href="#cb70-958" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb70-959"><a href="#cb70-959" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-960"><a href="#cb70-960" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb70-961"><a href="#cb70-961" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb70-962"><a href="#cb70-962" aria-hidden="true" tabindex="-1"></a>        <span class="at">input =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>),</span>
<span id="cb70-963"><a href="#cb70-963" aria-hidden="true" tabindex="-1"></a>        <span class="at">output =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb70-964"><a href="#cb70-964" aria-hidden="true" tabindex="-1"></a>                            <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb70-965"><a href="#cb70-965" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-966"><a href="#cb70-966" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-967"><a href="#cb70-967" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-968"><a href="#cb70-968" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-969"><a href="#cb70-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-970"><a href="#cb70-970" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb70-971"><a href="#cb70-971" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb70-972"><a href="#cb70-972" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-973"><a href="#cb70-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-974"><a href="#cb70-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb70-975"><a href="#cb70-975" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb70-976"><a href="#cb70-976" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-977"><a href="#cb70-977" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-978"><a href="#cb70-978" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-979"><a href="#cb70-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-980"><a href="#cb70-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-981"><a href="#cb70-981" aria-hidden="true" tabindex="-1"></a>We can create an instance of our <span class="in">`r ref("PipeOp")`</span>, put it in a graph, and see what happens when we train it on something:</span>
<span id="cb70-982"><a href="#cb70-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-983"><a href="#cb70-983" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-027}</span></span>
<span id="cb70-984"><a href="#cb70-984" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb70-985"><a href="#cb70-985" aria-hidden="true" tabindex="-1"></a>poct <span class="ot">=</span> PipeOpCopyTwo<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb70-986"><a href="#cb70-986" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb70-987"><a href="#cb70-987" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(poct)</span>
<span id="cb70-988"><a href="#cb70-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-989"><a href="#cb70-989" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span>
<span id="cb70-990"><a href="#cb70-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-991"><a href="#cb70-991" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb70-992"><a href="#cb70-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-993"><a href="#cb70-993" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(result)</span>
<span id="cb70-994"><a href="#cb70-994" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-995"><a href="#cb70-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-996"><a href="#cb70-996" aria-hidden="true" tabindex="-1"></a><span class="fu">### Special Case: Preprocessing {#ext-pipe-preproc}</span></span>
<span id="cb70-997"><a href="#cb70-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-998"><a href="#cb70-998" aria-hidden="true" tabindex="-1"></a>Many <span class="in">`r ref("PipeOp")`</span>s perform an operation on exactly one <span class="in">`r ref("Task")`</span>, and return exactly one <span class="in">`r ref("Task")`</span>. They may even not care about the "Target" / "Outcome" variable of that task, and only do some modification of some input data.</span>
<span id="cb70-999"><a href="#cb70-999" aria-hidden="true" tabindex="-1"></a>However, it is usually important to them that the <span class="in">`r ref("Task")`</span> on which they perform prediction has the same data columns as the <span class="in">`r ref("Task")`</span> on which they train.</span>
<span id="cb70-1000"><a href="#cb70-1000" aria-hidden="true" tabindex="-1"></a>For these cases, the auxiliary base class <span class="in">`r ref("PipeOpTaskPreproc")`</span> exists.</span>
<span id="cb70-1001"><a href="#cb70-1001" aria-hidden="true" tabindex="-1"></a>It inherits from <span class="in">`r ref("PipeOp")`</span> itself, and other <span class="in">`r ref("PipeOp")`</span>s should use it if they fall in the kind of use-case named above.</span>
<span id="cb70-1002"><a href="#cb70-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1003"><a href="#cb70-1003" aria-hidden="true" tabindex="-1"></a>When inheriting from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, one must either implement the private methods <span class="in">`.train_task()`</span> and <span class="in">`.predict_task()`</span>, or the methods <span class="in">`.train_dt()`</span>, <span class="in">`.predict_dt()`</span>, depending on whether wants to operate on a <span class="in">`r ref("Task")`</span> object or on its data as <span class="in">`data.table`</span>s.</span>
<span id="cb70-1004"><a href="#cb70-1004" aria-hidden="true" tabindex="-1"></a>In the second case, one can optionally also overload the <span class="in">`.select_cols()`</span> method, which chooses which of the incoming <span class="in">`r ref("Task")`</span>'s features are given to the <span class="in">`.train_dt()`</span> / <span class="in">`.predict_dt()`</span> functions.</span>
<span id="cb70-1005"><a href="#cb70-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1006"><a href="#cb70-1006" aria-hidden="true" tabindex="-1"></a>The following will show two examples: <span class="in">`PipeOpDropNA`</span>, which removes a <span class="in">`r ref("Task")`</span>'s rows with missing values during training (and implements <span class="in">`.train_task()`</span> and <span class="in">`.predict_task()`</span>), and <span class="in">`r ref("PipeOpScale")`</span>, which scales a <span class="in">`r ref("Task")`</span>'s numeric columns (and implements <span class="in">`.train_dt()`</span>, <span class="in">`.predict_dt()`</span>, and <span class="in">`.select_cols()`</span>).</span>
<span id="cb70-1007"><a href="#cb70-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1008"><a href="#cb70-1008" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpDropNA`</span></span>
<span id="cb70-1009"><a href="#cb70-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1010"><a href="#cb70-1010" aria-hidden="true" tabindex="-1"></a>Dropping rows with missing values may be important when training a model that can not handle them.</span>
<span id="cb70-1011"><a href="#cb70-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1012"><a href="#cb70-1012" aria-hidden="true" tabindex="-1"></a>Because <span class="in">`r mlr3`</span> <span class="in">`"Task", text = "Tasks")`</span> only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values.</span>
<span id="cb70-1013"><a href="#cb70-1013" aria-hidden="true" tabindex="-1"></a>Instead, the rows can be removed using the <span class="in">`r ref("Task")`</span>'s <span class="in">`$filter`</span> method, which modifies the <span class="in">`r ref("Task")`</span> in-place.</span>
<span id="cb70-1014"><a href="#cb70-1014" aria-hidden="true" tabindex="-1"></a>This is done in the private method <span class="in">`.train_task()`</span>.</span>
<span id="cb70-1015"><a href="#cb70-1015" aria-hidden="true" tabindex="-1"></a>We take care that we also set the <span class="in">`$state`</span> slot to signal that the <span class="in">`r ref("PipeOp")`</span> was trained.</span>
<span id="cb70-1016"><a href="#cb70-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1017"><a href="#cb70-1017" aria-hidden="true" tabindex="-1"></a>The private method <span class="in">`.predict_task()`</span> does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows.</span>
<span id="cb70-1018"><a href="#cb70-1018" aria-hidden="true" tabindex="-1"></a>Furthermore, <span class="in">`r mlr3`</span> expects a <span class="in">`r ref("Learner")`</span> to always return just as many predictions as it was given input rows, so a <span class="in">`r ref("PipeOp")`</span> that removes <span class="in">`r ref("Task")`</span> rows during training can not be used inside a <span class="in">`r ref("GraphLearner")`</span>.</span>
<span id="cb70-1019"><a href="#cb70-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1020"><a href="#cb70-1020" aria-hidden="true" tabindex="-1"></a>When we inherit from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, it sets the <span class="in">`input`</span> and <span class="in">`output`</span> <span class="in">`data.table`</span>s for us to only accept a single <span class="in">`r ref("Task")`</span>.</span>
<span id="cb70-1021"><a href="#cb70-1021" aria-hidden="true" tabindex="-1"></a>The only thing we do during <span class="in">`initialize()`</span> is therefore to set an <span class="in">`id`</span> (which can optionally be changed by the user).</span>
<span id="cb70-1022"><a href="#cb70-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1023"><a href="#cb70-1023" aria-hidden="true" tabindex="-1"></a>The complete <span class="in">`PipeOpDropNA`</span> can therefore be written as follows.</span>
<span id="cb70-1024"><a href="#cb70-1024" aria-hidden="true" tabindex="-1"></a>Note that it inherits from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, unlike the <span class="in">`PipeOpCopyTwo`</span> example from above:</span>
<span id="cb70-1025"><a href="#cb70-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1026"><a href="#cb70-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-028, tidy = FALSE}</span></span>
<span id="cb70-1027"><a href="#cb70-1027" aria-hidden="true" tabindex="-1"></a>PipeOpDropNA <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropNA"</span>,</span>
<span id="cb70-1028"><a href="#cb70-1028" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb70-1029"><a href="#cb70-1029" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-1030"><a href="#cb70-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.na"</span>) {</span>
<span id="cb70-1031"><a href="#cb70-1031" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id)</span>
<span id="cb70-1032"><a href="#cb70-1032" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1033"><a href="#cb70-1033" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-1034"><a href="#cb70-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1035"><a href="#cb70-1035" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-1036"><a href="#cb70-1036" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1037"><a href="#cb70-1037" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb70-1038"><a href="#cb70-1038" aria-hidden="true" tabindex="-1"></a>      featuredata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb70-1039"><a href="#cb70-1039" aria-hidden="true" tabindex="-1"></a>      exclude <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">is.na</span>(featuredata), <span class="dv">1</span>, any)</span>
<span id="cb70-1040"><a href="#cb70-1040" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">filter</span>(task<span class="sc">$</span>row_ids[<span class="sc">!</span>exclude])</span>
<span id="cb70-1041"><a href="#cb70-1041" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1042"><a href="#cb70-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1043"><a href="#cb70-1043" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1044"><a href="#cb70-1044" aria-hidden="true" tabindex="-1"></a>      <span class="co"># nothing to be done</span></span>
<span id="cb70-1045"><a href="#cb70-1045" aria-hidden="true" tabindex="-1"></a>      task</span>
<span id="cb70-1046"><a href="#cb70-1046" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1047"><a href="#cb70-1047" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-1048"><a href="#cb70-1048" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1049"><a href="#cb70-1049" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1050"><a href="#cb70-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1051"><a href="#cb70-1051" aria-hidden="true" tabindex="-1"></a>To test this <span class="in">`r ref("PipeOp")`</span>, we create a small task with missing values:</span>
<span id="cb70-1052"><a href="#cb70-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1053"><a href="#cb70-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-029}</span></span>
<span id="cb70-1054"><a href="#cb70-1054" aria-hidden="true" tabindex="-1"></a>smalliris <span class="ot">=</span> iris[(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">30</span>, ]</span>
<span id="cb70-1055"><a href="#cb70-1055" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb70-1056"><a href="#cb70-1056" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb70-1057"><a href="#cb70-1057" aria-hidden="true" tabindex="-1"></a>sitask <span class="ot">=</span> <span class="fu">as_task_classif</span>(smalliris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb70-1058"><a href="#cb70-1058" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sitask<span class="sc">$</span><span class="fu">data</span>())</span>
<span id="cb70-1059"><a href="#cb70-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1060"><a href="#cb70-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1061"><a href="#cb70-1061" aria-hidden="true" tabindex="-1"></a>We test this by feeding it to a new <span class="in">`r ref("Graph")`</span> that uses <span class="in">`PipeOpDropNA`</span>.</span>
<span id="cb70-1062"><a href="#cb70-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1063"><a href="#cb70-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-030}</span></span>
<span id="cb70-1064"><a href="#cb70-1064" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb70-1065"><a href="#cb70-1065" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropNA<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb70-1066"><a href="#cb70-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1067"><a href="#cb70-1067" aria-hidden="true" tabindex="-1"></a>filtered_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(sitask)[[<span class="dv">1</span>]]</span>
<span id="cb70-1068"><a href="#cb70-1068" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_task<span class="sc">$</span><span class="fu">data</span>())</span>
<span id="cb70-1069"><a href="#cb70-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1070"><a href="#cb70-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1071"><a href="#cb70-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpScaleAlways`</span></span>
<span id="cb70-1072"><a href="#cb70-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1073"><a href="#cb70-1073" aria-hidden="true" tabindex="-1"></a>An often-applied preprocessing step is to simply **center** and/or **scale** the data to mean $0$ and standard deviation $1$.</span>
<span id="cb70-1074"><a href="#cb70-1074" aria-hidden="true" tabindex="-1"></a>This fits the <span class="in">`r ref("PipeOpTaskPreproc")`</span> pattern quite well.</span>
<span id="cb70-1075"><a href="#cb70-1075" aria-hidden="true" tabindex="-1"></a>Because it always replaces all columns that it operates on, and does not require any information about the task's target, it only needs to overload the <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span> functions.</span>
<span id="cb70-1076"><a href="#cb70-1076" aria-hidden="true" tabindex="-1"></a>This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</span>
<span id="cb70-1077"><a href="#cb70-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1078"><a href="#cb70-1078" aria-hidden="true" tabindex="-1"></a>Because scaling only makes sense on numeric features, we want to instruct <span class="in">`r ref("PipeOpTaskPreproc")`</span> to give us only these numeric columns.</span>
<span id="cb70-1079"><a href="#cb70-1079" aria-hidden="true" tabindex="-1"></a>We do this by overloading the <span class="in">`.select_cols()`</span> function: It is called by the class to determine which columns to pass to <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span>.</span>
<span id="cb70-1080"><a href="#cb70-1080" aria-hidden="true" tabindex="-1"></a>Its input is the <span class="in">`r ref("Task")`</span> that is being transformed, and it should return a <span class="in">`character`</span> vector of all features to work with.</span>
<span id="cb70-1081"><a href="#cb70-1081" aria-hidden="true" tabindex="-1"></a>When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns.</span>
<span id="cb70-1082"><a href="#cb70-1082" aria-hidden="true" tabindex="-1"></a>Because the <span class="in">`levels()`</span> of the data table given to <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span> may be different from the <span class="in">`r ref("Task")`</span>'s levels, these functions must also take a <span class="in">`levels`</span> argument that is a named list of column names indicating their levels.</span>
<span id="cb70-1083"><a href="#cb70-1083" aria-hidden="true" tabindex="-1"></a>When working with numeric data, this argument can be ignored, but it should be used instead of <span class="in">`levels(dt[[column]])`</span> for factorial or character columns.</span>
<span id="cb70-1084"><a href="#cb70-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1085"><a href="#cb70-1085" aria-hidden="true" tabindex="-1"></a>This is the first <span class="in">`r ref("PipeOp")`</span> where we will be using the <span class="in">`$state`</span> slot for something useful: We save the centering offset and scaling coefficient and use it in <span class="in">`$.predict()`</span>!</span>
<span id="cb70-1086"><a href="#cb70-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1087"><a href="#cb70-1087" aria-hidden="true" tabindex="-1"></a>For simplicity, we are not using hyperparameters and will always scale and center all data.</span>
<span id="cb70-1088"><a href="#cb70-1088" aria-hidden="true" tabindex="-1"></a>Compare this <span class="in">`PipeOpScaleAlways`</span> operator to the one defined inside the <span class="in">`r mlr3pipelines`</span> package, <span class="in">`r ref("PipeOpScale")`</span>.</span>
<span id="cb70-1089"><a href="#cb70-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1090"><a href="#cb70-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-031, tidy = FALSE}</span></span>
<span id="cb70-1091"><a href="#cb70-1091" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlways <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlways"</span>,</span>
<span id="cb70-1092"><a href="#cb70-1092" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb70-1093"><a href="#cb70-1093" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-1094"><a href="#cb70-1094" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always"</span>) {</span>
<span id="cb70-1095"><a href="#cb70-1095" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb70-1096"><a href="#cb70-1096" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1097"><a href="#cb70-1097" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-1098"><a href="#cb70-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1099"><a href="#cb70-1099" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-1100"><a href="#cb70-1100" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1101"><a href="#cb70-1101" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb70-1102"><a href="#cb70-1102" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1103"><a href="#cb70-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1104"><a href="#cb70-1104" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb70-1105"><a href="#cb70-1105" aria-hidden="true" tabindex="-1"></a>      sc <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">as.matrix</span>(dt))</span>
<span id="cb70-1106"><a href="#cb70-1106" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb70-1107"><a href="#cb70-1107" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:center"</span>),</span>
<span id="cb70-1108"><a href="#cb70-1108" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:scale"</span>)</span>
<span id="cb70-1109"><a href="#cb70-1109" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-1110"><a href="#cb70-1110" aria-hidden="true" tabindex="-1"></a>      sc</span>
<span id="cb70-1111"><a href="#cb70-1111" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1112"><a href="#cb70-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1113"><a href="#cb70-1113" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb70-1114"><a href="#cb70-1114" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb70-1115"><a href="#cb70-1115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1116"><a href="#cb70-1116" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-1117"><a href="#cb70-1117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1118"><a href="#cb70-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1119"><a href="#cb70-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1120"><a href="#cb70-1120" aria-hidden="true" tabindex="-1"></a>_(Note for the observant: If you check `PipeOpScale.R` from the `r mlr3pipelines` package, you will notice that is uses "`get("type")`" and "`get("id")`" instead of "`type`" and "`id`", because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a "problem" with `data.table` and not exclusive to `r mlr3pipelines`.)_</span>
<span id="cb70-1121"><a href="#cb70-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1122"><a href="#cb70-1122" aria-hidden="true" tabindex="-1"></a>We can, again, create a new <span class="in">`r ref("Graph")`</span> that uses this <span class="in">`r ref("PipeOp")`</span> to test it.</span>
<span id="cb70-1123"><a href="#cb70-1123" aria-hidden="true" tabindex="-1"></a>Compare the resulting data to the original "iris" <span class="in">`r ref("Task")`</span> data printed at the beginning:</span>
<span id="cb70-1124"><a href="#cb70-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1125"><a href="#cb70-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-032}</span></span>
<span id="cb70-1126"><a href="#cb70-1126" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb70-1127"><a href="#cb70-1127" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb70-1128"><a href="#cb70-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1129"><a href="#cb70-1129" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb70-1130"><a href="#cb70-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1131"><a href="#cb70-1131" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1132"><a href="#cb70-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1133"><a href="#cb70-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1134"><a href="#cb70-1134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Special Case: Preprocessing with Simple Train</span></span>
<span id="cb70-1135"><a href="#cb70-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1136"><a href="#cb70-1136" aria-hidden="true" tabindex="-1"></a>It is possible to make even further simplifications for many <span class="in">`r ref("PipeOp")`</span>s that perform mostly the same operation during training and prediction.</span>
<span id="cb70-1137"><a href="#cb70-1137" aria-hidden="true" tabindex="-1"></a>The point of <span class="in">`r ref("Task")`</span> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that *may* depend on training data).</span>
<span id="cb70-1138"><a href="#cb70-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1139"><a href="#cb70-1139" aria-hidden="true" tabindex="-1"></a>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level.</span>
<span id="cb70-1140"><a href="#cb70-1140" aria-hidden="true" tabindex="-1"></a>However, what features get removed must be decided during *training*, and may only depend on training data.</span>
<span id="cb70-1141"><a href="#cb70-1141" aria-hidden="true" tabindex="-1"></a>Furthermore, the actual process of removing features is the same during training and prediction.</span>
<span id="cb70-1142"><a href="#cb70-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1143"><a href="#cb70-1143" aria-hidden="true" tabindex="-1"></a>A simplification to make is therefore to have a private method <span class="in">`.get_state(task)`</span> which sets the <span class="in">`$state`</span> slot during training, and a private method <span class="in">`.transform(task)`</span>, which gets called both during training *and* prediction.</span>
<span id="cb70-1144"><a href="#cb70-1144" aria-hidden="true" tabindex="-1"></a>This is done in the <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> class.</span>
<span id="cb70-1145"><a href="#cb70-1145" aria-hidden="true" tabindex="-1"></a>Just like <span class="in">`r ref("PipeOpTaskPreproc")`</span>, one can inherit from this and overload these functions to get a <span class="in">`r ref("PipeOp")`</span> that performs preprocessing with very little boilerplate code.</span>
<span id="cb70-1146"><a href="#cb70-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1147"><a href="#cb70-1147" aria-hidden="true" tabindex="-1"></a>Just like <span class="in">`r ref("PipeOpTaskPreproc")`</span>, <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> offers the possibility to instead overload the <span class="in">`.get_state_dt(dt, levels)`</span> and <span class="in">`.transform_dt(dt, levels)`</span> methods (and optionally, again, the <span class="in">`.select_cols(task)`</span> function) to operate on <span class="in">`data.table`</span> feature data instead of the whole <span class="in">`r ref("Task")`</span>.</span>
<span id="cb70-1148"><a href="#cb70-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1149"><a href="#cb70-1149" aria-hidden="true" tabindex="-1"></a>Even some methods that do not use <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> *could* work in a similar way: The <span class="in">`PipeOpScaleAlways`</span> example from above will be shown to also work with this paradigm.</span>
<span id="cb70-1150"><a href="#cb70-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1151"><a href="#cb70-1151" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpDropConst`</span></span>
<span id="cb70-1152"><a href="#cb70-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1153"><a href="#cb70-1153" aria-hidden="true" tabindex="-1"></a>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training.</span>
<span id="cb70-1154"><a href="#cb70-1154" aria-hidden="true" tabindex="-1"></a>One simple example of this is dropping constant features.</span>
<span id="cb70-1155"><a href="#cb70-1155" aria-hidden="true" tabindex="-1"></a>Because the <span class="in">`r mlr3`</span> <span class="in">`r ref("Task")`</span> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <span class="in">`$select()`</span> function, so the <span class="in">`.get_state_dt(dt, levels)`</span> / <span class="in">`.transform_dt(dt, levels)`</span> functions will *not* get used; instead we overload the <span class="in">`.get_state(task)`</span> and <span class="in">`.transform(task)`</span> methods.</span>
<span id="cb70-1156"><a href="#cb70-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1157"><a href="#cb70-1157" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.get_state()`</span> function's result is saved to the <span class="in">`$state`</span> slot, so we want to return something that is useful for dropping features.</span>
<span id="cb70-1158"><a href="#cb70-1158" aria-hidden="true" tabindex="-1"></a>We choose to save the names of all the columns that have nonzero variance.</span>
<span id="cb70-1159"><a href="#cb70-1159" aria-hidden="true" tabindex="-1"></a>For brevity, we use <span class="in">`length(unique(column)) &gt; 1`</span> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</span>
<span id="cb70-1160"><a href="#cb70-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1161"><a href="#cb70-1161" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.transform()`</span> method is evaluated both during training *and* prediction, and can rely on the <span class="in">`$state`</span> slot being present.</span>
<span id="cb70-1162"><a href="#cb70-1162" aria-hidden="true" tabindex="-1"></a>All it does here is call the <span class="in">`Task$select`</span> function with the columns we chose to keep.</span>
<span id="cb70-1163"><a href="#cb70-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1164"><a href="#cb70-1164" aria-hidden="true" tabindex="-1"></a>The full <span class="in">`r ref("PipeOp")`</span> could be written as follows:</span>
<span id="cb70-1165"><a href="#cb70-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1166"><a href="#cb70-1166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-033, tidy = FALSE}</span></span>
<span id="cb70-1167"><a href="#cb70-1167" aria-hidden="true" tabindex="-1"></a>PipeOpDropConst <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropConst"</span>,</span>
<span id="cb70-1168"><a href="#cb70-1168" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb70-1169"><a href="#cb70-1169" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-1170"><a href="#cb70-1170" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.const"</span>) {</span>
<span id="cb70-1171"><a href="#cb70-1171" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb70-1172"><a href="#cb70-1172" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1173"><a href="#cb70-1173" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-1174"><a href="#cb70-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1175"><a href="#cb70-1175" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-1176"><a href="#cb70-1176" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1177"><a href="#cb70-1177" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb70-1178"><a href="#cb70-1178" aria-hidden="true" tabindex="-1"></a>      nonconst <span class="ot">=</span> <span class="fu">sapply</span>(data, <span class="cf">function</span>(column) <span class="fu">length</span>(<span class="fu">unique</span>(column)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb70-1179"><a href="#cb70-1179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">cnames =</span> <span class="fu">colnames</span>(data)[nonconst])</span>
<span id="cb70-1180"><a href="#cb70-1180" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1181"><a href="#cb70-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1182"><a href="#cb70-1182" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1183"><a href="#cb70-1183" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">select</span>(self<span class="sc">$</span>state<span class="sc">$</span>cnames)</span>
<span id="cb70-1184"><a href="#cb70-1184" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1185"><a href="#cb70-1185" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-1186"><a href="#cb70-1186" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1187"><a href="#cb70-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1188"><a href="#cb70-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1189"><a href="#cb70-1189" aria-hidden="true" tabindex="-1"></a>This can be tested using the first five rows of the "Iris" <span class="in">`r ref("Task")`</span>, for which one feature (<span class="in">`"Petal.Width"`</span>) is constant:</span>
<span id="cb70-1190"><a href="#cb70-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1191"><a href="#cb70-1191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-034}</span></span>
<span id="cb70-1192"><a href="#cb70-1192" aria-hidden="true" tabindex="-1"></a>irishead <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb70-1193"><a href="#cb70-1193" aria-hidden="true" tabindex="-1"></a>irishead<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1194"><a href="#cb70-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1195"><a href="#cb70-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1196"><a href="#cb70-1196" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-035}</span></span>
<span id="cb70-1197"><a href="#cb70-1197" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropConst<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb70-1198"><a href="#cb70-1198" aria-hidden="true" tabindex="-1"></a>dropped_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(irishead)[[<span class="dv">1</span>]]</span>
<span id="cb70-1199"><a href="#cb70-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1200"><a href="#cb70-1200" aria-hidden="true" tabindex="-1"></a>dropped_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1201"><a href="#cb70-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1202"><a href="#cb70-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1203"><a href="#cb70-1203" aria-hidden="true" tabindex="-1"></a>We can also see that the <span class="in">`$state`</span> was correctly set.</span>
<span id="cb70-1204"><a href="#cb70-1204" aria-hidden="true" tabindex="-1"></a>Calling <span class="in">`$.predict()`</span> with this graph, even with different data (the whole Iris <span class="in">`r ref("Task")`</span>!) will still drop the <span class="in">`"Petal.Width"`</span> column, as it should.</span>
<span id="cb70-1205"><a href="#cb70-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1206"><a href="#cb70-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-036}</span></span>
<span id="cb70-1207"><a href="#cb70-1207" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>pipeops<span class="sc">$</span>drop.const<span class="sc">$</span>state</span>
<span id="cb70-1208"><a href="#cb70-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1209"><a href="#cb70-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1210"><a href="#cb70-1210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-037}</span></span>
<span id="cb70-1211"><a href="#cb70-1211" aria-hidden="true" tabindex="-1"></a>dropped_predict <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb70-1212"><a href="#cb70-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1213"><a href="#cb70-1213" aria-hidden="true" tabindex="-1"></a>dropped_predict<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1214"><a href="#cb70-1214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1215"><a href="#cb70-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1216"><a href="#cb70-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpScaleAlwaysSimple`</span></span>
<span id="cb70-1217"><a href="#cb70-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1218"><a href="#cb70-1218" aria-hidden="true" tabindex="-1"></a>This example will show how a <span class="in">`PipeOpTaskPreprocSimple`</span> can be used when only working on feature data in form of a <span class="in">`data.table`</span>.</span>
<span id="cb70-1219"><a href="#cb70-1219" aria-hidden="true" tabindex="-1"></a>Instead of calling the <span class="in">`scale()`</span> function, the <span class="in">`center`</span> and <span class="in">`scale`</span> values are calculated directly and saved to the <span class="in">`$state`</span> slot.</span>
<span id="cb70-1220"><a href="#cb70-1220" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.transform_dt()`</span> function will then perform the same operation during both training and prediction: subtract the <span class="in">`center`</span> and divide by the <span class="in">`scale`</span> value.</span>
<span id="cb70-1221"><a href="#cb70-1221" aria-hidden="true" tabindex="-1"></a>As in the <span class="co">[</span><span class="ot">`PipeOpScaleAlways` example above</span><span class="co">](#example-pipeopscalealways)</span>, we use <span class="in">`.select_cols()`</span> so that we only work on numeric columns.</span>
<span id="cb70-1222"><a href="#cb70-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1223"><a href="#cb70-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-038, tidy = FALSE}</span></span>
<span id="cb70-1224"><a href="#cb70-1224" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlwaysSimple <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlwaysSimple"</span>,</span>
<span id="cb70-1225"><a href="#cb70-1225" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb70-1226"><a href="#cb70-1226" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb70-1227"><a href="#cb70-1227" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always.simple"</span>) {</span>
<span id="cb70-1228"><a href="#cb70-1228" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb70-1229"><a href="#cb70-1229" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1230"><a href="#cb70-1230" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb70-1231"><a href="#cb70-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1232"><a href="#cb70-1232" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb70-1233"><a href="#cb70-1233" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb70-1234"><a href="#cb70-1234" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb70-1235"><a href="#cb70-1235" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1236"><a href="#cb70-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1237"><a href="#cb70-1237" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb70-1238"><a href="#cb70-1238" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb70-1239"><a href="#cb70-1239" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">sapply</span>(dt, mean),</span>
<span id="cb70-1240"><a href="#cb70-1240" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">sapply</span>(dt, sd)</span>
<span id="cb70-1241"><a href="#cb70-1241" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb70-1242"><a href="#cb70-1242" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-1243"><a href="#cb70-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1244"><a href="#cb70-1244" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb70-1245"><a href="#cb70-1245" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb70-1246"><a href="#cb70-1246" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-1247"><a href="#cb70-1247" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-1248"><a href="#cb70-1248" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-1249"><a href="#cb70-1249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1250"><a href="#cb70-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1251"><a href="#cb70-1251" aria-hidden="true" tabindex="-1"></a>We can compare this <span class="in">`r ref("PipeOp")`</span> to the one above to show that it behaves the same.</span>
<span id="cb70-1252"><a href="#cb70-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1253"><a href="#cb70-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-039}</span></span>
<span id="cb70-1254"><a href="#cb70-1254" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb70-1255"><a href="#cb70-1255" aria-hidden="true" tabindex="-1"></a>result_posa <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb70-1256"><a href="#cb70-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1257"><a href="#cb70-1257" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb70-1258"><a href="#cb70-1258" aria-hidden="true" tabindex="-1"></a>result_posa_simple <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb70-1259"><a href="#cb70-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1260"><a href="#cb70-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1261"><a href="#cb70-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-040}</span></span>
<span id="cb70-1262"><a href="#cb70-1262" aria-hidden="true" tabindex="-1"></a>result_posa<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1263"><a href="#cb70-1263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1264"><a href="#cb70-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1265"><a href="#cb70-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-041}</span></span>
<span id="cb70-1266"><a href="#cb70-1266" aria-hidden="true" tabindex="-1"></a>result_posa_simple<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1267"><a href="#cb70-1267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1268"><a href="#cb70-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1269"><a href="#cb70-1269" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hyperparameters {#ext-pipe-hyperpars}</span></span>
<span id="cb70-1270"><a href="#cb70-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1271"><a href="#cb70-1271" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> uses the <span class="co">[</span><span class="ot">`r ref_pkg("paradox")`</span><span class="co">](https://paradox.mlr-org.com)</span> package to define parameter spaces for <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb70-1272"><a href="#cb70-1272" aria-hidden="true" tabindex="-1"></a>Parameters for <span class="in">`r ref("PipeOp")`</span>s can modify their behavior in certain ways, e.g. switch centering or scaling off in the <span class="in">`r ref("PipeOpScale")`</span> operator.</span>
<span id="cb70-1273"><a href="#cb70-1273" aria-hidden="true" tabindex="-1"></a>The unified interface makes it possible to have parameters for whole <span class="in">`r ref("Graph")`</span>s that modify the individual <span class="in">`r ref("PipeOp")`</span>'s behavior.</span>
<span id="cb70-1274"><a href="#cb70-1274" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("Graph")`</span>s, when encapsulated in <span class="in">`r ref("GraphLearner")`</span>s, can even be tuned using the tuning functionality in <span class="in">`r mlr3tuning`</span>.</span>
<span id="cb70-1275"><a href="#cb70-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1276"><a href="#cb70-1276" aria-hidden="true" tabindex="-1"></a>Hyperparameters are declared during initialization, when calling the <span class="in">`r ref("PipeOp")`</span>'s <span class="in">`$initialize()`</span> function, by giving a <span class="in">`param_set`</span> argument.</span>
<span id="cb70-1277"><a href="#cb70-1277" aria-hidden="true" tabindex="-1"></a>The <span class="in">`param_set`</span> must be a <span class="in">`r ref("ParamSet")`</span> from the <span class="in">`r ref_pkg("paradox")`</span> package; see <span class="co">[</span><span class="ot">the tuning chapter</span><span class="co">](#searchspace)</span> or @sec-paradox for more information on how to define parameter spaces.</span>
<span id="cb70-1278"><a href="#cb70-1278" aria-hidden="true" tabindex="-1"></a>After construction, the <span class="in">`r ref("ParamSet")`</span> can be accessed through the <span class="in">`$param_set`</span> slot.</span>
<span id="cb70-1279"><a href="#cb70-1279" aria-hidden="true" tabindex="-1"></a>While it is *possible* to modify this `r ref("ParamSet")`, using e.g. the `$add()` and `$add_dep()` functions, *after* adding it to the <span class="in">`r ref("PipeOp")`</span>, it is strongly advised against.</span>
<span id="cb70-1280"><a href="#cb70-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1281"><a href="#cb70-1281" aria-hidden="true" tabindex="-1"></a>Hyperparameters can be set and queried through the <span class="in">`$values`</span> slot.</span>
<span id="cb70-1282"><a href="#cb70-1282" aria-hidden="true" tabindex="-1"></a>When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <span class="in">`$param_set`</span>, so it is not necessary to type check them.</span>
<span id="cb70-1283"><a href="#cb70-1283" aria-hidden="true" tabindex="-1"></a>Be aware that it is always possible to *remove* hyperparameter values.</span>
<span id="cb70-1284"><a href="#cb70-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1285"><a href="#cb70-1285" aria-hidden="true" tabindex="-1"></a>When a <span class="in">`r ref("PipeOp")`</span> is initialized, it usually does not have any parameter values---<span class="in">`$values`</span> takes the value <span class="in">`list()`</span>.</span>
<span id="cb70-1286"><a href="#cb70-1286" aria-hidden="true" tabindex="-1"></a>It is possible to set initial parameter values in the <span class="in">`$initialize()`</span> constructor; this must be done *after* the <span class="in">`super$initialize()`</span> call where the corresponding <span class="in">`r ref("ParamSet")`</span> must be supplied.</span>
<span id="cb70-1287"><a href="#cb70-1287" aria-hidden="true" tabindex="-1"></a>This is because setting <span class="in">`$values`</span> checks against the current <span class="in">`$param_set`</span>, which would fail if the <span class="in">`$param_set`</span> was not set yet.</span>
<span id="cb70-1288"><a href="#cb70-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1289"><a href="#cb70-1289" aria-hidden="true" tabindex="-1"></a>When using an underlying library function (the <span class="in">`scale`</span> function in <span class="in">`r ref("PipeOpScale")`</span>, say), then there is usually a "default" behaviour of that function when a parameter is not given.</span>
<span id="cb70-1290"><a href="#cb70-1290" aria-hidden="true" tabindex="-1"></a>It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed).</span>
<span id="cb70-1291"><a href="#cb70-1291" aria-hidden="true" tabindex="-1"></a>This can easily be done when using the <span class="in">`r mlr3misc`</span> library's <span class="in">`r ref("mlr3misc::invoke()")`</span> function, which has functionality similar to <span class="in">`"do.call()"`</span>.</span>
<span id="cb70-1292"><a href="#cb70-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1293"><a href="#cb70-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Hyperparameter Example: `r ref("PipeOpScale")`</span></span>
<span id="cb70-1294"><a href="#cb70-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1295"><a href="#cb70-1295" aria-hidden="true" tabindex="-1"></a>How to use hyperparameters can best be shown through the example of <span class="in">`r ref("PipeOpScale")`</span>, which is very similar to the example above, <span class="in">`PipeOpScaleAlways`</span>.</span>
<span id="cb70-1296"><a href="#cb70-1296" aria-hidden="true" tabindex="-1"></a>The difference is made by the presence of hyperparameters.</span>
<span id="cb70-1297"><a href="#cb70-1297" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOpScale")`</span> constructs a <span class="in">`r ref("ParamSet")`</span> in its <span class="in">`$initialize`</span> function and passes this on to the <span class="in">`super$initialize`</span> function:</span>
<span id="cb70-1298"><a href="#cb70-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1299"><a href="#cb70-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-042}</span></span>
<span id="cb70-1300"><a href="#cb70-1300" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>public_methods<span class="sc">$</span>initialize</span>
<span id="cb70-1301"><a href="#cb70-1301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1302"><a href="#cb70-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1303"><a href="#cb70-1303" aria-hidden="true" tabindex="-1"></a>The user has access to this and can set and get parameters.</span>
<span id="cb70-1304"><a href="#cb70-1304" aria-hidden="true" tabindex="-1"></a>Types are automatically checked:</span>
<span id="cb70-1305"><a href="#cb70-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1306"><a href="#cb70-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-043}</span></span>
<span id="cb70-1307"><a href="#cb70-1307" aria-hidden="true" tabindex="-1"></a>pss <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb70-1308"><a href="#cb70-1308" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set)</span>
<span id="cb70-1309"><a href="#cb70-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1310"><a href="#cb70-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1311"><a href="#cb70-1311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-044}</span></span>
<span id="cb70-1312"><a href="#cb70-1312" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb70-1313"><a href="#cb70-1313" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set<span class="sc">$</span>values)</span>
<span id="cb70-1314"><a href="#cb70-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1315"><a href="#cb70-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1316"><a href="#cb70-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-045, error = TRUE}</span></span>
<span id="cb70-1317"><a href="#cb70-1317" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="st">"TRUE"</span> <span class="co"># bad input is checked!</span></span>
<span id="cb70-1318"><a href="#cb70-1318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1319"><a href="#cb70-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1320"><a href="#cb70-1320" aria-hidden="true" tabindex="-1"></a>How <span class="in">`r ref("PipeOpScale")`</span> handles its parameters can be seen in its <span class="in">`$.train_dt`</span> method: It gets the relevant parameters from its <span class="in">`$values`</span> slot and uses them in the <span class="in">`r ref("mlr3misc::invoke()")`</span> call.</span>
<span id="cb70-1321"><a href="#cb70-1321" aria-hidden="true" tabindex="-1"></a>This has the advantage over calling <span class="in">`scale()`</span> directly that if a parameter is not given, its default value from the <span class="in">`"scale()"`</span> function will be used.</span>
<span id="cb70-1322"><a href="#cb70-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1323"><a href="#cb70-1323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-046}</span></span>
<span id="cb70-1324"><a href="#cb70-1324" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>private_methods<span class="sc">$</span>.train_dt</span>
<span id="cb70-1325"><a href="#cb70-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1326"><a href="#cb70-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1327"><a href="#cb70-1327" aria-hidden="true" tabindex="-1"></a>Another change that is necessary compared to <span class="in">`PipeOpScaleAlways`</span> is that the attributes <span class="in">`"scaled:scale"`</span> and <span class="in">`"scaled:center"`</span> are not always present, depending on parameters, and possibly need to be set to default values $1$ or $0$, respectively.</span>
<span id="cb70-1328"><a href="#cb70-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1329"><a href="#cb70-1329" aria-hidden="true" tabindex="-1"></a>It is now even possible (if a bit pointless) to call <span class="in">`r ref("PipeOpScale")`</span> with both <span class="in">`scale`</span> and <span class="in">`center`</span> set to <span class="in">`FALSE`</span>, which returns the original dataset, unchanged.</span>
<span id="cb70-1330"><a href="#cb70-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1331"><a href="#cb70-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extending-047}</span></span>
<span id="cb70-1332"><a href="#cb70-1332" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb70-1333"><a href="#cb70-1333" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb70-1334"><a href="#cb70-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1335"><a href="#cb70-1335" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb70-1336"><a href="#cb70-1336" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(pss)</span>
<span id="cb70-1337"><a href="#cb70-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1338"><a href="#cb70-1338" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb70-1339"><a href="#cb70-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1340"><a href="#cb70-1340" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb70-1341"><a href="#cb70-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb70-1342"><a href="#cb70-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1343"><a href="#cb70-1343" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding new Tuners {#extending-tuners}</span></span>
<span id="cb70-1344"><a href="#cb70-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1345"><a href="#cb70-1345" aria-hidden="true" tabindex="-1"></a>In this section, we show how to implement a custom tuner for <span class="in">`r mlr3tuning`</span>.</span>
<span id="cb70-1346"><a href="#cb70-1346" aria-hidden="true" tabindex="-1"></a>The main task of a tuner is to iteratively propose new hyperparameter configurations that we want to evaluate for a given task, learner and validation strategy.</span>
<span id="cb70-1347"><a href="#cb70-1347" aria-hidden="true" tabindex="-1"></a>The second task is to decide which configuration should be returned as a tuning result - usually it is the configuration that led to the best observed performance value.</span>
<span id="cb70-1348"><a href="#cb70-1348" aria-hidden="true" tabindex="-1"></a>If you want to implement your own tuner, you have to implement an R6-Object that offers an  <span class="co">[</span><span class="ot">`.optimize`</span><span class="co">](#tuner-optimize)</span> method that implements the iterative proposal and you are free to implement <span class="co">[</span><span class="ot">`.assign_result`</span><span class="co">](#tuner-add-result)</span> to differ from the before-mentioned default process of determining the result.</span>
<span id="cb70-1349"><a href="#cb70-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1350"><a href="#cb70-1350" aria-hidden="true" tabindex="-1"></a>Before you start with the implementation make yourself familiar with the main R6-Objects in <span class="in">`r ref_pkg("bbotk")`</span> (Black-Box Optimization Toolkit).</span>
<span id="cb70-1351"><a href="#cb70-1351" aria-hidden="true" tabindex="-1"></a>This package does not only provide basic black box optimization algorithms and but also the objects that represent the optimization problem (<span class="in">`r ref("OptimInstance")`</span>) and the log of all evaluated configurations (<span class="in">`r ref("Archive")`</span>).</span>
<span id="cb70-1352"><a href="#cb70-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1353"><a href="#cb70-1353" aria-hidden="true" tabindex="-1"></a>There are two ways to implement a new tuner:</span>
<span id="cb70-1354"><a href="#cb70-1354" aria-hidden="true" tabindex="-1"></a>a ) If your new tuner can be applied to any kind of optimization problem it should be implemented as a <span class="in">`r ref("Optimizer")`</span>.</span>
<span id="cb70-1355"><a href="#cb70-1355" aria-hidden="true" tabindex="-1"></a>Any <span class="in">`r ref("Optimizer")`</span> can be easily transformed to a <span class="in">`r ref("Tuner")`</span>.</span>
<span id="cb70-1356"><a href="#cb70-1356" aria-hidden="true" tabindex="-1"></a>b) If the new custom tuner is only usable for hyperparameter tuning, for example because it needs to access the task, learner or resampling objects it should be directly implemented in <span class="in">`r mlr3tuning`</span> as a <span class="in">`r ref("Tuner")`</span>.</span>
<span id="cb70-1357"><a href="#cb70-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1358"><a href="#cb70-1358" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding a new Tuner {#extending-tuners-summary}</span></span>
<span id="cb70-1359"><a href="#cb70-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1360"><a href="#cb70-1360" aria-hidden="true" tabindex="-1"></a>This is a summary of steps for adding a new tuner.</span>
<span id="cb70-1361"><a href="#cb70-1361" aria-hidden="true" tabindex="-1"></a>The fifth step is only required if the new tuner is added via <span class="in">`r ref_pkg("bbotk")`</span>.</span>
<span id="cb70-1362"><a href="#cb70-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1363"><a href="#cb70-1363" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Check the tuner does not already exist as a <span class="co">[</span><span class="ot">`r ref("Optimizer")`</span><span class="co">](https://github.com/mlr-org/bbotk/tree/master/R)</span> or <span class="co">[</span><span class="ot">`r ref("Tuner")`</span><span class="co">](https://github.com/mlr-org/mlr3tuning/tree/master/R)</span> in the GitHub repositories.</span>
<span id="cb70-1364"><a href="#cb70-1364" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use one of the existing optimizers / tuners as a <span class="co">[</span><span class="ot">template</span><span class="co">](#tuner-template)</span>.</span>
<span id="cb70-1365"><a href="#cb70-1365" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Overwrite the <span class="co">[</span><span class="ot">`.optimize`</span><span class="co">](#tuner-optimize)</span> private method of the optimizer / tuner.</span>
<span id="cb70-1366"><a href="#cb70-1366" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Optionally, overwrite the default <span class="co">[</span><span class="ot">`.assign_result`</span><span class="co">](#tuner-add-result)</span> private method.</span>
<span id="cb70-1367"><a href="#cb70-1367" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use the <span class="co">[</span><span class="ot">`mlr3tuning::TunerFromOptimizer`</span><span class="co">](#tuner-from-optimizer)</span> class to transform the <span class="in">`r ref("Optimizer")`</span> to a <span class="in">`r ref("Tuner")`</span>.</span>
<span id="cb70-1368"><a href="#cb70-1368" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Add <span class="co">[</span><span class="ot">unit tests</span><span class="co">](#tuner-test)</span> for the tuner and optionally for the optimizer.</span>
<span id="cb70-1369"><a href="#cb70-1369" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Open a new pull request for the <span class="co">[</span><span class="ot">`r ref("Tuner")`</span><span class="co">](https://github.com/mlr-org/mlr3tuning/pulls)</span> and optionally a second one for the <span class="co">[</span><span class="ot">`r ref("Optimizer")`</span><span class="co">](https://github.com/mlr-org/bbotk/pulls)</span>.</span>
<span id="cb70-1370"><a href="#cb70-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1371"><a href="#cb70-1371" aria-hidden="true" tabindex="-1"></a><span class="fu">### Template {#tuner-template}</span></span>
<span id="cb70-1372"><a href="#cb70-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1373"><a href="#cb70-1373" aria-hidden="true" tabindex="-1"></a>If the new custom tuner is implemented via <span class="in">`r ref_pkg("bbotk")`</span>, use one of the existing optimizer as a template e.g. <span class="co">[</span><span class="ot">`bbotk::OptimizerRandomSearch`</span><span class="co">](https://github.com/mlr-org/bbotk/blob/master/R/OptimizerRandomSearch.R)</span>. There are currently only two tuners that are not based on a <span class="in">`r ref("Optimizer")`</span>: <span class="co">[</span><span class="ot">`mlr3hyperband::TunerHyperband`</span><span class="co">](https://github.com/mlr-org/mlr3hyperband/blob/master/R/TunerHyperband.R)</span> and <span class="co">[</span><span class="ot">`mlr3tuning::TunerIrace`</span><span class="co">](https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R)</span>. Both are rather complex but you can still use the documentation and class structure as a template. The following steps are identical for optimizers and tuners.</span>
<span id="cb70-1374"><a href="#cb70-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1375"><a href="#cb70-1375" aria-hidden="true" tabindex="-1"></a>Rewrite the meta information in the documentation and create a new class name.</span>
<span id="cb70-1376"><a href="#cb70-1376" aria-hidden="true" tabindex="-1"></a>Scientific sources can be added in <span class="in">`R/bibentries.R`</span> which are added under <span class="in">`@source`</span> in the documentation.</span>
<span id="cb70-1377"><a href="#cb70-1377" aria-hidden="true" tabindex="-1"></a>The example and dictionary sections of the documentation are auto-generated based on the <span class="in">`@templateVar id &lt;tuner_id&gt;`</span>.</span>
<span id="cb70-1378"><a href="#cb70-1378" aria-hidden="true" tabindex="-1"></a>Change the parameter set of the optimizer / tuner and document them under <span class="in">`@section Parameters`</span>.</span>
<span id="cb70-1379"><a href="#cb70-1379" aria-hidden="true" tabindex="-1"></a>Do not forget to change <span class="in">`mlr_optimizers$add()`</span> / <span class="in">`mlr_tuners$add()`</span> in the last line which adds the optimizer / tuner to the dictionary.</span>
<span id="cb70-1380"><a href="#cb70-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1381"><a href="#cb70-1381" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimize method {#tuner-optimize}</span></span>
<span id="cb70-1382"><a href="#cb70-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1383"><a href="#cb70-1383" aria-hidden="true" tabindex="-1"></a>The <span class="in">`$.optimize()`</span> private method is the main part of the tuner.</span>
<span id="cb70-1384"><a href="#cb70-1384" aria-hidden="true" tabindex="-1"></a>It takes an instance, proposes new points and calls the <span class="in">`$eval_batch()`</span> method of the instance to evaluate them.</span>
<span id="cb70-1385"><a href="#cb70-1385" aria-hidden="true" tabindex="-1"></a>Here you can go two ways: Implement the iterative process yourself or call an external optimization function that resides in another package.</span>
<span id="cb70-1386"><a href="#cb70-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1387"><a href="#cb70-1387" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Writing a custom iteration</span></span>
<span id="cb70-1388"><a href="#cb70-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1389"><a href="#cb70-1389" aria-hidden="true" tabindex="-1"></a>Usually, the proposal and evaluation is done in a <span class="in">`repeat`</span>-loop which you have to implement.</span>
<span id="cb70-1390"><a href="#cb70-1390" aria-hidden="true" tabindex="-1"></a>Please consider the following points:</span>
<span id="cb70-1391"><a href="#cb70-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1392"><a href="#cb70-1392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You can evaluate one or multiple points per iteration</span>
<span id="cb70-1393"><a href="#cb70-1393" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You don't have to care about termination, as <span class="in">`$eval_batch()`</span> won't allow more evaluations then allowed by the <span class="in">`bbotk::Terminator`</span>. This implies, that code after the <span class="in">`repeat`</span>-loop will not be executed.</span>
<span id="cb70-1394"><a href="#cb70-1394" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You don't have to care about keeping track of the evaluations as every evaluation is automatically stored in <span class="in">`inst$archive`</span>.</span>
<span id="cb70-1395"><a href="#cb70-1395" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If you want to log additional information for each evaluation of the <span class="in">`r ref("Objective")`</span> in the <span class="in">`r ref("Archive")`</span> you can simply add columns to the <span class="in">`data.table`</span> object that is passed to <span class="in">`$eval_batch()`</span>.</span>
<span id="cb70-1396"><a href="#cb70-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1397"><a href="#cb70-1397" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Calling an external optimization function</span></span>
<span id="cb70-1398"><a href="#cb70-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1399"><a href="#cb70-1399" aria-hidden="true" tabindex="-1"></a>Optimization functions from external packages usually take an objective function as an argument.</span>
<span id="cb70-1400"><a href="#cb70-1400" aria-hidden="true" tabindex="-1"></a>In this case, you can pass <span class="in">`inst$objective_function`</span> which internally calls <span class="in">`$eval_batch()`</span>.</span>
<span id="cb70-1401"><a href="#cb70-1401" aria-hidden="true" tabindex="-1"></a>Check out <span class="co">[</span><span class="ot">`OptimizerGenSA`</span><span class="co">](https://github.com/mlr-org/bbotk/blob/master/R/OptimizerGenSA.R)</span> for an example.</span>
<span id="cb70-1402"><a href="#cb70-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1403"><a href="#cb70-1403" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assign result method {#tuner-add-result}</span></span>
<span id="cb70-1404"><a href="#cb70-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1405"><a href="#cb70-1405" aria-hidden="true" tabindex="-1"></a>The default <span class="in">`$.assign_result()`</span> private method simply obtains the best performing result from the archive.</span>
<span id="cb70-1406"><a href="#cb70-1406" aria-hidden="true" tabindex="-1"></a>The default method can be overwritten if the new tuner determines the result of the optimization in a different way.</span>
<span id="cb70-1407"><a href="#cb70-1407" aria-hidden="true" tabindex="-1"></a>The new function must call the <span class="in">`$assign_result()`</span> method of the instance to write the final result to the instance.</span>
<span id="cb70-1408"><a href="#cb70-1408" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">`mlr3tuning::TunerIrace`</span><span class="co">](https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R)</span> for an implementation of <span class="in">`$.assign_result()`</span>.</span>
<span id="cb70-1409"><a href="#cb70-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1410"><a href="#cb70-1410" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transform optimizer to tuner {#tuner-from-optimizer}</span></span>
<span id="cb70-1411"><a href="#cb70-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1412"><a href="#cb70-1412" aria-hidden="true" tabindex="-1"></a>This step is only needed if you implement via <span class="in">`r ref_pkg("bbotk")`</span>.</span>
<span id="cb70-1413"><a href="#cb70-1413" aria-hidden="true" tabindex="-1"></a>The <span class="in">`mlr3tuning::TunerFromOptimizer`</span> class transforms a <span class="in">`r ref("Optimizer")`</span> to a <span class="in">`r ref("Tuner")`</span>.</span>
<span id="cb70-1414"><a href="#cb70-1414" aria-hidden="true" tabindex="-1"></a>Just add the <span class="in">`r ref("Optimizer")`</span> to the <span class="in">`optimizer`</span> field.</span>
<span id="cb70-1415"><a href="#cb70-1415" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">`mlr3tuning::TunerRandomSearch`</span><span class="co">](https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerRandomSearch.R)</span> for an example.</span>
<span id="cb70-1416"><a href="#cb70-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1417"><a href="#cb70-1417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add unit tests {#tuner-test}</span></span>
<span id="cb70-1418"><a href="#cb70-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-1419"><a href="#cb70-1419" aria-hidden="true" tabindex="-1"></a>The new custom tuner should be thoroughly tested with unit tests.</span>
<span id="cb70-1420"><a href="#cb70-1420" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("Tuner")`</span>s can be tested with the <span class="in">`test_tuner()`</span> helper function.</span>
<span id="cb70-1421"><a href="#cb70-1421" aria-hidden="true" tabindex="-1"></a>If you added the Tuner via a <span class="in">`r ref("Optimizer")`</span>, you should additionally test the <span class="in">`r ref("Optimizer")`</span> with the <span class="in">`test_optimizer()`</span> helper function.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licenced under <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>.</div>   
      <div class="nav-footer-center"><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></div>
    <div class="nav-footer-right">Written with <i class="bi bi-heart-fill"></i> for #rstats, ML and FOSS by the mlr-org team.</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>