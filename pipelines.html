<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Author 1">
<meta name="author" content="Author 2">
<title>Flexible and Robust Machine Learning Using mlr3 in R - 6&nbsp; Pipelines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./preprocessing.html" rel="next">
<link href="./feature-selection.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script async="" src="https://hypothes.is/embed.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pipelines</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Flexible and Robust Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="./Flexible-and-Robust-Machine-Learning-Using-mlr3-in-R.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Getting Started</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Resampling and Benchmarking</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature-selection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Feature Selection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pipelines.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pipelines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preprocessing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Preprocessing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./special.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Special Tasks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./technical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Technical</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpretation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Interpretation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./extending.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Extending</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Appendices</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solutions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Glossary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tasks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview-tables.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Overview Tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./session.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Session Info</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#pipe-pipeops" id="toc-pipe-pipeops" class="nav-link active" data-scroll-target="#pipe-pipeops"><span class="toc-section-number">6.1</span>  The Building Blocks: PipeOps</a></li>
  <li><a href="#pipe-operator" id="toc-pipe-operator" class="nav-link" data-scroll-target="#pipe-operator"><span class="toc-section-number">6.2</span>  The Pipeline Operator: <code>%&gt;&gt;%</code></a></li>
  <li><a href="#pipe-nodes-edges-graphs" id="toc-pipe-nodes-edges-graphs" class="nav-link" data-scroll-target="#pipe-nodes-edges-graphs"><span class="toc-section-number">6.3</span>  Nodes, Edges and Graphs</a></li>
  <li>
<a href="#pipe-modeling" id="toc-pipe-modeling" class="nav-link" data-scroll-target="#pipe-modeling"><span class="toc-section-number">6.4</span>  Modeling</a>
  <ul class="collapse">
<li><a href="#pipe-hyperpars" id="toc-pipe-hyperpars" class="nav-link" data-scroll-target="#pipe-hyperpars"><span class="toc-section-number">6.4.1</span>  Setting Hyperparameters</a></li>
  <li><a href="#pipe-tuning" id="toc-pipe-tuning" class="nav-link" data-scroll-target="#pipe-tuning"><span class="toc-section-number">6.4.2</span>  Tuning</a></li>
  </ul>
</li>
  <li>
<a href="#pipe-nonlinear" id="toc-pipe-nonlinear" class="nav-link" data-scroll-target="#pipe-nonlinear"><span class="toc-section-number">6.5</span>  Non-Linear Graphs</a>
  <ul class="collapse">
<li><a href="#pipe-model-ensembles-branching-copying" id="toc-pipe-model-ensembles-branching-copying" class="nav-link" data-scroll-target="#pipe-model-ensembles-branching-copying"><span class="toc-section-number">6.5.1</span>  Branching &amp; Copying</a></li>
  <li><a href="#pipe-model-ensembles" id="toc-pipe-model-ensembles" class="nav-link" data-scroll-target="#pipe-model-ensembles"><span class="toc-section-number">6.5.2</span>  Model Ensembles</a></li>
  </ul>
</li>
  <li>
<a href="#extending-pipeops" id="toc-extending-pipeops" class="nav-link" data-scroll-target="#extending-pipeops"><span class="toc-section-number">6.6</span>  Adding new PipeOps</a>
  <ul class="collapse">
<li><a href="#ext-pipeopcopy" id="toc-ext-pipeopcopy" class="nav-link" data-scroll-target="#ext-pipeopcopy"><span class="toc-section-number">6.6.1</span>  General Case Example: <code>PipeOpCopy</code></a></li>
  <li><a href="#ext-pipe-preproc" id="toc-ext-pipe-preproc" class="nav-link" data-scroll-target="#ext-pipe-preproc"><span class="toc-section-number">6.6.2</span>  Special Case: Preprocessing</a></li>
  <li><a href="#special-case-preprocessing-with-simple-train" id="toc-special-case-preprocessing-with-simple-train" class="nav-link" data-scroll-target="#special-case-preprocessing-with-simple-train"><span class="toc-section-number">6.6.3</span>  Special Case: Preprocessing with Simple Train</a></li>
  <li><a href="#ext-pipe-hyperpars" id="toc-ext-pipe-hyperpars" class="nav-link" data-scroll-target="#ext-pipe-hyperpars"><span class="toc-section-number">6.6.4</span>  Hyperparameters</a></li>
  </ul>
</li>
  <li>
<a href="#pipe-special-ops" id="toc-pipe-special-ops" class="nav-link" data-scroll-target="#pipe-special-ops"><span class="toc-section-number">6.7</span>  Special Operators</a>
  <ul class="collapse">
<li><a href="#imputation-pipeopimpute" id="toc-imputation-pipeopimpute" class="nav-link" data-scroll-target="#imputation-pipeopimpute"><span class="toc-section-number">6.7.1</span>  Imputation: <code>PipeOpImpute</code></a></li>
  <li><a href="#feature-engineering-pipeopmutate" id="toc-feature-engineering-pipeopmutate" class="nav-link" data-scroll-target="#feature-engineering-pipeopmutate"><span class="toc-section-number">6.7.2</span>  Feature Engineering: <code>PipeOpMutate</code></a></li>
  <li><a href="#training-on-data-subsets-pipeopchunk" id="toc-training-on-data-subsets-pipeopchunk" class="nav-link" data-scroll-target="#training-on-data-subsets-pipeopchunk"><span class="toc-section-number">6.7.3</span>  Training on data subsets: <code>PipeOpChunk</code></a></li>
  <li><a href="#feature-selection-pipeopfilter-and-pipeopselect" id="toc-feature-selection-pipeopfilter-and-pipeopselect" class="nav-link" data-scroll-target="#feature-selection-pipeopfilter-and-pipeopselect"><span class="toc-section-number">6.7.4</span>  Feature Selection: <code>PipeOpFilter</code> and <code>PipeOpSelect</code></a></li>
  </ul>
</li>
  <li>
<a href="#in-depth-pipelines" id="toc-in-depth-pipelines" class="nav-link" data-scroll-target="#in-depth-pipelines"><span class="toc-section-number">6.8</span>  In-depth look into mlr3pipelines</a>
  <ul class="collapse">
<li><a href="#whats-the-point" id="toc-whats-the-point" class="nav-link" data-scroll-target="#whats-the-point"><span class="toc-section-number">6.8.1</span>  What’s the Point</a></li>
  <li><a href="#pipeop-pipeline-operators" id="toc-pipeop-pipeline-operators" class="nav-link" data-scroll-target="#pipeop-pipeline-operators"><span class="toc-section-number">6.8.2</span>  <code>PipeOp</code>: Pipeline Operators</a></li>
  <li><a href="#pipeop-channels" id="toc-pipeop-channels" class="nav-link" data-scroll-target="#pipeop-channels"><span class="toc-section-number">6.8.3</span>  PipeOp Channels</a></li>
  <li><a href="#graph-networks-of-pipeops" id="toc-graph-networks-of-pipeops" class="nav-link" data-scroll-target="#graph-networks-of-pipeops"><span class="toc-section-number">6.8.4</span>  <code>Graph</code>: Networks of <code>PipeOp</code>s</a></li>
  <li><a href="#learners-in-graphs-graphs-in-learners" id="toc-learners-in-graphs-graphs-in-learners" class="nav-link" data-scroll-target="#learners-in-graphs-graphs-in-learners"><span class="toc-section-number">6.8.5</span>  Learners in Graphs, Graphs in Learners</a></li>
  <li><a href="#hyperparameters" id="toc-hyperparameters" class="nav-link" data-scroll-target="#hyperparameters"><span class="toc-section-number">6.8.6</span>  Hyperparameters</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mlr-org/mlr3book/edit/main/book/pipelines.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/mlr-org/mlr3book/blob/main/book/pipelines.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-pipelines" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pipelines</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    Author 1 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 1
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    Author 2 
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Affiliation 2
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    TODO (150-200 WORDS)
  </div>
</div>

</header><div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This chapter is currently being re-written, in <a href="https://github.com/mlr-org/mlr3book/pull/385">this PR</a>. You can continue reading here if you want to learn about <code>mlr3pipelines</code>, but you currently don’t need to bother checking this chapter for typos etc.</p>
</div>
</div>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> <span class="citation" data-cites="mlr3pipelines">(<a href="references.html#ref-mlr3pipelines" role="doc-biblioref">Binder et al. 2021</a>)</span> is a dataflow programming toolkit. This chapter focuses on the applicant’s side of the package. A more in-depth and technically oriented guide can be found in the <a href="#in-depth-pipelines">In-depth look into mlr3pipelines</a> chapter.</p>
<p>Machine learning workflows can be written as directed “Graphs”/“Pipelines” that represent data flows between preprocessing, model fitting, and ensemble learning units in an expressive and intuitive language. We will most often use the term “Graph” in this manual but it can interchangeably be used with “pipeline” or “workflow”.</p>
<p>Below you can examine an example for such a graph:</p>
<div class="cell" data-layout-align="center" data-hash="pipelines_cache/html/pipelines-002_bf02dc856b8143dd2e3f4f7002ce8527">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="Figures/single_pipe.svg" class="img-fluid figure-img" style="width:98.0%"></p>
</figure>
</div>
</div>
</div>
<p>Single computational steps can be represented as so-called PipeOps, which can then be connected with directed edges in a Graph. The scope of <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is still growing. Currently supported features are:</p>
<ul>
<li>Data manipulation and preprocessing operations, e.g.&nbsp;PCA, feature filtering, imputation</li>
<li>Task subsampling for speed and outcome class imbalance handling</li>
<li>
<a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> Learner operations for prediction and stacking</li>
<li>Ensemble methods and aggregation of predictions</li>
</ul>
<p>Additionally, we implement several meta operators that can be used to construct powerful pipelines:</p>
<ul>
<li>Simultaneous path branching (data going both ways)</li>
<li>Alternative path branching (data going one specific way, controlled by hyperparameters)</li>
</ul>
<p>An extensive introduction to creating custom <strong>PipeOps</strong> (PO’s) can be found in the <a href="#extending-pipeops">technical introduction</a>.</p>
<p>Using methods from <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>, it is even possible to simultaneously optimize parameters of multiple processing units.</p>
<p>A predecessor to this package is the <a href="https://cran.r-project.org/package=mlrCPO"><code>mlrCPO</code></a> package, which works with <a href="https://cran.r-project.org/package=mlr"><code>mlr</code></a> 2.x. Other packages that provide, to varying degree, some preprocessing functionality or machine learning domain specific language, are:</p>
<ul>
<li>the <a href="https://cran.r-project.org/package=caret"><code>caret</code></a> package and the related <a href="https://cran.r-project.org/package=recipes"><code>recipes</code></a> project</li>
<li>the <a href="https://cran.r-project.org/package=dplyr"><code>dplyr</code></a> package</li>
</ul>
<p>An example for a Pipeline that can be constructed using <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is depicted below:</p>
<div class="cell" width="10" height="10" data-hash="pipelines_cache/html/pipelines-003_38fe53308d8f4ae20153bef7744e04cd">
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-003-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="pipe-pipeops" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="pipe-pipeops">
<span class="header-section-number">6.1</span> The Building Blocks: PipeOps</h2>
<p>The building blocks of <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> are <strong>PipeOp</strong>-objects (PO). They can be constructed directly using <code>PipeOp&lt;NAME&gt;$new()</code>, but the recommended way is to retrieve them from the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html"><code>mlr_pipeops</code></a> dictionary:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-005_3a721211fdab7754b3c8a1b4af4dbb8e">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">as.data.table</span>(mlr_pipeops)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               key                                               label
 1:         boxcox          Box-Cox Transformation of Numeric Features
 2:         branch                                      Path Branching
 3:          chunk                   Chunk Input into Multiple Outputs
 4: classbalancing                                     Class Balancing
 5:     classifavg                            Majority Vote Prediction
---                                                                   
60:      threshold Change the Threshold of a Classification Prediction
61:  tunethreshold   Tune the Threshold of a Classification Prediction
62:       unbranch                            Unbranch Different Paths
63:         vtreat                     Interface to the vtreat Package
64:     yeojohnson      Yeo-Johnson Transformation of Numeric Features
9 variables not shown: [packages, tags, feature_types, input.num, output.num, input.type.train, input.type.predict, output.type.train, output.type.predict]</code></pre>
</div>
</div>
<p>Single POs can be created using the dictionary:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-006_60c9aa1936b53b69bd614a43873b71ca">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>pca <span class="ot">=</span> mlr_pipeops<span class="sc">$</span><span class="fu">get</span>(<span class="st">"pca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or using <strong>syntactic sugar</strong> <code>po(&lt;name&gt;)</code>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-007_9305e82ffdcd409785c307a035b925dd">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some POs require additional arguments for construction:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-008_81ed0e35205bc031bd37a08af0e6fa51">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>learner <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># Error in as_learner(learner) : argument "learner" is missing, with no default argument "learner" is missing, with no default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-009_bb9fdd850957a37fc394f3bb34483b02">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>learner <span class="ot">=</span> mlr_pipeops<span class="sc">$</span><span class="fu">get</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or in short <code>po("learner", lrn("classif.rpart"))</code>.</p>
<p>Hyperparameters of POs can be set through the <code>param_vals</code> argument. Here we set the fraction of features for a filter:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-010_e6c12927c35735f6096d0879b64bd140">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or in short notation:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-011_f29a9c14aff3c8698d6a0411c757979c">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">po</span>(<span class="st">"filter"</span>, mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>), <span class="at">filter.frac =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The figure below shows an exemplary <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. It takes an input, transforms it during <code>.$train</code> and <code>.$predict</code> and returns data:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-012_173f3504cbdfb72981dce192b8958ca7">
<div class="cell-output-display">
<p><img src="Figures/po_viz.png" class="img-fluid" width="464"></p>
</div>
</div>
</section><section id="pipe-operator" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="pipe-operator">
<span class="header-section-number">6.2</span> The Pipeline Operator: <code>%&gt;&gt;%</code>
</h2>
<p>It is possible to create intricate <code>Graphs</code> with edges going all over the place (as long as no loops are introduced). Irrespective, there is usually a clear direction of flow between “layers” in the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. It is therefore convenient to build up a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> from layers.</p>
<p>This can be done using the <strong><code>%&gt;&gt;%</code></strong> (“double-arrow”) operator. It takes either a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> on each of its sides and connects all of the outputs of its left-hand side to one of the inputs each of its right-hand side. The number of inputs therefore must match the number of outputs.</p>
<div class="cell" data-layout-align="center" data-hash="pipelines_cache/html/pipelines-014_91ff987752daabf96a306328ffd4b63e">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="pipelines_files/figure-html/pipelines-014-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="pipe-nodes-edges-graphs" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="pipe-nodes-edges-graphs">
<span class="header-section-number">6.3</span> Nodes, Edges and Graphs</h2>
<p>POs are combined into <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s.</p>
<p>POs are identified by their <code>$id</code>. Note that the operations all modify the object in-place and return the object itself. Therefore, multiple modifications can be chained.</p>
<p>For this example we use the <code>pca</code> PO defined above and a new PO named “mutate”. The latter creates a new feature from existing variables. Additionally, we use the filter PO again.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-016_646aedea8213d8d127c595bd60dfe294">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>mutate <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The recommended way to construct a graph is to use the <code>%&gt;&gt;%</code> operator to chain POs or <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-017_189fb2a4a2b7c5f4e994ca22b20f0a5b">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>graph <span class="ot">=</span> mutate <span class="sc">%&gt;&gt;%</span> filter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To illustrate how this sugar operator works under the surface we will include an example of the manual way (= hard way) to construct a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. This is done by creating an empty graph first. Then one fills the empty graph with POs, and connects edges between the POs. Conceptually, this may look like this:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-018_c33a7fd34e64465e4268d01ef7628bf1">
<div class="cell-output-display">
<p><img src="Figures/po_nodes.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-019_63145c761b5dcb89dc51ceeb3a6916ec">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>graph <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">add_pipeop</span>(mutate)<span class="sc">$</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">add_pipeop</span>(filter)<span class="sc">$</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">add_edge</span>(<span class="st">"mutate"</span>, <span class="st">"variance"</span>) <span class="co"># add connection mutate -&gt; filter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The constructed <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> can be inspected using its <code>$plot()</code> function:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-020_ec12dcc5e9f43c6058a90f099bc80e55">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-020-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Chaining multiple POs of the same kind</strong></p>
<p>If multiple POs of the same kind should be chained, it is necessary to change the <code>id</code> to avoid name clashes. This can be done by either accessing the <code>$id</code> slot or during construction:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-021_fee4b5857b909d23774faa309e00b18a">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>graph<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-022_8698d8db2d54423f54c72cb0d2213e8d">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>graph<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-023_49ffb70510a18b40dd3d3c6f046905b9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-023-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="pipe-modeling" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="pipe-modeling">
<span class="header-section-number">6.4</span> Modeling</h2>
<p>The main purpose of a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> is to build combined preprocessing and model fitting pipelines that can be used as <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>.</p>
<p>Conceptually, the process may be summarized as follows:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-025_cee24f74ce177b53aafbfbdc2051ad20">
<div class="cell-output-display">
<p><img src="Figures/pipe_action.svg" class="img-fluid"></p>
</div>
</div>
<p>In the following we chain two preprocessing tasks:</p>
<ul>
<li>mutate (creation of a new feature)</li>
<li>filter (filtering the dataset)</li>
</ul>
<p>Subsequently one can chain a PO learner to train and predict on the modified dataset.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-026_13e56c0c16ae9dd3b6374acb2f270fdd">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>mutate <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb17-4"><a href="#cb17-4"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a>graph <span class="ot">=</span> mutate <span class="sc">%&gt;&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  filter <span class="sc">%&gt;&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>,</span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Until here we defined the main pipeline stored in <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. Now we can train and predict the pipeline:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-027_e2e248067308c16b1a058d7195ed6ab7">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb18-2"><a href="#cb18-2"></a>graph<span class="sc">$</span><span class="fu">train</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.rpart.output
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>graph<span class="sc">$</span><span class="fu">predict</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.rpart.output
&lt;PredictionClassif&gt; for 150 observations:
    row_ids     truth  response
          1    setosa    setosa
          2    setosa    setosa
          3    setosa    setosa
---                            
        148 virginica virginica
        149 virginica virginica
        150 virginica virginica</code></pre>
</div>
</div>
<p>Rather than calling <code>$train()</code> and <code>$predict()</code> manually, we can put the pipeline <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> into a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> object. A <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> encapsulates the whole pipeline (including the preprocessing steps) and can be put into <a href="https://mlr3.mlr-org.com/reference/resample.html"><code>resample()</code></a> or <a href="https://mlr3.mlr-org.com/reference/benchmark.html"><code>benchmark()</code></a> . If you are familiar with the old <em>mlr</em> package, this is the equivalent of all the <code>make*Wrapper()</code> functions. The pipeline being encapsulated (here <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>) must always produce a <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> with its <code>$predict()</code> call, so it will probably contain at least one <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a> .</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-028_a76a1b913839826ae053279419d89d10">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>glrn <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This learner can be used for model fitting, resampling, benchmarking, and tuning:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-029_8c151b54f8c4be3893dd262e5def7940">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>cv3 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="fu">resample</span>(task, glrn, cv3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResampleResult&gt; of 3 iterations
* Task: iris
* Learner: mutate.variance.classif.rpart
* Warnings: 0 in 0 iterations
* Errors: 0 in 0 iterations</code></pre>
</div>
</div>
<section id="pipe-hyperpars" class="level3" data-number="6.4.1"><h3 data-number="6.4.1" class="anchored" data-anchor-id="pipe-hyperpars">
<span class="header-section-number">6.4.1</span> Setting Hyperparameters</h3>
<p>Individual POs offer hyperparameters because they contain <code>$param_set</code> slots that can be read and written from <code>$param_set$values</code> (via the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package). The parameters get passed down to the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>, and finally to the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> . This makes it not only possible to easily change the behavior of a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> / <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> and try different settings manually, but also to perform tuning using the <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a> package.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-030_2316bfac356ed686e057494c0cb18087">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>glrn<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>variance.filter.frac <span class="ot">=</span> <span class="fl">0.25</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>cv3 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">resample</span>(task, glrn, cv3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResampleResult&gt; of 3 iterations
* Task: iris
* Learner: mutate.variance.classif.rpart
* Warnings: 0 in 0 iterations
* Errors: 0 in 0 iterations</code></pre>
</div>
</div>
</section><section id="pipe-tuning" class="level3" data-number="6.4.2"><h3 data-number="6.4.2" class="anchored" data-anchor-id="pipe-tuning">
<span class="header-section-number">6.4.2</span> Tuning</h3>
<p>If you are unfamiliar with tuning in <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>, we recommend to take a look at the section about <a href="#tuning">tuning</a> first. Here we define a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> for the “rpart” learner and the “variance” filter which should be optimized during the tuning process.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-031_42547d6e13cc4608ae034a7ba1a3d167">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a>ps <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="at">classif.rpart.cp =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="fl">0.05</span>),</span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="at">variance.filter.frac =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.25</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb27-5"><a href="#cb27-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After having defined the <a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html"><code>Tuner</code></a>, a random search with 10 iterations is created. For the inner resampling, we are simply using holdout (single split into train/test) to keep the runtimes reasonable.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-032_7141259e2ecec55ebdc26f0018fb8d84">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">library</span>(<span class="st">"mlr3tuning"</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a>instance <span class="ot">=</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="at">task =</span> task,</span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="at">learner =</span> glrn,</span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="at">search_space =</span> ps,</span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>)</span>
<span id="cb28-9"><a href="#cb28-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-033_e9ce03598b21525190b0440f28ea8302">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb29-2"><a href="#cb29-2"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   classif.rpart.cp variance.filter.frac learner_param_vals  x_domain
1:       0.04886918            0.6870548          &lt;list[5]&gt; &lt;list[2]&gt;
1 variable not shown: [classif.ce]</code></pre>
</div>
</div>
<p>The tuning result can be found in the respective <code>result</code> slots.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-034_49409c22b35a3fe938e531c062ff0b1d">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>instance<span class="sc">$</span>result_learner_param_vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$mutate.mutation
list()

$mutate.delete_originals
[1] FALSE

$variance.filter.frac
[1] 0.6870548

$classif.rpart.xval
[1] 0

$classif.rpart.cp
[1] 0.04886918</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>instance<span class="sc">$</span>result_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
      0.02 </code></pre>
</div>
</div>
</section></section><section id="pipe-nonlinear" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="pipe-nonlinear">
<span class="header-section-number">6.5</span> Non-Linear Graphs</h2>
<p>The Graphs seen so far all have a linear structure. Some POs may have multiple input or output channels. These channels make it possible to create non-linear Graphs with alternative paths taken by the data.</p>
<p>Possible types are:</p>
<ul>
<li>
<a href="#pipe-model-ensembles-branching-copying">Branching</a>: Splitting of a node into several paths, e.g.&nbsp;useful when comparing multiple feature-selection methods (pca, filters). Only one path will be executed.</li>
<li>
<a href="#pipe-model-ensembles-branching-copying">Copying</a>: Splitting of a node into several paths, all paths will be executed (sequentially). Parallel execution is not yet supported.</li>
<li>
<a href="#pipe-model-ensembles-stacking">Stacking</a>: Single graphs are stacked onto each other, i.e.&nbsp;the output of one <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> is the input for another. In machine learning this means that the prediction of one <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> is used as input for another <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>
</li>
</ul>
<section id="pipe-model-ensembles-branching-copying" class="level3" data-number="6.5.1"><h3 data-number="6.5.1" class="anchored" data-anchor-id="pipe-model-ensembles-branching-copying">
<span class="header-section-number">6.5.1</span> Branching &amp; Copying</h3>
<p>The <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_branch.html"><code>PipeOpBranch</code></a> and <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_unbranch.html"><code>PipeOpUnbranch</code></a> POs make it possible to specify multiple alternative paths. Only one path is actually executed, the others are ignored. The active path is determined by a hyperparameter. This concept makes it possible to tune alternative preprocessing paths (or learner models).</p>
<p>Below a conceptual visualization of branching:</p>
<div class="cell" data-layout-align="center" data-hash="pipelines_cache/html/pipelines-036_436fe57203828945121dc06f850d44f7">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="Figures/branching.svg" class="img-fluid figure-img" style="width:98.0%"></p>
</figure>
</div>
</div>
</div>
<p><code>PipeOp(Un)Branch</code> is initialized either with the number of branches, or with a <code>character</code>-vector indicating the names of the branches. If names are given, the “branch-choosing” hyperparameter becomes more readable. In the following, we set three options:</p>
<ol type="1">
<li>Doing nothing (“nop”)</li>
<li>Applying a PCA</li>
<li>Scaling the data</li>
</ol>
<p>It is important to “unbranch” again after “branching”, so that the outputs are merged into one result objects.</p>
<p>In the following we first create the branched graph and then show what happens if the “unbranching” is not applied:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-037_6e18266e20c9f1e1814798ecfb1b095c">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb35-3"><a href="#cb35-3"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"null1"</span>),</span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="fu">po</span>(<span class="st">"pca"</span>),</span>
<span id="cb35-5"><a href="#cb35-5"></a>    <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb35-6"><a href="#cb35-6"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Without “unbranching” one creates the following graph:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-038_65a011e3fb342412f1b0fa9883844b84">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-038-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now when “unbranching”, we obtain the following results:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-039_0af06a2509ffe2b23ac353020354156e">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>(graph <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)))<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-039-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The same can be achieved using a shorter notation:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-040_f1a9d3959a0aa86a1f0fee1fe8785c48">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># List of pipeops</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>opts <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">po</span>(<span class="st">"nop"</span>, <span class="st">"no_op"</span>), <span class="fu">po</span>(<span class="st">"pca"</span>), <span class="fu">po</span>(<span class="st">"scale"</span>))</span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co"># List of po ids</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>opt_ids <span class="ot">=</span> mlr3misc<span class="sc">::</span><span class="fu">map_chr</span>(opts, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="st">"id"</span>)</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="fu">po</span>(<span class="st">"branch"</span>, <span class="at">options =</span> opt_ids) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="fu">gunion</span>(opts) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="at">options =</span> opt_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 5 PipeOps:
       ID         State        sccssors       prdcssors
   branch &lt;&lt;UNTRAINED&gt;&gt; no_op,pca,scale                
    no_op &lt;&lt;UNTRAINED&gt;&gt;        unbranch          branch
      pca &lt;&lt;UNTRAINED&gt;&gt;        unbranch          branch
    scale &lt;&lt;UNTRAINED&gt;&gt;        unbranch          branch
 unbranch &lt;&lt;UNTRAINED&gt;&gt;                 no_op,pca,scale</code></pre>
</div>
</div>
</section><section id="pipe-model-ensembles" class="level3" data-number="6.5.2"><h3 data-number="6.5.2" class="anchored" data-anchor-id="pipe-model-ensembles">
<span class="header-section-number">6.5.2</span> Model Ensembles</h3>
<p>We can leverage the different operations presented to connect POs. This allows us to form powerful graphs.</p>
<p>Before we go into details, we split the task into train and test indices.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-041_c42bb93eb03101b424a268b684faa134">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb40-2"><a href="#cb40-2"></a>train.idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), <span class="dv">120</span>)</span>
<span id="cb40-3"><a href="#cb40-3"></a>test.idx <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train.idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="pipe-model-ensembles-bagging" class="level4" data-number="6.5.2.1"><h4 data-number="6.5.2.1" class="anchored" data-anchor-id="pipe-model-ensembles-bagging">
<span class="header-section-number">6.5.2.1</span> Bagging</h4>
<p>We first examine Bagging introduced by <span class="citation" data-cites="Breiman1996">(<a href="references.html#ref-Breiman1996" role="doc-biblioref">Breiman 1996</a>)</span>. The basic idea is to create multiple predictors and then aggregate those to a single, more powerful predictor.</p>
<blockquote class="blockquote">
<p>“… multiple versions are formed by making bootstrap replicates of the learning set and using these as new learning sets” <span class="citation" data-cites="Breiman1996">(<a href="references.html#ref-Breiman1996" role="doc-biblioref">Breiman 1996</a>)</span></p>
</blockquote>
<p>Bagging then aggregates a set of predictors by averaging (regression) or majority vote (classification). The idea behind bagging is, that a set of weak, but different predictors can be combined in order to arrive at a single, better predictor.</p>
<p>We can achieve this by downsampling our data before training a learner, repeating this e.g.&nbsp;10 times and then performing a majority vote on the predictions. Graphically, it may be summarized as follows:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-042_b56d5842c29403c89425058db82a8dc1">
<div class="cell-output-display">
<p><img src="Figures/nonlinear_pipeops.svg" class="img-fluid"></p>
</div>
</div>
<p>First, we create a simple pipeline, that uses <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_subsample.html"><code>PipeOpSubsample</code></a> before a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a> is trained:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-043_464d7a697193385bacb1418455ae3073">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>single_pred <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"subsample"</span>, <span class="at">frac =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now copy this operation 10 times using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_graphs_greplicate.html"><code>pipeline_greplicate</code></a>. The <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_graphs_greplicate.html"><code>pipeline_greplicate</code></a> allows us to parallelize many copies of an operation by creating a Graph containing <code>n</code> copies of the input Graph. We can also create it using <strong>syntactic sugar</strong> via <a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html"><code>ppl()</code></a>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-044_482eff199d0de14828b32c91382f323e">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>pred_set <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"greplicate"</span>, single_pred, 10L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards we need to aggregate the 10 pipelines to form a single model:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-045_b132be488570c80bbeec2b6641cd415d">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>bagging <span class="ot">=</span> pred_set <span class="sc">%&gt;&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">po</span>(<span class="st">"classifavg"</span>, <span class="at">innum =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can plot again to see what happens:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-046_bde90b047bd119555b672477c813985d">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>bagging<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-046-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<p>This pipeline can again be used in conjunction with <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> in order for Bagging to be used like a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-047_da79cefbd847f8fb69c99e9060f79e75">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>baglrn <span class="ot">=</span> <span class="fu">as_learner</span>(bagging)</span>
<span id="cb45-2"><a href="#cb45-2"></a>baglrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)</span>
<span id="cb45-3"><a href="#cb45-3"></a>baglrn<span class="sc">$</span><span class="fu">predict</span>(task, test.idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionClassif&gt; for 30 observations:
    row_ids     truth   response prob.setosa prob.versicolor prob.virginica
         16    setosa     setosa           1             0.0            0.0
         18    setosa     setosa           1             0.0            0.0
         21    setosa     setosa           1             0.0            0.0
---                                                                        
        129 virginica  virginica           0             0.0            1.0
        134 virginica versicolor           0             0.5            0.5
        149 virginica  virginica           0             0.0            1.0</code></pre>
</div>
</div>
<p>In conjunction with different <code>Backends</code>, this can be a very powerful tool. In cases when the data does not fully fit in memory, one can obtain a fraction of the data for each learner from a <a href="https://mlr3.mlr-org.com/reference/DataBackend.html"><code>DataBackend</code></a> and then aggregate predictions over all learners.</p>
</section><section id="pipe-model-ensembles-stacking" class="level4" data-number="6.5.2.2"><h4 data-number="6.5.2.2" class="anchored" data-anchor-id="pipe-model-ensembles-stacking">
<span class="header-section-number">6.5.2.2</span> Stacking</h4>
<p>Stacking <span class="citation" data-cites="Wolpert1992">(<a href="references.html#ref-Wolpert1992" role="doc-biblioref">Wolpert 1992</a>)</span> is another technique that can improve model performance. The basic idea behind stacking is the use of predictions from one model as features for a subsequent model to possibly improve performance.</p>
<p>Below an conceptual illustration of stacking:</p>
<div class="cell" data-layout-align="center" data-hash="pipelines_cache/html/pipelines-048_3c183e8875d3925397828a5ab8ef939c">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="Figures/stacking.svg" class="img-fluid figure-img" style="width:98.0%"></p>
</figure>
</div>
</div>
</div>
<p>As an example we can train a decision tree and use the predictions from this model in conjunction with the original features in order to train an additional model on top.</p>
<p>To limit overfitting, we additionally do not predict on the original predictions of the learner. Instead, we predict on out-of-bag predictions. To do all this, we can use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner_cv.html"><code>PipeOpLearnerCV</code></a> .</p>
<p><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner_cv.html"><code>PipeOpLearnerCV</code></a> performs nested cross-validation on the training data, fitting a model in each fold. Each of the models is then used to predict on the out-of-fold data. As a result, we obtain predictions for every data point in our input data.</p>
<p>We first create a “level 0” learner, which is used to extract a lower level prediction. Additionally, we <code>$clone()</code> the learner object to obtain a copy of the learner. Subsequently, one sets a custom id for the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> .</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-049_d7fc53ff155001c0210d0738e28b30b6">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb47-2"><a href="#cb47-2"></a>lrn_0 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, lrn<span class="sc">$</span><span class="fu">clone</span>())</span>
<span id="cb47-3"><a href="#cb47-3"></a>lrn_0<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"rpart_cv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_nop.html"><code>PipeOpNOP</code></a> in combination with <a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html"><code>gunion</code></a>, in order to send the unchanged Task to the next level. There it is combined with the predictions from our decision tree learner.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-050_25bf1fe2dcda5fa8d165189d9dea823b">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>level_0 <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(lrn_0, <span class="fu">po</span>(<span class="st">"nop"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards, we want to concatenate the predictions from <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner_cv.html"><code>PipeOpLearnerCV</code></a> and the original Task using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_featureunion.html"><code>PipeOpFeatureUnion</code></a> :</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-051_ac3b1144af744e8f9cfd765330f8b357">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>combined <span class="ot">=</span> level_0 <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can train another learner on top of the combined features:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-052_dea39b60e2595cb7f84b5dbbced416e5">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>stack <span class="ot">=</span> combined <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner"</span>, lrn<span class="sc">$</span><span class="fu">clone</span>())</span>
<span id="cb50-2"><a href="#cb50-2"></a>stack<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-052-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-053_87ee73fc666aabab9c477815c832a85d">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>stacklrn <span class="ot">=</span> <span class="fu">as_learner</span>(stack)</span>
<span id="cb51-2"><a href="#cb51-2"></a>stacklrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)</span>
<span id="cb51-3"><a href="#cb51-3"></a>stacklrn<span class="sc">$</span><span class="fu">predict</span>(task, test.idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;PredictionClassif&gt; for 30 observations:
    row_ids     truth   response
         16    setosa     setosa
         18    setosa     setosa
         21    setosa     setosa
---                             
        129 virginica  virginica
        134 virginica versicolor
        149 virginica  virginica</code></pre>
</div>
</div>
<p>In this vignette, we showed a very simple use-case for stacking. In many real-world applications, stacking is done for multiple levels and on multiple representations of the dataset. On a lower level, different preprocessing methods can be defined in conjunction with several learners. On a higher level, we can then combine those predictions in order to form a very powerful model.</p>
</section><section id="multilevel-stacking" class="level4" data-number="6.5.2.3"><h4 data-number="6.5.2.3" class="anchored" data-anchor-id="multilevel-stacking">
<span class="header-section-number">6.5.2.3</span> Multilevel Stacking</h4>
<p>In order to showcase the power of <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>, we will show a more complicated stacking example.</p>
<p>In this case, we train a <a href="https://cran.r-project.org/package=glmnet"><code>glmnet</code></a> and 2 different <a href="https://cran.r-project.org/package=rpart"><code>rpart</code></a> models (some transform its inputs using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html"><code>PipeOpPCA</code></a>) on our task in the “level 0” and concatenate them with the original features (via <a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html"><code>gunion</code></a>). The result is then passed on to “level 1”, where we copy the concatenated features 3 times and put this task into an <a href="https://cran.r-project.org/package=rpart"><code>rpart</code></a> and a <a href="https://cran.r-project.org/package=glmnet"><code>glmnet</code></a> model. Additionally, we keep a version of the “level 0” output (via <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_nop.html"><code>PipeOpNOP</code></a>) and pass this on to “level 2”. In “level 2” we simply concatenate all “level 1” outputs and train a final decision tree.</p>
<p>In the following examples, use <code>&lt;lrn&gt;$param_set$values$&lt;param_name&gt; = &lt;param_value&gt;</code> to set hyperparameters for the different learner.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-054_f603f02f78e673a7e65c62a1b9a3ec7d">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>) <span class="co"># for classif.glmnet</span></span>
<span id="cb53-3"><a href="#cb53-3"></a></span>
<span id="cb53-4"><a href="#cb53-4"></a>rprt <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb53-5"><a href="#cb53-5"></a>glmn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.glmnet"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="co">#  Create Learner CV Operators</span></span>
<span id="cb53-8"><a href="#cb53-8"></a>lrn_0 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_1"</span>)</span>
<span id="cb53-9"><a href="#cb53-9"></a>lrn_0<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>maxdepth <span class="ot">=</span> 5L</span>
<span id="cb53-10"><a href="#cb53-10"></a>lrn_1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca1"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_2"</span>)</span>
<span id="cb53-11"><a href="#cb53-11"></a>lrn_1<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>rpart_cv_2.maxdepth <span class="ot">=</span> 1L</span>
<span id="cb53-12"><a href="#cb53-12"></a>lrn_2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca2"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, glmn)</span>
<span id="cb53-13"><a href="#cb53-13"></a></span>
<span id="cb53-14"><a href="#cb53-14"></a><span class="co"># Union them with a PipeOpNULL to keep original features</span></span>
<span id="cb53-15"><a href="#cb53-15"></a>level_0 <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(lrn_0, lrn_1, lrn_2, <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"NOP1"</span>)))</span>
<span id="cb53-16"><a href="#cb53-16"></a></span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="co"># Cbind the output 3 times, train 2 learners but also keep level</span></span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="co"># 0 predictions</span></span>
<span id="cb53-19"><a href="#cb53-19"></a>level_1 <span class="ot">=</span> level_0 <span class="sc">%&gt;&gt;%</span></span>
<span id="cb53-20"><a href="#cb53-20"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">4</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb53-21"><a href="#cb53-21"></a>  <span class="fu">po</span>(<span class="st">"copy"</span>, <span class="dv">3</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb53-22"><a href="#cb53-22"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb53-23"><a href="#cb53-23"></a>    <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_l1"</span>),</span>
<span id="cb53-24"><a href="#cb53-24"></a>    <span class="fu">po</span>(<span class="st">"learner_cv"</span>, glmn, <span class="at">id =</span> <span class="st">"glmnt_cv_l1"</span>),</span>
<span id="cb53-25"><a href="#cb53-25"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"NOP_l1"</span>)</span>
<span id="cb53-26"><a href="#cb53-26"></a>  ))</span>
<span id="cb53-27"><a href="#cb53-27"></a></span>
<span id="cb53-28"><a href="#cb53-28"></a><span class="co"># Cbind predictions, train a final learner</span></span>
<span id="cb53-29"><a href="#cb53-29"></a>level_2 <span class="ot">=</span> level_1 <span class="sc">%&gt;&gt;%</span></span>
<span id="cb53-30"><a href="#cb53-30"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"u2"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb53-31"><a href="#cb53-31"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_l2"</span>)</span>
<span id="cb53-32"><a href="#cb53-32"></a></span>
<span id="cb53-33"><a href="#cb53-33"></a><span class="co"># Plot the resulting graph</span></span>
<span id="cb53-34"><a href="#cb53-34"></a>level_2<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-054-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb54-2"><a href="#cb54-2"></a>lrn <span class="ot">=</span> <span class="fu">as_learner</span>(level_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can again call <code>.$train</code> and <code>.$predict</code>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-055_6edbbe3ff0a6f376c52033d9fa2f959a">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>lrn<span class="sc">$</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">train</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb55-3"><a href="#cb55-3"></a>  <span class="fu">predict</span>(task, test.idx)<span class="sc">$</span></span>
<span id="cb55-4"><a href="#cb55-4"></a>  <span class="fu">score</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
       0.1 </code></pre>
</div>
</div>
</section></section></section><section id="extending-pipeops" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="extending-pipeops">
<span class="header-section-number">6.6</span> Adding new PipeOps</h2>
<p>This section showcases how the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package can be extended to include custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. To run the following examples, we will need a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>; we are using the well-known “Iris” task:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-056_97d48775a95857bd22a7dd42fea9428b">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb57-2"><a href="#cb57-2"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb57-3"><a href="#cb57-3"></a>task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa          1.4         0.2          5.1         3.5
  2:    setosa          1.4         0.2          4.9         3.0
  3:    setosa          1.3         0.2          4.7         3.2
  4:    setosa          1.5         0.2          4.6         3.1
  5:    setosa          1.4         0.2          5.0         3.6
 ---                                                            
146: virginica          5.2         2.3          6.7         3.0
147: virginica          5.0         1.9          6.3         2.5
148: virginica          5.2         2.0          6.5         3.0
149: virginica          5.4         2.3          6.2         3.4
150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is fundamentally built around <a href="https://r6.r-lib.org/"><code>R6</code></a>. When planning to create custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html">familiarize yourself with it</a>.</p>
<p>In principle, all a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> must do is inherit from the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> R6 class and implement the <code>.train()</code> and <code>.predict()</code> functions. There are, however, several auxiliary subclasses that can make the creation of <em>certain</em> operations much easier.</p>
<section id="ext-pipeopcopy" class="level3" data-number="6.6.1"><h3 data-number="6.6.1" class="anchored" data-anchor-id="ext-pipeopcopy">
<span class="header-section-number">6.6.1</span> General Case Example: <code>PipeOpCopy</code>
</h3>
<p>A very simple yet useful <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is <code>PipeOpCopy</code>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data. It is a simple example that showcases the important steps in defining a custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. We will show a simplified version here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly two copies of its input data.</p>
<p>The following figure visualizes how our <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is situated in the <code>Pipeline</code> and the significant in- and outputs.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-057_23dc904bd2faa8109f25be81bf90cf6d">
<div class="cell-output-display">
<p><img src="Figures/po_multi_viz.png" class="img-fluid" width="430"></p>
</div>
</div>
<section id="first-steps-inheriting-from-pipeop" class="level4" data-number="6.6.1.1"><h4 data-number="6.6.1.1" class="anchored" data-anchor-id="first-steps-inheriting-from-pipeop">
<span class="header-section-number">6.6.1.1</span> First Steps: Inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>
</h4>
<p>The first part of creating a custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. We make a mental note that we need to implement a <code>.train()</code> and a <code>.predict()</code> function, and that we probably want to have an <code>initialize()</code> as well:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-058_3f025e485bcb21a0fca355778dcb3111">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb59-3"><a href="#cb59-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb59-4"><a href="#cb59-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb59-5"><a href="#cb59-5"></a>      ....</span>
<span id="cb59-6"><a href="#cb59-6"></a>    },</span>
<span id="cb59-7"><a href="#cb59-7"></a>  ),</span>
<span id="cb59-8"><a href="#cb59-8"></a>  private <span class="sc">==</span> <span class="fu">list</span>(</span>
<span id="cb59-9"><a href="#cb59-9"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb59-10"><a href="#cb59-10"></a>      ....</span>
<span id="cb59-11"><a href="#cb59-11"></a>    },</span>
<span id="cb59-12"><a href="#cb59-12"></a></span>
<span id="cb59-13"><a href="#cb59-13"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb59-14"><a href="#cb59-14"></a>      ....</span>
<span id="cb59-15"><a href="#cb59-15"></a>    }</span>
<span id="cb59-16"><a href="#cb59-16"></a>  )</span>
<span id="cb59-17"><a href="#cb59-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, that <strong>private</strong> methods, e.g.&nbsp;<code>.train</code> and <code>.predict</code> etc are prefixed with a <code>.</code>.</p>
</section><section id="channel-definitions" class="level4" data-number="6.6.1.2"><h4 data-number="6.6.1.2" class="anchored" data-anchor-id="channel-definitions">
<span class="header-section-number">6.6.1.2</span> Channel Definitions</h4>
<p>We need to tell the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable. This is done on initialization of the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> (using a <code>super$initialize</code> call) by giving the <code>input</code> and <code>output</code> <code>data.table</code> objects. These must have three columns: a <code>"name"</code> column giving the names of input and output channels, and a <code>"train"</code> and <code>"predict"</code> column naming the class of objects we expect during training and prediction as input / output. A special value for these classes is <code>"*"</code>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</p>
<p>By convention, we name a single channel <code>"input"</code> or <code>"output"</code>, and a group of channels [<code>"input1"</code>, <code>"input2"</code>, …], unless there is a reason to give specific different names. Therefore, our <code>input</code> <code>data.table</code> will have a single row <code>&lt;"input", "*", "*"&gt;</code>, and our <code>output</code> table will have two rows, <code>&lt;"output1", "*", "*"&gt;</code> and <code>&lt;"output2", "*", "*"&gt;</code>.</p>
<p>All of this is given to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> creator. Our <code>initialize()</code> will thus look as follows:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-059_2c9b025bacf649d2512829b544c580c0">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>initialize <span class="ot">=</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb60-2"><a href="#cb60-2"></a>  input <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span id="cb60-4"><a href="#cb60-4"></a>  <span class="co"># and `predict` cols with "*"</span></span>
<span id="cb60-5"><a href="#cb60-5"></a>  output <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb60-6"><a href="#cb60-6"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb60-7"><a href="#cb60-7"></a>    <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>  )</span>
<span id="cb60-9"><a href="#cb60-9"></a>  super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb60-10"><a href="#cb60-10"></a>    <span class="at">input =</span> input,</span>
<span id="cb60-11"><a href="#cb60-11"></a>    <span class="at">output =</span> output</span>
<span id="cb60-12"><a href="#cb60-12"></a>  )</span>
<span id="cb60-13"><a href="#cb60-13"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="train-and-predict" class="level4" data-number="6.6.1.3"><h4 data-number="6.6.1.3" class="anchored" data-anchor-id="train-and-predict">
<span class="header-section-number">6.6.1.3</span> Train and Predict</h4>
<p>Both <code>.train()</code> and <code>.predict()</code> will receive a <code>list</code> as input and must give a <code>list</code> in return. According to our <code>input</code> and <code>output</code> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <code>c(inputs, inputs)</code>.</p>
<p>Two things to consider:</p>
<ul>
<li><p>The <code>.train()</code> function must always modify the <code>self$state</code> variable to something that is not <code>NULL</code> or <code>NO_OP</code>. This is because the <code>$state</code> slot is used as a signal that <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> has been trained on data, even if the state itself is not important to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> (as in our case). Therefore, our <code>.train()</code> will set <code>self$state = list()</code>.</p></li>
<li><p>It is not necessary to “clone” our input or make deep copies, because we don’t modify the data. However, if we were changing a reference-passed object, for example by changing data in a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, we would have to make a deep copy first. This is because a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> may never modify its input object by reference.</p></li>
</ul>
<p>Our <code>.train()</code> and <code>.predict()</code> functions are now:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-060_0260fdeff74054a5deb1f644d5776bf1">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb61-2"><a href="#cb61-2"></a>  self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb61-3"><a href="#cb61-3"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb61-4"><a href="#cb61-4"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-061_18f050b2a866440ab7a872ff5918e8b4">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb62-2"><a href="#cb62-2"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb62-3"><a href="#cb62-3"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="putting-it-together" class="level4" data-number="6.6.1.4"><h4 data-number="6.6.1.4" class="anchored" data-anchor-id="putting-it-together">
<span class="header-section-number">6.6.1.4</span> Putting it Together</h4>
<p>The whole definition thus becomes</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-062_10dbf855b908f3bb0c0a0b00496f9085">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb63-4"><a href="#cb63-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb63-5"><a href="#cb63-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb63-6"><a href="#cb63-6"></a>        <span class="at">input =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>),</span>
<span id="cb63-7"><a href="#cb63-7"></a>        <span class="at">output =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb63-8"><a href="#cb63-8"></a>                            <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb63-9"><a href="#cb63-9"></a>      )</span>
<span id="cb63-10"><a href="#cb63-10"></a>    }</span>
<span id="cb63-11"><a href="#cb63-11"></a>  ),</span>
<span id="cb63-12"><a href="#cb63-12"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb63-13"><a href="#cb63-13"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb63-14"><a href="#cb63-14"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb63-15"><a href="#cb63-15"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb63-16"><a href="#cb63-16"></a>    },</span>
<span id="cb63-17"><a href="#cb63-17"></a></span>
<span id="cb63-18"><a href="#cb63-18"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb63-19"><a href="#cb63-19"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb63-20"><a href="#cb63-20"></a>    }</span>
<span id="cb63-21"><a href="#cb63-21"></a>  )</span>
<span id="cb63-22"><a href="#cb63-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can create an instance of our <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, put it in a graph, and see what happens when we train it on something:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-063_9f5d231d38894229e64b8e333e120408">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb64-2"><a href="#cb64-2"></a>poct <span class="ot">=</span> PipeOpCopyTwo<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb64-3"><a href="#cb64-3"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb64-4"><a href="#cb64-4"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(poct)</span>
<span id="cb64-5"><a href="#cb64-5"></a></span>
<span id="cb64-6"><a href="#cb64-6"></a><span class="fu">print</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 1 PipeOps:
       ID         State sccssors prdcssors
 copy.two &lt;&lt;UNTRAINED&gt;&gt;                   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb66-2"><a href="#cb66-2"></a></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="fu">str</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ copy.two.output1:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; 
 $ copy.two.output2:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; </code></pre>
</div>
</div>
</section></section><section id="ext-pipe-preproc" class="level3" data-number="6.6.2"><h3 data-number="6.6.2" class="anchored" data-anchor-id="ext-pipe-preproc">
<span class="header-section-number">6.6.2</span> Special Case: Preprocessing</h3>
<p>Many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s perform an operation on exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, and return exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. They may even not care about the “Target” / “Outcome” variable of that task, and only do some modification of some input data. However, it is usually important to them that the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> on which they perform prediction has the same data columns as the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> on which they train. For these cases, the auxiliary base class <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> exists. It inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> itself, and other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s should use it if they fall in the kind of use-case named above.</p>
<p>When inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one must either implement the private methods <code>.train_task()</code> and <code>.predict_task()</code>, or the methods <code>.train_dt()</code>, <code>.predict_dt()</code>, depending on whether wants to operate on a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> object or on its data as <code>data.table</code>s. In the second case, one can optionally also overload the <code>.select_cols()</code> method, which chooses which of the incoming <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s features are given to the <code>.train_dt()</code> / <code>.predict_dt()</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>, which removes a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s rows with missing values during training (and implements <code>.train_task()</code> and <code>.predict_task()</code>), and <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, which scales a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s numeric columns (and implements <code>.train_dt()</code>, <code>.predict_dt()</code>, and <code>.select_cols()</code>).</p>
<section id="example-pipeopdropna" class="level4" data-number="6.6.2.1"><h4 data-number="6.6.2.1" class="anchored" data-anchor-id="example-pipeopdropna">
<span class="header-section-number">6.6.2.1</span> Example: <code>PipeOpDropNA</code>
</h4>
<p>Dropping rows with missing values may be important when training a model that can not handle them.</p>
<p>Because <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <code>"Task", text = "Tasks")</code> only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values. Instead, the rows can be removed using the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s <code>$filter</code> method, which modifies the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> in-place. This is done in the private method <code>.train_task()</code>. We take care that we also set the <code>$state</code> slot to signal that the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> was trained.</p>
<p>The private method <code>.predict_task()</code> does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows. Furthermore, <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> expects a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> to always return just as many predictions as it was given input rows, so a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that removes <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> rows during training can not be used inside a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>.</p>
<p>When we inherit from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, it sets the <code>input</code> and <code>output</code> <code>data.table</code>s for us to only accept a single <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. The only thing we do during <code>initialize()</code> is therefore to set an <code>id</code> (which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as follows. Note that it inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-064_bbef8713003cd22d81a12674149d0172">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>PipeOpDropNA <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropNA"</span>,</span>
<span id="cb68-2"><a href="#cb68-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb68-3"><a href="#cb68-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb68-4"><a href="#cb68-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.na"</span>) {</span>
<span id="cb68-5"><a href="#cb68-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id)</span>
<span id="cb68-6"><a href="#cb68-6"></a>    }</span>
<span id="cb68-7"><a href="#cb68-7"></a>  ),</span>
<span id="cb68-8"><a href="#cb68-8"></a></span>
<span id="cb68-9"><a href="#cb68-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb68-10"><a href="#cb68-10"></a>    <span class="at">.train_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb68-11"><a href="#cb68-11"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb68-12"><a href="#cb68-12"></a>      featuredata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb68-13"><a href="#cb68-13"></a>      exclude <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">is.na</span>(featuredata), <span class="dv">1</span>, any)</span>
<span id="cb68-14"><a href="#cb68-14"></a>      task<span class="sc">$</span><span class="fu">filter</span>(task<span class="sc">$</span>row_ids[<span class="sc">!</span>exclude])</span>
<span id="cb68-15"><a href="#cb68-15"></a>    },</span>
<span id="cb68-16"><a href="#cb68-16"></a></span>
<span id="cb68-17"><a href="#cb68-17"></a>    <span class="at">.predict_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb68-18"><a href="#cb68-18"></a>      <span class="co"># nothing to be done</span></span>
<span id="cb68-19"><a href="#cb68-19"></a>      task</span>
<span id="cb68-20"><a href="#cb68-20"></a>    }</span>
<span id="cb68-21"><a href="#cb68-21"></a>  )</span>
<span id="cb68-22"><a href="#cb68-22"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To test this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, we create a small task with missing values:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-065_8088596e22106a5c4a14ceec2b33ca5d">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>smalliris <span class="ot">=</span> iris[(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">30</span>, ]</span>
<span id="cb69-2"><a href="#cb69-2"></a>smalliris[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb69-3"><a href="#cb69-3"></a>smalliris[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb69-4"><a href="#cb69-4"></a>sitask <span class="ot">=</span> <span class="fu">as_task_classif</span>(smalliris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb69-5"><a href="#cb69-5"></a><span class="fu">print</span>(sitask<span class="sc">$</span><span class="fu">data</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:     setosa          1.6         0.2           NA         3.2
2: versicolor          3.9         1.4          5.2          NA
3: versicolor          4.0         1.3          5.5         2.5
4:  virginica          5.0         1.5          6.0         2.2
5:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
<p>We test this by feeding it to a new <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that uses <code>PipeOpDropNA</code>.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-066_623366387628b458a2b4ddb2b374a6ca">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb71-2"><a href="#cb71-2"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropNA<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb71-3"><a href="#cb71-3"></a></span>
<span id="cb71-4"><a href="#cb71-4"></a>filtered_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(sitask)[[<span class="dv">1</span>]]</span>
<span id="cb71-5"><a href="#cb71-5"></a><span class="fu">print</span>(filtered_task<span class="sc">$</span><span class="fu">data</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1: versicolor          4.0         1.3          5.5         2.5
2:  virginica          5.0         1.5          6.0         2.2
3:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
</section><section id="example-pipeopscalealways" class="level4" data-number="6.6.2.2"><h4 data-number="6.6.2.2" class="anchored" data-anchor-id="example-pipeopscalealways">
<span class="header-section-number">6.6.2.2</span> Example: <code>PipeOpScaleAlways</code>
</h4>
<p>An often-applied preprocessing step is to simply <strong>center</strong> and/or <strong>scale</strong> the data to mean <span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>. This fits the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> pattern quite well. Because it always replaces all columns that it operates on, and does not require any information about the task’s target, it only needs to overload the <code>.train_dt()</code> and <code>.predict_dt()</code> functions. This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to instruct <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> to give us only these numeric columns. We do this by overloading the <code>.select_cols()</code> function: It is called by the class to determine which columns to pass to <code>.train_dt()</code> and <code>.predict_dt()</code>. Its input is the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> that is being transformed, and it should return a <code>character</code> vector of all features to work with. When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns. Because the <code><a href="https://rdrr.io/r/base/levels.html">levels()</a></code> of the data table given to <code>.train_dt()</code> and <code>.predict_dt()</code> may be different from the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s levels, these functions must also take a <code>levels</code> argument that is a named list of column names indicating their levels. When working with numeric data, this argument can be ignored, but it should be used instead of <code>levels(dt[[column]])</code> for factorial or character columns.</p>
<p>This is the first <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> where we will be using the <code>$state</code> slot for something useful: We save the centering offset and scaling coefficient and use it in <code>$.predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always scale and center all data. Compare this <code>PipeOpScaleAlways</code> operator to the one defined inside the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package, <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-067_7a2f57aadb949ff6c7fe396104a79c37">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>PipeOpScaleAlways <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlways"</span>,</span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb73-3"><a href="#cb73-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb73-4"><a href="#cb73-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always"</span>) {</span>
<span id="cb73-5"><a href="#cb73-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb73-6"><a href="#cb73-6"></a>    }</span>
<span id="cb73-7"><a href="#cb73-7"></a>  ),</span>
<span id="cb73-8"><a href="#cb73-8"></a></span>
<span id="cb73-9"><a href="#cb73-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb73-10"><a href="#cb73-10"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb73-11"><a href="#cb73-11"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb73-12"><a href="#cb73-12"></a>    },</span>
<span id="cb73-13"><a href="#cb73-13"></a></span>
<span id="cb73-14"><a href="#cb73-14"></a>    <span class="at">.train_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb73-15"><a href="#cb73-15"></a>      sc <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">as.matrix</span>(dt))</span>
<span id="cb73-16"><a href="#cb73-16"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb73-17"><a href="#cb73-17"></a>        <span class="at">center =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:center"</span>),</span>
<span id="cb73-18"><a href="#cb73-18"></a>        <span class="at">scale =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:scale"</span>)</span>
<span id="cb73-19"><a href="#cb73-19"></a>      )</span>
<span id="cb73-20"><a href="#cb73-20"></a>      sc</span>
<span id="cb73-21"><a href="#cb73-21"></a>    },</span>
<span id="cb73-22"><a href="#cb73-22"></a></span>
<span id="cb73-23"><a href="#cb73-23"></a>    <span class="at">.predict_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb73-24"><a href="#cb73-24"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb73-25"><a href="#cb73-25"></a>    }</span>
<span id="cb73-26"><a href="#cb73-26"></a>  )</span>
<span id="cb73-27"><a href="#cb73-27"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code> from the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package, you will notice that is uses “<code>get("type")</code>” and “<code>get("id")</code>” instead of “<code>type</code>” and “<code>id</code>”, because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a “problem” with <code>data.table</code> and not exclusive to <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>.)</em></p>
<p>We can, again, create a new <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that uses this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to test it. Compare the resulting data to the original “iris” <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> data printed at the beginning:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-068_783612153171c11c8ed6daeb8d50a8f0">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb74-2"><a href="#cb74-2"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb74-3"><a href="#cb74-3"></a></span>
<span id="cb74-4"><a href="#cb74-4"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb74-5"><a href="#cb74-5"></a></span>
<span id="cb74-6"><a href="#cb74-6"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
</section></section><section id="special-case-preprocessing-with-simple-train" class="level3" data-number="6.6.3"><h3 data-number="6.6.3" class="anchored" data-anchor-id="special-case-preprocessing-with-simple-train">
<span class="header-section-number">6.6.3</span> Special Case: Preprocessing with Simple Train</h3>
<p>It is possible to make even further simplifications for many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s that perform mostly the same operation during training and prediction. The point of <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level. However, what features get removed must be decided during <em>training</em>, and may only depend on training data. Furthermore, the actual process of removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a private method <code>.get_state(task)</code> which sets the <code>$state</code> slot during training, and a private method <code>.transform(task)</code>, which gets called both during training <em>and</em> prediction. This is done in the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> class. Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one can inherit from this and overload these functions to get a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that performs preprocessing with very little boilerplate code.</p>
<p>Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> offers the possibility to instead overload the <code>.get_state_dt(dt, levels)</code> and <code>.transform_dt(dt, levels)</code> methods (and optionally, again, the <code>.select_cols(task)</code> function) to operate on <code>data.table</code> feature data instead of the whole <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>.</p>
<p>Even some methods that do not use <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> <em>could</em> work in a similar way: The <code>PipeOpScaleAlways</code> example from above will be shown to also work with this paradigm.</p>
<section id="example-pipeopdropconst" class="level4" data-number="6.6.3.1"><h4 data-number="6.6.3.1" class="anchored" data-anchor-id="example-pipeopdropconst">
<span class="header-section-number">6.6.3.1</span> Example: <code>PipeOpDropConst</code>
</h4>
<p>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training. One simple example of this is dropping constant features. Because the <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <code>$select()</code> function, so the <code>.get_state_dt(dt, levels)</code> / <code>.transform_dt(dt, levels)</code> functions will <em>not</em> get used; instead we overload the <code>.get_state(task)</code> and <code>.transform(task)</code> methods.</p>
<p>The <code>.get_state()</code> function’s result is saved to the <code>$state</code> slot, so we want to return something that is useful for dropping features. We choose to save the names of all the columns that have nonzero variance. For brevity, we use <code>length(unique(column)) &gt; 1</code> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</p>
<p>The <code>.transform()</code> method is evaluated both during training <em>and</em> prediction, and can rely on the <code>$state</code> slot being present. All it does here is call the <code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> could be written as follows:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-069_fb0cba11f3efadbfdc87ab393697a6dc">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>PipeOpDropConst <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropConst"</span>,</span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb76-4"><a href="#cb76-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.const"</span>) {</span>
<span id="cb76-5"><a href="#cb76-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb76-6"><a href="#cb76-6"></a>    }</span>
<span id="cb76-7"><a href="#cb76-7"></a>  ),</span>
<span id="cb76-8"><a href="#cb76-8"></a></span>
<span id="cb76-9"><a href="#cb76-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb76-10"><a href="#cb76-10"></a>    <span class="at">.get_state =</span> <span class="cf">function</span>(task) {</span>
<span id="cb76-11"><a href="#cb76-11"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb76-12"><a href="#cb76-12"></a>      nonconst <span class="ot">=</span> <span class="fu">sapply</span>(data, <span class="cf">function</span>(column) <span class="fu">length</span>(<span class="fu">unique</span>(column)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb76-13"><a href="#cb76-13"></a>      <span class="fu">list</span>(<span class="at">cnames =</span> <span class="fu">colnames</span>(data)[nonconst])</span>
<span id="cb76-14"><a href="#cb76-14"></a>    },</span>
<span id="cb76-15"><a href="#cb76-15"></a></span>
<span id="cb76-16"><a href="#cb76-16"></a>    <span class="at">.transform =</span> <span class="cf">function</span>(task) {</span>
<span id="cb76-17"><a href="#cb76-17"></a>      task<span class="sc">$</span><span class="fu">select</span>(self<span class="sc">$</span>state<span class="sc">$</span>cnames)</span>
<span id="cb76-18"><a href="#cb76-18"></a>    }</span>
<span id="cb76-19"><a href="#cb76-19"></a>  )</span>
<span id="cb76-20"><a href="#cb76-20"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This can be tested using the first five rows of the “Iris” <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, for which one feature (<code>"Petal.Width"</code>) is constant:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-070_1e4116072dba0cd6b5ab90a76be49f70">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>irishead <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb77-2"><a href="#cb77-2"></a>irishead<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa          1.4         0.2          5.1         3.5
2:  setosa          1.4         0.2          4.9         3.0
3:  setosa          1.3         0.2          4.7         3.2
4:  setosa          1.5         0.2          4.6         3.1
5:  setosa          1.4         0.2          5.0         3.6</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-071_5a067e5d7e28a961c2c195d66be9f7b4">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropConst<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb79-2"><a href="#cb79-2"></a>dropped_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(irishead)[[<span class="dv">1</span>]]</span>
<span id="cb79-3"><a href="#cb79-3"></a></span>
<span id="cb79-4"><a href="#cb79-4"></a>dropped_task<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Sepal.Length Sepal.Width
1:  setosa          1.4          5.1         3.5
2:  setosa          1.4          4.9         3.0
3:  setosa          1.3          4.7         3.2
4:  setosa          1.5          4.6         3.1
5:  setosa          1.4          5.0         3.6</code></pre>
</div>
</div>
<p>We can also see that the <code>$state</code> was correctly set. Calling <code>$.predict()</code> with this graph, even with different data (the whole Iris <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>!) will still drop the <code>"Petal.Width"</code> column, as it should.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-072_56c5ce49667bada602955679be98a3c2">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>gr<span class="sc">$</span>pipeops<span class="sc">$</span>drop.const<span class="sc">$</span>state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$cnames
[1] "Petal.Length" "Sepal.Length" "Sepal.Width" 

$affected_cols
[1] "Petal.Length" "Petal.Width"  "Sepal.Length" "Sepal.Width" 

$intasklayout
             id    type
1: Petal.Length numeric
2:  Petal.Width numeric
3: Sepal.Length numeric
4:  Sepal.Width numeric

$outtasklayout
             id    type
1: Petal.Length numeric
2: Sepal.Length numeric
3:  Sepal.Width numeric

$outtaskshell
Empty data.table (0 rows and 4 cols): Species,Petal.Length,Sepal.Length,Sepal.Width</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-073_8a46b14b07a951d51b612e2a68599e06">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>dropped_predict <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb83-2"><a href="#cb83-2"></a></span>
<span id="cb83-3"><a href="#cb83-3"></a>dropped_predict<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Sepal.Length Sepal.Width
  1:    setosa          1.4          5.1         3.5
  2:    setosa          1.4          4.9         3.0
  3:    setosa          1.3          4.7         3.2
  4:    setosa          1.5          4.6         3.1
  5:    setosa          1.4          5.0         3.6
 ---                                                
146: virginica          5.2          6.7         3.0
147: virginica          5.0          6.3         2.5
148: virginica          5.2          6.5         3.0
149: virginica          5.4          6.2         3.4
150: virginica          5.1          5.9         3.0</code></pre>
</div>
</div>
</section><section id="example-pipeopscalealwayssimple" class="level4" data-number="6.6.3.2"><h4 data-number="6.6.3.2" class="anchored" data-anchor-id="example-pipeopscalealwayssimple">
<span class="header-section-number">6.6.3.2</span> Example: <code>PipeOpScaleAlwaysSimple</code>
</h4>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can be used when only working on feature data in form of a <code>data.table</code>. Instead of calling the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function, the <code>center</code> and <code>scale</code> values are calculated directly and saved to the <code>$state</code> slot. The <code>.transform_dt()</code> function will then perform the same operation during both training and prediction: subtract the <code>center</code> and divide by the <code>scale</code> value. As in the <a href="#example-pipeopscalealways"><code>PipeOpScaleAlways</code> example above</a>, we use <code>.select_cols()</code> so that we only work on numeric columns.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-074_3bada064bc8ff85688dee1ef92483a29">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>PipeOpScaleAlwaysSimple <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlwaysSimple"</span>,</span>
<span id="cb85-2"><a href="#cb85-2"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb85-3"><a href="#cb85-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb85-4"><a href="#cb85-4"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always.simple"</span>) {</span>
<span id="cb85-5"><a href="#cb85-5"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb85-6"><a href="#cb85-6"></a>    }</span>
<span id="cb85-7"><a href="#cb85-7"></a>  ),</span>
<span id="cb85-8"><a href="#cb85-8"></a></span>
<span id="cb85-9"><a href="#cb85-9"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb85-10"><a href="#cb85-10"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb85-11"><a href="#cb85-11"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb85-12"><a href="#cb85-12"></a>    },</span>
<span id="cb85-13"><a href="#cb85-13"></a></span>
<span id="cb85-14"><a href="#cb85-14"></a>    <span class="at">.get_state_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb85-15"><a href="#cb85-15"></a>      <span class="fu">list</span>(</span>
<span id="cb85-16"><a href="#cb85-16"></a>        <span class="at">center =</span> <span class="fu">sapply</span>(dt, mean),</span>
<span id="cb85-17"><a href="#cb85-17"></a>        <span class="at">scale =</span> <span class="fu">sapply</span>(dt, sd)</span>
<span id="cb85-18"><a href="#cb85-18"></a>      )</span>
<span id="cb85-19"><a href="#cb85-19"></a>    },</span>
<span id="cb85-20"><a href="#cb85-20"></a></span>
<span id="cb85-21"><a href="#cb85-21"></a>    <span class="at">.transform_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb85-22"><a href="#cb85-22"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb85-23"><a href="#cb85-23"></a>    }</span>
<span id="cb85-24"><a href="#cb85-24"></a>  )</span>
<span id="cb85-25"><a href="#cb85-25"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can compare this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to the one above to show that it behaves the same.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-075_2fac58bc6b2afbd5deb0ab5fe7845e4f">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb86-2"><a href="#cb86-2"></a>result_posa <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb86-3"><a href="#cb86-3"></a></span>
<span id="cb86-4"><a href="#cb86-4"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb86-5"><a href="#cb86-5"></a>result_posa_simple <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-076_06a50bf6b2cb5b7373c71e278de5c8d0">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>result_posa<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-077_f776c436a316a0e6a5f3eab8f7248577">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a>result_posa_simple<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa   -1.3357516  -1.3110521  -0.89767388  1.01560199
  2:    setosa   -1.3357516  -1.3110521  -1.13920048 -0.13153881
  3:    setosa   -1.3923993  -1.3110521  -1.38072709  0.32731751
  4:    setosa   -1.2791040  -1.3110521  -1.50149039  0.09788935
  5:    setosa   -1.3357516  -1.3110521  -1.01843718  1.24503015
 ---                                                            
146: virginica    0.8168591   1.4439941   1.03453895 -0.13153881
147: virginica    0.7035638   0.9192234   0.55148575 -1.27867961
148: virginica    0.8168591   1.0504160   0.79301235 -0.13153881
149: virginica    0.9301544   1.4439941   0.43072244  0.78617383
150: virginica    0.7602115   0.7880307   0.06843254 -0.13153881</code></pre>
</div>
</div>
</section></section><section id="ext-pipe-hyperpars" class="level3" data-number="6.6.4"><h3 data-number="6.6.4" class="anchored" data-anchor-id="ext-pipe-hyperpars">
<span class="header-section-number">6.6.4</span> Hyperparameters</h3>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> uses the <a href="https://paradox.mlr-org.com">[<code>paradox</code>](https://paradox.mlr-org.com)</a> package to define parameter spaces for <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. Parameters for <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s can modify their behavior in certain ways, e.g.&nbsp;switch centering or scaling off in the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> operator. The unified interface makes it possible to have parameters for whole <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s that modify the individual <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s behavior. The <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s, when encapsulated in <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>s, can even be tuned using the tuning functionality in <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>.</p>
<p>Hyperparameters are declared during initialization, when calling the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s <code>$initialize()</code> function, by giving a <code>param_set</code> argument. The <code>param_set</code> must be a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> from the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package; see <a href="#searchspace">the tuning chapter</a> or <a href="technical.html#sec-paradox"><span>Section&nbsp;9.4</span></a> for more information on how to define parameter spaces. After construction, the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> can be accessed through the <code>$param_set</code> slot. While it is <em>possible</em> to modify this <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a>, using e.g.&nbsp;the <code>$add()</code> and <code>$add_dep()</code> functions, <em>after</em> adding it to the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the <code>$values</code> slot. When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <code>$param_set</code>, so it is not necessary to type check them. Be aware that it is always possible to <em>remove</em> hyperparameter values.</p>
<p>When a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is initialized, it usually does not have any parameter values—<code>$values</code> takes the value <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>. It is possible to set initial parameter values in the <code>$initialize()</code> constructor; this must be done <em>after</em> the <code>super$initialize()</code> call where the corresponding <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> must be supplied. This is because setting <code>$values</code> checks against the current <code>$param_set</code>, which would fail if the <code>$param_set</code> was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code> function in <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, say), then there is usually a “default” behaviour of that function when a parameter is not given. It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed). This can easily be done when using the <a href="https://mlr3misc.mlr-org.com"><code>mlr3misc</code></a> library’s <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> function, which has functionality similar to <code>"do.call()"</code>.</p>
<section id="hyperparameter-example-pipeopscale" class="level4" data-number="6.6.4.1"><h4 data-number="6.6.4.1" class="anchored" data-anchor-id="hyperparameter-example-pipeopscale">
<span class="header-section-number">6.6.4.1</span> Hyperparameter Example: <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>
</h4>
<p>How to use hyperparameters can best be shown through the example of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, which is very similar to the example above, <code>PipeOpScaleAlways</code>. The difference is made by the presence of hyperparameters. <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> constructs a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> in its <code>$initialize</code> function and passes this on to the <code>super$initialize</code> function:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-078_4174225591788868d453bf84a90cd1b4">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>PipeOpScale<span class="sc">$</span>public_methods<span class="sc">$</span>initialize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (id = "scale", param_vals = list()) 
.__PipeOpScale__initialize(self = self, private = private, super = super, 
    id = id, param_vals = param_vals)
&lt;environment: namespace:mlr3pipelines&gt;</code></pre>
</div>
</div>
<p>The user has access to this and can set and get parameters. Types are automatically checked:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-079_2f07b12f4fe8ba9518dc0b967c4e7d3d">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a>pss <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb93-2"><a href="#cb93-2"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet:scale&gt;
               id    class lower upper nlevels        default value
1:         center ParamLgl    NA    NA       2           TRUE      
2:          scale ParamLgl    NA    NA       2           TRUE      
3:         robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt; FALSE
4: affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;      </code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-080_dced840f19cbc3795c18817dc2901f25">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb95-2"><a href="#cb95-2"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set<span class="sc">$</span>values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$robust
[1] FALSE

$center
[1] FALSE</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-081_4155a7ba8fbf358b05255699d2517d8c">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="st">"TRUE"</span> <span class="co"># bad input is checked!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in self$assert(xs): Assertion on 'xs' failed: scale: Must be of type 'logical flag', not 'character'.</code></pre>
</div>
</div>
<p>How <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> handles its parameters can be seen in its <code>$.train_dt</code> method: It gets the relevant parameters from its <code>$values</code> slot and uses them in the <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> call. This has the advantage over calling <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> directly that if a parameter is not given, its default value from the <code>"scale()"</code> function will be used.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-082_a91d8cc011e0250a85f58e1f43778c6c">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>PipeOpScale<span class="sc">$</span>private_methods<span class="sc">$</span>.train_dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (dt, levels, target) 
.__PipeOpScale__.train_dt(self = self, private = private, super = super, 
    dt = dt, levels = levels, target = target)
&lt;environment: namespace:mlr3pipelines&gt;</code></pre>
</div>
</div>
<p>Another change that is necessary compared to <code>PipeOpScaleAlways</code> is that the attributes <code>"scaled:scale"</code> and <code>"scaled:center"</code> are not always present, depending on parameters, and possibly need to be set to default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> with both <code>scale</code> and <code>center</code> set to <code>FALSE</code>, which returns the original dataset, unchanged.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-083_8f6f47fb40bd3bbbc7447bd786151190">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb101-2"><a href="#cb101-2"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb101-3"><a href="#cb101-3"></a></span>
<span id="cb101-4"><a href="#cb101-4"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb101-5"><a href="#cb101-5"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(pss)</span>
<span id="cb101-6"><a href="#cb101-6"></a></span>
<span id="cb101-7"><a href="#cb101-7"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb101-8"><a href="#cb101-8"></a></span>
<span id="cb101-9"><a href="#cb101-9"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa          1.4         0.2          5.1         3.5
  2:    setosa          1.4         0.2          4.9         3.0
  3:    setosa          1.3         0.2          4.7         3.2
  4:    setosa          1.5         0.2          4.6         3.1
  5:    setosa          1.4         0.2          5.0         3.6
 ---                                                            
146: virginica          5.2         2.3          6.7         3.0
147: virginica          5.0         1.9          6.3         2.5
148: virginica          5.2         2.0          6.5         3.0
149: virginica          5.4         2.3          6.2         3.4
150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
</section></section></section><section id="pipe-special-ops" class="level2" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="pipe-special-ops">
<span class="header-section-number">6.7</span> Special Operators</h2>
<p>This section introduces some special operators, that might be useful in numerous further applications.</p>
<section id="imputation-pipeopimpute" class="level3" data-number="6.7.1"><h3 data-number="6.7.1" class="anchored" data-anchor-id="imputation-pipeopimpute">
<span class="header-section-number">6.7.1</span> Imputation: <code>PipeOpImpute</code>
</h3>
<p>Often you will be using data sets that have missing values. There are many methods of dealing with this issue, from relatively simple imputation using either&nbsp;mean,&nbsp;median&nbsp;or histograms to way more involved methods including using machine learning algorithms in order to predict missing values. These methods are called imputation.</p>
<p>The following <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpImpute.html"><code>PipeOpImpute</code></a>:</p>
<ul>
<li>Add an indicator column marking whether a value for a given feature was missing or not (numeric only)</li>
<li>Impute numeric values from a histogram</li>
<li>Impute categorical values using a learner</li>
<li>We use <code>po("featureunion")</code> and <code>po("nop")</code> to cbind the missing indicator features. In other words to combine the indicator columns with the rest of the data.</li>
</ul>
<div class="cell" data-hash="pipelines_cache/html/pipelines-085_25169533c1540c88f2f7b177333ad796">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a><span class="co"># Imputation example</span></span>
<span id="cb103-2"><a href="#cb103-2"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb103-3"><a href="#cb103-3"></a>task<span class="sc">$</span><span class="fu">missings</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       species     bill_depth    bill_length      body_mass flipper_length 
             0              2              2              2              2 
        island            sex           year 
             0             11              0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a><span class="co"># Add missing indicator columns ("dummy columns") to the Task</span></span>
<span id="cb105-2"><a href="#cb105-2"></a>pom <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"missind"</span>)</span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="co"># Simply pushes the input forward</span></span>
<span id="cb105-4"><a href="#cb105-4"></a>nop <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"nop"</span>)</span>
<span id="cb105-5"><a href="#cb105-5"></a><span class="co"># Imputes numerical features by histogram.</span></span>
<span id="cb105-6"><a href="#cb105-6"></a>pon <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputehist"</span>, <span class="at">id =</span> <span class="st">"imputer_num"</span>)</span>
<span id="cb105-7"><a href="#cb105-7"></a><span class="co"># combines features (used here to add indicator columns to original data)</span></span>
<span id="cb105-8"><a href="#cb105-8"></a>pou <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>)</span>
<span id="cb105-9"><a href="#cb105-9"></a><span class="co"># Impute categorical features by fitting a Learner ("classif.rpart") for each feature.</span></span>
<span id="cb105-10"><a href="#cb105-10"></a>pof <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputelearner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>), <span class="at">id =</span> <span class="st">"imputer_fct"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we construct the graph.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-086_e72afe8de3b7223289de227852396000">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a>impgraph <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb106-2"><a href="#cb106-2"></a>  pom,</span>
<span id="cb106-3"><a href="#cb106-3"></a>  nop</span>
<span id="cb106-4"><a href="#cb106-4"></a>) <span class="sc">%&gt;&gt;%</span> pou <span class="sc">%&gt;&gt;%</span> pof <span class="sc">%&gt;&gt;%</span> pon</span>
<span id="cb106-5"><a href="#cb106-5"></a></span>
<span id="cb106-6"><a href="#cb106-6"></a>impgraph<span class="sc">$</span><span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-086-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we get the new task and we can see that all of the missing values have been imputed.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-087_adafe4961b78db18909d7911f289e673">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a>new_task <span class="ot">=</span> impgraph<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb107-2"><a href="#cb107-2"></a></span>
<span id="cb107-3"><a href="#cb107-3"></a>new_task<span class="sc">$</span><span class="fu">missings</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               species     missing_bill_depth    missing_bill_length 
                     0                      0                      0 
     missing_body_mass missing_flipper_length                 island 
                     0                      0                      0 
                  year                    sex             bill_depth 
                     0                      0                      0 
           bill_length              body_mass         flipper_length 
                     0                      0                      0 </code></pre>
</div>
</div>
<p>A learner can thus be equipped with automatic imputation of missing values by adding an imputation Pipeop.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-088_9f238d0b56abc1412f9943404abd5819">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a>polrn <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb109-2"><a href="#cb109-2"></a>lrn <span class="ot">=</span> <span class="fu">as_learner</span>(impgraph <span class="sc">%&gt;&gt;%</span> polrn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="feature-engineering-pipeopmutate" class="level3" data-number="6.7.2"><h3 data-number="6.7.2" class="anchored" data-anchor-id="feature-engineering-pipeopmutate">
<span class="header-section-number">6.7.2</span> Feature Engineering: <code>PipeOpMutate</code>
</h3>
<p>New features can be added or computed from a task using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_mutate.html"><code>PipeOpMutate</code></a> . The operator evaluates one or multiple expressions provided in an <code>alist</code>. In this example, we compute some new features on top of the <code>iris</code> task. Then we add them to the data as illustrated below:</p>
<p><code>iris</code> dataset looks like this:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-089_02dd4b8ed7109af7065d3d327bdb8c7b">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a>task <span class="ot">=</span> task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb110-2"><a href="#cb110-2"></a><span class="fu">head</span>(<span class="fu">as.data.table</span>(task))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa          1.4         0.2          5.1         3.5
2:  setosa          1.4         0.2          4.9         3.0
3:  setosa          1.3         0.2          4.7         3.2
4:  setosa          1.5         0.2          4.6         3.1
5:  setosa          1.4         0.2          5.0         3.6
6:  setosa          1.7         0.4          5.4         3.9</code></pre>
</div>
</div>
<p>Once we do the mutations, you can see the new columns:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-090_e1502d1aae0297133a8d009947d7015d">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a>pom <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb112-2"><a href="#cb112-2"></a></span>
<span id="cb112-3"><a href="#cb112-3"></a><span class="co"># Define a set of mutations</span></span>
<span id="cb112-4"><a href="#cb112-4"></a>mutations <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb112-5"><a href="#cb112-5"></a>  <span class="at">Sepal.Sum =</span> <span class="sc">~</span> Sepal.Length <span class="sc">+</span> Sepal.Width,</span>
<span id="cb112-6"><a href="#cb112-6"></a>  <span class="at">Petal.Sum =</span> <span class="sc">~</span> Petal.Length <span class="sc">+</span> Petal.Width,</span>
<span id="cb112-7"><a href="#cb112-7"></a>  <span class="at">Sepal.Petal.Ratio =</span> <span class="sc">~</span> (Sepal.Length <span class="sc">/</span> Petal.Length)</span>
<span id="cb112-8"><a href="#cb112-8"></a>)</span>
<span id="cb112-9"><a href="#cb112-9"></a>pom<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>mutation <span class="ot">=</span> mutations</span>
<span id="cb112-10"><a href="#cb112-10"></a></span>
<span id="cb112-11"><a href="#cb112-11"></a>new_task <span class="ot">=</span> pom<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(task))[[<span class="dv">1</span>]]</span>
<span id="cb112-12"><a href="#cb112-12"></a><span class="fu">head</span>(<span class="fu">as.data.table</span>(new_task))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width Sepal.Sum
1:  setosa          1.4         0.2          5.1         3.5       8.6
2:  setosa          1.4         0.2          4.9         3.0       7.9
3:  setosa          1.3         0.2          4.7         3.2       7.9
4:  setosa          1.5         0.2          4.6         3.1       7.7
5:  setosa          1.4         0.2          5.0         3.6       8.6
6:  setosa          1.7         0.4          5.4         3.9       9.3
2 variables not shown: [Petal.Sum, Sepal.Petal.Ratio]</code></pre>
</div>
</div>
<p>If outside data is required, we can make use of the <code>env</code> parameter. Moreover, we provide an environment, where expressions are evaluated (<code>env</code> defaults to <code>.GlobalEnv</code>).</p>
</section><section id="training-on-data-subsets-pipeopchunk" class="level3" data-number="6.7.3"><h3 data-number="6.7.3" class="anchored" data-anchor-id="training-on-data-subsets-pipeopchunk">
<span class="header-section-number">6.7.3</span> Training on data subsets: <code>PipeOpChunk</code>
</h3>
<p>In cases, where data is too big to fit into the machine’s memory, an often-used technique is to split the data into several parts. Subsequently, the parts are trained on each part of the data.</p>
<p>After undertaking these steps, we aggregate the models. In this example, we split our data into 4 parts using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_chunk.html"><code>PipeOpChunk</code></a> . Additionally, we create 4 <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a> POS, which are then trained on each split of the data.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-091_e609d14b71b6b53dfe02b5bd67d99a6b">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a>chks <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"chunk"</span>, <span class="dv">4</span>)</span>
<span id="cb114-2"><a href="#cb114-2"></a>lrns <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"greplicate"</span>, <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards we can use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_classifavg.html"><code>PipeOpClassifAvg</code></a> to aggregate the predictions from the 4 different models into a new one.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-092_4e06d6e29b55350af575cbc4a1ec4c55">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a>mjv <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"classifavg"</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now connect the different operators and visualize the full graph:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-093_12f886f7efffb42635351221ce8bb761">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1"></a>pipeline <span class="ot">=</span> chks <span class="sc">%&gt;&gt;%</span> lrns <span class="sc">%&gt;&gt;%</span> mjv</span>
<span id="cb116-2"><a href="#cb116-2"></a>pipeline<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-093-1.png" class="img-fluid" width="720"></p>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-094_c04618c1817d6e9dc27de7d7bb925390">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb117-2"><a href="#cb117-2"></a>train.idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), <span class="dv">120</span>)</span>
<span id="cb117-3"><a href="#cb117-3"></a>test.idx <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train.idx)</span>
<span id="cb117-4"><a href="#cb117-4"></a></span>
<span id="cb117-5"><a href="#cb117-5"></a>pipelrn <span class="ot">=</span> <span class="fu">as_learner</span>(pipeline)</span>
<span id="cb117-6"><a href="#cb117-6"></a>pipelrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb117-7"><a href="#cb117-7"></a>  <span class="fu">predict</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb117-8"><a href="#cb117-8"></a>  <span class="fu">score</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
 0.2083333 </code></pre>
</div>
</div>
</section><section id="feature-selection-pipeopfilter-and-pipeopselect" class="level3" data-number="6.7.4"><h3 data-number="6.7.4" class="anchored" data-anchor-id="feature-selection-pipeopfilter-and-pipeopselect">
<span class="header-section-number">6.7.4</span> Feature Selection: <code>PipeOpFilter</code> and <code>PipeOpSelect</code>
</h3>
<p>The package <a href="https://mlr3filters.mlr-org.com"><code>mlr3filters</code></a> contains many different <code>"mlr3filters::Filter")</code>s that can be used to select features for subsequent learners. This is often required when the data has a large amount of features.</p>
<p>A <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> for filters is <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_filter.html"><code>PipeOpFilter</code></a>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-095_cd2b12efbc0c30e999dc2dfaf303fb40">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a><span class="fu">po</span>(<span class="st">"filter"</span>, mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"information_gain"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;information_gain&gt; (not trained)
values: &lt;list()&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<p>How many features to keep can be set using <code>filter_nfeat</code>, <code>filter_frac</code> and <code>filter_cutoff</code>.</p>
<p>Filters can be selected / de-selected by name using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_select.html"><code>PipeOpSelect</code></a>.</p>
</section></section><section id="in-depth-pipelines" class="level2 page-columns page-full" data-number="6.8"><h2 data-number="6.8" class="anchored" data-anchor-id="in-depth-pipelines">
<span class="header-section-number">6.8</span> In-depth look into mlr3pipelines</h2>
<p>This vignette is an in-depth introduction to <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>, the dataflow programming toolkit for machine learning in <code>R</code> using <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>. It will go through basic concepts and then give a few examples that both show the simplicity as well as the power and versatility of using <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>.</p>
<section id="whats-the-point" class="level3" data-number="6.8.1"><h3 data-number="6.8.1" class="anchored" data-anchor-id="whats-the-point">
<span class="header-section-number">6.8.1</span> What’s the Point</h3>
<p>Machine learning toolkits often try to abstract away the processes happening inside machine learning algorithms. This makes it easy for the user to switch out one algorithm for another without having to worry about what is happening inside it, what kind of data it is able to operate on etc. The benefit of using <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>, for example, is that one can create a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>, a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, a <a href="https://mlr3.mlr-org.com/reference/Resampling.html"><code>Resampling</code></a> etc. and use them for typical machine learning operations. It is trivial to exchange individual components and therefore use, for example, a different <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> in the same experiment for comparison.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-097_4598730ea23fbf8004214bd61724f9f0">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif</span>(iris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb121-2"><a href="#cb121-2"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb121-3"><a href="#cb121-3"></a>rsmp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb121-4"><a href="#cb121-4"></a><span class="fu">resample</span>(task, lrn, rsmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResampleResult&gt; of 1 iterations
* Task: iris
* Learner: classif.rpart
* Warnings: 0 in 0 iterations
* Errors: 0 in 0 iterations</code></pre>
</div>
</div>
<p>However, this modularity breaks down as soon as the learning algorithm encompasses more than just model fitting, like data preprocessing, ensembles or other meta models. <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> takes modularity one step further than <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>: it makes it possible to build individual steps within a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> out of building blocks called <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s.</p>
</section><section id="pipeop-pipeline-operators" class="level3" data-number="6.8.2"><h3 data-number="6.8.2" class="anchored" data-anchor-id="pipeop-pipeline-operators">
<span class="header-section-number">6.8.2</span> <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>: Pipeline Operators</h3>
<p>The most basic unit of functionality within <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, short for “pipeline operator”, which represents a trans-formative operation on input (for example a training dataset) leading to output. It can therefore be seen as a generalized notion of a function, with a certain twist: <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s behave differently during a “training phase” and a “prediction phase”. The training phase will typically generate a certain model of the data that is saved as internal state. The prediction phase will then operate on the input data depending on the trained model.</p>
<p>An example of this behavior is the <em>principal component analysis</em> operation (“<a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html"><code>PipeOpPCA</code></a>”): During training, it will transform incoming data by rotating it in a way that leads to uncorrelated features ordered by their contribution to total variance. It will <em>also</em> save the rotation matrix to be use for new data during the “prediction phase”. This makes it possible to perform “prediction” with single rows of new data, where a row’s scores on each of the principal components (the components of the training data!) is computed.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-098_701cc263c5695dd69536c63342631159">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a>po <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb123-2"><a href="#cb123-2"></a>po<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(task))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species       PC1         PC2         PC3          PC4
  1:    setosa -2.684126 -0.31939725  0.02791483 -0.002262437
  2:    setosa -2.714142  0.17700123  0.21046427 -0.099026550
  3:    setosa -2.888991  0.14494943 -0.01790026 -0.019968390
  4:    setosa -2.745343  0.31829898 -0.03155937  0.075575817
  5:    setosa -2.728717 -0.32675451 -0.09007924  0.061258593
 ---                                                         
146: virginica  1.944110 -0.18753230 -0.17782509 -0.426195940
147: virginica  1.527167  0.37531698  0.12189817 -0.254367442
148: virginica  1.764346 -0.07885885 -0.13048163 -0.137001274
149: virginica  1.900942 -0.11662796 -0.72325156 -0.044595305
150: virginica  1.390189  0.28266094 -0.36290965  0.155038628</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-099_cd601c582c93b2f6f7293c06c00d24a0">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a>single_line_task <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span>)</span>
<span id="cb125-2"><a href="#cb125-2"></a>po<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(single_line_task))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species       PC1        PC2        PC3          PC4
1:  setosa -2.684126 -0.3193972 0.02791483 -0.002262437</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-100_f3dcee999cf23c91884e47f9db58ef5a">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>po<span class="sc">$</span>state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Standard deviations (1, .., p=4):
[1] 2.0562689 0.4926162 0.2796596 0.1543862

Rotation (n x k) = (4 x 4):
                     PC1         PC2         PC3        PC4
Petal.Length  0.85667061  0.17337266 -0.07623608  0.4798390
Petal.Width   0.35828920  0.07548102 -0.54583143 -0.7536574
Sepal.Length  0.36138659 -0.65658877  0.58202985 -0.3154872
Sepal.Width  -0.08452251 -0.73016143 -0.59791083  0.3197231</code></pre>
</div>
</div>
<p>This shows the most important primitives incorporated in a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>: * <strong><code>$train()</code></strong>, taking a list of input arguments, turning them into a list of outputs, meanwhile saving a state in <code>$state</code> * <strong><code>$predict()</code></strong>, taking a list of input arguments, turning them into a list of outputs, making use of the saved <code>$state</code> * <strong><code>$state</code></strong>, the “model” trained with <code>$train()</code> and utilized during <code>$predict()</code>.</p>
<p>Schematically we can represent the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> like so:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-101_1f6152950e6afed191af18d0c126c248">
<div class="cell-output-display">
<p><img src="Figures/po_viz.png" class="img-fluid" width="464"></p>
</div>
</div>
<section id="why-the-state" class="level4" data-number="6.8.2.1"><h4 data-number="6.8.2.1" class="anchored" data-anchor-id="why-the-state">
<span class="header-section-number">6.8.2.1</span> Why the <code>$state</code>
</h4>
<p>It is important to take a moment and notice the importance of a <code>$state</code> variable and the <code>$train()</code> / <code>$predict()</code> dichotomy in a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. There are many preprocessing methods, for example scaling of parameters or imputation, that could in theory just be applied to training data and prediction / validation data separately, or they could be applied to a task before resampling is performed. This would, however, be fallacious:</p>
<ul>
<li>The preprocessing of each instance of prediction data should not depend on the remaining prediction dataset. A prediction on a single instance of new data should give the same result as prediction performed on a whole dataset.</li>
<li>If preprocessing is performed on a task <em>before</em> resampling is done, information about the test set can leak into the training set. Resampling should evaluate the generalization performance of the <em>entire</em> machine learning method, therefore the behavior of this entire method must only depend only on the content of the <em>training</em> split during resampling.</li>
</ul></section><section id="where-to-get-pipeops" class="level4" data-number="6.8.2.2"><h4 data-number="6.8.2.2" class="anchored" data-anchor-id="where-to-get-pipeops">
<span class="header-section-number">6.8.2.2</span> Where to get <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s</h4>
<p>Each <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is an instance of an “<code>R6</code>” class, many of which are provided by the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package itself. They can be constructed explicitly (“<code>PipeOpPCA$new()</code>”) or retrieved from the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html"><code>mlr_pipeops</code></a> dictionary: <code>po("pca")</code>. The entire list of available <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s, and some meta-information, can be retrieved using <a href="https://www.rdocumentation.org/packages/data.table/topics/as.data.table"><code>as.data.table()</code></a>:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-102_c6d5510bd8aa629e8d1bad9a9537ff9a">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1"></a><span class="fu">as.data.table</span>(mlr_pipeops)[, <span class="fu">c</span>(<span class="st">"key"</span>, <span class="st">"input.num"</span>, <span class="st">"output.num"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               key input.num output.num
 1:         boxcox         1          1
 2:         branch         1         NA
 3:          chunk         1         NA
 4: classbalancing         1          1
 5:     classifavg        NA          1
---                                    
60:      threshold         1          1
61:  tunethreshold         1          1
62:       unbranch        NA          1
63:         vtreat         1          1
64:     yeojohnson         1          1</code></pre>
</div>
</div>
<p>When retrieving <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s from the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html"><code>mlr_pipeops</code></a> dictionary, it is also possible to give additional constructor arguments, such as an <a href="#pipeop-ids-and-id-name-clashes">id</a> or <a href="#hyperparameters">parameter values</a>.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-103_010d76c97fc7ebe9bbe1066a79f64adf">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1"></a><span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">rank. =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;pca&gt; (not trained)
values: &lt;rank.=3&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
</section></section><section id="pipeop-channels" class="level3" data-number="6.8.3"><h3 data-number="6.8.3" class="anchored" data-anchor-id="pipeop-channels">
<span class="header-section-number">6.8.3</span> PipeOp Channels</h3>
<section id="input-channels" class="level4" data-number="6.8.3.1"><h4 data-number="6.8.3.1" class="anchored" data-anchor-id="input-channels">
<span class="header-section-number">6.8.3.1</span> Input Channels</h4>
<p>Just like functions, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s can take multiple inputs. These multiple inputs are always given as elements in the input list. For example, there is a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_featureunion.html"><code>PipeOpFeatureUnion</code></a> that combines multiple tasks with different features and “<code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>s” them together, creating one combined task. When two halves of the <code>iris</code> task are given, for example, it recreates the original task:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-104_e94c4385daecb67011a6635a57493b0c">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a>iris_first_half <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"Petal.Length"</span>, <span class="st">"Petal.Width"</span>))</span>
<span id="cb133-2"><a href="#cb133-2"></a>iris_second_half <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span>))</span>
<span id="cb133-3"><a href="#cb133-3"></a></span>
<span id="cb133-4"><a href="#cb133-4"></a>pofu <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>)</span>
<span id="cb133-5"><a href="#cb133-5"></a></span>
<span id="cb133-6"><a href="#cb133-6"></a>pofu<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(iris_first_half, iris_second_half))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
  1:    setosa          1.4         0.2          5.1         3.5
  2:    setosa          1.4         0.2          4.9         3.0
  3:    setosa          1.3         0.2          4.7         3.2
  4:    setosa          1.5         0.2          4.6         3.1
  5:    setosa          1.4         0.2          5.0         3.6
 ---                                                            
146: virginica          5.2         2.3          6.7         3.0
147: virginica          5.0         1.9          6.3         2.5
148: virginica          5.2         2.0          6.5         3.0
149: virginica          5.4         2.3          6.2         3.4
150: virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
</div>
<p>Because <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_featureunion.html"><code>PipeOpFeatureUnion</code></a> effectively takes two input arguments here, we can say it has two <strong>input channels</strong>. An input channel also carries information about the <em>type</em> of input that is acceptable. The input channels of the <code>pofu</code> object constructed above, for example, each accept a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> during training and prediction. This information can be queried from the <code>$input</code> slot:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-105_0cf4e3d3de33ac764a85a181ad2d813e">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a>pofu<span class="sc">$</span>input</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name train predict
1: input1  Task    Task
2: input2  Task    Task</code></pre>
</div>
</div>
<p>Other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s may have channels that take different types during different phases. The <code>backuplearner</code> <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, for example, takes a <code>NULL</code> and a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> during training, and a <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> and a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> during prediction:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-106_cd834c1090001295482d90bc4ccc6845">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> this is an important case to handle here, do not delete unless there is a better example.</span></span>
<span id="cb137-2"><a href="#cb137-2"></a><span class="co"># po("backuplearner")$input</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="output-channels" class="level4" data-number="6.8.3.2"><h4 data-number="6.8.3.2" class="anchored" data-anchor-id="output-channels">
<span class="header-section-number">6.8.3.2</span> Output Channels</h4>
<p>Unlike the typical notion of a function, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s can also have multiple <strong>output channels</strong>. <code>$train()</code> and <code>$predict()</code> always return a list, so certain <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s may return lists with more than one element. Similar to input channels, the information about the number and type of outputs given by a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> is available in the <code>$output</code> slot. The <code>chunk</code> PipeOp, for example, chunks a given <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> into subsets and consequently returns multiple <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> objects, both during training and prediction. The number of output channels must be given during construction through the <code>outnum</code> argument.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-107_feaa4cc76c88edf144d134775a477a34">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1"></a><span class="fu">po</span>(<span class="st">"chunk"</span>, <span class="at">outnum =</span> <span class="dv">3</span>)<span class="sc">$</span>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      name train predict
1: output1  Task    Task
2: output2  Task    Task
3: output3  Task    Task</code></pre>
</div>
</div>
<p>Note that the number of output channels during training and prediction is the same. A schema of a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> with two output channels:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-108_2f1d7d0e0c039a5fdbebbc72e5e98f81">
<div class="cell-output-display">
<p><img src="Figures/po_multi_alone.png" class="img-fluid" width="282"></p>
</div>
</div>
</section><section id="channel-configuration" class="level4" data-number="6.8.3.3"><h4 data-number="6.8.3.3" class="anchored" data-anchor-id="channel-configuration">
<span class="header-section-number">6.8.3.3</span> Channel Configuration</h4>
<p>Most <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s have only one input channel (so they take a list with a single element), but there are a few with more than one; In many cases, the number of input or output channels is determined during construction, e.g.&nbsp;through the <code>innum</code> / <code>outnum</code> arguments. The <code>input.num</code> and <code>output.num</code> columns of the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html"><code>mlr_pipeops</code></a>-table <a href="#where-to-get-pipeops">above</a> show the default number of channels, and <code>NA</code> if the number depends on a construction argument.</p>
<p>The default printer of a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> gives information about channel names and types:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-109_2741fb9e0521dfa2298342ff29750b56">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1"></a><span class="co"># po("backuplearner")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="graph-networks-of-pipeops" class="level3 page-columns page-full" data-number="6.8.4"><h3 data-number="6.8.4" class="anchored" data-anchor-id="graph-networks-of-pipeops">
<span class="header-section-number">6.8.4</span> <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>: Networks of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s</h3>
<section id="basics" class="level4" data-number="6.8.4.1"><h4 data-number="6.8.4.1" class="anchored" data-anchor-id="basics">
<span class="header-section-number">6.8.4.1</span> Basics</h4>
<p>What is the advantage of this tedious way of declaring input and output channels and handling in/output through lists? Because each <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> has a known number of input and output channels that always produce or accept data of a known type, it is possible to network them together in <strong><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a></strong>s. A <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> is a collection of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s with “edges” that mandate that data should be flowing along them. Edges always pass between <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> <em>channels</em>, so it is not only possible to explicitly prescribe which position of an input or output list an edge refers to, it makes it possible to make different components of a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s output flow to multiple different other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s, as well as to have a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> gather its input from multiple other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s.</p>
<p>A schema of a simple graph of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-110_4f92f9601df2e35c0296e41b31f639d4">
<div class="cell-output-display">
<p><img src="Figures/po_multi_viz.png" class="img-fluid" width="430"></p>
</div>
</div>
<p>A <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> is empty when first created, and <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s can be added using the <strong><code>$add_pipeop()</code></strong> method. The <strong><code>$add_edge()</code></strong> method is used to create connections between them. While the printer of a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> gives some information about its layout, the most intuitive way of visualizing it is using the <code>$plot()</code> function.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-111_191b0e9e0400af3e98a12c333505c833">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb141-2"><a href="#cb141-2"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"scale"</span>))</span>
<span id="cb141-3"><a href="#cb141-3"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"subsample"</span>, <span class="at">frac =</span> <span class="fl">0.1</span>))</span>
<span id="cb141-4"><a href="#cb141-4"></a>gr<span class="sc">$</span><span class="fu">add_edge</span>(<span class="st">"scale"</span>, <span class="st">"subsample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-112_bf0a8c97853ed20802f587980c7e72c8">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a><span class="fu">print</span>(gr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 2 PipeOps:
        ID         State  sccssors prdcssors
     scale &lt;&lt;UNTRAINED&gt;&gt; subsample          
 subsample &lt;&lt;UNTRAINED&gt;&gt;               scale</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-113_735742675d0b9934da4b5a4659f8cafd">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-113-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>A <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> itself has a <strong><code>$train()</code></strong> and a <strong><code>$predict()</code></strong> method that accept some data and propagate this data through the network of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. The return value corresponds to the output of the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> output channels that are not connected to other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-114_17afff5413fe9fe794646a5a4e9ce6b4">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length   Petal.Width Sepal.Length Sepal.Width
 1:     setosa  -1.27910398 -1.3110521482  -1.01843718   0.7861738
 2:     setosa  -1.22245633 -1.3110521482  -1.25996379   0.7861738
 3:     setosa  -1.50569459 -1.4422448248  -1.86378030  -0.1315388
 4:     setosa  -1.16580868 -1.3110521482  -0.53538397   0.7861738
 5:     setosa  -1.44904694 -1.3110521482  -1.01843718   0.3273175
 6:     setosa  -1.39239929 -1.3110521482  -1.74301699  -0.1315388
 7: versicolor   0.42032558  0.3944526477   0.67224905   0.3273175
 8: versicolor  -0.14615094 -0.2615107354  -1.01843718  -2.4258204
 9: versicolor  -0.08950329  0.1320672944  -0.29385737  -0.3609670
10: versicolor   0.42032558  0.3944526477   0.43072244  -1.9669641
11: versicolor   0.42032558  0.3944526477   0.18919584  -0.3609670
12: versicolor   0.36367793  0.0008746178  -0.41462067  -1.0492515
13: versicolor   0.47697323  0.2632599711   0.30995914  -0.1315388
14: versicolor   0.13708732  0.0008746178  -0.05233076  -1.0492515
15:  virginica   1.04344975  1.1816087073   0.67224905  -0.5903951</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-115_a6e3a0e926b173c9d6745c649a8db313">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a>gr<span class="sc">$</span><span class="fu">predict</span>(single_line_task)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa    -1.335752   -1.311052   -0.8976739    1.015602</code></pre>
</div>
</div>
<p>The collection of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s inside a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> can be accessed through the <strong><code>$pipeops</code></strong> slot. The set of edges in the Graph can be inspected through the <strong><code>$edges</code></strong> slot. It is possible to modify individual <code>PipeOps</code> and edges in a Graph through these slots, but this is not recommended because no error checking is performed and it may put the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> in an unsupported state.</p>
</section><section id="networks" class="level4 page-columns page-full" data-number="6.8.4.2"><h4 data-number="6.8.4.2" class="anchored" data-anchor-id="networks">
<span class="header-section-number">6.8.4.2</span> Networks</h4>
<div class="page-columns page-full"><p>The example above showed a linear preprocessing pipeline, but it is in fact possible to build true “graphs” of operations, as long as no loops are introduced<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s with multiple output channels can feed their data to multiple different subsequent <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s, and <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s with multiple input channels can take results from different <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s. When a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> has more than one input / output channel, then the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>’s <code>$add_edge()</code> method needs an additional argument that indicates which channel to connect to. This argument can be given in the form of an integer, or as the name of the channel.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;It is tempting to denote this as a “directed acyclic graph”, but this would not be entirely correct because edges run between channels of <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s, not <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s themselves.</p></li></div></div>
<p>The following constructs a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that copies the input and gives one copy each to a “scale” and a “pca” <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>. The resulting columns of each operation are put next to each other by “featureunion”.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-116_3d87a221a616a40b9b25664413cc04ec">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span></span>
<span id="cb149-2"><a href="#cb149-2"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"copy"</span>, <span class="at">outnum =</span> <span class="dv">2</span>))<span class="sc">$</span></span>
<span id="cb149-3"><a href="#cb149-3"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"scale"</span>))<span class="sc">$</span></span>
<span id="cb149-4"><a href="#cb149-4"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>))<span class="sc">$</span></span>
<span id="cb149-5"><a href="#cb149-5"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>))</span>
<span id="cb149-6"><a href="#cb149-6"></a></span>
<span id="cb149-7"><a href="#cb149-7"></a>gr<span class="sc">$</span></span>
<span id="cb149-8"><a href="#cb149-8"></a>  <span class="fu">add_edge</span>(<span class="st">"copy"</span>, <span class="st">"scale"</span>, <span class="at">src_channel =</span> <span class="dv">1</span>)<span class="sc">$</span>        <span class="co"># designating channel by index</span></span>
<span id="cb149-9"><a href="#cb149-9"></a>  <span class="fu">add_edge</span>(<span class="st">"copy"</span>, <span class="st">"pca"</span>, <span class="at">src_channel =</span> <span class="st">"output2"</span>)<span class="sc">$</span>  <span class="co"># designating channel by name</span></span>
<span id="cb149-10"><a href="#cb149-10"></a>  <span class="fu">add_edge</span>(<span class="st">"scale"</span>, <span class="st">"featureunion"</span>, <span class="at">dst_channel =</span> <span class="dv">1</span>)<span class="sc">$</span></span>
<span id="cb149-11"><a href="#cb149-11"></a>  <span class="fu">add_edge</span>(<span class="st">"pca"</span>, <span class="st">"featureunion"</span>, <span class="at">dst_channel =</span> <span class="dv">2</span>)</span>
<span id="cb149-12"><a href="#cb149-12"></a></span>
<span id="cb149-13"><a href="#cb149-13"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-116-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-117_a1d423d86079207c2effa71b0407ff87">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(iris_first_half)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Species Petal.Length Petal.Width       PC1          PC2
  1:    setosa   -1.3357516  -1.3110521 -2.561012 -0.006922191
  2:    setosa   -1.3357516  -1.3110521 -2.561012 -0.006922191
  3:    setosa   -1.3923993  -1.3110521 -2.653190  0.031849692
  4:    setosa   -1.2791040  -1.3110521 -2.468834 -0.045694073
  5:    setosa   -1.3357516  -1.3110521 -2.561012 -0.006922191
 ---                                                          
146: virginica    0.8168591   1.4439941  1.755953  0.455479438
147: virginica    0.7035638   0.9192234  1.416510  0.164312126
148: virginica    0.8168591   1.0504160  1.639637  0.178946130
149: virginica    0.9301544   1.4439941  1.940308  0.377935674
150: virginica    0.7602115   0.7880307  1.469915  0.033362474</code></pre>
</div>
</div>
</section><section id="syntactic-sugar" class="level4" data-number="6.8.4.3"><h4 data-number="6.8.4.3" class="anchored" data-anchor-id="syntactic-sugar">
<span class="header-section-number">6.8.4.3</span> Syntactic Sugar</h4>
<p>Although it is possible to create intricate <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s with edges going all over the place (as long as no loops are introduced), there is usually a clear direction of flow between “layers” in the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. It is therefore convenient to build up a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> from layers, which can be done using the <strong><code>%&gt;&gt;%</code></strong> (“double-arrow”) operator. It takes either a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> on each of its sides and connects all of the outputs of its left-hand side to one of the inputs each of its right-hand side–the number of inputs therefore must match the number of outputs. Together with the <a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html"><code>gunion()</code></a> operation, which takes <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s or <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>s and arranges them next to each other akin to a (disjoint) graph union, the above network can more easily be constructed as follows:</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-118_259526fc9866e32c5fdbfeacaa428847">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"copy"</span>, <span class="at">outnum =</span> <span class="dv">2</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(<span class="fu">po</span>(<span class="st">"scale"</span>), <span class="fu">po</span>(<span class="st">"pca"</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb152-3"><a href="#cb152-3"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>)</span>
<span id="cb152-4"><a href="#cb152-4"></a></span>
<span id="cb152-5"><a href="#cb152-5"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="pipelines_files/figure-html/pipelines-118-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="pipeop-ids-and-id-name-clashes" class="level4" data-number="6.8.4.4"><h4 data-number="6.8.4.4" class="anchored" data-anchor-id="pipeop-ids-and-id-name-clashes">
<span class="header-section-number">6.8.4.4</span> <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> IDs and ID Name Clashes</h4>
<p><a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s within a graph are addressed by their <strong><code>$id</code></strong>-slot. It is therefore necessary for all <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s within a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> to have a unique <code>$id</code>. The <code>$id</code> can be set during or after construction, but it should not directly be changed after a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> was inserted in a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. At that point, the <strong><code>$set_names()</code></strong>-method can be used to change <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> ids.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-119_b60005f2c8c85f9d015dddfbb4552ece">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1"></a>po1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb153-2"><a href="#cb153-2"></a>po2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb153-3"><a href="#cb153-3"></a>po1 <span class="sc">%&gt;&gt;%</span> po2 <span class="co"># name clash</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gunion(list(g1, g2), in_place = c(TRUE, TRUE)): Assertion on 'ids of pipe operators of graphs' failed: Must have unique names, but element 2 is duplicated.</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-120_e12fbdc0fe6b399b550a8b0008f1341b">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a>po2<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"scale2"</span></span>
<span id="cb155-2"><a href="#cb155-2"></a>gr <span class="ot">=</span> po1 <span class="sc">%&gt;&gt;%</span> po2</span>
<span id="cb155-3"><a href="#cb155-3"></a>gr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 2 PipeOps:
     ID         State sccssors prdcssors
  scale &lt;&lt;UNTRAINED&gt;&gt;   scale2          
 scale2 &lt;&lt;UNTRAINED&gt;&gt;              scale</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-121_50caddf5205b6d7efdf1bcf829df8655">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1"></a><span class="co"># Alternative ways of getting new ids:</span></span>
<span id="cb157-2"><a href="#cb157-2"></a><span class="fu">po</span>(<span class="st">"scale"</span>, <span class="at">id =</span> <span class="st">"scale2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;scale2&gt; (not trained)
values: &lt;robust=FALSE&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-122_2b4488b019c98305b6068d556c748c59">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1"></a><span class="co"># sometimes names of PipeOps within a Graph need to be changed</span></span>
<span id="cb159-2"><a href="#cb159-2"></a>gr2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb159-3"><a href="#cb159-3"></a>gr <span class="sc">%&gt;&gt;%</span> gr2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in gunion(list(g1, g2), in_place = c(TRUE, TRUE)): Assertion on 'ids of pipe operators of graphs' failed: Must have unique names, but element 3 is duplicated.</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-123_2018bd5e35a9b99c29b0cfb60a42deeb">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1"></a>gr2<span class="sc">$</span><span class="fu">set_names</span>(<span class="st">"scale"</span>, <span class="st">"scale3"</span>)</span>
<span id="cb161-2"><a href="#cb161-2"></a>gr <span class="sc">%&gt;&gt;%</span> gr2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 4 PipeOps:
     ID         State sccssors prdcssors
  scale &lt;&lt;UNTRAINED&gt;&gt;   scale2          
 scale2 &lt;&lt;UNTRAINED&gt;&gt;   scale3     scale
 scale3 &lt;&lt;UNTRAINED&gt;&gt;      pca    scale2
    pca &lt;&lt;UNTRAINED&gt;&gt;             scale3</code></pre>
</div>
</div>
</section></section><section id="learners-in-graphs-graphs-in-learners" class="level3" data-number="6.8.5"><h3 data-number="6.8.5" class="anchored" data-anchor-id="learners-in-graphs-graphs-in-learners">
<span class="header-section-number">6.8.5</span> Learners in Graphs, Graphs in Learners</h3>
<p>The true power of <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> derives from the fact that it can be integrated seamlessly with <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>. Two components are mainly responsible for this:</p>
<ul>
<li>
<a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a>, a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that encapsulates a <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> and creates a <a href="https://mlr3.mlr-org.com/reference/PredictionData.html"><code>PredictionData</code></a> object in its <code>$predict()</code> phase</li>
<li>
<a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>, a <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> that can be used in place of any other <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>, but which does prediction using a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> given to it</li>
</ul>
<p>Note that these are dual to each other: One takes a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> and produces a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> (and by extension a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>); the other takes a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> and produces a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>.</p>
<section id="pipeoplearner" class="level4" data-number="6.8.5.1"><h4 data-number="6.8.5.1" class="anchored" data-anchor-id="pipeoplearner">
<span class="header-section-number">6.8.5.1</span> <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a>
</h4>
<p>The <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a> is constructed using a <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> and will use it to create <a href="https://mlr3.mlr-org.com/reference/PredictionData.html"><code>PredictionData</code></a> in the <code>$predict()</code> phase. The output during <code>$train()</code> is <code>NULL</code>. It can be used after a preprocessing pipeline, and it is even possible to perform operations on the <a href="https://mlr3.mlr-org.com/reference/PredictionData.html"><code>PredictionData</code></a>, for example by averaging multiple predictions or by using the <code>PipeOpBackupLearner</code>” operator to impute predictions that a given model failed to create.</p>
<p>The following is a very simple <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that performs training and prediction on data after performing principal component analysis.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-124_a2dfe0731f7c27e0a00aa0072adf5ff8">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner"</span>,</span>
<span id="cb163-2"><a href="#cb163-2"></a>  <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-125_1ae5315934fcce725adfc6ead518fcd0">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.rpart.output
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a>gr<span class="sc">$</span><span class="fu">predict</span>(task)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$classif.rpart.output
&lt;PredictionClassif&gt; for 150 observations:
    row_ids     truth  response
          1    setosa    setosa
          2    setosa    setosa
          3    setosa    setosa
---                            
        148 virginica virginica
        149 virginica virginica
        150 virginica virginica</code></pre>
</div>
</div>
</section><section id="graphlearner" class="level4" data-number="6.8.5.2"><h4 data-number="6.8.5.2" class="anchored" data-anchor-id="graphlearner">
<span class="header-section-number">6.8.5.2</span> <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>
</h4>
<p>Although a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> has <code>$train()</code> and <code>$predict()</code> functions, it can not be used directly in places where <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> <code>Learners</code> can be used like resampling or benchmarks. For this, it needs to be wrapped in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> object, which is a thin wrapper that enables this functionality. The resulting <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> is extremely versatile, because every part of it can be modified, replaced, parameterized and optimized over. Resampling the graph above can be done the same way that resampling of the <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> was performed in the <a href="#whats-the-point">introductory example</a>.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-126_1dc1c667d3823c199fe68ad7a657e6bc">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a>lrngrph <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb168-2"><a href="#cb168-2"></a><span class="fu">resample</span>(task, lrngrph, rsmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ResampleResult&gt; of 1 iterations
* Task: iris
* Learner: pca.classif.rpart
* Warnings: 0 in 0 iterations
* Errors: 0 in 0 iterations</code></pre>
</div>
</div>
</section></section><section id="hyperparameters" class="level3" data-number="6.8.6"><h3 data-number="6.8.6" class="anchored" data-anchor-id="hyperparameters">
<span class="header-section-number">6.8.6</span> Hyperparameters</h3>
<p><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> relies on the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package to provide parameters that can modify each <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s behavior. <a href="https://paradox.mlr-org.com"><code>paradox</code></a> parameters provide information about the parameters that can be changed, as well as their types and ranges. They provide a unified interface for benchmarks and parameter optimization (“tuning”). For a deep dive into <a href="https://paradox.mlr-org.com"><code>paradox</code></a>, see <a href="#searchspace">the tuning chapter</a> or <a href="technical.html#sec-paradox"><span>Section&nbsp;9.4</span></a>.</p>
<p>The <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a>, representing the space of possible parameter configurations of a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>, can be inspected by accessing the <strong><code>$param_set</code></strong> slot of a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-127_9b08dd83011e51919342df9f82f0edbb">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1"></a>op_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb170-2"><a href="#cb170-2"></a>op_pca<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet:pca&gt;
               id    class lower upper nlevels       default value
1:         center ParamLgl    NA    NA       2          TRUE      
2:         scale. ParamLgl    NA    NA       2         FALSE      
3:          rank. ParamInt     1   Inf     Inf                    
4: affect_columns ParamUty    NA    NA     Inf &lt;Selector[1]&gt;      </code></pre>
</div>
</div>
<p>To set or retrieve a parameter, the <strong><code>$param_set$values</code></strong> slot can be accessed. Alternatively, the <code>param_vals</code> value can be given during construction.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-128_b83d13e52ec98f3b72a938c53745847f">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb172-2"><a href="#cb172-2"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$center
[1] FALSE</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-129_71109da67f67dcca56931a8728bce848">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1"></a>op_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb174-2"><a href="#cb174-2"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$center
[1] TRUE</code></pre>
</div>
</div>
<p>Each <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> can bring its own individual parameters which are collected together in the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>’s <code>$param_set</code>. A <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s parameter names are prefixed with its <code>$id</code> to prevent parameter name clashes.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-130_61d060c677899e1b8061ac974d5afa8b">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1"></a>gr <span class="ot">=</span> op_pca <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb176-2"><a href="#cb176-2"></a>gr<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                     id    class lower upper nlevels        default value
1:           pca.center ParamLgl    NA    NA       2           TRUE  TRUE
2:           pca.scale. ParamLgl    NA    NA       2          FALSE      
3:            pca.rank. ParamInt     1   Inf     Inf                     
4:   pca.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;      
5:         scale.center ParamLgl    NA    NA       2           TRUE      
6:          scale.scale ParamLgl    NA    NA       2           TRUE      
7:         scale.robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt; FALSE
8: scale.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;      </code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-131_12f8784047a0d4211b843018120c20e3">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1"></a>gr<span class="sc">$</span>param_set<span class="sc">$</span>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pca.center
[1] TRUE

$scale.robust
[1] FALSE</code></pre>
</div>
</div>
<p>Both <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html"><code>PipeOpLearner</code></a> and <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> preserve parameters of the objects they encapsulate.</p>
<div class="cell" data-hash="pipelines_cache/html/pipelines-132_78a63e2583ae5fd1a874304a5f1ac66e">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1"></a>op_rpart <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb180-2"><a href="#cb180-2"></a>op_rpart<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet:classif.rpart&gt;
                id    class lower upper nlevels        default value
 1:             cp ParamDbl     0     1     Inf           0.01      
 2:     keep_model ParamLgl    NA    NA       2          FALSE      
 3:     maxcompete ParamInt     0   Inf     Inf              4      
 4:       maxdepth ParamInt     1    30      30             30      
 5:   maxsurrogate ParamInt     0   Inf     Inf              5      
 6:      minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;      
 7:       minsplit ParamInt     1   Inf     Inf             20      
 8: surrogatestyle ParamInt     0     1       2              0      
 9:   usesurrogate ParamInt     0     2       3              2      
10:           xval ParamInt     0   Inf     Inf             10     0</code></pre>
</div>
</div>
<div class="cell" data-hash="pipelines_cache/html/pipelines-133_eb94f0e5bf9f55916231c0a738ba3963">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1"></a>glrn <span class="ot">=</span> <span class="fu">as_learner</span>(gr <span class="sc">%&gt;&gt;%</span> op_rpart)</span>
<span id="cb182-2"><a href="#cb182-2"></a>glrn<span class="sc">$</span>param_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                              id    class lower upper nlevels        default
 1:                   pca.center ParamLgl    NA    NA       2           TRUE
 2:                   pca.scale. ParamLgl    NA    NA       2          FALSE
 3:                    pca.rank. ParamInt     1   Inf     Inf               
 4:           pca.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;
 5:                 scale.center ParamLgl    NA    NA       2           TRUE
 6:                  scale.scale ParamLgl    NA    NA       2           TRUE
 7:                 scale.robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt;
 8:         scale.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;
 9:             classif.rpart.cp ParamDbl     0     1     Inf           0.01
10:     classif.rpart.keep_model ParamLgl    NA    NA       2          FALSE
11:     classif.rpart.maxcompete ParamInt     0   Inf     Inf              4
12:       classif.rpart.maxdepth ParamInt     1    30      30             30
13:   classif.rpart.maxsurrogate ParamInt     0   Inf     Inf              5
14:      classif.rpart.minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
15:       classif.rpart.minsplit ParamInt     1   Inf     Inf             20
16: classif.rpart.surrogatestyle ParamInt     0     1       2              0
17:   classif.rpart.usesurrogate ParamInt     0     2       3              2
18:           classif.rpart.xval ParamInt     0   Inf     Inf             10
1 variable not shown: [value]</code></pre>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-mlr3pipelines" class="csl-entry" role="doc-biblioentry">
Binder, Martin, Florian Pfisterer, Michel Lang, Lennart Schneider, Lars Kotthoff, and Bernd Bischl. 2021. <span>“<span class="nocase">mlr3pipelines</span> - Flexible Machine Learning Pipelines in <span>R</span>.”</span> <em>Journal of Machine Learning Research</em> 22 (184): 1–7. <a href="http://jmlr.org/papers/v22/21-0281.html">http://jmlr.org/papers/v22/21-0281.html</a>.
</div>
<div id="ref-Breiman1996" class="csl-entry" role="doc-biblioentry">
Breiman, Leo. 1996. <span>“Bagging Predictors.”</span> <em>Machine Learning</em> 24 (2): 123–40.
</div>
<div id="ref-Wolpert1992" class="csl-entry" role="doc-biblioentry">
Wolpert, David H. 1992. <span>“Stacked Generalization.”</span> <em>Neural Networks</em> 5 (2): 241–59. https://doi.org/<a href="https://doi.org/10.1016/S0893-6080(05)80023-1">https://doi.org/10.1016/S0893-6080(05)80023-1</a>.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./feature-selection.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Feature Selection</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./preprocessing.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Preprocessing</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb184" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 1</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 1</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Author 2</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a><span class="co">    email:</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Affiliation 2</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> TODO (150-200 WORDS)</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># Pipelines {#sec-pipelines}</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup.qmd &gt;}}</span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>This chapter is currently being re-written, in <span class="co">[</span><span class="ot">this PR</span><span class="co">](https://github.com/mlr-org/mlr3book/pull/385)</span>. You can continue reading here if you want to learn about <span class="in">`mlr3pipelines`</span>, but you currently don't need to bother checking this chapter for typos etc.</span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-001, include = FALSE}</span></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> <span class="co">[</span><span class="ot">@mlr3pipelines</span><span class="co">]</span> is a dataflow programming toolkit.</span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>This chapter focuses on the applicant's side of the package.</span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>A more in-depth and technically oriented guide can be found in the <span class="co">[</span><span class="ot">In-depth look into mlr3pipelines</span><span class="co">](#in-depth-pipelines)</span> chapter.</span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>Machine learning workflows can be written as directed “Graphs”/"Pipelines" that represent data flows between preprocessing, model fitting, and ensemble learning units in an expressive and intuitive language.</span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>We will most often use the term "Graph" in this manual but it can interchangeably be used  with "pipeline" or "workflow".</span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>Below you can examine an example for such a graph:</span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-002, echo=FALSE, fig.align='center', out.width="98%"}</span></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/single_pipe.svg"</span>)</span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>Single computational steps can be represented as so-called PipeOps, which can then be connected with directed edges in a Graph.</span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a>The scope of <span class="in">`r mlr3pipelines`</span> is still growing.</span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a>Currently supported features are:</span>
<span id="cb184-44"><a href="#cb184-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-45"><a href="#cb184-45" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Data manipulation and preprocessing operations, e.g. PCA, feature filtering, imputation</span>
<span id="cb184-46"><a href="#cb184-46" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Task subsampling for speed and outcome class imbalance handling</span>
<span id="cb184-47"><a href="#cb184-47" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r mlr3`</span> Learner operations for prediction and stacking</span>
<span id="cb184-48"><a href="#cb184-48" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Ensemble methods and aggregation of predictions</span>
<span id="cb184-49"><a href="#cb184-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-50"><a href="#cb184-50" aria-hidden="true" tabindex="-1"></a>Additionally, we implement several meta operators that can be used to construct powerful pipelines:</span>
<span id="cb184-51"><a href="#cb184-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-52"><a href="#cb184-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Simultaneous path branching (data going both ways)</span>
<span id="cb184-53"><a href="#cb184-53" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Alternative path branching (data going one specific way, controlled by hyperparameters)</span>
<span id="cb184-54"><a href="#cb184-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-55"><a href="#cb184-55" aria-hidden="true" tabindex="-1"></a>An extensive introduction to creating custom **PipeOps** (PO's) can be found in the <span class="co">[</span><span class="ot">technical introduction</span><span class="co">](#extending-pipeops)</span>.</span>
<span id="cb184-56"><a href="#cb184-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-57"><a href="#cb184-57" aria-hidden="true" tabindex="-1"></a>Using methods from <span class="in">`r mlr3tuning`</span>, it is even possible to simultaneously optimize parameters of multiple processing units.</span>
<span id="cb184-58"><a href="#cb184-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-59"><a href="#cb184-59" aria-hidden="true" tabindex="-1"></a>A predecessor to this package is the <span class="in">`r ref_pkg("mlrCPO")`</span> package, which works with <span class="in">`r ref_pkg("mlr")`</span> 2.x.</span>
<span id="cb184-60"><a href="#cb184-60" aria-hidden="true" tabindex="-1"></a>Other packages that provide, to varying degree, some preprocessing functionality or machine learning domain specific language, are:</span>
<span id="cb184-61"><a href="#cb184-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-62"><a href="#cb184-62" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the <span class="in">`r ref_pkg("caret")`</span> package and the related <span class="in">`r ref_pkg("recipes")`</span>  project</span>
<span id="cb184-63"><a href="#cb184-63" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the <span class="in">`r ref_pkg("dplyr")`</span> package</span>
<span id="cb184-64"><a href="#cb184-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-65"><a href="#cb184-65" aria-hidden="true" tabindex="-1"></a>An example for a Pipeline that can be constructed using <span class="in">`r mlr3pipelines`</span> is depicted below:</span>
<span id="cb184-66"><a href="#cb184-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-67"><a href="#cb184-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-003, echo = FALSE, width = 10, height = 10, eval = TRUE, message=FALSE}</span></span>
<span id="cb184-68"><a href="#cb184-68" aria-hidden="true" tabindex="-1"></a><span class="co"># This just produces a plot, not visible to the user.</span></span>
<span id="cb184-69"><a href="#cb184-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb184-70"><a href="#cb184-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-71"><a href="#cb184-71" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-72"><a href="#cb184-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb184-73"><a href="#cb184-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"null1"</span>),</span>
<span id="cb184-74"><a href="#cb184-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"pca"</span>),</span>
<span id="cb184-75"><a href="#cb184-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-76"><a href="#cb184-76" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb184-77"><a href="#cb184-77" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> graph <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-78"><a href="#cb184-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-79"><a href="#cb184-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-80"><a href="#cb184-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-81"><a href="#cb184-81" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-82"><a href="#cb184-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-83"><a href="#cb184-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-84"><a href="#cb184-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Building Blocks: PipeOps {#pipe-pipeops}</span></span>
<span id="cb184-85"><a href="#cb184-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-86"><a href="#cb184-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-004, include = FALSE}</span></span>
<span id="cb184-87"><a href="#cb184-87" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-88"><a href="#cb184-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-89"><a href="#cb184-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-90"><a href="#cb184-90" aria-hidden="true" tabindex="-1"></a>The building blocks of <span class="in">`r mlr3pipelines`</span> are **PipeOp**-objects (PO).</span>
<span id="cb184-91"><a href="#cb184-91" aria-hidden="true" tabindex="-1"></a>They can be constructed directly using <span class="in">`PipeOp&lt;NAME&gt;$new()`</span>, but the recommended way is to retrieve them from the <span class="in">`r ref("mlr_pipeops")`</span> dictionary:</span>
<span id="cb184-92"><a href="#cb184-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-93"><a href="#cb184-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-005}</span></span>
<span id="cb184-94"><a href="#cb184-94" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb184-95"><a href="#cb184-95" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_pipeops)</span>
<span id="cb184-96"><a href="#cb184-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-97"><a href="#cb184-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-98"><a href="#cb184-98" aria-hidden="true" tabindex="-1"></a>Single POs can be created using the dictionary:</span>
<span id="cb184-99"><a href="#cb184-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-100"><a href="#cb184-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-006}</span></span>
<span id="cb184-101"><a href="#cb184-101" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">=</span> mlr_pipeops<span class="sc">$</span><span class="fu">get</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-102"><a href="#cb184-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-103"><a href="#cb184-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-104"><a href="#cb184-104" aria-hidden="true" tabindex="-1"></a>or using **syntactic sugar** <span class="in">`po(&lt;name&gt;)`</span>:</span>
<span id="cb184-105"><a href="#cb184-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-106"><a href="#cb184-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-007, eval = FALSE}</span></span>
<span id="cb184-107"><a href="#cb184-107" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-108"><a href="#cb184-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-109"><a href="#cb184-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-110"><a href="#cb184-110" aria-hidden="true" tabindex="-1"></a>Some POs require additional arguments for construction:</span>
<span id="cb184-111"><a href="#cb184-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-112"><a href="#cb184-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-008, eval = FALSE}</span></span>
<span id="cb184-113"><a href="#cb184-113" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>)</span>
<span id="cb184-114"><a href="#cb184-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-115"><a href="#cb184-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Error in as_learner(learner) : argument "learner" is missing, with no default argument "learner" is missing, with no default</span></span>
<span id="cb184-116"><a href="#cb184-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-117"><a href="#cb184-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-118"><a href="#cb184-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-009}</span></span>
<span id="cb184-119"><a href="#cb184-119" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> mlr_pipeops<span class="sc">$</span><span class="fu">get</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-120"><a href="#cb184-120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-121"><a href="#cb184-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-122"><a href="#cb184-122" aria-hidden="true" tabindex="-1"></a>or in short <span class="in">`po("learner", lrn("classif.rpart"))`</span>.</span>
<span id="cb184-123"><a href="#cb184-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-124"><a href="#cb184-124" aria-hidden="true" tabindex="-1"></a>Hyperparameters of POs can be set through the <span class="in">`param_vals`</span> argument.</span>
<span id="cb184-125"><a href="#cb184-125" aria-hidden="true" tabindex="-1"></a>Here we set the fraction of features for a filter:</span>
<span id="cb184-126"><a href="#cb184-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-127"><a href="#cb184-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-010}</span></span>
<span id="cb184-128"><a href="#cb184-128" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb184-129"><a href="#cb184-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb184-130"><a href="#cb184-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span>
<span id="cb184-131"><a href="#cb184-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-132"><a href="#cb184-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-133"><a href="#cb184-133" aria-hidden="true" tabindex="-1"></a>or in short notation:</span>
<span id="cb184-134"><a href="#cb184-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-135"><a href="#cb184-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-011, eval = FALSE}</span></span>
<span id="cb184-136"><a href="#cb184-136" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"filter"</span>, mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>), <span class="at">filter.frac =</span> <span class="fl">0.5</span>)</span>
<span id="cb184-137"><a href="#cb184-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-138"><a href="#cb184-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-139"><a href="#cb184-139" aria-hidden="true" tabindex="-1"></a>The figure below shows an exemplary <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb184-140"><a href="#cb184-140" aria-hidden="true" tabindex="-1"></a>It takes an input, transforms it during <span class="in">`.$train`</span> and <span class="in">`.$predict`</span> and returns data:</span>
<span id="cb184-141"><a href="#cb184-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-142"><a href="#cb184-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-012, echo=FALSE}</span></span>
<span id="cb184-143"><a href="#cb184-143" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_viz.png"</span>)</span>
<span id="cb184-144"><a href="#cb184-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-145"><a href="#cb184-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-146"><a href="#cb184-146" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Pipeline Operator: `%&gt;&gt;%` {#pipe-operator}</span></span>
<span id="cb184-147"><a href="#cb184-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-148"><a href="#cb184-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-013, include = FALSE}</span></span>
<span id="cb184-149"><a href="#cb184-149" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-150"><a href="#cb184-150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-151"><a href="#cb184-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-152"><a href="#cb184-152" aria-hidden="true" tabindex="-1"></a>It is possible to create intricate <span class="in">`Graphs`</span> with edges going all over the place (as long as no loops are introduced).</span>
<span id="cb184-153"><a href="#cb184-153" aria-hidden="true" tabindex="-1"></a>Irrespective, there is usually a clear direction of flow between "layers" in the <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-154"><a href="#cb184-154" aria-hidden="true" tabindex="-1"></a>It is therefore convenient to build up a <span class="in">`r ref("Graph")`</span> from layers.</span>
<span id="cb184-155"><a href="#cb184-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-156"><a href="#cb184-156" aria-hidden="true" tabindex="-1"></a>This can be done using the **`%&gt;&gt;%`** ("double-arrow") operator.</span>
<span id="cb184-157"><a href="#cb184-157" aria-hidden="true" tabindex="-1"></a>It takes either a <span class="in">`r ref("PipeOp")`</span> or a <span class="in">`r ref("Graph")`</span> on each of its sides and connects all of the outputs of its left-hand side to one of the inputs each of its right-hand side.</span>
<span id="cb184-158"><a href="#cb184-158" aria-hidden="true" tabindex="-1"></a>The number of inputs therefore must match the number of outputs.</span>
<span id="cb184-159"><a href="#cb184-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-160"><a href="#cb184-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-014, fig.align = "center"}</span></span>
<span id="cb184-161"><a href="#cb184-161" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb184-162"><a href="#cb184-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-163"><a href="#cb184-163" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-164"><a href="#cb184-164" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-165"><a href="#cb184-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-166"><a href="#cb184-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-167"><a href="#cb184-167" aria-hidden="true" tabindex="-1"></a><span class="fu">## Nodes, Edges and Graphs {#pipe-nodes-edges-graphs}</span></span>
<span id="cb184-168"><a href="#cb184-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-169"><a href="#cb184-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-015, include = FALSE}</span></span>
<span id="cb184-170"><a href="#cb184-170" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-171"><a href="#cb184-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-172"><a href="#cb184-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-173"><a href="#cb184-173" aria-hidden="true" tabindex="-1"></a>POs are combined into <span class="in">`r ref("Graph")`</span>s.</span>
<span id="cb184-174"><a href="#cb184-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-175"><a href="#cb184-175" aria-hidden="true" tabindex="-1"></a>POs are identified by their <span class="in">`$id`</span>.</span>
<span id="cb184-176"><a href="#cb184-176" aria-hidden="true" tabindex="-1"></a>Note that the operations all modify the object in-place and return the object itself.</span>
<span id="cb184-177"><a href="#cb184-177" aria-hidden="true" tabindex="-1"></a>Therefore, multiple modifications can be chained.</span>
<span id="cb184-178"><a href="#cb184-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-179"><a href="#cb184-179" aria-hidden="true" tabindex="-1"></a>For this example we use the <span class="in">`pca`</span> PO defined above and a new PO named "mutate".</span>
<span id="cb184-180"><a href="#cb184-180" aria-hidden="true" tabindex="-1"></a>The latter creates a new feature from existing variables.</span>
<span id="cb184-181"><a href="#cb184-181" aria-hidden="true" tabindex="-1"></a>Additionally, we use the filter PO again.</span>
<span id="cb184-182"><a href="#cb184-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-183"><a href="#cb184-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-016}</span></span>
<span id="cb184-184"><a href="#cb184-184" aria-hidden="true" tabindex="-1"></a>mutate <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb184-185"><a href="#cb184-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-186"><a href="#cb184-186" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb184-187"><a href="#cb184-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb184-188"><a href="#cb184-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span>
<span id="cb184-189"><a href="#cb184-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-190"><a href="#cb184-190" aria-hidden="true" tabindex="-1"></a>The recommended way to construct a graph is to use the <span class="in">`%&gt;&gt;%`</span> operator to chain POs or <span class="in">`r ref("Graph")`</span>s.</span>
<span id="cb184-191"><a href="#cb184-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-192"><a href="#cb184-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-017}</span></span>
<span id="cb184-193"><a href="#cb184-193" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> mutate <span class="sc">%&gt;&gt;%</span> filter</span>
<span id="cb184-194"><a href="#cb184-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-195"><a href="#cb184-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-196"><a href="#cb184-196" aria-hidden="true" tabindex="-1"></a>To illustrate how this sugar operator works under the surface we will include an example of the manual way (= hard way) to construct a <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-197"><a href="#cb184-197" aria-hidden="true" tabindex="-1"></a>This is done by creating an empty graph first.</span>
<span id="cb184-198"><a href="#cb184-198" aria-hidden="true" tabindex="-1"></a>Then one fills the empty graph with POs, and connects edges between the POs.</span>
<span id="cb184-199"><a href="#cb184-199" aria-hidden="true" tabindex="-1"></a>Conceptually, this may look like this:</span>
<span id="cb184-200"><a href="#cb184-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-201"><a href="#cb184-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-018, echo=FALSE}</span></span>
<span id="cb184-202"><a href="#cb184-202" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_nodes.svg"</span>)</span>
<span id="cb184-203"><a href="#cb184-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-204"><a href="#cb184-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-205"><a href="#cb184-205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-019}</span></span>
<span id="cb184-206"><a href="#cb184-206" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span></span>
<span id="cb184-207"><a href="#cb184-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(mutate)<span class="sc">$</span></span>
<span id="cb184-208"><a href="#cb184-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(filter)<span class="sc">$</span></span>
<span id="cb184-209"><a href="#cb184-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_edge</span>(<span class="st">"mutate"</span>, <span class="st">"variance"</span>) <span class="co"># add connection mutate -&gt; filter</span></span>
<span id="cb184-210"><a href="#cb184-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-211"><a href="#cb184-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-212"><a href="#cb184-212" aria-hidden="true" tabindex="-1"></a>The constructed <span class="in">`r ref("Graph")`</span>  can be inspected using its <span class="in">`$plot()`</span> function:</span>
<span id="cb184-213"><a href="#cb184-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-214"><a href="#cb184-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-020}</span></span>
<span id="cb184-215"><a href="#cb184-215" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb184-216"><a href="#cb184-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-217"><a href="#cb184-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-218"><a href="#cb184-218" aria-hidden="true" tabindex="-1"></a>**Chaining multiple POs of the same kind**</span>
<span id="cb184-219"><a href="#cb184-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-220"><a href="#cb184-220" aria-hidden="true" tabindex="-1"></a>If multiple POs of the same kind should be chained, it is necessary to change the <span class="in">`id`</span> to avoid name clashes.</span>
<span id="cb184-221"><a href="#cb184-221" aria-hidden="true" tabindex="-1"></a>This can be done by either accessing the <span class="in">`$id`</span> slot or during construction:</span>
<span id="cb184-222"><a href="#cb184-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-223"><a href="#cb184-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-021, error = TRUE}</span></span>
<span id="cb184-224"><a href="#cb184-224" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>))</span>
<span id="cb184-225"><a href="#cb184-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-226"><a href="#cb184-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-227"><a href="#cb184-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-022}</span></span>
<span id="cb184-228"><a href="#cb184-228" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca2"</span>))</span>
<span id="cb184-229"><a href="#cb184-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-230"><a href="#cb184-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-231"><a href="#cb184-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-023}</span></span>
<span id="cb184-232"><a href="#cb184-232" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb184-233"><a href="#cb184-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-234"><a href="#cb184-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-235"><a href="#cb184-235" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modeling {#pipe-modeling}</span></span>
<span id="cb184-236"><a href="#cb184-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-237"><a href="#cb184-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-024, include = FALSE}</span></span>
<span id="cb184-238"><a href="#cb184-238" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-239"><a href="#cb184-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-240"><a href="#cb184-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-241"><a href="#cb184-241" aria-hidden="true" tabindex="-1"></a>The main purpose of a <span class="in">`r ref("Graph")`</span> is to build combined preprocessing and model fitting pipelines that can be used as <span class="in">`r mlr3`</span> <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb184-242"><a href="#cb184-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-243"><a href="#cb184-243" aria-hidden="true" tabindex="-1"></a>Conceptually, the process may be summarized as follows:</span>
<span id="cb184-244"><a href="#cb184-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-245"><a href="#cb184-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-025, echo=FALSE }</span></span>
<span id="cb184-246"><a href="#cb184-246" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/pipe_action.svg"</span>)</span>
<span id="cb184-247"><a href="#cb184-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-248"><a href="#cb184-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-249"><a href="#cb184-249" aria-hidden="true" tabindex="-1"></a>In the following we chain two preprocessing tasks:</span>
<span id="cb184-250"><a href="#cb184-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-251"><a href="#cb184-251" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>mutate (creation of a new feature)</span>
<span id="cb184-252"><a href="#cb184-252" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>filter (filtering the dataset)</span>
<span id="cb184-253"><a href="#cb184-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-254"><a href="#cb184-254" aria-hidden="true" tabindex="-1"></a>Subsequently one can chain a PO learner to train and predict on the modified dataset.</span>
<span id="cb184-255"><a href="#cb184-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-256"><a href="#cb184-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-026}</span></span>
<span id="cb184-257"><a href="#cb184-257" aria-hidden="true" tabindex="-1"></a>mutate <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb184-258"><a href="#cb184-258" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"filter"</span>,</span>
<span id="cb184-259"><a href="#cb184-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter =</span> mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"variance"</span>),</span>
<span id="cb184-260"><a href="#cb184-260" aria-hidden="true" tabindex="-1"></a>  <span class="at">param_vals =</span> <span class="fu">list</span>(<span class="at">filter.frac =</span> <span class="fl">0.5</span>))</span>
<span id="cb184-261"><a href="#cb184-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-262"><a href="#cb184-262" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> mutate <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-263"><a href="#cb184-263" aria-hidden="true" tabindex="-1"></a>  filter <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-264"><a href="#cb184-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>,</span>
<span id="cb184-265"><a href="#cb184-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-266"><a href="#cb184-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-267"><a href="#cb184-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-268"><a href="#cb184-268" aria-hidden="true" tabindex="-1"></a>Until here we defined the main pipeline stored in <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-269"><a href="#cb184-269" aria-hidden="true" tabindex="-1"></a>Now we can train and predict the pipeline:</span>
<span id="cb184-270"><a href="#cb184-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-271"><a href="#cb184-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-027}</span></span>
<span id="cb184-272"><a href="#cb184-272" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-273"><a href="#cb184-273" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb184-274"><a href="#cb184-274" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb184-275"><a href="#cb184-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-276"><a href="#cb184-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-277"><a href="#cb184-277" aria-hidden="true" tabindex="-1"></a>Rather than calling <span class="in">`$train()`</span> and <span class="in">`$predict()`</span> manually, we can put the pipeline <span class="in">`r ref("Graph")`</span> into a <span class="in">`r ref("GraphLearner")`</span> object.</span>
<span id="cb184-278"><a href="#cb184-278" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("GraphLearner")`</span> encapsulates the whole pipeline (including the preprocessing steps) and can be put into <span class="in">`r ref("resample()")`</span> or <span class="in">`r ref("benchmark()")`</span> .</span>
<span id="cb184-279"><a href="#cb184-279" aria-hidden="true" tabindex="-1"></a>If you are familiar with the old _mlr_ package, this is the equivalent of all the <span class="in">`make*Wrapper()`</span> functions.</span>
<span id="cb184-280"><a href="#cb184-280" aria-hidden="true" tabindex="-1"></a>The pipeline being encapsulated (here <span class="in">`r ref("Graph")`</span>) must always produce a <span class="in">`r ref("Prediction")`</span>  with its <span class="in">`$predict()`</span> call, so it will probably contain at least one <span class="in">`r ref("PipeOpLearner")`</span> .</span>
<span id="cb184-281"><a href="#cb184-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-282"><a href="#cb184-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-028}</span></span>
<span id="cb184-283"><a href="#cb184-283" aria-hidden="true" tabindex="-1"></a>glrn <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span>
<span id="cb184-284"><a href="#cb184-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-285"><a href="#cb184-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-286"><a href="#cb184-286" aria-hidden="true" tabindex="-1"></a>This learner can be used for model fitting, resampling, benchmarking, and tuning:</span>
<span id="cb184-287"><a href="#cb184-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-288"><a href="#cb184-288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-029}</span></span>
<span id="cb184-289"><a href="#cb184-289" aria-hidden="true" tabindex="-1"></a>cv3 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb184-290"><a href="#cb184-290" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, glrn, cv3)</span>
<span id="cb184-291"><a href="#cb184-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-292"><a href="#cb184-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-293"><a href="#cb184-293" aria-hidden="true" tabindex="-1"></a><span class="fu">### Setting Hyperparameters {#pipe-hyperpars}</span></span>
<span id="cb184-294"><a href="#cb184-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-295"><a href="#cb184-295" aria-hidden="true" tabindex="-1"></a>Individual POs offer hyperparameters because they contain <span class="in">`$param_set`</span> slots that can be read and written from <span class="in">`$param_set$values`</span> (via the <span class="in">`r ref_pkg("paradox")`</span> package).</span>
<span id="cb184-296"><a href="#cb184-296" aria-hidden="true" tabindex="-1"></a>The parameters get passed down to the <span class="in">`r ref("Graph")`</span>, and finally to the <span class="in">`r ref("GraphLearner")`</span> .</span>
<span id="cb184-297"><a href="#cb184-297" aria-hidden="true" tabindex="-1"></a>This makes it not only possible to easily change the behavior of a <span class="in">`r ref("Graph")`</span>  / <span class="in">`r ref("GraphLearner")`</span> and try different settings manually, but also to perform tuning using the <span class="in">`r mlr3tuning`</span> package.</span>
<span id="cb184-298"><a href="#cb184-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-299"><a href="#cb184-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-030}</span></span>
<span id="cb184-300"><a href="#cb184-300" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>variance.filter.frac <span class="ot">=</span> <span class="fl">0.25</span></span>
<span id="cb184-301"><a href="#cb184-301" aria-hidden="true" tabindex="-1"></a>cv3 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb184-302"><a href="#cb184-302" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, glrn, cv3)</span>
<span id="cb184-303"><a href="#cb184-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-304"><a href="#cb184-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-305"><a href="#cb184-305" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tuning {#pipe-tuning}</span></span>
<span id="cb184-306"><a href="#cb184-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-307"><a href="#cb184-307" aria-hidden="true" tabindex="-1"></a>If you are unfamiliar with tuning in <span class="in">`r mlr3`</span>, we recommend to take a look at the section about <span class="co">[</span><span class="ot">tuning</span><span class="co">](#tuning)</span> first.</span>
<span id="cb184-308"><a href="#cb184-308" aria-hidden="true" tabindex="-1"></a>Here we define a <span class="in">`r ref("ParamSet")`</span> for the "rpart" learner and the "variance" filter which should be optimized during the tuning process.</span>
<span id="cb184-309"><a href="#cb184-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-310"><a href="#cb184-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-031}</span></span>
<span id="cb184-311"><a href="#cb184-311" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"paradox"</span>)</span>
<span id="cb184-312"><a href="#cb184-312" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb184-313"><a href="#cb184-313" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.rpart.cp =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="fl">0.05</span>),</span>
<span id="cb184-314"><a href="#cb184-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">variance.filter.frac =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="fl">0.25</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb184-315"><a href="#cb184-315" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-316"><a href="#cb184-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-317"><a href="#cb184-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-318"><a href="#cb184-318" aria-hidden="true" tabindex="-1"></a>After having defined the <span class="in">`r ref("Tuner")`</span>, a random search with 10 iterations is created.</span>
<span id="cb184-319"><a href="#cb184-319" aria-hidden="true" tabindex="-1"></a>For the inner resampling, we are simply using holdout (single split into train/test) to keep the runtimes reasonable.</span>
<span id="cb184-320"><a href="#cb184-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-321"><a href="#cb184-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-032}</span></span>
<span id="cb184-322"><a href="#cb184-322" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3tuning"</span>)</span>
<span id="cb184-323"><a href="#cb184-323" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb184-324"><a href="#cb184-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb184-325"><a href="#cb184-325" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> glrn,</span>
<span id="cb184-326"><a href="#cb184-326" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb184-327"><a href="#cb184-327" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb184-328"><a href="#cb184-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> ps,</span>
<span id="cb184-329"><a href="#cb184-329" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">20</span>)</span>
<span id="cb184-330"><a href="#cb184-330" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-331"><a href="#cb184-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-332"><a href="#cb184-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-333"><a href="#cb184-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-033}</span></span>
<span id="cb184-334"><a href="#cb184-334" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>)</span>
<span id="cb184-335"><a href="#cb184-335" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb184-336"><a href="#cb184-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-337"><a href="#cb184-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-338"><a href="#cb184-338" aria-hidden="true" tabindex="-1"></a>The tuning result can be found in the respective <span class="in">`result`</span> slots.</span>
<span id="cb184-339"><a href="#cb184-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-340"><a href="#cb184-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-034}</span></span>
<span id="cb184-341"><a href="#cb184-341" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>result_learner_param_vals</span>
<span id="cb184-342"><a href="#cb184-342" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>result_y</span>
<span id="cb184-343"><a href="#cb184-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-344"><a href="#cb184-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-345"><a href="#cb184-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Non-Linear Graphs {#pipe-nonlinear}</span></span>
<span id="cb184-346"><a href="#cb184-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-347"><a href="#cb184-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-035, include = FALSE}</span></span>
<span id="cb184-348"><a href="#cb184-348" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-349"><a href="#cb184-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-350"><a href="#cb184-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-351"><a href="#cb184-351" aria-hidden="true" tabindex="-1"></a>The Graphs seen so far all have a linear structure.</span>
<span id="cb184-352"><a href="#cb184-352" aria-hidden="true" tabindex="-1"></a>Some POs may have multiple input or output channels.</span>
<span id="cb184-353"><a href="#cb184-353" aria-hidden="true" tabindex="-1"></a>These channels make it possible to create non-linear Graphs with alternative paths taken by the data.</span>
<span id="cb184-354"><a href="#cb184-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-355"><a href="#cb184-355" aria-hidden="true" tabindex="-1"></a>Possible types are:</span>
<span id="cb184-356"><a href="#cb184-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-357"><a href="#cb184-357" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Branching</span><span class="co">](#pipe-model-ensembles-branching-copying)</span>:</span>
<span id="cb184-358"><a href="#cb184-358" aria-hidden="true" tabindex="-1"></a>  Splitting of a node into several paths, e.g. useful when comparing multiple feature-selection methods (pca, filters).</span>
<span id="cb184-359"><a href="#cb184-359" aria-hidden="true" tabindex="-1"></a>  Only one path will be executed.</span>
<span id="cb184-360"><a href="#cb184-360" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Copying</span><span class="co">](#pipe-model-ensembles-branching-copying)</span>:</span>
<span id="cb184-361"><a href="#cb184-361" aria-hidden="true" tabindex="-1"></a>  Splitting of a node into several paths, all paths will be executed (sequentially).</span>
<span id="cb184-362"><a href="#cb184-362" aria-hidden="true" tabindex="-1"></a>  Parallel execution is not yet supported.</span>
<span id="cb184-363"><a href="#cb184-363" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Stacking</span><span class="co">](#pipe-model-ensembles-stacking)</span>:</span>
<span id="cb184-364"><a href="#cb184-364" aria-hidden="true" tabindex="-1"></a>  Single graphs are stacked onto each other, i.e. the output of one <span class="in">`r ref("Graph")`</span> is the input for another.</span>
<span id="cb184-365"><a href="#cb184-365" aria-hidden="true" tabindex="-1"></a>  In machine learning this means that the prediction of one <span class="in">`r ref("Graph")`</span> is used as input for another <span class="in">`r ref("Graph")`</span></span>
<span id="cb184-366"><a href="#cb184-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-367"><a href="#cb184-367" aria-hidden="true" tabindex="-1"></a><span class="fu">### Branching &amp; Copying {#pipe-model-ensembles-branching-copying}</span></span>
<span id="cb184-368"><a href="#cb184-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-369"><a href="#cb184-369" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("PipeOpBranch")`</span> and <span class="in">`r ref("PipeOpUnbranch")`</span> POs make it possible to specify multiple alternative paths.</span>
<span id="cb184-370"><a href="#cb184-370" aria-hidden="true" tabindex="-1"></a>Only one path is actually executed, the others are ignored.</span>
<span id="cb184-371"><a href="#cb184-371" aria-hidden="true" tabindex="-1"></a>The active path is determined by a hyperparameter.</span>
<span id="cb184-372"><a href="#cb184-372" aria-hidden="true" tabindex="-1"></a>This concept makes it possible to tune alternative preprocessing paths (or learner models).</span>
<span id="cb184-373"><a href="#cb184-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-374"><a href="#cb184-374" aria-hidden="true" tabindex="-1"></a>Below a conceptual visualization of branching:</span>
<span id="cb184-375"><a href="#cb184-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-376"><a href="#cb184-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-036, echo=FALSE, fig.align='center', out.width="98%"}</span></span>
<span id="cb184-377"><a href="#cb184-377" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/branching.svg"</span>)</span>
<span id="cb184-378"><a href="#cb184-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-379"><a href="#cb184-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-380"><a href="#cb184-380" aria-hidden="true" tabindex="-1"></a><span class="in">`PipeOp(Un)Branch`</span> is initialized either with the number of branches, or with a <span class="in">`character`</span>-vector indicating the names of the branches.</span>
<span id="cb184-381"><a href="#cb184-381" aria-hidden="true" tabindex="-1"></a>If names are given, the "branch-choosing" hyperparameter becomes more readable.</span>
<span id="cb184-382"><a href="#cb184-382" aria-hidden="true" tabindex="-1"></a>In the following, we set three options:</span>
<span id="cb184-383"><a href="#cb184-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-384"><a href="#cb184-384" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Doing nothing ("nop")</span>
<span id="cb184-385"><a href="#cb184-385" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Applying a PCA</span>
<span id="cb184-386"><a href="#cb184-386" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Scaling the data</span>
<span id="cb184-387"><a href="#cb184-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-388"><a href="#cb184-388" aria-hidden="true" tabindex="-1"></a>It is important to "unbranch" again after "branching", so that the outputs are merged into one result objects.</span>
<span id="cb184-389"><a href="#cb184-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-390"><a href="#cb184-390" aria-hidden="true" tabindex="-1"></a>In the following we first create the branched graph and then show what happens if the "unbranching" is not applied:</span>
<span id="cb184-391"><a href="#cb184-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-392"><a href="#cb184-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-037, eval = TRUE}</span></span>
<span id="cb184-393"><a href="#cb184-393" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-394"><a href="#cb184-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb184-395"><a href="#cb184-395" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"null1"</span>),</span>
<span id="cb184-396"><a href="#cb184-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"pca"</span>),</span>
<span id="cb184-397"><a href="#cb184-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-398"><a href="#cb184-398" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb184-399"><a href="#cb184-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-400"><a href="#cb184-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-401"><a href="#cb184-401" aria-hidden="true" tabindex="-1"></a>Without "unbranching" one creates the following graph:</span>
<span id="cb184-402"><a href="#cb184-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-403"><a href="#cb184-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-038}</span></span>
<span id="cb184-404"><a href="#cb184-404" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-405"><a href="#cb184-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-406"><a href="#cb184-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-407"><a href="#cb184-407" aria-hidden="true" tabindex="-1"></a>Now when "unbranching", we obtain the following results:</span>
<span id="cb184-408"><a href="#cb184-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-409"><a href="#cb184-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-039}</span></span>
<span id="cb184-410"><a href="#cb184-410" aria-hidden="true" tabindex="-1"></a>(graph <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)))<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-411"><a href="#cb184-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-412"><a href="#cb184-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-413"><a href="#cb184-413" aria-hidden="true" tabindex="-1"></a>The same can be achieved using a shorter notation:</span>
<span id="cb184-414"><a href="#cb184-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-415"><a href="#cb184-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-040}</span></span>
<span id="cb184-416"><a href="#cb184-416" aria-hidden="true" tabindex="-1"></a><span class="co"># List of pipeops</span></span>
<span id="cb184-417"><a href="#cb184-417" aria-hidden="true" tabindex="-1"></a>opts <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">po</span>(<span class="st">"nop"</span>, <span class="st">"no_op"</span>), <span class="fu">po</span>(<span class="st">"pca"</span>), <span class="fu">po</span>(<span class="st">"scale"</span>))</span>
<span id="cb184-418"><a href="#cb184-418" aria-hidden="true" tabindex="-1"></a><span class="co"># List of po ids</span></span>
<span id="cb184-419"><a href="#cb184-419" aria-hidden="true" tabindex="-1"></a>opt_ids <span class="ot">=</span> mlr3misc<span class="sc">::</span><span class="fu">map_chr</span>(opts, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="st">"id"</span>)</span>
<span id="cb184-420"><a href="#cb184-420" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"branch"</span>, <span class="at">options =</span> opt_ids) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-421"><a href="#cb184-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(opts) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-422"><a href="#cb184-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="at">options =</span> opt_ids)</span>
<span id="cb184-423"><a href="#cb184-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-424"><a href="#cb184-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-425"><a href="#cb184-425" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Ensembles {#pipe-model-ensembles}</span></span>
<span id="cb184-426"><a href="#cb184-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-427"><a href="#cb184-427" aria-hidden="true" tabindex="-1"></a>We can leverage the different operations presented to connect POs.</span>
<span id="cb184-428"><a href="#cb184-428" aria-hidden="true" tabindex="-1"></a>This allows us to form powerful graphs.</span>
<span id="cb184-429"><a href="#cb184-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-430"><a href="#cb184-430" aria-hidden="true" tabindex="-1"></a>Before we go into details, we split the task into train and test indices.</span>
<span id="cb184-431"><a href="#cb184-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-432"><a href="#cb184-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-041}</span></span>
<span id="cb184-433"><a href="#cb184-433" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-434"><a href="#cb184-434" aria-hidden="true" tabindex="-1"></a>train.idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), <span class="dv">120</span>)</span>
<span id="cb184-435"><a href="#cb184-435" aria-hidden="true" tabindex="-1"></a>test.idx <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train.idx)</span>
<span id="cb184-436"><a href="#cb184-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-437"><a href="#cb184-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-438"><a href="#cb184-438" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Bagging {#pipe-model-ensembles-bagging}</span></span>
<span id="cb184-439"><a href="#cb184-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-440"><a href="#cb184-440" aria-hidden="true" tabindex="-1"></a>We first examine Bagging introduced by <span class="co">[</span><span class="ot">@Breiman1996</span><span class="co">]</span>.</span>
<span id="cb184-441"><a href="#cb184-441" aria-hidden="true" tabindex="-1"></a>The basic idea is to create multiple predictors and then aggregate those to a single, more powerful predictor.</span>
<span id="cb184-442"><a href="#cb184-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-443"><a href="#cb184-443" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; "... multiple versions are formed</span></span>
<span id="cb184-444"><a href="#cb184-444" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; by making bootstrap replicates of the learning set</span></span>
<span id="cb184-445"><a href="#cb184-445" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; and using these as new learning sets" </span><span class="co">[</span><span class="ot">@Breiman1996</span><span class="co">]</span></span>
<span id="cb184-446"><a href="#cb184-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-447"><a href="#cb184-447" aria-hidden="true" tabindex="-1"></a>Bagging then aggregates a set of predictors by averaging (regression) or majority vote (classification).</span>
<span id="cb184-448"><a href="#cb184-448" aria-hidden="true" tabindex="-1"></a>The idea behind bagging is, that a set of weak, but different predictors can be combined in order to arrive at a single, better predictor.</span>
<span id="cb184-449"><a href="#cb184-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-450"><a href="#cb184-450" aria-hidden="true" tabindex="-1"></a>We can achieve this by downsampling our data before training a learner, repeating this e.g. 10 times and then performing a majority vote on the predictions.</span>
<span id="cb184-451"><a href="#cb184-451" aria-hidden="true" tabindex="-1"></a>Graphically, it may be summarized as follows:</span>
<span id="cb184-452"><a href="#cb184-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-453"><a href="#cb184-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-042, echo=FALSE}</span></span>
<span id="cb184-454"><a href="#cb184-454" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/nonlinear_pipeops.svg"</span>)</span>
<span id="cb184-455"><a href="#cb184-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-456"><a href="#cb184-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-457"><a href="#cb184-457" aria-hidden="true" tabindex="-1"></a>First, we create a simple pipeline, that uses <span class="in">`r ref("PipeOpSubsample")`</span> before a <span class="in">`r ref("PipeOpLearner")`</span> is trained:</span>
<span id="cb184-458"><a href="#cb184-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-459"><a href="#cb184-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-043}</span></span>
<span id="cb184-460"><a href="#cb184-460" aria-hidden="true" tabindex="-1"></a>single_pred <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"subsample"</span>, <span class="at">frac =</span> <span class="fl">0.7</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-461"><a href="#cb184-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-462"><a href="#cb184-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-463"><a href="#cb184-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-464"><a href="#cb184-464" aria-hidden="true" tabindex="-1"></a>We can now copy this operation 10 times using <span class="in">`r ref("pipeline_greplicate")`</span>.</span>
<span id="cb184-465"><a href="#cb184-465" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("pipeline_greplicate")`</span> allows us to parallelize many copies of an operation by creating a Graph containing <span class="in">`n`</span> copies of the input Graph.</span>
<span id="cb184-466"><a href="#cb184-466" aria-hidden="true" tabindex="-1"></a>We can also create it using  **syntactic sugar** via <span class="in">`r ref("ppl()")`</span>:</span>
<span id="cb184-467"><a href="#cb184-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-468"><a href="#cb184-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-044}</span></span>
<span id="cb184-469"><a href="#cb184-469" aria-hidden="true" tabindex="-1"></a>pred_set <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"greplicate"</span>, single_pred, 10L)</span>
<span id="cb184-470"><a href="#cb184-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-471"><a href="#cb184-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-472"><a href="#cb184-472" aria-hidden="true" tabindex="-1"></a>Afterwards we need to aggregate the 10 pipelines to form a single model:</span>
<span id="cb184-473"><a href="#cb184-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-474"><a href="#cb184-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-045}</span></span>
<span id="cb184-475"><a href="#cb184-475" aria-hidden="true" tabindex="-1"></a>bagging <span class="ot">=</span> pred_set <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-476"><a href="#cb184-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"classifavg"</span>, <span class="at">innum =</span> <span class="dv">10</span>)</span>
<span id="cb184-477"><a href="#cb184-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-478"><a href="#cb184-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-479"><a href="#cb184-479" aria-hidden="true" tabindex="-1"></a>Now we can plot again to see what happens:</span>
<span id="cb184-480"><a href="#cb184-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-481"><a href="#cb184-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-046, fig.width=7.5}</span></span>
<span id="cb184-482"><a href="#cb184-482" aria-hidden="true" tabindex="-1"></a>bagging<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-483"><a href="#cb184-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-484"><a href="#cb184-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-485"><a href="#cb184-485" aria-hidden="true" tabindex="-1"></a>This pipeline can again be used in conjunction with <span class="in">`r ref("GraphLearner")`</span> in order for Bagging to be used like a <span class="in">`r ref("Learner")`</span>:</span>
<span id="cb184-486"><a href="#cb184-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-487"><a href="#cb184-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-047}</span></span>
<span id="cb184-488"><a href="#cb184-488" aria-hidden="true" tabindex="-1"></a>baglrn <span class="ot">=</span> <span class="fu">as_learner</span>(bagging)</span>
<span id="cb184-489"><a href="#cb184-489" aria-hidden="true" tabindex="-1"></a>baglrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)</span>
<span id="cb184-490"><a href="#cb184-490" aria-hidden="true" tabindex="-1"></a>baglrn<span class="sc">$</span><span class="fu">predict</span>(task, test.idx)</span>
<span id="cb184-491"><a href="#cb184-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-492"><a href="#cb184-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-493"><a href="#cb184-493" aria-hidden="true" tabindex="-1"></a>In conjunction with different <span class="in">`Backends`</span>, this can be a very powerful tool.</span>
<span id="cb184-494"><a href="#cb184-494" aria-hidden="true" tabindex="-1"></a>In cases when the data does not fully fit in memory, one can obtain a fraction of the data for each learner from a <span class="in">`r ref("DataBackend")`</span> and then aggregate predictions over all learners.</span>
<span id="cb184-495"><a href="#cb184-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-496"><a href="#cb184-496" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stacking {#pipe-model-ensembles-stacking}</span></span>
<span id="cb184-497"><a href="#cb184-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-498"><a href="#cb184-498" aria-hidden="true" tabindex="-1"></a>Stacking <span class="co">[</span><span class="ot">@Wolpert1992</span><span class="co">]</span> is another technique that can improve model performance.</span>
<span id="cb184-499"><a href="#cb184-499" aria-hidden="true" tabindex="-1"></a>The basic idea behind stacking is the use of predictions from one model as features for a subsequent model to possibly improve performance.</span>
<span id="cb184-500"><a href="#cb184-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-501"><a href="#cb184-501" aria-hidden="true" tabindex="-1"></a>Below an conceptual illustration of stacking:</span>
<span id="cb184-502"><a href="#cb184-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-503"><a href="#cb184-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-048, echo=FALSE, fig.align='center', out.width="98%"}</span></span>
<span id="cb184-504"><a href="#cb184-504" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/stacking.svg"</span>)</span>
<span id="cb184-505"><a href="#cb184-505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-506"><a href="#cb184-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-507"><a href="#cb184-507" aria-hidden="true" tabindex="-1"></a>As an example we can train a decision tree and use the predictions from this model in conjunction with the original features in order to train an additional model on top.</span>
<span id="cb184-508"><a href="#cb184-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-509"><a href="#cb184-509" aria-hidden="true" tabindex="-1"></a>To limit overfitting, we additionally do not predict on the original predictions of the learner.</span>
<span id="cb184-510"><a href="#cb184-510" aria-hidden="true" tabindex="-1"></a>Instead, we predict on out-of-bag predictions.</span>
<span id="cb184-511"><a href="#cb184-511" aria-hidden="true" tabindex="-1"></a>To do all this, we can use <span class="in">`r ref("PipeOpLearnerCV")`</span> .</span>
<span id="cb184-512"><a href="#cb184-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-513"><a href="#cb184-513" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOpLearnerCV")`</span> performs nested cross-validation on the training data, fitting a model in each fold.</span>
<span id="cb184-514"><a href="#cb184-514" aria-hidden="true" tabindex="-1"></a>Each of the models is then used to predict on the out-of-fold data.</span>
<span id="cb184-515"><a href="#cb184-515" aria-hidden="true" tabindex="-1"></a>As a result, we obtain predictions for every data point in our input data.</span>
<span id="cb184-516"><a href="#cb184-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-517"><a href="#cb184-517" aria-hidden="true" tabindex="-1"></a>We first create a "level 0" learner, which is used to extract a lower level prediction.</span>
<span id="cb184-518"><a href="#cb184-518" aria-hidden="true" tabindex="-1"></a>Additionally, we <span class="in">`$clone()`</span> the learner object to obtain a copy of the learner.</span>
<span id="cb184-519"><a href="#cb184-519" aria-hidden="true" tabindex="-1"></a>Subsequently, one sets a custom id for the <span class="in">`r ref("PipeOp")`</span> .</span>
<span id="cb184-520"><a href="#cb184-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-521"><a href="#cb184-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-049, eval = TRUE}</span></span>
<span id="cb184-522"><a href="#cb184-522" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb184-523"><a href="#cb184-523" aria-hidden="true" tabindex="-1"></a>lrn_0 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, lrn<span class="sc">$</span><span class="fu">clone</span>())</span>
<span id="cb184-524"><a href="#cb184-524" aria-hidden="true" tabindex="-1"></a>lrn_0<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"rpart_cv"</span></span>
<span id="cb184-525"><a href="#cb184-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-526"><a href="#cb184-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-527"><a href="#cb184-527" aria-hidden="true" tabindex="-1"></a>We use <span class="in">`r ref("PipeOpNOP")`</span>  in combination with <span class="in">`r ref("gunion")`</span>, in order to send the unchanged Task to the next level.</span>
<span id="cb184-528"><a href="#cb184-528" aria-hidden="true" tabindex="-1"></a>There it is combined with the predictions from our decision tree learner.</span>
<span id="cb184-529"><a href="#cb184-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-530"><a href="#cb184-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-050, eval = TRUE}</span></span>
<span id="cb184-531"><a href="#cb184-531" aria-hidden="true" tabindex="-1"></a>level_0 <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(lrn_0, <span class="fu">po</span>(<span class="st">"nop"</span>)))</span>
<span id="cb184-532"><a href="#cb184-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-533"><a href="#cb184-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-534"><a href="#cb184-534" aria-hidden="true" tabindex="-1"></a>Afterwards, we want to concatenate the predictions from <span class="in">`r ref("PipeOpLearnerCV")`</span> and the original Task using <span class="in">`r ref("PipeOpFeatureUnion")`</span> :</span>
<span id="cb184-535"><a href="#cb184-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-536"><a href="#cb184-536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-051, eval = TRUE}</span></span>
<span id="cb184-537"><a href="#cb184-537" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">=</span> level_0 <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">2</span>)</span>
<span id="cb184-538"><a href="#cb184-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-539"><a href="#cb184-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-540"><a href="#cb184-540" aria-hidden="true" tabindex="-1"></a>Now we can train another learner on top of the combined features:</span>
<span id="cb184-541"><a href="#cb184-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-542"><a href="#cb184-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-052, fig.width=7.5, eval = TRUE}</span></span>
<span id="cb184-543"><a href="#cb184-543" aria-hidden="true" tabindex="-1"></a>stack <span class="ot">=</span> combined <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner"</span>, lrn<span class="sc">$</span><span class="fu">clone</span>())</span>
<span id="cb184-544"><a href="#cb184-544" aria-hidden="true" tabindex="-1"></a>stack<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-545"><a href="#cb184-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-546"><a href="#cb184-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-547"><a href="#cb184-547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-053, eval = TRUE}</span></span>
<span id="cb184-548"><a href="#cb184-548" aria-hidden="true" tabindex="-1"></a>stacklrn <span class="ot">=</span> <span class="fu">as_learner</span>(stack)</span>
<span id="cb184-549"><a href="#cb184-549" aria-hidden="true" tabindex="-1"></a>stacklrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)</span>
<span id="cb184-550"><a href="#cb184-550" aria-hidden="true" tabindex="-1"></a>stacklrn<span class="sc">$</span><span class="fu">predict</span>(task, test.idx)</span>
<span id="cb184-551"><a href="#cb184-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-552"><a href="#cb184-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-553"><a href="#cb184-553" aria-hidden="true" tabindex="-1"></a>In this vignette, we showed a very simple use-case for stacking.</span>
<span id="cb184-554"><a href="#cb184-554" aria-hidden="true" tabindex="-1"></a>In many real-world applications, stacking is done for multiple levels and on multiple representations of the dataset.</span>
<span id="cb184-555"><a href="#cb184-555" aria-hidden="true" tabindex="-1"></a>On a lower level, different preprocessing methods can be defined in conjunction with several learners.</span>
<span id="cb184-556"><a href="#cb184-556" aria-hidden="true" tabindex="-1"></a>On a higher level, we can then combine those predictions in order to form a very powerful model.</span>
<span id="cb184-557"><a href="#cb184-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-558"><a href="#cb184-558" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Multilevel Stacking</span></span>
<span id="cb184-559"><a href="#cb184-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-560"><a href="#cb184-560" aria-hidden="true" tabindex="-1"></a>In order to showcase the power of <span class="in">`r mlr3pipelines`</span>, we will show a more complicated stacking example.</span>
<span id="cb184-561"><a href="#cb184-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-562"><a href="#cb184-562" aria-hidden="true" tabindex="-1"></a>In this case, we train a <span class="in">`r ref_pkg("glmnet")`</span> and 2 different <span class="in">`r ref_pkg("rpart")`</span> models (some transform its inputs using <span class="in">`r ref("PipeOpPCA")`</span>) on our task in the "level 0" and concatenate them with the original features (via <span class="in">`r ref("gunion")`</span>).</span>
<span id="cb184-563"><a href="#cb184-563" aria-hidden="true" tabindex="-1"></a>The result is then passed on to "level 1", where we copy the concatenated features 3 times and put this task into an <span class="in">`r ref_pkg("rpart")`</span> and a <span class="in">`r ref_pkg("glmnet")`</span> model.</span>
<span id="cb184-564"><a href="#cb184-564" aria-hidden="true" tabindex="-1"></a>Additionally, we keep a version of the "level 0" output (via <span class="in">`r ref("PipeOpNOP")`</span>) and pass this on to "level 2".</span>
<span id="cb184-565"><a href="#cb184-565" aria-hidden="true" tabindex="-1"></a>In "level 2" we simply concatenate all "level 1" outputs and train a final decision tree.</span>
<span id="cb184-566"><a href="#cb184-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-567"><a href="#cb184-567" aria-hidden="true" tabindex="-1"></a>In the following examples, use <span class="in">`&lt;lrn&gt;$param_set$values$&lt;param_name&gt; = &lt;param_value&gt;`</span> to set hyperparameters for the different learner.</span>
<span id="cb184-568"><a href="#cb184-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-569"><a href="#cb184-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-054}</span></span>
<span id="cb184-570"><a href="#cb184-570" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb184-571"><a href="#cb184-571" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3learners"</span>) <span class="co"># for classif.glmnet</span></span>
<span id="cb184-572"><a href="#cb184-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-573"><a href="#cb184-573" aria-hidden="true" tabindex="-1"></a>rprt <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb184-574"><a href="#cb184-574" aria-hidden="true" tabindex="-1"></a>glmn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.glmnet"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb184-575"><a href="#cb184-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-576"><a href="#cb184-576" aria-hidden="true" tabindex="-1"></a><span class="co">#  Create Learner CV Operators</span></span>
<span id="cb184-577"><a href="#cb184-577" aria-hidden="true" tabindex="-1"></a>lrn_0 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_1"</span>)</span>
<span id="cb184-578"><a href="#cb184-578" aria-hidden="true" tabindex="-1"></a>lrn_0<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>maxdepth <span class="ot">=</span> 5L</span>
<span id="cb184-579"><a href="#cb184-579" aria-hidden="true" tabindex="-1"></a>lrn_1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca1"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_2"</span>)</span>
<span id="cb184-580"><a href="#cb184-580" aria-hidden="true" tabindex="-1"></a>lrn_1<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>rpart_cv_2.maxdepth <span class="ot">=</span> 1L</span>
<span id="cb184-581"><a href="#cb184-581" aria-hidden="true" tabindex="-1"></a>lrn_2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca2"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, glmn)</span>
<span id="cb184-582"><a href="#cb184-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-583"><a href="#cb184-583" aria-hidden="true" tabindex="-1"></a><span class="co"># Union them with a PipeOpNULL to keep original features</span></span>
<span id="cb184-584"><a href="#cb184-584" aria-hidden="true" tabindex="-1"></a>level_0 <span class="ot">=</span> <span class="fu">gunion</span>(<span class="fu">list</span>(lrn_0, lrn_1, lrn_2, <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"NOP1"</span>)))</span>
<span id="cb184-585"><a href="#cb184-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-586"><a href="#cb184-586" aria-hidden="true" tabindex="-1"></a><span class="co"># Cbind the output 3 times, train 2 learners but also keep level</span></span>
<span id="cb184-587"><a href="#cb184-587" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 predictions</span></span>
<span id="cb184-588"><a href="#cb184-588" aria-hidden="true" tabindex="-1"></a>level_1 <span class="ot">=</span> level_0 <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-589"><a href="#cb184-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">4</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-590"><a href="#cb184-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"copy"</span>, <span class="dv">3</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-591"><a href="#cb184-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb184-592"><a href="#cb184-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"learner_cv"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_cv_l1"</span>),</span>
<span id="cb184-593"><a href="#cb184-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"learner_cv"</span>, glmn, <span class="at">id =</span> <span class="st">"glmnt_cv_l1"</span>),</span>
<span id="cb184-594"><a href="#cb184-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"NOP_l1"</span>)</span>
<span id="cb184-595"><a href="#cb184-595" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb184-596"><a href="#cb184-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-597"><a href="#cb184-597" aria-hidden="true" tabindex="-1"></a><span class="co"># Cbind predictions, train a final learner</span></span>
<span id="cb184-598"><a href="#cb184-598" aria-hidden="true" tabindex="-1"></a>level_2 <span class="ot">=</span> level_1 <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-599"><a href="#cb184-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"u2"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-600"><a href="#cb184-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, rprt, <span class="at">id =</span> <span class="st">"rpart_l2"</span>)</span>
<span id="cb184-601"><a href="#cb184-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-602"><a href="#cb184-602" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the resulting graph</span></span>
<span id="cb184-603"><a href="#cb184-603" aria-hidden="true" tabindex="-1"></a>level_2<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-604"><a href="#cb184-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-605"><a href="#cb184-605" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-606"><a href="#cb184-606" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">as_learner</span>(level_2)</span>
<span id="cb184-607"><a href="#cb184-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-608"><a href="#cb184-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-609"><a href="#cb184-609" aria-hidden="true" tabindex="-1"></a>And we can again call <span class="in">`.$train`</span> and <span class="in">`.$predict`</span>:</span>
<span id="cb184-610"><a href="#cb184-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-611"><a href="#cb184-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-055, warning=FALSE}</span></span>
<span id="cb184-612"><a href="#cb184-612" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span></span>
<span id="cb184-613"><a href="#cb184-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">train</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb184-614"><a href="#cb184-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(task, test.idx)<span class="sc">$</span></span>
<span id="cb184-615"><a href="#cb184-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">score</span>()</span>
<span id="cb184-616"><a href="#cb184-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-617"><a href="#cb184-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-618"><a href="#cb184-618" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding new PipeOps {#extending-pipeops}</span></span>
<span id="cb184-619"><a href="#cb184-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-620"><a href="#cb184-620" aria-hidden="true" tabindex="-1"></a>This section showcases how the <span class="in">`r mlr3pipelines`</span> package can be extended to include custom <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-621"><a href="#cb184-621" aria-hidden="true" tabindex="-1"></a>To run the following examples, we will need a <span class="in">`r ref("Task")`</span>; we are using the well-known "Iris" task:</span>
<span id="cb184-622"><a href="#cb184-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-623"><a href="#cb184-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-056}</span></span>
<span id="cb184-624"><a href="#cb184-624" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3"</span>)</span>
<span id="cb184-625"><a href="#cb184-625" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-626"><a href="#cb184-626" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-627"><a href="#cb184-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-628"><a href="#cb184-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-629"><a href="#cb184-629" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> is fundamentally built around <span class="co">[</span><span class="ot">`R6`</span><span class="co">](https://r6.r-lib.org/)</span>.</span>
<span id="cb184-630"><a href="#cb184-630" aria-hidden="true" tabindex="-1"></a>When planning to create custom <span class="in">`r ref("PipeOp")`</span> objects, it can only help to <span class="co">[</span><span class="ot">familiarize yourself with it</span><span class="co">](https://adv-r.hadley.nz/r6.html)</span>.</span>
<span id="cb184-631"><a href="#cb184-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-632"><a href="#cb184-632" aria-hidden="true" tabindex="-1"></a>In principle, all a <span class="in">`r ref("PipeOp")`</span> must do is inherit from the <span class="in">`r ref("PipeOp")`</span> R6 class and implement the <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> functions.</span>
<span id="cb184-633"><a href="#cb184-633" aria-hidden="true" tabindex="-1"></a>There are, however, several auxiliary subclasses that can make the creation of *certain* operations much easier.</span>
<span id="cb184-634"><a href="#cb184-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-635"><a href="#cb184-635" aria-hidden="true" tabindex="-1"></a><span class="fu">### General Case Example: `PipeOpCopy` {#ext-pipeopcopy}</span></span>
<span id="cb184-636"><a href="#cb184-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-637"><a href="#cb184-637" aria-hidden="true" tabindex="-1"></a>A very simple yet useful <span class="in">`r ref("PipeOp")`</span> is <span class="in">`PipeOpCopy`</span>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data.</span>
<span id="cb184-638"><a href="#cb184-638" aria-hidden="true" tabindex="-1"></a>It is a simple example that showcases the important steps in defining a custom <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb184-639"><a href="#cb184-639" aria-hidden="true" tabindex="-1"></a>We will show a simplified version here, **`PipeOpCopyTwo`**, that creates exactly two copies of its input data.</span>
<span id="cb184-640"><a href="#cb184-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-641"><a href="#cb184-641" aria-hidden="true" tabindex="-1"></a>The following figure visualizes how our <span class="in">`r ref("PipeOp")`</span> is situated in the <span class="in">`Pipeline`</span> and the significant in- and outputs.</span>
<span id="cb184-642"><a href="#cb184-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-643"><a href="#cb184-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-057, echo=FALSE}</span></span>
<span id="cb184-644"><a href="#cb184-644" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_multi_viz.png"</span>)</span>
<span id="cb184-645"><a href="#cb184-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-646"><a href="#cb184-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-647"><a href="#cb184-647" aria-hidden="true" tabindex="-1"></a><span class="fu">#### First Steps: Inheriting from `r ref("PipeOp")`</span></span>
<span id="cb184-648"><a href="#cb184-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-649"><a href="#cb184-649" aria-hidden="true" tabindex="-1"></a>The first part of creating a custom <span class="in">`r ref("PipeOp")`</span> is inheriting from <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb184-650"><a href="#cb184-650" aria-hidden="true" tabindex="-1"></a>We make a mental note that we need to implement a <span class="in">`.train()`</span> and a <span class="in">`.predict()`</span> function, and that we probably want to have an <span class="in">`initialize()`</span> as well:</span>
<span id="cb184-651"><a href="#cb184-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-652"><a href="#cb184-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-058, eval = FALSE, tidy = FALSE}</span></span>
<span id="cb184-653"><a href="#cb184-653" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb184-654"><a href="#cb184-654" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb184-655"><a href="#cb184-655" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-656"><a href="#cb184-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb184-657"><a href="#cb184-657" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb184-658"><a href="#cb184-658" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-659"><a href="#cb184-659" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-660"><a href="#cb184-660" aria-hidden="true" tabindex="-1"></a>  private <span class="sc">==</span> <span class="fu">list</span>(</span>
<span id="cb184-661"><a href="#cb184-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-662"><a href="#cb184-662" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb184-663"><a href="#cb184-663" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-664"><a href="#cb184-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-665"><a href="#cb184-665" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-666"><a href="#cb184-666" aria-hidden="true" tabindex="-1"></a>      ....</span>
<span id="cb184-667"><a href="#cb184-667" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-668"><a href="#cb184-668" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-669"><a href="#cb184-669" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-670"><a href="#cb184-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-671"><a href="#cb184-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-672"><a href="#cb184-672" aria-hidden="true" tabindex="-1"></a>Note, that **private** methods, e.g. <span class="in">`.train`</span> and <span class="in">`.predict`</span> etc are prefixed with a <span class="in">`.`</span>.</span>
<span id="cb184-673"><a href="#cb184-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-674"><a href="#cb184-674" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Channel Definitions</span></span>
<span id="cb184-675"><a href="#cb184-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-676"><a href="#cb184-676" aria-hidden="true" tabindex="-1"></a>We need to tell the <span class="in">`r ref("PipeOp")`</span> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable.</span>
<span id="cb184-677"><a href="#cb184-677" aria-hidden="true" tabindex="-1"></a>This is done on initialization of the <span class="in">`r ref("PipeOp")`</span> (using a <span class="in">`super$initialize`</span> call) by giving the <span class="in">`input`</span> and <span class="in">`output`</span> <span class="in">`data.table`</span> objects.</span>
<span id="cb184-678"><a href="#cb184-678" aria-hidden="true" tabindex="-1"></a>These must have three columns: a <span class="in">`"name"`</span> column giving the names of input and output channels, and a <span class="in">`"train"`</span> and <span class="in">`"predict"`</span> column naming the class of objects we expect during training and prediction as input / output.</span>
<span id="cb184-679"><a href="#cb184-679" aria-hidden="true" tabindex="-1"></a>A special value for these classes is <span class="in">`"*"`</span>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</span>
<span id="cb184-680"><a href="#cb184-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-681"><a href="#cb184-681" aria-hidden="true" tabindex="-1"></a>By convention, we name a single channel <span class="in">`"input"`</span> or <span class="in">`"output"`</span>, and a group of channels <span class="co">[</span><span class="ot">`"input1"`, `"input2"`, ...</span><span class="co">]</span>, unless there is a reason to give specific different names. Therefore, our <span class="in">`input`</span> <span class="in">`data.table`</span> will have a single row <span class="in">`&lt;"input", "*", "*"&gt;`</span>, and our <span class="in">`output`</span> table will have two rows, <span class="in">`&lt;"output1", "*", "*"&gt;`</span> and <span class="in">`&lt;"output2", "*", "*"&gt;`</span>.</span>
<span id="cb184-682"><a href="#cb184-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-683"><a href="#cb184-683" aria-hidden="true" tabindex="-1"></a>All of this is given to the <span class="in">`r ref("PipeOp")`</span> creator. Our <span class="in">`initialize()`</span> will thus look as follows:</span>
<span id="cb184-684"><a href="#cb184-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-685"><a href="#cb184-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-059, eval = FALSE}</span></span>
<span id="cb184-686"><a href="#cb184-686" aria-hidden="true" tabindex="-1"></a>initialize <span class="ot">=</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb184-687"><a href="#cb184-687" aria-hidden="true" tabindex="-1"></a>  input <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb184-688"><a href="#cb184-688" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the following will create two rows and automatically fill the `train`</span></span>
<span id="cb184-689"><a href="#cb184-689" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and `predict` cols with "*"</span></span>
<span id="cb184-690"><a href="#cb184-690" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb184-691"><a href="#cb184-691" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb184-692"><a href="#cb184-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span></span>
<span id="cb184-693"><a href="#cb184-693" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-694"><a href="#cb184-694" aria-hidden="true" tabindex="-1"></a>  super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb184-695"><a href="#cb184-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">input =</span> input,</span>
<span id="cb184-696"><a href="#cb184-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> output</span>
<span id="cb184-697"><a href="#cb184-697" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-698"><a href="#cb184-698" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-699"><a href="#cb184-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-700"><a href="#cb184-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-701"><a href="#cb184-701" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Train and Predict</span></span>
<span id="cb184-702"><a href="#cb184-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-703"><a href="#cb184-703" aria-hidden="true" tabindex="-1"></a>Both <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> will receive a <span class="in">`list`</span> as input and must give a <span class="in">`list`</span> in return.</span>
<span id="cb184-704"><a href="#cb184-704" aria-hidden="true" tabindex="-1"></a>According to our <span class="in">`input`</span> and <span class="in">`output`</span> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <span class="in">`c(inputs, inputs)`</span>.</span>
<span id="cb184-705"><a href="#cb184-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-706"><a href="#cb184-706" aria-hidden="true" tabindex="-1"></a>Two things to consider:</span>
<span id="cb184-707"><a href="#cb184-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-708"><a href="#cb184-708" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The <span class="in">`.train()`</span> function must always modify the <span class="in">`self$state`</span> variable to something that is not <span class="in">`NULL`</span> or <span class="in">`NO_OP`</span>.</span>
<span id="cb184-709"><a href="#cb184-709" aria-hidden="true" tabindex="-1"></a>  This is because the <span class="in">`$state`</span> slot is used as a signal that <span class="in">`r ref("PipeOp")`</span>  has been trained on data, even if the state itself is not important to the <span class="in">`r ref("PipeOp")`</span> (as in our case).</span>
<span id="cb184-710"><a href="#cb184-710" aria-hidden="true" tabindex="-1"></a>  Therefore, our <span class="in">`.train()`</span> will set <span class="in">`self$state = list()`</span>.</span>
<span id="cb184-711"><a href="#cb184-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-712"><a href="#cb184-712" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is not necessary to "clone" our input or make deep copies, because we don't modify the data.</span>
<span id="cb184-713"><a href="#cb184-713" aria-hidden="true" tabindex="-1"></a>  However, if we were changing a reference-passed object, for example by changing data in a <span class="in">`r ref("Task")`</span>, we would have to make a deep copy first.</span>
<span id="cb184-714"><a href="#cb184-714" aria-hidden="true" tabindex="-1"></a>  This is because a <span class="in">`r ref("PipeOp")`</span> may never modify its input object by reference.</span>
<span id="cb184-715"><a href="#cb184-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-716"><a href="#cb184-716" aria-hidden="true" tabindex="-1"></a>Our <span class="in">`.train()`</span> and <span class="in">`.predict()`</span> functions are now:</span>
<span id="cb184-717"><a href="#cb184-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-718"><a href="#cb184-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-060, eval = FALSE}</span></span>
<span id="cb184-719"><a href="#cb184-719" aria-hidden="true" tabindex="-1"></a>.train <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-720"><a href="#cb184-720" aria-hidden="true" tabindex="-1"></a>  self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb184-721"><a href="#cb184-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb184-722"><a href="#cb184-722" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-723"><a href="#cb184-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-724"><a href="#cb184-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-061, eval = FALSE}</span></span>
<span id="cb184-725"><a href="#cb184-725" aria-hidden="true" tabindex="-1"></a>.predict <span class="ot">=</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-726"><a href="#cb184-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb184-727"><a href="#cb184-727" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-728"><a href="#cb184-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-729"><a href="#cb184-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-730"><a href="#cb184-730" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Putting it Together</span></span>
<span id="cb184-731"><a href="#cb184-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-732"><a href="#cb184-732" aria-hidden="true" tabindex="-1"></a>The whole definition thus becomes</span>
<span id="cb184-733"><a href="#cb184-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-734"><a href="#cb184-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-062, tidy = FALSE}</span></span>
<span id="cb184-735"><a href="#cb184-735" aria-hidden="true" tabindex="-1"></a>PipeOpCopyTwo <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpCopyTwo"</span>,</span>
<span id="cb184-736"><a href="#cb184-736" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOp,</span>
<span id="cb184-737"><a href="#cb184-737" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-738"><a href="#cb184-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"copy.two"</span>) {</span>
<span id="cb184-739"><a href="#cb184-739" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id,</span>
<span id="cb184-740"><a href="#cb184-740" aria-hidden="true" tabindex="-1"></a>        <span class="at">input =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="st">"input"</span>, <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>),</span>
<span id="cb184-741"><a href="#cb184-741" aria-hidden="true" tabindex="-1"></a>        <span class="at">output =</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"output1"</span>, <span class="st">"output2"</span>),</span>
<span id="cb184-742"><a href="#cb184-742" aria-hidden="true" tabindex="-1"></a>                            <span class="at">train =</span> <span class="st">"*"</span>, <span class="at">predict =</span> <span class="st">"*"</span>)</span>
<span id="cb184-743"><a href="#cb184-743" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb184-744"><a href="#cb184-744" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-745"><a href="#cb184-745" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-746"><a href="#cb184-746" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb184-747"><a href="#cb184-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-748"><a href="#cb184-748" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb184-749"><a href="#cb184-749" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb184-750"><a href="#cb184-750" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-751"><a href="#cb184-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-752"><a href="#cb184-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(inputs) {</span>
<span id="cb184-753"><a href="#cb184-753" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(inputs, inputs)</span>
<span id="cb184-754"><a href="#cb184-754" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-755"><a href="#cb184-755" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-756"><a href="#cb184-756" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-757"><a href="#cb184-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-758"><a href="#cb184-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-759"><a href="#cb184-759" aria-hidden="true" tabindex="-1"></a>We can create an instance of our <span class="in">`r ref("PipeOp")`</span>, put it in a graph, and see what happens when we train it on something:</span>
<span id="cb184-760"><a href="#cb184-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-761"><a href="#cb184-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-063}</span></span>
<span id="cb184-762"><a href="#cb184-762" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb184-763"><a href="#cb184-763" aria-hidden="true" tabindex="-1"></a>poct <span class="ot">=</span> PipeOpCopyTwo<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-764"><a href="#cb184-764" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-765"><a href="#cb184-765" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(poct)</span>
<span id="cb184-766"><a href="#cb184-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-767"><a href="#cb184-767" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span>
<span id="cb184-768"><a href="#cb184-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-769"><a href="#cb184-769" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb184-770"><a href="#cb184-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-771"><a href="#cb184-771" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(result)</span>
<span id="cb184-772"><a href="#cb184-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-773"><a href="#cb184-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-774"><a href="#cb184-774" aria-hidden="true" tabindex="-1"></a><span class="fu">### Special Case: Preprocessing {#ext-pipe-preproc}</span></span>
<span id="cb184-775"><a href="#cb184-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-776"><a href="#cb184-776" aria-hidden="true" tabindex="-1"></a>Many <span class="in">`r ref("PipeOp")`</span>s perform an operation on exactly one <span class="in">`r ref("Task")`</span>, and return exactly one <span class="in">`r ref("Task")`</span>. They may even not care about the "Target" / "Outcome" variable of that task, and only do some modification of some input data.</span>
<span id="cb184-777"><a href="#cb184-777" aria-hidden="true" tabindex="-1"></a>However, it is usually important to them that the <span class="in">`r ref("Task")`</span> on which they perform prediction has the same data columns as the <span class="in">`r ref("Task")`</span> on which they train.</span>
<span id="cb184-778"><a href="#cb184-778" aria-hidden="true" tabindex="-1"></a>For these cases, the auxiliary base class <span class="in">`r ref("PipeOpTaskPreproc")`</span> exists.</span>
<span id="cb184-779"><a href="#cb184-779" aria-hidden="true" tabindex="-1"></a>It inherits from <span class="in">`r ref("PipeOp")`</span> itself, and other <span class="in">`r ref("PipeOp")`</span>s should use it if they fall in the kind of use-case named above.</span>
<span id="cb184-780"><a href="#cb184-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-781"><a href="#cb184-781" aria-hidden="true" tabindex="-1"></a>When inheriting from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, one must either implement the private methods <span class="in">`.train_task()`</span> and <span class="in">`.predict_task()`</span>, or the methods <span class="in">`.train_dt()`</span>, <span class="in">`.predict_dt()`</span>, depending on whether wants to operate on a <span class="in">`r ref("Task")`</span> object or on its data as <span class="in">`data.table`</span>s.</span>
<span id="cb184-782"><a href="#cb184-782" aria-hidden="true" tabindex="-1"></a>In the second case, one can optionally also overload the <span class="in">`.select_cols()`</span> method, which chooses which of the incoming <span class="in">`r ref("Task")`</span>'s features are given to the <span class="in">`.train_dt()`</span> / <span class="in">`.predict_dt()`</span> functions.</span>
<span id="cb184-783"><a href="#cb184-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-784"><a href="#cb184-784" aria-hidden="true" tabindex="-1"></a>The following will show two examples: <span class="in">`PipeOpDropNA`</span>, which removes a <span class="in">`r ref("Task")`</span>'s rows with missing values during training (and implements <span class="in">`.train_task()`</span> and <span class="in">`.predict_task()`</span>), and <span class="in">`r ref("PipeOpScale")`</span>, which scales a <span class="in">`r ref("Task")`</span>'s numeric columns (and implements <span class="in">`.train_dt()`</span>, <span class="in">`.predict_dt()`</span>, and <span class="in">`.select_cols()`</span>).</span>
<span id="cb184-785"><a href="#cb184-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-786"><a href="#cb184-786" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpDropNA`</span></span>
<span id="cb184-787"><a href="#cb184-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-788"><a href="#cb184-788" aria-hidden="true" tabindex="-1"></a>Dropping rows with missing values may be important when training a model that can not handle them.</span>
<span id="cb184-789"><a href="#cb184-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-790"><a href="#cb184-790" aria-hidden="true" tabindex="-1"></a>Because <span class="in">`r mlr3`</span> <span class="in">`"Task", text = "Tasks")`</span> only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values.</span>
<span id="cb184-791"><a href="#cb184-791" aria-hidden="true" tabindex="-1"></a>Instead, the rows can be removed using the <span class="in">`r ref("Task")`</span>'s <span class="in">`$filter`</span> method, which modifies the <span class="in">`r ref("Task")`</span> in-place.</span>
<span id="cb184-792"><a href="#cb184-792" aria-hidden="true" tabindex="-1"></a>This is done in the private method <span class="in">`.train_task()`</span>.</span>
<span id="cb184-793"><a href="#cb184-793" aria-hidden="true" tabindex="-1"></a>We take care that we also set the <span class="in">`$state`</span> slot to signal that the <span class="in">`r ref("PipeOp")`</span> was trained.</span>
<span id="cb184-794"><a href="#cb184-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-795"><a href="#cb184-795" aria-hidden="true" tabindex="-1"></a>The private method <span class="in">`.predict_task()`</span> does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows.</span>
<span id="cb184-796"><a href="#cb184-796" aria-hidden="true" tabindex="-1"></a>Furthermore, <span class="in">`r mlr3`</span> expects a <span class="in">`r ref("Learner")`</span> to always return just as many predictions as it was given input rows, so a <span class="in">`r ref("PipeOp")`</span> that removes <span class="in">`r ref("Task")`</span> rows during training can not be used inside a <span class="in">`r ref("GraphLearner")`</span>.</span>
<span id="cb184-797"><a href="#cb184-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-798"><a href="#cb184-798" aria-hidden="true" tabindex="-1"></a>When we inherit from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, it sets the <span class="in">`input`</span> and <span class="in">`output`</span> <span class="in">`data.table`</span>s for us to only accept a single <span class="in">`r ref("Task")`</span>.</span>
<span id="cb184-799"><a href="#cb184-799" aria-hidden="true" tabindex="-1"></a>The only thing we do during <span class="in">`initialize()`</span> is therefore to set an <span class="in">`id`</span> (which can optionally be changed by the user).</span>
<span id="cb184-800"><a href="#cb184-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-801"><a href="#cb184-801" aria-hidden="true" tabindex="-1"></a>The complete <span class="in">`PipeOpDropNA`</span> can therefore be written as follows.</span>
<span id="cb184-802"><a href="#cb184-802" aria-hidden="true" tabindex="-1"></a>Note that it inherits from <span class="in">`r ref("PipeOpTaskPreproc")`</span>, unlike the <span class="in">`PipeOpCopyTwo`</span> example from above:</span>
<span id="cb184-803"><a href="#cb184-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-804"><a href="#cb184-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-064, tidy = FALSE}</span></span>
<span id="cb184-805"><a href="#cb184-805" aria-hidden="true" tabindex="-1"></a>PipeOpDropNA <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropNA"</span>,</span>
<span id="cb184-806"><a href="#cb184-806" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb184-807"><a href="#cb184-807" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-808"><a href="#cb184-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.na"</span>) {</span>
<span id="cb184-809"><a href="#cb184-809" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(id)</span>
<span id="cb184-810"><a href="#cb184-810" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-811"><a href="#cb184-811" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-812"><a href="#cb184-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-813"><a href="#cb184-813" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb184-814"><a href="#cb184-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-815"><a href="#cb184-815" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb184-816"><a href="#cb184-816" aria-hidden="true" tabindex="-1"></a>      featuredata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb184-817"><a href="#cb184-817" aria-hidden="true" tabindex="-1"></a>      exclude <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">is.na</span>(featuredata), <span class="dv">1</span>, any)</span>
<span id="cb184-818"><a href="#cb184-818" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">filter</span>(task<span class="sc">$</span>row_ids[<span class="sc">!</span>exclude])</span>
<span id="cb184-819"><a href="#cb184-819" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-820"><a href="#cb184-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-821"><a href="#cb184-821" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_task =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-822"><a href="#cb184-822" aria-hidden="true" tabindex="-1"></a>      <span class="co"># nothing to be done</span></span>
<span id="cb184-823"><a href="#cb184-823" aria-hidden="true" tabindex="-1"></a>      task</span>
<span id="cb184-824"><a href="#cb184-824" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-825"><a href="#cb184-825" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-826"><a href="#cb184-826" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-827"><a href="#cb184-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-828"><a href="#cb184-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-829"><a href="#cb184-829" aria-hidden="true" tabindex="-1"></a>To test this <span class="in">`r ref("PipeOp")`</span>, we create a small task with missing values:</span>
<span id="cb184-830"><a href="#cb184-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-831"><a href="#cb184-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-065}</span></span>
<span id="cb184-832"><a href="#cb184-832" aria-hidden="true" tabindex="-1"></a>smalliris <span class="ot">=</span> iris[(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">*</span> <span class="dv">30</span>, ]</span>
<span id="cb184-833"><a href="#cb184-833" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb184-834"><a href="#cb184-834" aria-hidden="true" tabindex="-1"></a>smalliris[<span class="dv">2</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb184-835"><a href="#cb184-835" aria-hidden="true" tabindex="-1"></a>sitask <span class="ot">=</span> <span class="fu">as_task_classif</span>(smalliris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb184-836"><a href="#cb184-836" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sitask<span class="sc">$</span><span class="fu">data</span>())</span>
<span id="cb184-837"><a href="#cb184-837" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-838"><a href="#cb184-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-839"><a href="#cb184-839" aria-hidden="true" tabindex="-1"></a>We test this by feeding it to a new <span class="in">`r ref("Graph")`</span> that uses <span class="in">`PipeOpDropNA`</span>.</span>
<span id="cb184-840"><a href="#cb184-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-841"><a href="#cb184-841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-066}</span></span>
<span id="cb184-842"><a href="#cb184-842" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-843"><a href="#cb184-843" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropNA<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb184-844"><a href="#cb184-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-845"><a href="#cb184-845" aria-hidden="true" tabindex="-1"></a>filtered_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(sitask)[[<span class="dv">1</span>]]</span>
<span id="cb184-846"><a href="#cb184-846" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_task<span class="sc">$</span><span class="fu">data</span>())</span>
<span id="cb184-847"><a href="#cb184-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-848"><a href="#cb184-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-849"><a href="#cb184-849" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpScaleAlways`</span></span>
<span id="cb184-850"><a href="#cb184-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-851"><a href="#cb184-851" aria-hidden="true" tabindex="-1"></a>An often-applied preprocessing step is to simply **center** and/or **scale** the data to mean $0$ and standard deviation $1$.</span>
<span id="cb184-852"><a href="#cb184-852" aria-hidden="true" tabindex="-1"></a>This fits the <span class="in">`r ref("PipeOpTaskPreproc")`</span> pattern quite well.</span>
<span id="cb184-853"><a href="#cb184-853" aria-hidden="true" tabindex="-1"></a>Because it always replaces all columns that it operates on, and does not require any information about the task's target, it only needs to overload the <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span> functions.</span>
<span id="cb184-854"><a href="#cb184-854" aria-hidden="true" tabindex="-1"></a>This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</span>
<span id="cb184-855"><a href="#cb184-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-856"><a href="#cb184-856" aria-hidden="true" tabindex="-1"></a>Because scaling only makes sense on numeric features, we want to instruct <span class="in">`r ref("PipeOpTaskPreproc")`</span> to give us only these numeric columns.</span>
<span id="cb184-857"><a href="#cb184-857" aria-hidden="true" tabindex="-1"></a>We do this by overloading the <span class="in">`.select_cols()`</span> function: It is called by the class to determine which columns to pass to <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span>.</span>
<span id="cb184-858"><a href="#cb184-858" aria-hidden="true" tabindex="-1"></a>Its input is the <span class="in">`r ref("Task")`</span> that is being transformed, and it should return a <span class="in">`character`</span> vector of all features to work with.</span>
<span id="cb184-859"><a href="#cb184-859" aria-hidden="true" tabindex="-1"></a>When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns.</span>
<span id="cb184-860"><a href="#cb184-860" aria-hidden="true" tabindex="-1"></a>Because the <span class="in">`levels()`</span> of the data table given to <span class="in">`.train_dt()`</span> and <span class="in">`.predict_dt()`</span> may be different from the <span class="in">`r ref("Task")`</span>'s levels, these functions must also take a <span class="in">`levels`</span> argument that is a named list of column names indicating their levels.</span>
<span id="cb184-861"><a href="#cb184-861" aria-hidden="true" tabindex="-1"></a>When working with numeric data, this argument can be ignored, but it should be used instead of <span class="in">`levels(dt[[column]])`</span> for factorial or character columns.</span>
<span id="cb184-862"><a href="#cb184-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-863"><a href="#cb184-863" aria-hidden="true" tabindex="-1"></a>This is the first <span class="in">`r ref("PipeOp")`</span> where we will be using the <span class="in">`$state`</span> slot for something useful: We save the centering offset and scaling coefficient and use it in <span class="in">`$.predict()`</span>!</span>
<span id="cb184-864"><a href="#cb184-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-865"><a href="#cb184-865" aria-hidden="true" tabindex="-1"></a>For simplicity, we are not using hyperparameters and will always scale and center all data.</span>
<span id="cb184-866"><a href="#cb184-866" aria-hidden="true" tabindex="-1"></a>Compare this <span class="in">`PipeOpScaleAlways`</span> operator to the one defined inside the <span class="in">`r mlr3pipelines`</span> package, <span class="in">`r ref("PipeOpScale")`</span>.</span>
<span id="cb184-867"><a href="#cb184-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-868"><a href="#cb184-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-067, tidy = FALSE}</span></span>
<span id="cb184-869"><a href="#cb184-869" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlways <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlways"</span>,</span>
<span id="cb184-870"><a href="#cb184-870" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreproc,</span>
<span id="cb184-871"><a href="#cb184-871" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-872"><a href="#cb184-872" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always"</span>) {</span>
<span id="cb184-873"><a href="#cb184-873" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb184-874"><a href="#cb184-874" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-875"><a href="#cb184-875" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-876"><a href="#cb184-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-877"><a href="#cb184-877" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb184-878"><a href="#cb184-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-879"><a href="#cb184-879" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb184-880"><a href="#cb184-880" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-881"><a href="#cb184-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-882"><a href="#cb184-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb184-883"><a href="#cb184-883" aria-hidden="true" tabindex="-1"></a>      sc <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">as.matrix</span>(dt))</span>
<span id="cb184-884"><a href="#cb184-884" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb184-885"><a href="#cb184-885" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:center"</span>),</span>
<span id="cb184-886"><a href="#cb184-886" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">attr</span>(sc, <span class="st">"scaled:scale"</span>)</span>
<span id="cb184-887"><a href="#cb184-887" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb184-888"><a href="#cb184-888" aria-hidden="true" tabindex="-1"></a>      sc</span>
<span id="cb184-889"><a href="#cb184-889" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-890"><a href="#cb184-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-891"><a href="#cb184-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb184-892"><a href="#cb184-892" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb184-893"><a href="#cb184-893" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-894"><a href="#cb184-894" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-895"><a href="#cb184-895" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-896"><a href="#cb184-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-897"><a href="#cb184-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-898"><a href="#cb184-898" aria-hidden="true" tabindex="-1"></a>_(Note for the observant: If you check `PipeOpScale.R` from the `r mlr3pipelines` package, you will notice that is uses "`get("type")`" and "`get("id")`" instead of "`type`" and "`id`", because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a "problem" with `data.table` and not exclusive to `r mlr3pipelines`.)_</span>
<span id="cb184-899"><a href="#cb184-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-900"><a href="#cb184-900" aria-hidden="true" tabindex="-1"></a>We can, again, create a new <span class="in">`r ref("Graph")`</span> that uses this <span class="in">`r ref("PipeOp")`</span> to test it.</span>
<span id="cb184-901"><a href="#cb184-901" aria-hidden="true" tabindex="-1"></a>Compare the resulting data to the original "iris" <span class="in">`r ref("Task")`</span> data printed at the beginning:</span>
<span id="cb184-902"><a href="#cb184-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-903"><a href="#cb184-903" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-068}</span></span>
<span id="cb184-904"><a href="#cb184-904" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-905"><a href="#cb184-905" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb184-906"><a href="#cb184-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-907"><a href="#cb184-907" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb184-908"><a href="#cb184-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-909"><a href="#cb184-909" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-910"><a href="#cb184-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-911"><a href="#cb184-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-912"><a href="#cb184-912" aria-hidden="true" tabindex="-1"></a><span class="fu">### Special Case: Preprocessing with Simple Train</span></span>
<span id="cb184-913"><a href="#cb184-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-914"><a href="#cb184-914" aria-hidden="true" tabindex="-1"></a>It is possible to make even further simplifications for many <span class="in">`r ref("PipeOp")`</span>s that perform mostly the same operation during training and prediction.</span>
<span id="cb184-915"><a href="#cb184-915" aria-hidden="true" tabindex="-1"></a>The point of <span class="in">`r ref("Task")`</span> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that *may* depend on training data).</span>
<span id="cb184-916"><a href="#cb184-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-917"><a href="#cb184-917" aria-hidden="true" tabindex="-1"></a>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level.</span>
<span id="cb184-918"><a href="#cb184-918" aria-hidden="true" tabindex="-1"></a>However, what features get removed must be decided during *training*, and may only depend on training data.</span>
<span id="cb184-919"><a href="#cb184-919" aria-hidden="true" tabindex="-1"></a>Furthermore, the actual process of removing features is the same during training and prediction.</span>
<span id="cb184-920"><a href="#cb184-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-921"><a href="#cb184-921" aria-hidden="true" tabindex="-1"></a>A simplification to make is therefore to have a private method <span class="in">`.get_state(task)`</span> which sets the <span class="in">`$state`</span> slot during training, and a private method <span class="in">`.transform(task)`</span>, which gets called both during training *and* prediction.</span>
<span id="cb184-922"><a href="#cb184-922" aria-hidden="true" tabindex="-1"></a>This is done in the <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> class.</span>
<span id="cb184-923"><a href="#cb184-923" aria-hidden="true" tabindex="-1"></a>Just like <span class="in">`r ref("PipeOpTaskPreproc")`</span>, one can inherit from this and overload these functions to get a <span class="in">`r ref("PipeOp")`</span> that performs preprocessing with very little boilerplate code.</span>
<span id="cb184-924"><a href="#cb184-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-925"><a href="#cb184-925" aria-hidden="true" tabindex="-1"></a>Just like <span class="in">`r ref("PipeOpTaskPreproc")`</span>, <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> offers the possibility to instead overload the <span class="in">`.get_state_dt(dt, levels)`</span> and <span class="in">`.transform_dt(dt, levels)`</span> methods (and optionally, again, the <span class="in">`.select_cols(task)`</span> function) to operate on <span class="in">`data.table`</span> feature data instead of the whole <span class="in">`r ref("Task")`</span>.</span>
<span id="cb184-926"><a href="#cb184-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-927"><a href="#cb184-927" aria-hidden="true" tabindex="-1"></a>Even some methods that do not use <span class="in">`r ref("PipeOpTaskPreprocSimple")`</span> *could* work in a similar way: The <span class="in">`PipeOpScaleAlways`</span> example from above will be shown to also work with this paradigm.</span>
<span id="cb184-928"><a href="#cb184-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-929"><a href="#cb184-929" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpDropConst`</span></span>
<span id="cb184-930"><a href="#cb184-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-931"><a href="#cb184-931" aria-hidden="true" tabindex="-1"></a>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training.</span>
<span id="cb184-932"><a href="#cb184-932" aria-hidden="true" tabindex="-1"></a>One simple example of this is dropping constant features.</span>
<span id="cb184-933"><a href="#cb184-933" aria-hidden="true" tabindex="-1"></a>Because the <span class="in">`r mlr3`</span> <span class="in">`r ref("Task")`</span> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <span class="in">`$select()`</span> function, so the <span class="in">`.get_state_dt(dt, levels)`</span> / <span class="in">`.transform_dt(dt, levels)`</span> functions will *not* get used; instead we overload the <span class="in">`.get_state(task)`</span> and <span class="in">`.transform(task)`</span> methods.</span>
<span id="cb184-934"><a href="#cb184-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-935"><a href="#cb184-935" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.get_state()`</span> function's result is saved to the <span class="in">`$state`</span> slot, so we want to return something that is useful for dropping features.</span>
<span id="cb184-936"><a href="#cb184-936" aria-hidden="true" tabindex="-1"></a>We choose to save the names of all the columns that have nonzero variance.</span>
<span id="cb184-937"><a href="#cb184-937" aria-hidden="true" tabindex="-1"></a>For brevity, we use <span class="in">`length(unique(column)) &gt; 1`</span> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</span>
<span id="cb184-938"><a href="#cb184-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-939"><a href="#cb184-939" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.transform()`</span> method is evaluated both during training *and* prediction, and can rely on the <span class="in">`$state`</span> slot being present.</span>
<span id="cb184-940"><a href="#cb184-940" aria-hidden="true" tabindex="-1"></a>All it does here is call the <span class="in">`Task$select`</span> function with the columns we chose to keep.</span>
<span id="cb184-941"><a href="#cb184-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-942"><a href="#cb184-942" aria-hidden="true" tabindex="-1"></a>The full <span class="in">`r ref("PipeOp")`</span> could be written as follows:</span>
<span id="cb184-943"><a href="#cb184-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-944"><a href="#cb184-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-069, tidy = FALSE}</span></span>
<span id="cb184-945"><a href="#cb184-945" aria-hidden="true" tabindex="-1"></a>PipeOpDropConst <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpDropConst"</span>,</span>
<span id="cb184-946"><a href="#cb184-946" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb184-947"><a href="#cb184-947" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-948"><a href="#cb184-948" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"drop.const"</span>) {</span>
<span id="cb184-949"><a href="#cb184-949" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb184-950"><a href="#cb184-950" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-951"><a href="#cb184-951" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-952"><a href="#cb184-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-953"><a href="#cb184-953" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb184-954"><a href="#cb184-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-955"><a href="#cb184-955" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb184-956"><a href="#cb184-956" aria-hidden="true" tabindex="-1"></a>      nonconst <span class="ot">=</span> <span class="fu">sapply</span>(data, <span class="cf">function</span>(column) <span class="fu">length</span>(<span class="fu">unique</span>(column)) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb184-957"><a href="#cb184-957" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">cnames =</span> <span class="fu">colnames</span>(data)[nonconst])</span>
<span id="cb184-958"><a href="#cb184-958" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-959"><a href="#cb184-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-960"><a href="#cb184-960" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-961"><a href="#cb184-961" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span><span class="fu">select</span>(self<span class="sc">$</span>state<span class="sc">$</span>cnames)</span>
<span id="cb184-962"><a href="#cb184-962" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-963"><a href="#cb184-963" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-964"><a href="#cb184-964" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-965"><a href="#cb184-965" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-966"><a href="#cb184-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-967"><a href="#cb184-967" aria-hidden="true" tabindex="-1"></a>This can be tested using the first five rows of the "Iris" <span class="in">`r ref("Task")`</span>, for which one feature (<span class="in">`"Petal.Width"`</span>) is constant:</span>
<span id="cb184-968"><a href="#cb184-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-969"><a href="#cb184-969" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-070}</span></span>
<span id="cb184-970"><a href="#cb184-970" aria-hidden="true" tabindex="-1"></a>irishead <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb184-971"><a href="#cb184-971" aria-hidden="true" tabindex="-1"></a>irishead<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-972"><a href="#cb184-972" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-973"><a href="#cb184-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-974"><a href="#cb184-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-071}</span></span>
<span id="cb184-975"><a href="#cb184-975" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpDropConst<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb184-976"><a href="#cb184-976" aria-hidden="true" tabindex="-1"></a>dropped_task <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(irishead)[[<span class="dv">1</span>]]</span>
<span id="cb184-977"><a href="#cb184-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-978"><a href="#cb184-978" aria-hidden="true" tabindex="-1"></a>dropped_task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-979"><a href="#cb184-979" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-980"><a href="#cb184-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-981"><a href="#cb184-981" aria-hidden="true" tabindex="-1"></a>We can also see that the <span class="in">`$state`</span> was correctly set.</span>
<span id="cb184-982"><a href="#cb184-982" aria-hidden="true" tabindex="-1"></a>Calling <span class="in">`$.predict()`</span> with this graph, even with different data (the whole Iris <span class="in">`r ref("Task")`</span>!) will still drop the <span class="in">`"Petal.Width"`</span> column, as it should.</span>
<span id="cb184-983"><a href="#cb184-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-984"><a href="#cb184-984" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-072}</span></span>
<span id="cb184-985"><a href="#cb184-985" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>pipeops<span class="sc">$</span>drop.const<span class="sc">$</span>state</span>
<span id="cb184-986"><a href="#cb184-986" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-987"><a href="#cb184-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-988"><a href="#cb184-988" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-073}</span></span>
<span id="cb184-989"><a href="#cb184-989" aria-hidden="true" tabindex="-1"></a>dropped_predict <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb184-990"><a href="#cb184-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-991"><a href="#cb184-991" aria-hidden="true" tabindex="-1"></a>dropped_predict<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-992"><a href="#cb184-992" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-993"><a href="#cb184-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-994"><a href="#cb184-994" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Example: `PipeOpScaleAlwaysSimple`</span></span>
<span id="cb184-995"><a href="#cb184-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-996"><a href="#cb184-996" aria-hidden="true" tabindex="-1"></a>This example will show how a <span class="in">`PipeOpTaskPreprocSimple`</span> can be used when only working on feature data in form of a <span class="in">`data.table`</span>.</span>
<span id="cb184-997"><a href="#cb184-997" aria-hidden="true" tabindex="-1"></a>Instead of calling the <span class="in">`scale()`</span> function, the <span class="in">`center`</span> and <span class="in">`scale`</span> values are calculated directly and saved to the <span class="in">`$state`</span> slot.</span>
<span id="cb184-998"><a href="#cb184-998" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.transform_dt()`</span> function will then perform the same operation during both training and prediction: subtract the <span class="in">`center`</span> and divide by the <span class="in">`scale`</span> value.</span>
<span id="cb184-999"><a href="#cb184-999" aria-hidden="true" tabindex="-1"></a>As in the <span class="co">[</span><span class="ot">`PipeOpScaleAlways` example above</span><span class="co">](#example-pipeopscalealways)</span>, we use <span class="in">`.select_cols()`</span> so that we only work on numeric columns.</span>
<span id="cb184-1000"><a href="#cb184-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1001"><a href="#cb184-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-074, tidy = FALSE}</span></span>
<span id="cb184-1002"><a href="#cb184-1002" aria-hidden="true" tabindex="-1"></a>PipeOpScaleAlwaysSimple <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"PipeOpScaleAlwaysSimple"</span>,</span>
<span id="cb184-1003"><a href="#cb184-1003" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3pipelines<span class="sc">::</span>PipeOpTaskPreprocSimple,</span>
<span id="cb184-1004"><a href="#cb184-1004" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb184-1005"><a href="#cb184-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">id =</span> <span class="st">"scale.always.simple"</span>) {</span>
<span id="cb184-1006"><a href="#cb184-1006" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(<span class="at">id =</span> id)</span>
<span id="cb184-1007"><a href="#cb184-1007" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-1008"><a href="#cb184-1008" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb184-1009"><a href="#cb184-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1010"><a href="#cb184-1010" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb184-1011"><a href="#cb184-1011" aria-hidden="true" tabindex="-1"></a>    <span class="at">.select_cols =</span> <span class="cf">function</span>(task) {</span>
<span id="cb184-1012"><a href="#cb184-1012" aria-hidden="true" tabindex="-1"></a>      task<span class="sc">$</span>feature_types[type <span class="sc">==</span> <span class="st">"numeric"</span>, id]</span>
<span id="cb184-1013"><a href="#cb184-1013" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-1014"><a href="#cb184-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1015"><a href="#cb184-1015" aria-hidden="true" tabindex="-1"></a>    <span class="at">.get_state_dt =</span> <span class="cf">function</span>(dt, levels, target) {</span>
<span id="cb184-1016"><a href="#cb184-1016" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb184-1017"><a href="#cb184-1017" aria-hidden="true" tabindex="-1"></a>        <span class="at">center =</span> <span class="fu">sapply</span>(dt, mean),</span>
<span id="cb184-1018"><a href="#cb184-1018" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale =</span> <span class="fu">sapply</span>(dt, sd)</span>
<span id="cb184-1019"><a href="#cb184-1019" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb184-1020"><a href="#cb184-1020" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb184-1021"><a href="#cb184-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1022"><a href="#cb184-1022" aria-hidden="true" tabindex="-1"></a>    <span class="at">.transform_dt =</span> <span class="cf">function</span>(dt, levels) {</span>
<span id="cb184-1023"><a href="#cb184-1023" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>((<span class="fu">t</span>(dt) <span class="sc">-</span> self<span class="sc">$</span>state<span class="sc">$</span>center) <span class="sc">/</span> self<span class="sc">$</span>state<span class="sc">$</span>scale)</span>
<span id="cb184-1024"><a href="#cb184-1024" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb184-1025"><a href="#cb184-1025" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb184-1026"><a href="#cb184-1026" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-1027"><a href="#cb184-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1028"><a href="#cb184-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1029"><a href="#cb184-1029" aria-hidden="true" tabindex="-1"></a>We can compare this <span class="in">`r ref("PipeOp")`</span> to the one above to show that it behaves the same.</span>
<span id="cb184-1030"><a href="#cb184-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1031"><a href="#cb184-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-075}</span></span>
<span id="cb184-1032"><a href="#cb184-1032" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlways<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb184-1033"><a href="#cb184-1033" aria-hidden="true" tabindex="-1"></a>result_posa <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb184-1034"><a href="#cb184-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1035"><a href="#cb184-1035" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span><span class="fu">add_pipeop</span>(PipeOpScaleAlwaysSimple<span class="sc">$</span><span class="fu">new</span>())</span>
<span id="cb184-1036"><a href="#cb184-1036" aria-hidden="true" tabindex="-1"></a>result_posa_simple <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb184-1037"><a href="#cb184-1037" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1038"><a href="#cb184-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1039"><a href="#cb184-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-076}</span></span>
<span id="cb184-1040"><a href="#cb184-1040" aria-hidden="true" tabindex="-1"></a>result_posa<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1041"><a href="#cb184-1041" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1042"><a href="#cb184-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1043"><a href="#cb184-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-077}</span></span>
<span id="cb184-1044"><a href="#cb184-1044" aria-hidden="true" tabindex="-1"></a>result_posa_simple<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1045"><a href="#cb184-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1046"><a href="#cb184-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1047"><a href="#cb184-1047" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hyperparameters {#ext-pipe-hyperpars}</span></span>
<span id="cb184-1048"><a href="#cb184-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1049"><a href="#cb184-1049" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> uses the <span class="co">[</span><span class="ot">`r ref_pkg("paradox")`</span><span class="co">](https://paradox.mlr-org.com)</span> package to define parameter spaces for <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1050"><a href="#cb184-1050" aria-hidden="true" tabindex="-1"></a>Parameters for <span class="in">`r ref("PipeOp")`</span>s can modify their behavior in certain ways, e.g. switch centering or scaling off in the <span class="in">`r ref("PipeOpScale")`</span> operator.</span>
<span id="cb184-1051"><a href="#cb184-1051" aria-hidden="true" tabindex="-1"></a>The unified interface makes it possible to have parameters for whole <span class="in">`r ref("Graph")`</span>s that modify the individual <span class="in">`r ref("PipeOp")`</span>'s behavior.</span>
<span id="cb184-1052"><a href="#cb184-1052" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("Graph")`</span>s, when encapsulated in <span class="in">`r ref("GraphLearner")`</span>s, can even be tuned using the tuning functionality in <span class="in">`r mlr3tuning`</span>.</span>
<span id="cb184-1053"><a href="#cb184-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1054"><a href="#cb184-1054" aria-hidden="true" tabindex="-1"></a>Hyperparameters are declared during initialization, when calling the <span class="in">`r ref("PipeOp")`</span>'s <span class="in">`$initialize()`</span> function, by giving a <span class="in">`param_set`</span> argument.</span>
<span id="cb184-1055"><a href="#cb184-1055" aria-hidden="true" tabindex="-1"></a>The <span class="in">`param_set`</span> must be a <span class="in">`r ref("ParamSet")`</span> from the <span class="in">`r ref_pkg("paradox")`</span> package; see <span class="co">[</span><span class="ot">the tuning chapter</span><span class="co">](#searchspace)</span> or @sec-paradox for more information on how to define parameter spaces.</span>
<span id="cb184-1056"><a href="#cb184-1056" aria-hidden="true" tabindex="-1"></a>After construction, the <span class="in">`r ref("ParamSet")`</span> can be accessed through the <span class="in">`$param_set`</span> slot.</span>
<span id="cb184-1057"><a href="#cb184-1057" aria-hidden="true" tabindex="-1"></a>While it is *possible* to modify this `r ref("ParamSet")`, using e.g. the `$add()` and `$add_dep()` functions, *after* adding it to the <span class="in">`r ref("PipeOp")`</span>, it is strongly advised against.</span>
<span id="cb184-1058"><a href="#cb184-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1059"><a href="#cb184-1059" aria-hidden="true" tabindex="-1"></a>Hyperparameters can be set and queried through the <span class="in">`$values`</span> slot.</span>
<span id="cb184-1060"><a href="#cb184-1060" aria-hidden="true" tabindex="-1"></a>When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <span class="in">`$param_set`</span>, so it is not necessary to type check them.</span>
<span id="cb184-1061"><a href="#cb184-1061" aria-hidden="true" tabindex="-1"></a>Be aware that it is always possible to *remove* hyperparameter values.</span>
<span id="cb184-1062"><a href="#cb184-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1063"><a href="#cb184-1063" aria-hidden="true" tabindex="-1"></a>When a <span class="in">`r ref("PipeOp")`</span> is initialized, it usually does not have any parameter values---<span class="in">`$values`</span> takes the value <span class="in">`list()`</span>.</span>
<span id="cb184-1064"><a href="#cb184-1064" aria-hidden="true" tabindex="-1"></a>It is possible to set initial parameter values in the <span class="in">`$initialize()`</span> constructor; this must be done *after* the <span class="in">`super$initialize()`</span> call where the corresponding <span class="in">`r ref("ParamSet")`</span> must be supplied.</span>
<span id="cb184-1065"><a href="#cb184-1065" aria-hidden="true" tabindex="-1"></a>This is because setting <span class="in">`$values`</span> checks against the current <span class="in">`$param_set`</span>, which would fail if the <span class="in">`$param_set`</span> was not set yet.</span>
<span id="cb184-1066"><a href="#cb184-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1067"><a href="#cb184-1067" aria-hidden="true" tabindex="-1"></a>When using an underlying library function (the <span class="in">`scale`</span> function in <span class="in">`r ref("PipeOpScale")`</span>, say), then there is usually a "default" behaviour of that function when a parameter is not given.</span>
<span id="cb184-1068"><a href="#cb184-1068" aria-hidden="true" tabindex="-1"></a>It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed).</span>
<span id="cb184-1069"><a href="#cb184-1069" aria-hidden="true" tabindex="-1"></a>This can easily be done when using the <span class="in">`r mlr3misc`</span> library's <span class="in">`r ref("mlr3misc::invoke()")`</span> function, which has functionality similar to <span class="in">`"do.call()"`</span>.</span>
<span id="cb184-1070"><a href="#cb184-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1071"><a href="#cb184-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Hyperparameter Example: `r ref("PipeOpScale")`</span></span>
<span id="cb184-1072"><a href="#cb184-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1073"><a href="#cb184-1073" aria-hidden="true" tabindex="-1"></a>How to use hyperparameters can best be shown through the example of <span class="in">`r ref("PipeOpScale")`</span>, which is very similar to the example above, <span class="in">`PipeOpScaleAlways`</span>.</span>
<span id="cb184-1074"><a href="#cb184-1074" aria-hidden="true" tabindex="-1"></a>The difference is made by the presence of hyperparameters.</span>
<span id="cb184-1075"><a href="#cb184-1075" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOpScale")`</span> constructs a <span class="in">`r ref("ParamSet")`</span> in its <span class="in">`$initialize`</span> function and passes this on to the <span class="in">`super$initialize`</span> function:</span>
<span id="cb184-1076"><a href="#cb184-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1077"><a href="#cb184-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-078}</span></span>
<span id="cb184-1078"><a href="#cb184-1078" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>public_methods<span class="sc">$</span>initialize</span>
<span id="cb184-1079"><a href="#cb184-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1080"><a href="#cb184-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1081"><a href="#cb184-1081" aria-hidden="true" tabindex="-1"></a>The user has access to this and can set and get parameters.</span>
<span id="cb184-1082"><a href="#cb184-1082" aria-hidden="true" tabindex="-1"></a>Types are automatically checked:</span>
<span id="cb184-1083"><a href="#cb184-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1084"><a href="#cb184-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-079}</span></span>
<span id="cb184-1085"><a href="#cb184-1085" aria-hidden="true" tabindex="-1"></a>pss <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-1086"><a href="#cb184-1086" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set)</span>
<span id="cb184-1087"><a href="#cb184-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1088"><a href="#cb184-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1089"><a href="#cb184-1089" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-080}</span></span>
<span id="cb184-1090"><a href="#cb184-1090" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb184-1091"><a href="#cb184-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pss<span class="sc">$</span>param_set<span class="sc">$</span>values)</span>
<span id="cb184-1092"><a href="#cb184-1092" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1093"><a href="#cb184-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1094"><a href="#cb184-1094" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-081, error = TRUE}</span></span>
<span id="cb184-1095"><a href="#cb184-1095" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="st">"TRUE"</span> <span class="co"># bad input is checked!</span></span>
<span id="cb184-1096"><a href="#cb184-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1097"><a href="#cb184-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1098"><a href="#cb184-1098" aria-hidden="true" tabindex="-1"></a>How <span class="in">`r ref("PipeOpScale")`</span> handles its parameters can be seen in its <span class="in">`$.train_dt`</span> method: It gets the relevant parameters from its <span class="in">`$values`</span> slot and uses them in the <span class="in">`r ref("mlr3misc::invoke()")`</span> call.</span>
<span id="cb184-1099"><a href="#cb184-1099" aria-hidden="true" tabindex="-1"></a>This has the advantage over calling <span class="in">`scale()`</span> directly that if a parameter is not given, its default value from the <span class="in">`"scale()"`</span> function will be used.</span>
<span id="cb184-1100"><a href="#cb184-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1101"><a href="#cb184-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-082}</span></span>
<span id="cb184-1102"><a href="#cb184-1102" aria-hidden="true" tabindex="-1"></a>PipeOpScale<span class="sc">$</span>private_methods<span class="sc">$</span>.train_dt</span>
<span id="cb184-1103"><a href="#cb184-1103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1104"><a href="#cb184-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1105"><a href="#cb184-1105" aria-hidden="true" tabindex="-1"></a>Another change that is necessary compared to <span class="in">`PipeOpScaleAlways`</span> is that the attributes <span class="in">`"scaled:scale"`</span> and <span class="in">`"scaled:center"`</span> are not always present, depending on parameters, and possibly need to be set to default values $1$ or $0$, respectively.</span>
<span id="cb184-1106"><a href="#cb184-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1107"><a href="#cb184-1107" aria-hidden="true" tabindex="-1"></a>It is now even possible (if a bit pointless) to call <span class="in">`r ref("PipeOpScale")`</span> with both <span class="in">`scale`</span> and <span class="in">`center`</span> set to <span class="in">`FALSE`</span>, which returns the original dataset, unchanged.</span>
<span id="cb184-1108"><a href="#cb184-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1109"><a href="#cb184-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-083}</span></span>
<span id="cb184-1110"><a href="#cb184-1110" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>scale <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb184-1111"><a href="#cb184-1111" aria-hidden="true" tabindex="-1"></a>pss<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb184-1112"><a href="#cb184-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1113"><a href="#cb184-1113" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-1114"><a href="#cb184-1114" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(pss)</span>
<span id="cb184-1115"><a href="#cb184-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1116"><a href="#cb184-1116" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb184-1117"><a href="#cb184-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1118"><a href="#cb184-1118" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1119"><a href="#cb184-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1120"><a href="#cb184-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1121"><a href="#cb184-1121" aria-hidden="true" tabindex="-1"></a><span class="fu">## Special Operators {#pipe-special-ops}</span></span>
<span id="cb184-1122"><a href="#cb184-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1123"><a href="#cb184-1123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-084, include = FALSE}</span></span>
<span id="cb184-1124"><a href="#cb184-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-1125"><a href="#cb184-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1126"><a href="#cb184-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1127"><a href="#cb184-1127" aria-hidden="true" tabindex="-1"></a>This section introduces some special operators, that might be useful in numerous further applications.</span>
<span id="cb184-1128"><a href="#cb184-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1129"><a href="#cb184-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputation: `PipeOpImpute`</span></span>
<span id="cb184-1130"><a href="#cb184-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1131"><a href="#cb184-1131" aria-hidden="true" tabindex="-1"></a>Often you will be using data sets that have missing values.</span>
<span id="cb184-1132"><a href="#cb184-1132" aria-hidden="true" tabindex="-1"></a>There are many methods of dealing with this issue, from relatively simple imputation using either&nbsp;mean,&nbsp;median&nbsp;or histograms to way more involved methods including using machine learning algorithms in order to predict missing values.</span>
<span id="cb184-1133"><a href="#cb184-1133" aria-hidden="true" tabindex="-1"></a>These methods are called imputation.</span>
<span id="cb184-1134"><a href="#cb184-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1135"><a href="#cb184-1135" aria-hidden="true" tabindex="-1"></a>The following <span class="in">`r ref("PipeOp")`</span>s, <span class="in">`r ref("PipeOpImpute")`</span>:</span>
<span id="cb184-1136"><a href="#cb184-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1137"><a href="#cb184-1137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add an indicator column marking whether a value for a given feature was missing or not (numeric only)</span>
<span id="cb184-1138"><a href="#cb184-1138" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Impute numeric values from a histogram</span>
<span id="cb184-1139"><a href="#cb184-1139" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Impute categorical values using a learner</span>
<span id="cb184-1140"><a href="#cb184-1140" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We use <span class="in">`po("featureunion")`</span> and <span class="in">`po("nop")`</span> to cbind the missing indicator features. In other words to combine the indicator columns with the rest of the data.</span>
<span id="cb184-1141"><a href="#cb184-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1142"><a href="#cb184-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-085}</span></span>
<span id="cb184-1143"><a href="#cb184-1143" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputation example</span></span>
<span id="cb184-1144"><a href="#cb184-1144" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb184-1145"><a href="#cb184-1145" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">missings</span>()</span>
<span id="cb184-1146"><a href="#cb184-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1147"><a href="#cb184-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># Add missing indicator columns ("dummy columns") to the Task</span></span>
<span id="cb184-1148"><a href="#cb184-1148" aria-hidden="true" tabindex="-1"></a>pom <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"missind"</span>)</span>
<span id="cb184-1149"><a href="#cb184-1149" aria-hidden="true" tabindex="-1"></a><span class="co"># Simply pushes the input forward</span></span>
<span id="cb184-1150"><a href="#cb184-1150" aria-hidden="true" tabindex="-1"></a>nop <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"nop"</span>)</span>
<span id="cb184-1151"><a href="#cb184-1151" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputes numerical features by histogram.</span></span>
<span id="cb184-1152"><a href="#cb184-1152" aria-hidden="true" tabindex="-1"></a>pon <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputehist"</span>, <span class="at">id =</span> <span class="st">"imputer_num"</span>)</span>
<span id="cb184-1153"><a href="#cb184-1153" aria-hidden="true" tabindex="-1"></a><span class="co"># combines features (used here to add indicator columns to original data)</span></span>
<span id="cb184-1154"><a href="#cb184-1154" aria-hidden="true" tabindex="-1"></a>pou <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>)</span>
<span id="cb184-1155"><a href="#cb184-1155" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute categorical features by fitting a Learner ("classif.rpart") for each feature.</span></span>
<span id="cb184-1156"><a href="#cb184-1156" aria-hidden="true" tabindex="-1"></a>pof <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputelearner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>), <span class="at">id =</span> <span class="st">"imputer_fct"</span>, <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>))</span>
<span id="cb184-1157"><a href="#cb184-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1158"><a href="#cb184-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1159"><a href="#cb184-1159" aria-hidden="true" tabindex="-1"></a>Now we construct the graph.</span>
<span id="cb184-1160"><a href="#cb184-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1161"><a href="#cb184-1161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-086}</span></span>
<span id="cb184-1162"><a href="#cb184-1162" aria-hidden="true" tabindex="-1"></a>impgraph <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb184-1163"><a href="#cb184-1163" aria-hidden="true" tabindex="-1"></a>  pom,</span>
<span id="cb184-1164"><a href="#cb184-1164" aria-hidden="true" tabindex="-1"></a>  nop</span>
<span id="cb184-1165"><a href="#cb184-1165" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;&gt;%</span> pou <span class="sc">%&gt;&gt;%</span> pof <span class="sc">%&gt;&gt;%</span> pon</span>
<span id="cb184-1166"><a href="#cb184-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1167"><a href="#cb184-1167" aria-hidden="true" tabindex="-1"></a>impgraph<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb184-1168"><a href="#cb184-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1169"><a href="#cb184-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1170"><a href="#cb184-1170" aria-hidden="true" tabindex="-1"></a>Now we get the new task and we can see that all of the missing values have been imputed.</span>
<span id="cb184-1171"><a href="#cb184-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1172"><a href="#cb184-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-087}</span></span>
<span id="cb184-1173"><a href="#cb184-1173" aria-hidden="true" tabindex="-1"></a>new_task <span class="ot">=</span> impgraph<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]</span>
<span id="cb184-1174"><a href="#cb184-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1175"><a href="#cb184-1175" aria-hidden="true" tabindex="-1"></a>new_task<span class="sc">$</span><span class="fu">missings</span>()</span>
<span id="cb184-1176"><a href="#cb184-1176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1177"><a href="#cb184-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1178"><a href="#cb184-1178" aria-hidden="true" tabindex="-1"></a>A learner can thus be equipped with automatic imputation of missing values by adding an imputation Pipeop.</span>
<span id="cb184-1179"><a href="#cb184-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1180"><a href="#cb184-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-088}</span></span>
<span id="cb184-1181"><a href="#cb184-1181" aria-hidden="true" tabindex="-1"></a>polrn <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-1182"><a href="#cb184-1182" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">as_learner</span>(impgraph <span class="sc">%&gt;&gt;%</span> polrn)</span>
<span id="cb184-1183"><a href="#cb184-1183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1184"><a href="#cb184-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1185"><a href="#cb184-1185" aria-hidden="true" tabindex="-1"></a><span class="fu">### Feature Engineering: `PipeOpMutate`</span></span>
<span id="cb184-1186"><a href="#cb184-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1187"><a href="#cb184-1187" aria-hidden="true" tabindex="-1"></a>New features can be added or computed from a task using <span class="in">`r ref("PipeOpMutate")`</span> .</span>
<span id="cb184-1188"><a href="#cb184-1188" aria-hidden="true" tabindex="-1"></a>The operator evaluates one or multiple expressions provided in an <span class="in">`alist`</span>.</span>
<span id="cb184-1189"><a href="#cb184-1189" aria-hidden="true" tabindex="-1"></a>In this example, we compute some new features on top of the <span class="in">`iris`</span> task.</span>
<span id="cb184-1190"><a href="#cb184-1190" aria-hidden="true" tabindex="-1"></a>Then we add them to the data as illustrated below:</span>
<span id="cb184-1191"><a href="#cb184-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1192"><a href="#cb184-1192" aria-hidden="true" tabindex="-1"></a><span class="in">`iris`</span> dataset looks like this:</span>
<span id="cb184-1193"><a href="#cb184-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1194"><a href="#cb184-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-089}</span></span>
<span id="cb184-1195"><a href="#cb184-1195" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-1196"><a href="#cb184-1196" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">as.data.table</span>(task))</span>
<span id="cb184-1197"><a href="#cb184-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1198"><a href="#cb184-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1199"><a href="#cb184-1199" aria-hidden="true" tabindex="-1"></a>Once we do the mutations, you can see the new columns:</span>
<span id="cb184-1200"><a href="#cb184-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1201"><a href="#cb184-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-090}</span></span>
<span id="cb184-1202"><a href="#cb184-1202" aria-hidden="true" tabindex="-1"></a>pom <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>)</span>
<span id="cb184-1203"><a href="#cb184-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1204"><a href="#cb184-1204" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a set of mutations</span></span>
<span id="cb184-1205"><a href="#cb184-1205" aria-hidden="true" tabindex="-1"></a>mutations <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb184-1206"><a href="#cb184-1206" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sepal.Sum =</span> <span class="sc">~</span> Sepal.Length <span class="sc">+</span> Sepal.Width,</span>
<span id="cb184-1207"><a href="#cb184-1207" aria-hidden="true" tabindex="-1"></a>  <span class="at">Petal.Sum =</span> <span class="sc">~</span> Petal.Length <span class="sc">+</span> Petal.Width,</span>
<span id="cb184-1208"><a href="#cb184-1208" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sepal.Petal.Ratio =</span> <span class="sc">~</span> (Sepal.Length <span class="sc">/</span> Petal.Length)</span>
<span id="cb184-1209"><a href="#cb184-1209" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-1210"><a href="#cb184-1210" aria-hidden="true" tabindex="-1"></a>pom<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>mutation <span class="ot">=</span> mutations</span>
<span id="cb184-1211"><a href="#cb184-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1212"><a href="#cb184-1212" aria-hidden="true" tabindex="-1"></a>new_task <span class="ot">=</span> pom<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(task))[[<span class="dv">1</span>]]</span>
<span id="cb184-1213"><a href="#cb184-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">as.data.table</span>(new_task))</span>
<span id="cb184-1214"><a href="#cb184-1214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1215"><a href="#cb184-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1216"><a href="#cb184-1216" aria-hidden="true" tabindex="-1"></a>If outside data is required, we can make use of the <span class="in">`env`</span> parameter.</span>
<span id="cb184-1217"><a href="#cb184-1217" aria-hidden="true" tabindex="-1"></a>Moreover, we provide an environment, where expressions are evaluated (<span class="in">`env`</span> defaults to <span class="in">`.GlobalEnv`</span>).</span>
<span id="cb184-1218"><a href="#cb184-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1219"><a href="#cb184-1219" aria-hidden="true" tabindex="-1"></a><span class="fu">### Training on data subsets: `PipeOpChunk`</span></span>
<span id="cb184-1220"><a href="#cb184-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1221"><a href="#cb184-1221" aria-hidden="true" tabindex="-1"></a>In cases, where data is too big to fit into the machine's memory, an often-used technique is to split the data into several parts.</span>
<span id="cb184-1222"><a href="#cb184-1222" aria-hidden="true" tabindex="-1"></a>Subsequently, the parts are trained on each part of the data.</span>
<span id="cb184-1223"><a href="#cb184-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1224"><a href="#cb184-1224" aria-hidden="true" tabindex="-1"></a>After undertaking these steps, we aggregate the models.</span>
<span id="cb184-1225"><a href="#cb184-1225" aria-hidden="true" tabindex="-1"></a>In this example, we split our data into 4 parts using <span class="in">`r ref("PipeOpChunk")`</span> .</span>
<span id="cb184-1226"><a href="#cb184-1226" aria-hidden="true" tabindex="-1"></a>Additionally, we create 4 <span class="in">`r ref("PipeOpLearner")`</span>  POS, which are then trained on each split of the data.</span>
<span id="cb184-1227"><a href="#cb184-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1228"><a href="#cb184-1228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-091}</span></span>
<span id="cb184-1229"><a href="#cb184-1229" aria-hidden="true" tabindex="-1"></a>chks <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"chunk"</span>, <span class="dv">4</span>)</span>
<span id="cb184-1230"><a href="#cb184-1230" aria-hidden="true" tabindex="-1"></a>lrns <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"greplicate"</span>, <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)), <span class="dv">4</span>)</span>
<span id="cb184-1231"><a href="#cb184-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1232"><a href="#cb184-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1233"><a href="#cb184-1233" aria-hidden="true" tabindex="-1"></a>Afterwards we can use <span class="in">`r ref("PipeOpClassifAvg")`</span> to aggregate the predictions from the 4 different models into a new one.</span>
<span id="cb184-1234"><a href="#cb184-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1235"><a href="#cb184-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-092}</span></span>
<span id="cb184-1236"><a href="#cb184-1236" aria-hidden="true" tabindex="-1"></a>mjv <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"classifavg"</span>, <span class="dv">4</span>)</span>
<span id="cb184-1237"><a href="#cb184-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1238"><a href="#cb184-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1239"><a href="#cb184-1239" aria-hidden="true" tabindex="-1"></a>We can now connect the different operators and visualize the full graph:</span>
<span id="cb184-1240"><a href="#cb184-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1241"><a href="#cb184-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-093, fig.width=7.5, fig.height = 9}</span></span>
<span id="cb184-1242"><a href="#cb184-1242" aria-hidden="true" tabindex="-1"></a>pipeline <span class="ot">=</span> chks <span class="sc">%&gt;&gt;%</span> lrns <span class="sc">%&gt;&gt;%</span> mjv</span>
<span id="cb184-1243"><a href="#cb184-1243" aria-hidden="true" tabindex="-1"></a>pipeline<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-1244"><a href="#cb184-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1245"><a href="#cb184-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1246"><a href="#cb184-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-094}</span></span>
<span id="cb184-1247"><a href="#cb184-1247" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)</span>
<span id="cb184-1248"><a href="#cb184-1248" aria-hidden="true" tabindex="-1"></a>train.idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), <span class="dv">120</span>)</span>
<span id="cb184-1249"><a href="#cb184-1249" aria-hidden="true" tabindex="-1"></a>test.idx <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="fu">seq_len</span>(task<span class="sc">$</span>nrow), train.idx)</span>
<span id="cb184-1250"><a href="#cb184-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1251"><a href="#cb184-1251" aria-hidden="true" tabindex="-1"></a>pipelrn <span class="ot">=</span> <span class="fu">as_learner</span>(pipeline)</span>
<span id="cb184-1252"><a href="#cb184-1252" aria-hidden="true" tabindex="-1"></a>pipelrn<span class="sc">$</span><span class="fu">train</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb184-1253"><a href="#cb184-1253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(task, train.idx)<span class="sc">$</span></span>
<span id="cb184-1254"><a href="#cb184-1254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">score</span>()</span>
<span id="cb184-1255"><a href="#cb184-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1256"><a href="#cb184-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1257"><a href="#cb184-1257" aria-hidden="true" tabindex="-1"></a><span class="fu">### Feature Selection: `PipeOpFilter` and `PipeOpSelect`</span></span>
<span id="cb184-1258"><a href="#cb184-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1259"><a href="#cb184-1259" aria-hidden="true" tabindex="-1"></a>The package <span class="in">`r mlr3filters`</span> contains many different <span class="in">`"mlr3filters::Filter")`</span>s that can be used to select features for subsequent learners.</span>
<span id="cb184-1260"><a href="#cb184-1260" aria-hidden="true" tabindex="-1"></a>This is often required when the data has a large amount of features.</span>
<span id="cb184-1261"><a href="#cb184-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1262"><a href="#cb184-1262" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("PipeOp")`</span> for filters is <span class="in">`r ref("PipeOpFilter")`</span>:</span>
<span id="cb184-1263"><a href="#cb184-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1264"><a href="#cb184-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-095}</span></span>
<span id="cb184-1265"><a href="#cb184-1265" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"filter"</span>, mlr3filters<span class="sc">::</span><span class="fu">flt</span>(<span class="st">"information_gain"</span>))</span>
<span id="cb184-1266"><a href="#cb184-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1267"><a href="#cb184-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1268"><a href="#cb184-1268" aria-hidden="true" tabindex="-1"></a>How many features to keep can be set using <span class="in">`filter_nfeat`</span>, <span class="in">`filter_frac`</span> and <span class="in">`filter_cutoff`</span>.</span>
<span id="cb184-1269"><a href="#cb184-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1270"><a href="#cb184-1270" aria-hidden="true" tabindex="-1"></a>Filters can be selected / de-selected by name using <span class="in">`r ref("PipeOpSelect")`</span>.</span>
<span id="cb184-1271"><a href="#cb184-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1272"><a href="#cb184-1272" aria-hidden="true" tabindex="-1"></a><span class="fu">## In-depth look into mlr3pipelines {#in-depth-pipelines}</span></span>
<span id="cb184-1273"><a href="#cb184-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1274"><a href="#cb184-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-096, include = FALSE}</span></span>
<span id="cb184-1275"><a href="#cb184-1275" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb184-1276"><a href="#cb184-1276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1277"><a href="#cb184-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1278"><a href="#cb184-1278" aria-hidden="true" tabindex="-1"></a>This vignette is an in-depth introduction to <span class="in">`r mlr3pipelines`</span>, the dataflow programming toolkit for machine learning in <span class="in">`R`</span> using <span class="in">`r mlr3`</span>.</span>
<span id="cb184-1279"><a href="#cb184-1279" aria-hidden="true" tabindex="-1"></a>It will go through basic concepts and then give a few examples that both show the simplicity as well as the power and versatility of using <span class="in">`r mlr3pipelines`</span>.</span>
<span id="cb184-1280"><a href="#cb184-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1281"><a href="#cb184-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">### What's the Point</span></span>
<span id="cb184-1282"><a href="#cb184-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1283"><a href="#cb184-1283" aria-hidden="true" tabindex="-1"></a>Machine learning toolkits often try to abstract away the processes happening inside machine learning algorithms.</span>
<span id="cb184-1284"><a href="#cb184-1284" aria-hidden="true" tabindex="-1"></a>This makes it easy for the user to switch out one algorithm for another without having to worry about what is happening inside it, what kind of data it is able to operate on etc.</span>
<span id="cb184-1285"><a href="#cb184-1285" aria-hidden="true" tabindex="-1"></a>The benefit of using <span class="in">`r mlr3`</span>, for example, is that one can create a <span class="in">`r ref("Learner")`</span>, a <span class="in">`r ref("Task")`</span>, a <span class="in">`r ref("Resampling")`</span> etc. and use them for typical machine learning operations.</span>
<span id="cb184-1286"><a href="#cb184-1286" aria-hidden="true" tabindex="-1"></a>It is trivial to exchange individual components and therefore use, for example, a different <span class="in">`r ref("Learner")`</span> in the same experiment for comparison.</span>
<span id="cb184-1287"><a href="#cb184-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1288"><a href="#cb184-1288" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-097}</span></span>
<span id="cb184-1289"><a href="#cb184-1289" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif</span>(iris, <span class="at">target =</span> <span class="st">"Species"</span>)</span>
<span id="cb184-1290"><a href="#cb184-1290" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb184-1291"><a href="#cb184-1291" aria-hidden="true" tabindex="-1"></a>rsmp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb184-1292"><a href="#cb184-1292" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, lrn, rsmp)</span>
<span id="cb184-1293"><a href="#cb184-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1294"><a href="#cb184-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1295"><a href="#cb184-1295" aria-hidden="true" tabindex="-1"></a>However, this modularity breaks down as soon as the learning algorithm encompasses more than just model fitting, like data preprocessing, ensembles or other meta models.</span>
<span id="cb184-1296"><a href="#cb184-1296" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> takes modularity one step further than <span class="in">`r mlr3`</span>: it makes it possible to build individual steps within a <span class="in">`r ref("Learner")`</span> out of building blocks called <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1297"><a href="#cb184-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1298"><a href="#cb184-1298" aria-hidden="true" tabindex="-1"></a><span class="fu">### `r ref("PipeOp")`: Pipeline Operators</span></span>
<span id="cb184-1299"><a href="#cb184-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1300"><a href="#cb184-1300" aria-hidden="true" tabindex="-1"></a>The most basic unit of functionality within <span class="in">`r mlr3pipelines`</span> is the <span class="in">`r ref("PipeOp")`</span>, short for "pipeline operator", which represents a trans-formative operation on input (for example a training dataset) leading to output.</span>
<span id="cb184-1301"><a href="#cb184-1301" aria-hidden="true" tabindex="-1"></a>It can therefore be seen as a generalized notion of a function, with a certain twist: <span class="in">`r ref("PipeOp")`</span>s behave differently during a "training phase" and a "prediction phase".</span>
<span id="cb184-1302"><a href="#cb184-1302" aria-hidden="true" tabindex="-1"></a>The training phase will typically generate a certain model of the data that is saved as internal state.</span>
<span id="cb184-1303"><a href="#cb184-1303" aria-hidden="true" tabindex="-1"></a>The prediction phase will then operate on the input data depending on the trained model.</span>
<span id="cb184-1304"><a href="#cb184-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1305"><a href="#cb184-1305" aria-hidden="true" tabindex="-1"></a>An example of this behavior is the *principal component analysis* operation ("<span class="in">`r ref("PipeOpPCA")`</span>"):</span>
<span id="cb184-1306"><a href="#cb184-1306" aria-hidden="true" tabindex="-1"></a>During training, it will transform incoming data by rotating it in a way that leads to uncorrelated features ordered by their contribution to total variance.</span>
<span id="cb184-1307"><a href="#cb184-1307" aria-hidden="true" tabindex="-1"></a>It will *also* save the rotation matrix to be use for new data during the "prediction phase".</span>
<span id="cb184-1308"><a href="#cb184-1308" aria-hidden="true" tabindex="-1"></a>This makes it possible to perform "prediction" with single rows of new data, where a row's scores on each of the principal components (the components of the training data!) is computed.</span>
<span id="cb184-1309"><a href="#cb184-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1310"><a href="#cb184-1310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-098}</span></span>
<span id="cb184-1311"><a href="#cb184-1311" aria-hidden="true" tabindex="-1"></a>po <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-1312"><a href="#cb184-1312" aria-hidden="true" tabindex="-1"></a>po<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(task))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1313"><a href="#cb184-1313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1314"><a href="#cb184-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1315"><a href="#cb184-1315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-099}</span></span>
<span id="cb184-1316"><a href="#cb184-1316" aria-hidden="true" tabindex="-1"></a>single_line_task <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span>)</span>
<span id="cb184-1317"><a href="#cb184-1317" aria-hidden="true" tabindex="-1"></a>po<span class="sc">$</span><span class="fu">predict</span>(<span class="fu">list</span>(single_line_task))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1318"><a href="#cb184-1318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1319"><a href="#cb184-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1320"><a href="#cb184-1320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-100}</span></span>
<span id="cb184-1321"><a href="#cb184-1321" aria-hidden="true" tabindex="-1"></a>po<span class="sc">$</span>state</span>
<span id="cb184-1322"><a href="#cb184-1322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1323"><a href="#cb184-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1324"><a href="#cb184-1324" aria-hidden="true" tabindex="-1"></a>This shows the most important primitives incorporated in a <span class="in">`r ref("PipeOp")`</span>:</span>
<span id="cb184-1325"><a href="#cb184-1325" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**`$train()`**, taking a list of input arguments, turning them into a list of outputs, meanwhile saving a state in <span class="in">`$state`</span></span>
<span id="cb184-1326"><a href="#cb184-1326" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**`$predict()`**, taking a list of input arguments, turning them into a list of outputs, making use of the saved <span class="in">`$state`</span></span>
<span id="cb184-1327"><a href="#cb184-1327" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>**`$state`**, the "model" trained with <span class="in">`$train()`</span> and utilized during <span class="in">`$predict()`</span>.</span>
<span id="cb184-1328"><a href="#cb184-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1329"><a href="#cb184-1329" aria-hidden="true" tabindex="-1"></a>Schematically we can represent the <span class="in">`r ref("PipeOp")`</span> like so:</span>
<span id="cb184-1330"><a href="#cb184-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1331"><a href="#cb184-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-101, echo = FALSE}</span></span>
<span id="cb184-1332"><a href="#cb184-1332" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_viz.png"</span>)</span>
<span id="cb184-1333"><a href="#cb184-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1334"><a href="#cb184-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1335"><a href="#cb184-1335" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Why the `$state`</span></span>
<span id="cb184-1336"><a href="#cb184-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1337"><a href="#cb184-1337" aria-hidden="true" tabindex="-1"></a>It is important to take a moment and notice the importance of a <span class="in">`$state`</span> variable and the <span class="in">`$train()`</span> / <span class="in">`$predict()`</span> dichotomy in a <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb184-1338"><a href="#cb184-1338" aria-hidden="true" tabindex="-1"></a>There are many preprocessing methods, for example scaling of parameters or imputation, that could in theory just be applied to training data and prediction / validation data separately, or they could be applied to a task before resampling is performed.</span>
<span id="cb184-1339"><a href="#cb184-1339" aria-hidden="true" tabindex="-1"></a>This would, however, be fallacious:</span>
<span id="cb184-1340"><a href="#cb184-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1341"><a href="#cb184-1341" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The preprocessing of each instance of prediction data should not depend on the remaining prediction dataset.</span>
<span id="cb184-1342"><a href="#cb184-1342" aria-hidden="true" tabindex="-1"></a>A prediction on a single instance of new data should give the same result as prediction performed on a whole dataset.</span>
<span id="cb184-1343"><a href="#cb184-1343" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If preprocessing is performed on a task *before* resampling is done, information about the test set can leak into the training set.</span>
<span id="cb184-1344"><a href="#cb184-1344" aria-hidden="true" tabindex="-1"></a>Resampling should evaluate the generalization performance of the *entire* machine learning method, therefore the behavior of this entire method must only depend only on the content of the *training* split during resampling.</span>
<span id="cb184-1345"><a href="#cb184-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1346"><a href="#cb184-1346" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Where to get `r ref("PipeOp")`s</span></span>
<span id="cb184-1347"><a href="#cb184-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1348"><a href="#cb184-1348" aria-hidden="true" tabindex="-1"></a>Each <span class="in">`r ref("PipeOp")`</span> is an instance of an "<span class="in">`R6`</span>" class, many of which are provided by the <span class="in">`r mlr3pipelines`</span> package itself.</span>
<span id="cb184-1349"><a href="#cb184-1349" aria-hidden="true" tabindex="-1"></a>They can be constructed explicitly ("<span class="in">`PipeOpPCA$new()`</span>") or retrieved from the <span class="in">`r ref("mlr_pipeops")`</span> dictionary: <span class="in">`po("pca")`</span>.</span>
<span id="cb184-1350"><a href="#cb184-1350" aria-hidden="true" tabindex="-1"></a>The entire list of available <span class="in">`r ref("PipeOp")`</span>s, and some meta-information, can be retrieved using <span class="in">`r ref("as.data.table()")`</span>:</span>
<span id="cb184-1351"><a href="#cb184-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1352"><a href="#cb184-1352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-102}</span></span>
<span id="cb184-1353"><a href="#cb184-1353" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(mlr_pipeops)[, <span class="fu">c</span>(<span class="st">"key"</span>, <span class="st">"input.num"</span>, <span class="st">"output.num"</span>)]</span>
<span id="cb184-1354"><a href="#cb184-1354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1355"><a href="#cb184-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1356"><a href="#cb184-1356" aria-hidden="true" tabindex="-1"></a>When retrieving <span class="in">`r ref("PipeOp")`</span>s from the <span class="in">`r ref("mlr_pipeops")`</span> dictionary, it is also possible to give additional constructor arguments, such as an <span class="co">[</span><span class="ot">id</span><span class="co">](#pipeop-ids-and-id-name-clashes)</span> or <span class="co">[</span><span class="ot">parameter values</span><span class="co">](#hyperparameters)</span>.</span>
<span id="cb184-1357"><a href="#cb184-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1358"><a href="#cb184-1358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-103}</span></span>
<span id="cb184-1359"><a href="#cb184-1359" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">rank. =</span> <span class="dv">3</span>)</span>
<span id="cb184-1360"><a href="#cb184-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1361"><a href="#cb184-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1362"><a href="#cb184-1362" aria-hidden="true" tabindex="-1"></a><span class="fu">### PipeOp Channels</span></span>
<span id="cb184-1363"><a href="#cb184-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1364"><a href="#cb184-1364" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Input Channels</span></span>
<span id="cb184-1365"><a href="#cb184-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1366"><a href="#cb184-1366" aria-hidden="true" tabindex="-1"></a>Just like functions, <span class="in">`r ref("PipeOp")`</span>s can take multiple inputs.</span>
<span id="cb184-1367"><a href="#cb184-1367" aria-hidden="true" tabindex="-1"></a>These multiple inputs are always given as elements in the input list.</span>
<span id="cb184-1368"><a href="#cb184-1368" aria-hidden="true" tabindex="-1"></a>For example, there is a <span class="in">`r ref("PipeOpFeatureUnion")`</span> that combines multiple tasks with different features and "<span class="in">`cbind()`</span>s" them together, creating one combined task.</span>
<span id="cb184-1369"><a href="#cb184-1369" aria-hidden="true" tabindex="-1"></a>When two halves of the <span class="in">`iris`</span> task are given, for example, it recreates the original task:</span>
<span id="cb184-1370"><a href="#cb184-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1371"><a href="#cb184-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-104}</span></span>
<span id="cb184-1372"><a href="#cb184-1372" aria-hidden="true" tabindex="-1"></a>iris_first_half <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"Petal.Length"</span>, <span class="st">"Petal.Width"</span>))</span>
<span id="cb184-1373"><a href="#cb184-1373" aria-hidden="true" tabindex="-1"></a>iris_second_half <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>()<span class="sc">$</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"Sepal.Length"</span>, <span class="st">"Sepal.Width"</span>))</span>
<span id="cb184-1374"><a href="#cb184-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1375"><a href="#cb184-1375" aria-hidden="true" tabindex="-1"></a>pofu <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>)</span>
<span id="cb184-1376"><a href="#cb184-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1377"><a href="#cb184-1377" aria-hidden="true" tabindex="-1"></a>pofu<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(iris_first_half, iris_second_half))[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1378"><a href="#cb184-1378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1379"><a href="#cb184-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1380"><a href="#cb184-1380" aria-hidden="true" tabindex="-1"></a>Because <span class="in">`r ref("PipeOpFeatureUnion")`</span> effectively takes two input arguments here, we can say it has two **input channels**.</span>
<span id="cb184-1381"><a href="#cb184-1381" aria-hidden="true" tabindex="-1"></a>An input channel also carries information about the *type* of input that is acceptable.</span>
<span id="cb184-1382"><a href="#cb184-1382" aria-hidden="true" tabindex="-1"></a>The input channels of the <span class="in">`pofu`</span> object constructed above, for example, each accept a <span class="in">`r ref("Task")`</span> during training and prediction.</span>
<span id="cb184-1383"><a href="#cb184-1383" aria-hidden="true" tabindex="-1"></a>This information can be queried from the <span class="in">`$input`</span> slot:</span>
<span id="cb184-1384"><a href="#cb184-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1385"><a href="#cb184-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-105}</span></span>
<span id="cb184-1386"><a href="#cb184-1386" aria-hidden="true" tabindex="-1"></a>pofu<span class="sc">$</span>input</span>
<span id="cb184-1387"><a href="#cb184-1387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1388"><a href="#cb184-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1389"><a href="#cb184-1389" aria-hidden="true" tabindex="-1"></a>Other <span class="in">`r ref("PipeOp")`</span>s may have channels that take different types during different phases.</span>
<span id="cb184-1390"><a href="#cb184-1390" aria-hidden="true" tabindex="-1"></a>The <span class="in">`backuplearner`</span> <span class="in">`r ref("PipeOp")`</span>, for example, takes a <span class="in">`NULL`</span> and a <span class="in">`r ref("Task")`</span> during training, and a <span class="in">`r ref("Prediction")`</span> and a <span class="in">`r ref("Task")`</span> during prediction:</span>
<span id="cb184-1391"><a href="#cb184-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1392"><a href="#cb184-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-106}</span></span>
<span id="cb184-1393"><a href="#cb184-1393" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> this is an important case to handle here, do not delete unless there is a better example.</span></span>
<span id="cb184-1394"><a href="#cb184-1394" aria-hidden="true" tabindex="-1"></a><span class="co"># po("backuplearner")$input</span></span>
<span id="cb184-1395"><a href="#cb184-1395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1396"><a href="#cb184-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1397"><a href="#cb184-1397" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Output Channels</span></span>
<span id="cb184-1398"><a href="#cb184-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1399"><a href="#cb184-1399" aria-hidden="true" tabindex="-1"></a>Unlike the typical notion of a function, <span class="in">`r ref("PipeOp")`</span>s can also have multiple **output channels**.</span>
<span id="cb184-1400"><a href="#cb184-1400" aria-hidden="true" tabindex="-1"></a><span class="in">`$train()`</span> and <span class="in">`$predict()`</span> always return a list, so certain <span class="in">`r ref("PipeOp")`</span>s may return lists with more than one element.</span>
<span id="cb184-1401"><a href="#cb184-1401" aria-hidden="true" tabindex="-1"></a>Similar to input channels, the information about the number and type of outputs given by a <span class="in">`r ref("PipeOp")`</span> is available in the <span class="in">`$output`</span> slot.</span>
<span id="cb184-1402"><a href="#cb184-1402" aria-hidden="true" tabindex="-1"></a>The <span class="in">`chunk`</span> PipeOp, for example, chunks a given <span class="in">`r ref("Task")`</span> into subsets and consequently returns multiple <span class="in">`r ref("Task")`</span> objects, both during training and prediction.</span>
<span id="cb184-1403"><a href="#cb184-1403" aria-hidden="true" tabindex="-1"></a>The number of output channels must be given during construction through the <span class="in">`outnum`</span> argument.</span>
<span id="cb184-1404"><a href="#cb184-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1405"><a href="#cb184-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-107}</span></span>
<span id="cb184-1406"><a href="#cb184-1406" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"chunk"</span>, <span class="at">outnum =</span> <span class="dv">3</span>)<span class="sc">$</span>output</span>
<span id="cb184-1407"><a href="#cb184-1407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1408"><a href="#cb184-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1409"><a href="#cb184-1409" aria-hidden="true" tabindex="-1"></a>Note that the number of output channels during training and prediction is the same.</span>
<span id="cb184-1410"><a href="#cb184-1410" aria-hidden="true" tabindex="-1"></a>A schema of a <span class="in">`r ref("PipeOp")`</span> with two output channels:</span>
<span id="cb184-1411"><a href="#cb184-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1412"><a href="#cb184-1412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-108, echo = FALSE}</span></span>
<span id="cb184-1413"><a href="#cb184-1413" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_multi_alone.png"</span>)</span>
<span id="cb184-1414"><a href="#cb184-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1415"><a href="#cb184-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1416"><a href="#cb184-1416" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Channel Configuration</span></span>
<span id="cb184-1417"><a href="#cb184-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1418"><a href="#cb184-1418" aria-hidden="true" tabindex="-1"></a>Most <span class="in">`r ref("PipeOp")`</span>s have only one input channel (so they take a list with a single element), but there are a few with more than one;</span>
<span id="cb184-1419"><a href="#cb184-1419" aria-hidden="true" tabindex="-1"></a>In many cases, the number of input or output channels is determined during construction, e.g. through the <span class="in">`innum`</span> / <span class="in">`outnum`</span> arguments.</span>
<span id="cb184-1420"><a href="#cb184-1420" aria-hidden="true" tabindex="-1"></a>The <span class="in">`input.num`</span> and <span class="in">`output.num`</span> columns of the <span class="in">`r ref("mlr_pipeops")`</span>-table <span class="co">[</span><span class="ot">above</span><span class="co">](#where-to-get-pipeops)</span> show the default number of channels, and <span class="in">`NA`</span> if the number depends on a construction argument.</span>
<span id="cb184-1421"><a href="#cb184-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1422"><a href="#cb184-1422" aria-hidden="true" tabindex="-1"></a>The default printer of a <span class="in">`r ref("PipeOp")`</span> gives information about channel names and types:</span>
<span id="cb184-1423"><a href="#cb184-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1424"><a href="#cb184-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-109, out.width="98%"}</span></span>
<span id="cb184-1425"><a href="#cb184-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># po("backuplearner")</span></span>
<span id="cb184-1426"><a href="#cb184-1426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1427"><a href="#cb184-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1428"><a href="#cb184-1428" aria-hidden="true" tabindex="-1"></a><span class="fu">### `r ref("Graph")`: Networks of `r ref("PipeOp")`s</span></span>
<span id="cb184-1429"><a href="#cb184-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1430"><a href="#cb184-1430" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Basics</span></span>
<span id="cb184-1431"><a href="#cb184-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1432"><a href="#cb184-1432" aria-hidden="true" tabindex="-1"></a>What is the advantage of this tedious way of declaring input and output channels and handling in/output through lists?</span>
<span id="cb184-1433"><a href="#cb184-1433" aria-hidden="true" tabindex="-1"></a>Because each <span class="in">`r ref("PipeOp")`</span> has a known number of input and output channels that always produce or accept data of a known type, it is possible to network them together in **`r ref("Graph")`**s.</span>
<span id="cb184-1434"><a href="#cb184-1434" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("Graph")`</span> is a collection of <span class="in">`r ref("PipeOp")`</span>s with "edges" that mandate that data should be flowing along them.</span>
<span id="cb184-1435"><a href="#cb184-1435" aria-hidden="true" tabindex="-1"></a>Edges always pass between <span class="in">`r ref("PipeOp")`</span> *channels*, so it is not only possible to explicitly prescribe which position of an input or output list an edge refers to, it makes it possible to make different components of a <span class="in">`r ref("PipeOp")`</span>'s output flow to multiple different other <span class="in">`r ref("PipeOp")`</span>s, as well as to have a <span class="in">`r ref("PipeOp")`</span> gather its input from multiple other <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1436"><a href="#cb184-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1437"><a href="#cb184-1437" aria-hidden="true" tabindex="-1"></a>A schema of a simple graph of <span class="in">`r ref("PipeOp")`</span>s:</span>
<span id="cb184-1438"><a href="#cb184-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1439"><a href="#cb184-1439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-110, echo = FALSE}</span></span>
<span id="cb184-1440"><a href="#cb184-1440" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/po_multi_viz.png"</span>)</span>
<span id="cb184-1441"><a href="#cb184-1441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1442"><a href="#cb184-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1443"><a href="#cb184-1443" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("Graph")`</span> is empty when first created, and <span class="in">`r ref("PipeOp")`</span>s can be added using the **`$add_pipeop()`** method.</span>
<span id="cb184-1444"><a href="#cb184-1444" aria-hidden="true" tabindex="-1"></a>The **`$add_edge()`** method is used to create connections between them.</span>
<span id="cb184-1445"><a href="#cb184-1445" aria-hidden="true" tabindex="-1"></a>While the printer of a <span class="in">`r ref("Graph")`</span> gives some information about its layout, the most intuitive way of visualizing it is using the <span class="in">`$plot()`</span> function.</span>
<span id="cb184-1446"><a href="#cb184-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1447"><a href="#cb184-1447" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-111}</span></span>
<span id="cb184-1448"><a href="#cb184-1448" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb184-1449"><a href="#cb184-1449" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"scale"</span>))</span>
<span id="cb184-1450"><a href="#cb184-1450" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"subsample"</span>, <span class="at">frac =</span> <span class="fl">0.1</span>))</span>
<span id="cb184-1451"><a href="#cb184-1451" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_edge</span>(<span class="st">"scale"</span>, <span class="st">"subsample"</span>)</span>
<span id="cb184-1452"><a href="#cb184-1452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1453"><a href="#cb184-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1454"><a href="#cb184-1454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-112}</span></span>
<span id="cb184-1455"><a href="#cb184-1455" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span>
<span id="cb184-1456"><a href="#cb184-1456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1457"><a href="#cb184-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1458"><a href="#cb184-1458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-113, fig.width = 8, fig.height = 8}</span></span>
<span id="cb184-1459"><a href="#cb184-1459" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-1460"><a href="#cb184-1460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1461"><a href="#cb184-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1462"><a href="#cb184-1462" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("Graph")`</span> itself has a **`$train()`** and a **`$predict()`** method that accept some data and propagate this data through the network of <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1463"><a href="#cb184-1463" aria-hidden="true" tabindex="-1"></a>The return value corresponds to the output of the <span class="in">`r ref("PipeOp")`</span> output channels that are not connected to other <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1464"><a href="#cb184-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1465"><a href="#cb184-1465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-114}</span></span>
<span id="cb184-1466"><a href="#cb184-1466" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(task)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1467"><a href="#cb184-1467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1468"><a href="#cb184-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1469"><a href="#cb184-1469" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-115}</span></span>
<span id="cb184-1470"><a href="#cb184-1470" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">predict</span>(single_line_task)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1471"><a href="#cb184-1471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1472"><a href="#cb184-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1473"><a href="#cb184-1473" aria-hidden="true" tabindex="-1"></a>The collection of <span class="in">`r ref("PipeOp")`</span>s inside a <span class="in">`r ref("Graph")`</span> can be accessed through the **`$pipeops`** slot.</span>
<span id="cb184-1474"><a href="#cb184-1474" aria-hidden="true" tabindex="-1"></a>The set of edges in the Graph can be inspected through the **`$edges`** slot.</span>
<span id="cb184-1475"><a href="#cb184-1475" aria-hidden="true" tabindex="-1"></a>It is possible to modify individual <span class="in">`PipeOps`</span> and edges in a Graph through these slots, but this is not recommended because no error checking is performed and it may put the <span class="in">`r ref("Graph")`</span> in an unsupported state.</span>
<span id="cb184-1476"><a href="#cb184-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1477"><a href="#cb184-1477" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Networks</span></span>
<span id="cb184-1478"><a href="#cb184-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1479"><a href="#cb184-1479" aria-hidden="true" tabindex="-1"></a>The example above showed a linear preprocessing pipeline, but it is in fact possible to build true "graphs" of operations, as long as no loops are introduced^<span class="co">[</span><span class="ot">It is tempting to denote this as a "directed acyclic graph", but this would not be entirely correct because edges run between channels of `r ref("PipeOp")`s, not `r ref("PipeOp")`s themselves.</span><span class="co">]</span>.</span>
<span id="cb184-1480"><a href="#cb184-1480" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOp")`</span>s with multiple output channels can feed their data to multiple different subsequent <span class="in">`r ref("PipeOp")`</span>s, and <span class="in">`r ref("PipeOp")`</span>s with multiple input channels can take results from different <span class="in">`r ref("PipeOp")`</span>s.</span>
<span id="cb184-1481"><a href="#cb184-1481" aria-hidden="true" tabindex="-1"></a>When a <span class="in">`r ref("PipeOp")`</span> has more than one input / output channel, then the <span class="in">`r ref("Graph")`</span>'s <span class="in">`$add_edge()`</span> method needs an additional argument that indicates which channel to connect to.</span>
<span id="cb184-1482"><a href="#cb184-1482" aria-hidden="true" tabindex="-1"></a>This argument can be given in the form of an integer, or as the name of the channel.</span>
<span id="cb184-1483"><a href="#cb184-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1484"><a href="#cb184-1484" aria-hidden="true" tabindex="-1"></a>The following constructs a <span class="in">`r ref("Graph")`</span> that copies the input and gives one copy each to a "scale" and a "pca" <span class="in">`r ref("PipeOp")`</span>.</span>
<span id="cb184-1485"><a href="#cb184-1485" aria-hidden="true" tabindex="-1"></a>The resulting columns of each operation are put next to each other by "featureunion".</span>
<span id="cb184-1486"><a href="#cb184-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1487"><a href="#cb184-1487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-116, tidy = FALSE}</span></span>
<span id="cb184-1488"><a href="#cb184-1488" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()<span class="sc">$</span></span>
<span id="cb184-1489"><a href="#cb184-1489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"copy"</span>, <span class="at">outnum =</span> <span class="dv">2</span>))<span class="sc">$</span></span>
<span id="cb184-1490"><a href="#cb184-1490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"scale"</span>))<span class="sc">$</span></span>
<span id="cb184-1491"><a href="#cb184-1491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"pca"</span>))<span class="sc">$</span></span>
<span id="cb184-1492"><a href="#cb184-1492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_pipeop</span>(<span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>))</span>
<span id="cb184-1493"><a href="#cb184-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1494"><a href="#cb184-1494" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span></span>
<span id="cb184-1495"><a href="#cb184-1495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_edge</span>(<span class="st">"copy"</span>, <span class="st">"scale"</span>, <span class="at">src_channel =</span> <span class="dv">1</span>)<span class="sc">$</span>        <span class="co"># designating channel by index</span></span>
<span id="cb184-1496"><a href="#cb184-1496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_edge</span>(<span class="st">"copy"</span>, <span class="st">"pca"</span>, <span class="at">src_channel =</span> <span class="st">"output2"</span>)<span class="sc">$</span>  <span class="co"># designating channel by name</span></span>
<span id="cb184-1497"><a href="#cb184-1497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_edge</span>(<span class="st">"scale"</span>, <span class="st">"featureunion"</span>, <span class="at">dst_channel =</span> <span class="dv">1</span>)<span class="sc">$</span></span>
<span id="cb184-1498"><a href="#cb184-1498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_edge</span>(<span class="st">"pca"</span>, <span class="st">"featureunion"</span>, <span class="at">dst_channel =</span> <span class="dv">2</span>)</span>
<span id="cb184-1499"><a href="#cb184-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1500"><a href="#cb184-1500" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-1501"><a href="#cb184-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1502"><a href="#cb184-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-117}</span></span>
<span id="cb184-1503"><a href="#cb184-1503" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(iris_first_half)[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb184-1504"><a href="#cb184-1504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1505"><a href="#cb184-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1506"><a href="#cb184-1506" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Syntactic Sugar</span></span>
<span id="cb184-1507"><a href="#cb184-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1508"><a href="#cb184-1508" aria-hidden="true" tabindex="-1"></a>Although it is possible to create intricate <span class="in">`r ref("Graph")`</span>s with edges going all over the place (as long as no loops are introduced), there is usually a clear direction of flow between "layers" in the <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-1509"><a href="#cb184-1509" aria-hidden="true" tabindex="-1"></a>It is therefore convenient to build up a <span class="in">`r ref("Graph")`</span> from layers, which can be done using the **`%&gt;&gt;%`** ("double-arrow") operator.</span>
<span id="cb184-1510"><a href="#cb184-1510" aria-hidden="true" tabindex="-1"></a>It takes either a <span class="in">`r ref("PipeOp")`</span> or a <span class="in">`r ref("Graph")`</span> on each of its sides and connects all of the outputs of its left-hand side to one of the inputs each of its right-hand side--the number of inputs therefore must match the number of outputs.</span>
<span id="cb184-1511"><a href="#cb184-1511" aria-hidden="true" tabindex="-1"></a>Together with the <span class="in">`r ref("gunion()")`</span> operation, which takes <span class="in">`r ref("PipeOp")`</span>s or <span class="in">`r ref("Graph")`</span>s and arranges them next to each other akin to a (disjoint) graph union, the above network can more easily be constructed as follows:</span>
<span id="cb184-1512"><a href="#cb184-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1513"><a href="#cb184-1513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-118}</span></span>
<span id="cb184-1514"><a href="#cb184-1514" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"copy"</span>, <span class="at">outnum =</span> <span class="dv">2</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-1515"><a href="#cb184-1515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(<span class="fu">po</span>(<span class="st">"scale"</span>), <span class="fu">po</span>(<span class="st">"pca"</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb184-1516"><a href="#cb184-1516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"featureunion"</span>, <span class="at">innum =</span> <span class="dv">2</span>)</span>
<span id="cb184-1517"><a href="#cb184-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1518"><a href="#cb184-1518" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span>
<span id="cb184-1519"><a href="#cb184-1519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1520"><a href="#cb184-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1521"><a href="#cb184-1521" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r ref("PipeOp")` IDs and ID Name Clashes</span></span>
<span id="cb184-1522"><a href="#cb184-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1523"><a href="#cb184-1523" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("PipeOp")`</span>s within a graph are addressed by their **`$id`**-slot.</span>
<span id="cb184-1524"><a href="#cb184-1524" aria-hidden="true" tabindex="-1"></a>It is therefore necessary for all <span class="in">`r ref("PipeOp")`</span>s within a <span class="in">`r ref("Graph")`</span> to have a unique <span class="in">`$id`</span>.</span>
<span id="cb184-1525"><a href="#cb184-1525" aria-hidden="true" tabindex="-1"></a>The <span class="in">`$id`</span> can be set during or after construction, but it should not directly be changed after a <span class="in">`r ref("PipeOp")`</span> was inserted in a <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-1526"><a href="#cb184-1526" aria-hidden="true" tabindex="-1"></a>At that point, the **`$set_names()`**-method can be used to change <span class="in">`r ref("PipeOp")`</span> ids.</span>
<span id="cb184-1527"><a href="#cb184-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1528"><a href="#cb184-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-119, error = TRUE}</span></span>
<span id="cb184-1529"><a href="#cb184-1529" aria-hidden="true" tabindex="-1"></a>po1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-1530"><a href="#cb184-1530" aria-hidden="true" tabindex="-1"></a>po2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-1531"><a href="#cb184-1531" aria-hidden="true" tabindex="-1"></a>po1 <span class="sc">%&gt;&gt;%</span> po2 <span class="co"># name clash</span></span>
<span id="cb184-1532"><a href="#cb184-1532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1533"><a href="#cb184-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1534"><a href="#cb184-1534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-120}</span></span>
<span id="cb184-1535"><a href="#cb184-1535" aria-hidden="true" tabindex="-1"></a>po2<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"scale2"</span></span>
<span id="cb184-1536"><a href="#cb184-1536" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> po1 <span class="sc">%&gt;&gt;%</span> po2</span>
<span id="cb184-1537"><a href="#cb184-1537" aria-hidden="true" tabindex="-1"></a>gr</span>
<span id="cb184-1538"><a href="#cb184-1538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1539"><a href="#cb184-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1540"><a href="#cb184-1540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-121}</span></span>
<span id="cb184-1541"><a href="#cb184-1541" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative ways of getting new ids:</span></span>
<span id="cb184-1542"><a href="#cb184-1542" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"scale"</span>, <span class="at">id =</span> <span class="st">"scale2"</span>)</span>
<span id="cb184-1543"><a href="#cb184-1543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1544"><a href="#cb184-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1545"><a href="#cb184-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-122, error = TRUE}</span></span>
<span id="cb184-1546"><a href="#cb184-1546" aria-hidden="true" tabindex="-1"></a><span class="co"># sometimes names of PipeOps within a Graph need to be changed</span></span>
<span id="cb184-1547"><a href="#cb184-1547" aria-hidden="true" tabindex="-1"></a>gr2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-1548"><a href="#cb184-1548" aria-hidden="true" tabindex="-1"></a>gr <span class="sc">%&gt;&gt;%</span> gr2</span>
<span id="cb184-1549"><a href="#cb184-1549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1550"><a href="#cb184-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1551"><a href="#cb184-1551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-123}</span></span>
<span id="cb184-1552"><a href="#cb184-1552" aria-hidden="true" tabindex="-1"></a>gr2<span class="sc">$</span><span class="fu">set_names</span>(<span class="st">"scale"</span>, <span class="st">"scale3"</span>)</span>
<span id="cb184-1553"><a href="#cb184-1553" aria-hidden="true" tabindex="-1"></a>gr <span class="sc">%&gt;&gt;%</span> gr2</span>
<span id="cb184-1554"><a href="#cb184-1554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1555"><a href="#cb184-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1556"><a href="#cb184-1556" aria-hidden="true" tabindex="-1"></a><span class="fu">### Learners in Graphs, Graphs in Learners</span></span>
<span id="cb184-1557"><a href="#cb184-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1558"><a href="#cb184-1558" aria-hidden="true" tabindex="-1"></a>The true power of <span class="in">`r mlr3pipelines`</span> derives from the fact that it can be integrated seamlessly with <span class="in">`r mlr3`</span>.</span>
<span id="cb184-1559"><a href="#cb184-1559" aria-hidden="true" tabindex="-1"></a>Two components are mainly responsible for this:</span>
<span id="cb184-1560"><a href="#cb184-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1561"><a href="#cb184-1561" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("PipeOpLearner")`</span>, a <span class="in">`r ref("PipeOp")`</span> that encapsulates a <span class="in">`r mlr3`</span> <span class="in">`r ref("Learner")`</span> and creates a <span class="in">`r ref("PredictionData")`</span> object in its <span class="in">`$predict()`</span> phase</span>
<span id="cb184-1562"><a href="#cb184-1562" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`r ref("GraphLearner")`</span>, a <span class="in">`r mlr3`</span> <span class="in">`r ref("Learner")`</span> that can be used in place of any other <span class="in">`r mlr3`</span> <span class="in">`r ref("Learner")`</span>, but which does prediction using a <span class="in">`r ref("Graph")`</span> given to it</span>
<span id="cb184-1563"><a href="#cb184-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1564"><a href="#cb184-1564" aria-hidden="true" tabindex="-1"></a>Note that these are dual to each other: One takes a <span class="in">`r ref("Learner")`</span> and produces a <span class="in">`r ref("PipeOp")`</span> (and by extension a <span class="in">`r ref("Graph")`</span>); the other takes a <span class="in">`r ref("Graph")`</span> and produces a <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb184-1565"><a href="#cb184-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1566"><a href="#cb184-1566" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r ref("PipeOpLearner")`</span></span>
<span id="cb184-1567"><a href="#cb184-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1568"><a href="#cb184-1568" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("PipeOpLearner")`</span> is constructed using a <span class="in">`r mlr3`</span> <span class="in">`r ref("Learner")`</span> and will use it to create <span class="in">`r ref("PredictionData")`</span> in the <span class="in">`$predict()`</span> phase.</span>
<span id="cb184-1569"><a href="#cb184-1569" aria-hidden="true" tabindex="-1"></a>The output during <span class="in">`$train()`</span> is <span class="in">`NULL`</span>.</span>
<span id="cb184-1570"><a href="#cb184-1570" aria-hidden="true" tabindex="-1"></a>It can be used after a preprocessing pipeline, and it is even possible to perform operations on the <span class="in">`r ref("PredictionData")`</span>, for example by averaging multiple predictions or by using the <span class="in">`PipeOpBackupLearner`</span>" operator to impute predictions that a given model failed to create.</span>
<span id="cb184-1571"><a href="#cb184-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1572"><a href="#cb184-1572" aria-hidden="true" tabindex="-1"></a>The following is a very simple <span class="in">`r ref("Graph")`</span> that performs training and prediction on data after performing principal component analysis.</span>
<span id="cb184-1573"><a href="#cb184-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1574"><a href="#cb184-1574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-124}</span></span>
<span id="cb184-1575"><a href="#cb184-1575" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"learner"</span>,</span>
<span id="cb184-1576"><a href="#cb184-1576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-1577"><a href="#cb184-1577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1578"><a href="#cb184-1578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-125}</span></span>
<span id="cb184-1579"><a href="#cb184-1579" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">train</span>(task)</span>
<span id="cb184-1580"><a href="#cb184-1580" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">predict</span>(task)</span>
<span id="cb184-1581"><a href="#cb184-1581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1582"><a href="#cb184-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1583"><a href="#cb184-1583" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `r ref("GraphLearner")`</span></span>
<span id="cb184-1584"><a href="#cb184-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1585"><a href="#cb184-1585" aria-hidden="true" tabindex="-1"></a>Although a <span class="in">`r ref("Graph")`</span> has <span class="in">`$train()`</span> and <span class="in">`$predict()`</span> functions, it can not be used directly in places where <span class="in">`r mlr3`</span> <span class="in">`Learners`</span> can be used like resampling or benchmarks.</span>
<span id="cb184-1586"><a href="#cb184-1586" aria-hidden="true" tabindex="-1"></a>For this, it needs to be wrapped in a <span class="in">`r ref("GraphLearner")`</span> object, which is a thin wrapper that enables this functionality.</span>
<span id="cb184-1587"><a href="#cb184-1587" aria-hidden="true" tabindex="-1"></a>The resulting <span class="in">`r ref("Learner")`</span> is extremely versatile, because every part of it can be modified, replaced, parameterized and optimized over.</span>
<span id="cb184-1588"><a href="#cb184-1588" aria-hidden="true" tabindex="-1"></a>Resampling the graph above can be done the same way that resampling of the <span class="in">`r ref("Learner")`</span> was performed in the <span class="co">[</span><span class="ot">introductory example</span><span class="co">](#whats-the-point)</span>.</span>
<span id="cb184-1589"><a href="#cb184-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1590"><a href="#cb184-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-126}</span></span>
<span id="cb184-1591"><a href="#cb184-1591" aria-hidden="true" tabindex="-1"></a>lrngrph <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb184-1592"><a href="#cb184-1592" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, lrngrph, rsmp)</span>
<span id="cb184-1593"><a href="#cb184-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1594"><a href="#cb184-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1595"><a href="#cb184-1595" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hyperparameters</span></span>
<span id="cb184-1596"><a href="#cb184-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1597"><a href="#cb184-1597" aria-hidden="true" tabindex="-1"></a><span class="in">`r mlr3pipelines`</span> relies on the <span class="in">`r ref_pkg("paradox")`</span> package to provide parameters that can modify each <span class="in">`r ref("PipeOp")`</span>'s behavior.</span>
<span id="cb184-1598"><a href="#cb184-1598" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref_pkg("paradox")`</span> parameters provide information about the parameters that can be changed, as well as their types and ranges.</span>
<span id="cb184-1599"><a href="#cb184-1599" aria-hidden="true" tabindex="-1"></a>They provide a unified interface for benchmarks and parameter optimization ("tuning").</span>
<span id="cb184-1600"><a href="#cb184-1600" aria-hidden="true" tabindex="-1"></a>For a deep dive into <span class="in">`r ref_pkg("paradox")`</span>, see <span class="co">[</span><span class="ot">the tuning chapter</span><span class="co">](#searchspace)</span> or @sec-paradox.</span>
<span id="cb184-1601"><a href="#cb184-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1602"><a href="#cb184-1602" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("ParamSet")`</span>, representing the space of possible parameter configurations of a <span class="in">`r ref("PipeOp")`</span>, can be inspected by accessing the **`$param_set`** slot of a <span class="in">`r ref("PipeOp")`</span> or a <span class="in">`r ref("Graph")`</span>.</span>
<span id="cb184-1603"><a href="#cb184-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1604"><a href="#cb184-1604" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-127}</span></span>
<span id="cb184-1605"><a href="#cb184-1605" aria-hidden="true" tabindex="-1"></a>op_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb184-1606"><a href="#cb184-1606" aria-hidden="true" tabindex="-1"></a>op_pca<span class="sc">$</span>param_set</span>
<span id="cb184-1607"><a href="#cb184-1607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1608"><a href="#cb184-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1609"><a href="#cb184-1609" aria-hidden="true" tabindex="-1"></a>To set or retrieve a parameter, the **`$param_set$values`** slot can be accessed.</span>
<span id="cb184-1610"><a href="#cb184-1610" aria-hidden="true" tabindex="-1"></a>Alternatively, the <span class="in">`param_vals`</span> value can be given during construction.</span>
<span id="cb184-1611"><a href="#cb184-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1612"><a href="#cb184-1612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-128}</span></span>
<span id="cb184-1613"><a href="#cb184-1613" aria-hidden="true" tabindex="-1"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb184-1614"><a href="#cb184-1614" aria-hidden="true" tabindex="-1"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb184-1615"><a href="#cb184-1615" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1616"><a href="#cb184-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1617"><a href="#cb184-1617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-129}</span></span>
<span id="cb184-1618"><a href="#cb184-1618" aria-hidden="true" tabindex="-1"></a>op_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb184-1619"><a href="#cb184-1619" aria-hidden="true" tabindex="-1"></a>op_pca<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb184-1620"><a href="#cb184-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1621"><a href="#cb184-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1622"><a href="#cb184-1622" aria-hidden="true" tabindex="-1"></a>Each <span class="in">`r ref("PipeOp")`</span> can bring its own individual parameters which are collected together in the <span class="in">`r ref("Graph")`</span>'s <span class="in">`$param_set`</span>.</span>
<span id="cb184-1623"><a href="#cb184-1623" aria-hidden="true" tabindex="-1"></a>A <span class="in">`r ref("PipeOp")`</span>'s parameter names are prefixed with its <span class="in">`$id`</span> to prevent parameter name clashes.</span>
<span id="cb184-1624"><a href="#cb184-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1625"><a href="#cb184-1625" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-130}</span></span>
<span id="cb184-1626"><a href="#cb184-1626" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> op_pca <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb184-1627"><a href="#cb184-1627" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>param_set</span>
<span id="cb184-1628"><a href="#cb184-1628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1629"><a href="#cb184-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1630"><a href="#cb184-1630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-131}</span></span>
<span id="cb184-1631"><a href="#cb184-1631" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb184-1632"><a href="#cb184-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1633"><a href="#cb184-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1634"><a href="#cb184-1634" aria-hidden="true" tabindex="-1"></a>Both <span class="in">`r ref("PipeOpLearner")`</span> and <span class="in">`r ref("GraphLearner")`</span> preserve parameters of the objects they encapsulate.</span>
<span id="cb184-1635"><a href="#cb184-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1636"><a href="#cb184-1636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-132}</span></span>
<span id="cb184-1637"><a href="#cb184-1637" aria-hidden="true" tabindex="-1"></a>op_rpart <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb184-1638"><a href="#cb184-1638" aria-hidden="true" tabindex="-1"></a>op_rpart<span class="sc">$</span>param_set</span>
<span id="cb184-1639"><a href="#cb184-1639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb184-1640"><a href="#cb184-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-1641"><a href="#cb184-1641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-133}</span></span>
<span id="cb184-1642"><a href="#cb184-1642" aria-hidden="true" tabindex="-1"></a>glrn <span class="ot">=</span> <span class="fu">as_learner</span>(gr <span class="sc">%&gt;&gt;%</span> op_rpart)</span>
<span id="cb184-1643"><a href="#cb184-1643" aria-hidden="true" tabindex="-1"></a>glrn<span class="sc">$</span>param_set</span>
<span id="cb184-1644"><a href="#cb184-1644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licenced under <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>.</div>   
      <div class="nav-footer-center"><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></div>
    <div class="nav-footer-right">Written with <i class="bi bi-heart-fill"></i> for #rstats, ML and FOSS by the mlr-org team.</div>
  </div>
</footer>


<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>